

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bacco.sampler &mdash; bacco 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> bacco
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bacco</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bacco.sampler</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bacco.sampler</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of the &#39;Sampler&#39; class and helper functions</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Sampler&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">cosmology</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Simulation</span><span class="p">,</span> <span class="n">PairedSimulation</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">latinhypercube</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Try installing &#39;h5py&#39;: pip install h5py --user&quot;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;bacco.sampler&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Sampler"><a class="viewcode-back" href="../../code.html#bacco.Sampler">[docs]</a><span class="k">class</span> <span class="nc">Sampler</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class that defines some MCMC sampling utilities</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;metropolis&#39;</span><span class="p">,</span> <span class="n">lnlike</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_scatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_scatter_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">nchains</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">par_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">backup_fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_backup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">convergence_crit</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">auto_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        analysis_mode: If True, for each step of the MCMC the Gelman-Rubin test will be</span>
<span class="sd">                       performed. Enable only to test the performances of the sampler,</span>
<span class="sd">                       it might slow down the execution of the sampling.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> <span class="c1"># TODO: check if we can avoid import numpy here</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mpi</span> <span class="o">=</span> <span class="n">MPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

        <span class="n">extension</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">{:02d}</span><span class="s1">.hdf5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span> <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;.hdf5&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">backup_fname</span> <span class="o">+</span> <span class="n">extension</span> <span class="k">if</span> <span class="n">backup_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auto_stop</span> <span class="o">=</span> <span class="n">auto_stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">=</span> <span class="n">load_backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_mode</span> <span class="o">=</span> <span class="n">analysis_mode</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_stop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;stop&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">backup_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">load_backup</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">backupfile</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span>            <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span>           <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;nchains&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span>          <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;nwalkers&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span>             <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;ndims&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span>            <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span>         <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;par_names&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span>             <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span>      <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;chain_lnlike&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span>       <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence_crit</span>  <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;convergence_crit&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span>        <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times</span>             <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gelman_rubin</span>      <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;gelman_rubin&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jump_factors</span>      <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;jump_factors&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acceptance_rates</span>  <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;acceptance_rates&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nupdated_steps</span>    <span class="o">=</span> <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;nupdated_steps&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metropolis&#39;</span><span class="p">,</span> <span class="s1">&#39;emcee&#39;</span><span class="p">,</span> <span class="s1">&#39;montecarlo&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Method </span><span class="si">{}</span><span class="s1"> not known&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">lnlike</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A likelihood function must be provided&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nchains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please, specify the number of chains&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please, specify the flat prior bounds&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ndims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please, specify the number of free parameters&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">par_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">par_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span> <span class="o">=</span> <span class="n">nchains</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span> <span class="o">=</span> <span class="n">ndims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">=</span> <span class="n">nwalkers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span> <span class="o">=</span> <span class="n">par_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence_crit</span> <span class="o">=</span> <span class="n">convergence_crit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_stop</span> <span class="o">=</span> <span class="n">auto_stop</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnlike</span> <span class="o">=</span> <span class="n">lnlike</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_args</span> <span class="o">=</span> <span class="n">lnlike_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="o">=</span> <span class="n">lnlike_scatter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter_args</span> <span class="o">=</span> <span class="n">lnlike_scatter_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamical_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emulate_like</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_args</span>


<div class="viewcode-block" id="Sampler.initialize_run"><a class="viewcode-back" href="../../code.html#bacco.Sampler.initialize_run">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;latinhypercube&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lh_seed</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lh_spread</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">initguess</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        fname: file with the initial positions of the chains.</span>
<span class="sd">        initguess: array of initial positions of the chains. In case of emulated likelihoods,</span>
<span class="sd">         these points will be added on top of the latin hypercube ones.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;loading backup...&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;initializing with direct initguess...&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;latinhypercube&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;initializing with latin hypercube...&#39;</span><span class="p">)</span>
                <span class="n">n_lhpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;emcee&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span> <span class="o">=</span> <span class="n">latinhypercube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">,</span> <span class="n">n_lhpoints</span><span class="p">,</span> <span class="n">spread</span><span class="o">=</span><span class="n">lh_spread</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">lh_seed</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
                    <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span> <span class="o">=</span> <span class="n">initguess</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized initialization method&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;montecarlo&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;emcee&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">(</span><span class="n">init</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">]])</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Sampler.emulate_likelihood"><a class="viewcode-back" href="../../code.html#bacco.Sampler.emulate_likelihood">[docs]</a>    <span class="k">def</span> <span class="nf">emulate_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emulator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hyperspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">space_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">space_rotation_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">divide_by_multvar_gaussian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">add_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_likes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lhc_seed</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lhc_spread</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lhc_nbuild</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                <span class="n">gp</span><span class="o">=</span><span class="s1">&#39;george&#39;</span><span class="p">,</span> <span class="n">gp_variance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gp_lengthscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">gp_num_restarts</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">gp_seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gp_realisation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">gp_fix_hyperparams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gp_noise_stdev</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fix_noise</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">use_fitted</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        emulator: emulator object, if None it will be builded.</span>
<span class="sd">        file: file containing coordinates and likelihood evaluations to build the emulator. If None</span>
<span class="sd">                a latin hypercube will be builded</span>
<span class="sd">        hyperspace: boundaries for the emulator latin hypercube, if None the sampler boundaries will be used</span>
<span class="sd">        space rotation: if True the emulator space will be rotated and renormalised</span>
<span class="sd">        add_points: points to be added to the latin hypercube</span>
<span class="sd">        add_likes: likelihoods associated to add_points to be added to the latin hypercube, if None they will be computed</span>
<span class="sd">        lhc_seed: seed fot the latin hypercube</span>
<span class="sd">        lhc_spread: if True, the projected distances will be maximised</span>
<span class="sd">        lhc_nbuild: number of points in the latin hypercube</span>
<span class="sd">        gp: gaussian process to be used, between &#39;george&#39; (default), &#39;gpy&#39; and &#39;sklearn&#39;</span>
<span class="sd">        gp_variance: gaussian process variance, default is 1</span>
<span class="sd">        gp_lengthscale: gaussian process lenghtscale, default is 1</span>
<span class="sd">        gp_num_restarts = gaussian process number of optimisation restarts, default is 9</span>
<span class="sd">        gp_seed= gaussian process seed, default is 1</span>
<span class="sd">        gp_realisation = if True, a random realisation of the emulator will be returned instead of the mean. Default is False</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emulate_like</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_gp</span> <span class="o">=</span> <span class="n">gp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space_rotation</span> <span class="o">=</span> <span class="n">space_rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">divide_by_multvar_gaussian</span> <span class="o">=</span> <span class="n">divide_by_multvar_gaussian</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_realisation</span> <span class="o">=</span> <span class="n">gp_realisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="k">if</span> <span class="n">hyperspace</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">hyperspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln_ln</span> <span class="o">=</span> <span class="n">ln_ln</span>
        <span class="k">if</span> <span class="n">emulator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span> <span class="o">=</span> <span class="n">emulator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;loading the initial latin hypercube of the emulator...&#39;</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
                <span class="n">lhc</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">lnlike_points</span> <span class="o">=</span> <span class="n">lhc</span><span class="p">[</span><span class="s1">&#39;lnlike_points&#39;</span><span class="p">]</span>
                <span class="n">lhc_points</span> <span class="o">=</span> <span class="n">lhc</span><span class="p">[</span><span class="s1">&#39;lhc_points&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="n">lnlike_points_scatter</span> <span class="o">=</span> <span class="n">lhc</span><span class="p">[</span><span class="s1">&#39;lnlike_points_scatter&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#emulator_file is None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;finding the initial latin hypercube for the emulator...&#39;</span><span class="p">)</span>
                <span class="n">lhc_points</span> <span class="o">=</span> <span class="n">latinhypercube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">,</span> <span class="n">lhc_nbuild</span><span class="p">,</span> <span class="n">spread</span><span class="o">=</span><span class="n">lhc_spread</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">lhc_seed</span><span class="p">)</span>
                <span class="n">lhc_points</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lhc_points</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">_lnlike_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lhc_nbuild</span><span class="p">)</span>
                <span class="n">lnlike_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lhc_nbuild</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="n">_lnlike_points_scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lhc_nbuild</span><span class="p">)</span>
                    <span class="n">lnlike_points_scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lhc_nbuild</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lhc_points</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
                        <span class="n">_lnlike_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lnlike_args</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                            <span class="n">_lnlike_points_scatter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter_args</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">(</span><span class="n">_lnlike_points</span><span class="p">,</span> <span class="n">lnlike_points</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">(</span><span class="n">_lnlike_points_scatter</span><span class="p">,</span> <span class="n">lnlike_points_scatter</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">add_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">add_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">add_points</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">add_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">lhc_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">add_likes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">add_likes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">add_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">_add_likes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">add_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                        <span class="n">add_likes_scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">add_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">_add_likes_scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">add_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">add_points</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
                            <span class="c1"># print &#39;\n\n\nIn Run &#39;,i,&#39;lh points: &#39;,p,&#39;\n&#39;,&#39;in CPU %d of %d\n\n\n&#39;%(rank,size)</span>
                            <span class="n">_add_likes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lnlike_args</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                                <span class="n">_add_likes_scatter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter_args</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">(</span><span class="n">_add_likes</span><span class="p">,</span> <span class="n">add_likes</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">(</span><span class="n">_add_likes_scatter</span><span class="p">,</span> <span class="n">add_likes_scatter</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
                <span class="n">lhc_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">lhc_points</span><span class="p">,</span> <span class="n">add_points</span><span class="p">))</span>
                <span class="n">lnlike_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">lnlike_points</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">add_likes</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="n">lnlike_points_scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">lnlike_points_scatter</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">add_likes_scatter</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="p">))</span>

                <span class="c1"># Use only the last points suggested for constructing the emulator</span>
                <span class="c1"># useful to test the amount of points really needed to reconstruct the contours</span>
                <span class="n">use_last_points</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">use_npoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_points</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">use_last_points</span><span class="p">:</span>
                    <span class="n">lhc_points</span> <span class="o">=</span> <span class="n">lhc_points</span><span class="p">[</span><span class="o">-</span><span class="n">use_npoints</span><span class="p">:]</span>
                    <span class="n">lnlike_points</span> <span class="o">=</span> <span class="n">lnlike_points</span><span class="p">[</span><span class="o">-</span><span class="n">use_npoints</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                        <span class="n">lnlike_points_scatter</span> <span class="o">=</span> <span class="n">lnlike_points_scatter</span><span class="p">[</span><span class="o">-</span><span class="n">use_npoints</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lhc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lhc_points&#39;</span><span class="p">:</span><span class="n">lhc_points</span><span class="p">,</span> <span class="s1">&#39;lnlike_points&#39;</span><span class="p">:</span><span class="n">lnlike_points</span><span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="n">lhc</span><span class="p">[</span><span class="s1">&#39;lnlike_points_scatter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lnlike_points_scatter</span>
                <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
                <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">lhc</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_rotation</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">linalg</span>
                <span class="n">rotation_points</span> <span class="o">=</span> <span class="n">lhc_points</span> <span class="k">if</span> <span class="n">space_rotation_points</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">space_rotation_points</span>
                <span class="n">rot_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rotation_points</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">w</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">rot_cov</span><span class="p">)</span> <span class="c1">#eigenvalues, rotation matrix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rotation_matrix</span> <span class="o">=</span> <span class="n">R</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ci</span><span class="p">)</span> <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">lhc_points</span><span class="p">]))</span>
                <span class="n">rotation_points_mcmc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ci</span><span class="p">)</span> <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">rotation_points</span><span class="p">]))</span>
                <span class="c1">#self.lhc_rot_points = np.dot(R.T,rotation_points.T).T</span>
                <span class="c1">#rot_bounds_min =  np.min(self.lhc_rot_points,axis=0) #np.array(np.dot(R.T,self.bounds[:,0]))</span>
                <span class="c1">#rot_bounds_max =  np.max(self.lhc_rot_points,axis=0)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#0.5*(rot_bounds_max+rot_bounds_min) #np.mean(rotation_points_mcmc,axis=0)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_stddevs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#0.5*(rot_bounds_max-rot_bounds_min) #np.std(rotation_points_mcmc, axis=0)</span>
                <span class="c1">#self.lhc_rot_points_reg = self.lhc_rot_points[:] - self.lhc_rot_points_means</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_means</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_reg</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_stddevs</span>
                <span class="n">normalized_lhc_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_reg</span> <span class="c1">#if space_rotation_points is None else self.lhc_rot_points_reg.T</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                import corner</span>
<span class="sd">                bounds = np.repeat([[-1,1]],self.bounds.shape[0]).reshape(2,self.bounds.shape[0]).T</span>
<span class="sd">                import ipdb; ipdb.set_trace()</span>
<span class="sd">                fig_it = corner.corner(normalized_lhc_points,  color=&#39;red&#39;, range=bounds)# if space_rotation_points is None else corner.corner(normalized_lhc_points.T,  color=&#39;red&#39;, range=bounds)</span>
<span class="sd">                plt.show()</span>
<span class="sd">                rotation_points_mcmc = rotation_points_mcmc - np.mean(rotation_points_mcmc,axis=0)</span>
<span class="sd">                rotation_points_mcmc = rotation_points_mcmc/np.std(rotation_points_mcmc, 0)</span>
<span class="sd">                fig_it = corner.corner(rotation_points_mcmc,  color=&#39;red&#39;, range=bounds)</span>
<span class="sd">                plt.show()</span>
<span class="sd">                &#39;&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">normalized_lhc_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">lhc_points</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span> <span class="o">=</span> <span class="n">lnlike_points</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emulator_lhc_points</span> <span class="o">=</span> <span class="n">lhc_points</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emulator_lhc_points_scatter</span> <span class="o">=</span> <span class="n">lnlike_points_scatter</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;building the emulator...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_by_multvar_gaussian</span><span class="p">:</span>
                    <span class="n">loglike_multvar_gauss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_multvar_gauss_fit</span><span class="p">(</span><span class="n">lhc_points</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Amp_mulvar_gauss_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lnlike_points</span><span class="o">/</span><span class="n">loglike_multvar_gauss</span><span class="p">)</span>
                    <span class="n">lnlike_points</span><span class="o">=</span><span class="n">lnlike_points</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Amp_mulvar_gauss_fit</span><span class="o">*</span><span class="n">loglike_multvar_gauss</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_scatter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span> <span class="o">=</span> <span class="n">construct_emulator</span><span class="p">(</span><span class="n">normalized_lhc_points</span><span class="p">,</span> <span class="n">lnlike_points</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span>
                                                              <span class="n">gp_variance</span><span class="p">,</span> <span class="n">gp_lengthscale</span><span class="p">,</span> <span class="n">gp_num_restarts</span><span class="p">,</span> <span class="n">gp_seed</span><span class="p">,</span>
                                                              <span class="n">fix_hyperparams</span><span class="o">=</span><span class="n">gp_fix_hyperparams</span><span class="p">,</span>
                                                              <span class="n">noise_stdev</span><span class="o">=</span><span class="n">gp_noise_stdev</span><span class="p">,</span> <span class="n">use_fitted</span><span class="o">=</span><span class="n">use_fitted</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="n">ln_ln</span><span class="p">,</span> <span class="n">fix_noise</span><span class="o">=</span><span class="n">fix_noise</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span> <span class="o">=</span> <span class="n">construct_emulator</span><span class="p">(</span><span class="n">normalized_lhc_points</span><span class="p">,</span> <span class="n">lnlike_points</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span>
                                                              <span class="n">gp_variance</span><span class="p">,</span> <span class="n">gp_lengthscale</span><span class="p">,</span> <span class="n">gp_num_restarts</span><span class="p">,</span> <span class="n">gp_seed</span><span class="p">,</span>
                                                              <span class="n">fix_hyperparams</span><span class="o">=</span><span class="n">gp_fix_hyperparams</span><span class="p">,</span>
                                                              <span class="n">noise_stdev</span><span class="o">=</span><span class="n">lnlike_points_scatter</span><span class="p">,</span> <span class="n">use_fitted</span><span class="o">=</span><span class="n">use_fitted</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="n">ln_ln</span><span class="p">,</span> <span class="n">fix_noise</span><span class="o">=</span><span class="n">fix_noise</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emulated_lnlike_args</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1">#if np.any(np.isnan(self.lnlike_emulator.obj_grads)):</span>
        <span class="c1">#    raise RuntimeError(&#39;Emulator minimisation failed: Try larger nbuild&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulated_lnlike</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulated_lnlike_args</span>

        <span class="k">return</span></div>


    <span class="k">def</span> <span class="nf">emulated_lnlike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">return_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;montecarlo&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">dim</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">dim</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">infty</span>
            <span class="c1">#normalise the points to emulate the likelihood</span>
            <span class="n">traspoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_coordinates</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
            <span class="n">pred</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">traspoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_gp</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_realisation</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_ln</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_cov</span><span class="p">:</span> <span class="k">return</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">:</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">points</span><span class="p">])</span>
            <span class="n">pred</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_gp</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_realisation</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_ln</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_cov</span><span class="p">:</span> <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">cov</span>

            <span class="k">return</span> <span class="n">pred</span>

<div class="viewcode-block" id="Sampler.run"><a class="viewcode-back" href="../../code.html#bacco.Sampler.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">maxrepetitions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbackup</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nconverge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nupdate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsuperupdate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">initial_step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">use_ntry</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        nupdate=0 and nsuperupdate=0 to not update covariance matrix and jumping</span>
<span class="sd">        factor, respectively.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># WARNING: maybe instead of appending step by step, we should append</span>
        <span class="c1"># larger chunks of these arrays in advance</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;times&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;chain_lnlike&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;gelman_rubin&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gelman_rubin</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nupdated_steps&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nupdated_steps</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;jump_factors&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jump_factors</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;acceptance_rates&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acceptance_rates</span>  <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jump_factor</span> <span class="o">=</span> <span class="mf">2.38</span>
        <span class="k">for</span> <span class="n">nblocks</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxrepetitions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">=</span> <span class="n">nblocks</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;metropolis&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_mcmc_mpi</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">nupdate</span><span class="o">=</span><span class="n">nupdate</span><span class="p">,</span> <span class="n">nsuperupdate</span><span class="o">=</span><span class="n">nsuperupdate</span><span class="p">,</span>
                                    <span class="n">seeds</span><span class="o">=</span><span class="n">seeds</span><span class="p">,</span> <span class="n">initial_step</span><span class="o">=</span><span class="n">initial_step</span><span class="p">,</span> <span class="n">use_ntry</span><span class="o">=</span><span class="n">use_ntry</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;emcee&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_emcee</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span><span class="n">seeds</span><span class="o">=</span><span class="n">seeds</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;montecarlo&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_montecarlo</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span><span class="n">seeds</span><span class="o">=</span><span class="n">seeds</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">%</span> <span class="n">nconverge</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metropolis&#39;</span><span class="p">,</span><span class="s1">&#39;emcee&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gelman_rubin_test</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">%</span> <span class="n">nbackup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_stop</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_fname</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_fname</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_fname</span><span class="p">)</span>
                    <span class="k">break</span></div>


    <span class="k">def</span> <span class="nf">_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;doing the backup...&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">backupfile</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;nchains&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;ndims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;par_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;nwalkers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;chain_lnlike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;convergence_crit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence_crit</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;gelman_rubin&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">gelman_rubin</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;jump_factors&#39;</span><span class="p">]</span> <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">jump_factors</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;acceptance_rates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptance_rates</span>
            <span class="n">backupfile</span><span class="p">[</span><span class="s1">&#39;nupdated_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nupdated_steps</span>
            <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span><span class="p">,</span> <span class="n">backupfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;resetting the chains...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gelman_rubin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jump_factors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptance_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nupdated_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_gelman_rubin_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;emcee&#39;</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
        <span class="c1"># now chain has shape (Nchain, Nsteps, Ndims)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">chain</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">general_result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">R_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">min_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">general_result</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">R_1</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nsteps</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="mf">0.75</span><span class="o">*</span><span class="n">min_len</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;emcee&#39;</span><span class="p">:</span>
                    <span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[:][</span><span class="o">-</span><span class="n">nsteps</span><span class="p">:]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">])</span>
                <span class="n">mean_in_chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">sigma2_in_chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mean_among_chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mean_in_chain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;emcee&#39;</span><span class="p">:</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="n">nsteps</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">mean_in_chain</span><span class="o">-</span><span class="n">mean_among_chains</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="n">nsteps</span><span class="o">/</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">mean_in_chain</span><span class="o">-</span><span class="n">mean_among_chains</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma2_in_chain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nsteps</span> <span class="o">*</span> <span class="n">W</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="o">*</span><span class="n">nsteps</span><span class="p">)</span><span class="o">*</span><span class="n">B</span> <span class="c1">#pooled variance</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>                     <span class="c1">#degrees of freedom</span>
                <span class="c1"># R = np.sqrt( (d+3)/(d+1) * V/W )</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">V</span><span class="o">/</span><span class="n">W</span> <span class="p">)</span>
                <span class="n">R_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Gelman-Rubin R - 1 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">R_1</span><span class="p">))</span>
                <span class="n">general_result</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">R_1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence_crit</span><span class="p">):</span>
                    <span class="n">general_result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">general_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">general_result</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">R_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">R_1</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">general_result</span><span class="p">,</span> <span class="n">R_1</span>

    <span class="k">def</span> <span class="nf">_update_covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

        <span class="n">sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sampler</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_advance_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">effective_covariance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">jump_factor</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span>
        <span class="c1"># using the whole covariance matrix. Possibility of using just the</span>
        <span class="c1"># diagonal by subtituting self.covariance with  self.covariance.diagonal()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">effective_covariance</span><span class="p">,</span> <span class="n">check_valid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_mcmc_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nupdate</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">nsuperupdate</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                            <span class="n">initial_step</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">use_ntry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        MCMC sampler employing a Metropolis-Hastings Adaptive algorithm (MA),</span>
<span class="sd">        parallelised with MPI. See Haario et al. (2001) for a detailed</span>
<span class="sd">        description of the algorithm and the proof it converges to the</span>
<span class="sd">        desired posterior distribution. See Roberts et al. (1997) and Roberts</span>
<span class="sd">        and Rosenthal (2001) for details on the empirical 2.38^2 covergence</span>
<span class="sd">        factor.</span>

<span class="sd">        &gt;&gt; Please, run your code with</span>
<span class="sd">        &gt;&gt; mpirun -np n python your_code.py</span>
<span class="sd">        &gt;&gt; where n is the number of mpi-tasks requested.</span>

<span class="sd">        Note that it is required that the number of mpi-task is the same as</span>
<span class="sd">        the number of chains. You will get an error otherwise.</span>

<span class="sd">        INPUT:</span>
<span class="sd">        nchains:        number of chains</span>
<span class="sd">        initguess:      starting point in parameter space (see latin hypercubes)</span>
<span class="sd">                        Note: this needs to have shape (Nchains, Npars)</span>
<span class="sd">        nsteps:         MA algorithms prefer fewer but longer chains than affine</span>
<span class="sd">                        invariant ones (such as emcee&#39;s default).</span>
<span class="sd">        seeds:          vector of seed (one for each chain)</span>
<span class="sd">        maxrepetitions: maximum number of times nsteps steps will be added to</span>
<span class="sd">                        the chain</span>
<span class="sd">        show_plot:      whether to show a plot</span>
<span class="sd">        save_plot:      whether to save a plot</span>
<span class="sd">        lnlike_args:    the arguments to be passed to your likelihood function</span>
<span class="sd">                        in the form of a tuple (they will be passed as *args)</span>
<span class="sd">        par_names:      names to be dispayed on axes if plot is required</span>
<span class="sd">        target_values:  fiducial values  to be dispayed if plot is required</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span> <span class="o">==</span> <span class="n">size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">initguess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span>

        <span class="c1"># NOTE: maybe it is safer to generate all the random numbers that</span>
        <span class="c1"># will be used HERE in a vector that we will access later.</span>
        <span class="c1"># This can prevent that, is in the computation of the likelihood there</span>
        <span class="c1"># is some function setting a seed in numpy, this seed is used also</span>
        <span class="c1"># in the MCMC (it would always be the same!!)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hi from process </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">seeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="p">)</span>
                <span class="n">seeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seeds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">seeds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">initguess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
            <span class="n">dix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">initial_step</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="p">[</span><span class="n">dix</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_step</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="p">[</span><span class="n">dix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">initial_step</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_covariance</span><span class="p">()</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">lL_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span>
        <span class="n">naccepted_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_up</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">acceptance_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">use_ntry</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nsteps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> steps realized in chain; </span><span class="si">{}</span><span class="s1"> steps accepted; rank </span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">naccepted_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">r_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gelman_rubin_test</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_mode</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nupdate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="n">nupdate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">r_1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">r_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gelman_rubin_test</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">r_1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">r_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">nupdated_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">))</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> steps realized in chain </span><span class="si">{}</span><span class="s1">; steps accepted </span><span class="si">{}</span><span class="s1">; updating step size.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">naccepted_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">n_up</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">old_covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_update_covariance</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">n_up</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jump_factor</span> <span class="o">*=</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">old_covariance</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="p">))</span> <span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">)</span>
                            <span class="n">n_up</span> <span class="o">=</span> <span class="n">n</span>

                <span class="c1"># if (np.abs(np.mean(self.jump_factors[n-n_up:])/jump_factor-1)&gt;0.01):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nsuperupdate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                     <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">n_up</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nsuperupdate</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acceptance_rates</span><span class="p">[</span><span class="o">-</span><span class="n">nsuperupdate</span><span class="p">:])</span><span class="o">-</span><span class="mf">0.26</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">r_1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">r_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gelman_rubin_test</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">r_1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">r_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.4</span> <span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jump_factor</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acceptance_rates</span><span class="p">[</span><span class="o">-</span><span class="n">nsuperupdate</span><span class="p">:])</span><span class="o">-</span><span class="mf">0.26</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">n_up</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jump_factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jump_factor</span><span class="p">,</span><span class="mf">0.238</span><span class="p">),</span><span class="mi">238</span><span class="p">)</span>

                <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_advance_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
                <span class="n">lL_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lL_1</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">acceptance</span> <span class="o">=</span> <span class="n">lL_1</span> <span class="o">-</span> <span class="n">lL_0</span>
                <span class="k">if</span> <span class="n">acceptance</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">naccepted_steps</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lL_1</span><span class="p">)</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">x1</span>
                    <span class="n">lL_0</span> <span class="o">=</span> <span class="n">lL_1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gelman_rubin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acceptance_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">naccepted_steps</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">jump_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jump_factor</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">dt of last accepted step= </span><span class="si">{}</span><span class="s1"> from cpu </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                <span class="n">acceptance_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">naccepted_steps</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">naccepted_steps</span> <span class="o">&lt;</span> <span class="n">nsteps</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> steps realized in chain; </span><span class="si">{}</span><span class="s1"> steps accepted; rank </span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">naccepted_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">naccepted_steps</span> <span class="o">%</span> <span class="n">nupdate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">naccepted_steps</span> <span class="o">!=</span> <span class="n">last_n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> steps realized in chain </span><span class="si">{}</span><span class="s1">; steps accepted </span><span class="si">{}</span><span class="s1">; updating step size.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">naccepted_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_covariance</span><span class="p">()</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_advance_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
                <span class="n">lL_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lL_1</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">acceptance</span> <span class="o">=</span> <span class="n">lL_1</span> <span class="o">-</span> <span class="n">lL_0</span>
                <span class="k">if</span> <span class="n">acceptance</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">naccepted_steps</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lL_1</span><span class="p">)</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">x1</span>
                    <span class="n">lL_0</span> <span class="o">=</span> <span class="n">lL_1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">dt of last accepted step= </span><span class="si">{}</span><span class="s1"> from cpu </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                    <span class="n">last_n</span> <span class="o">=</span> <span class="n">naccepted_steps</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># self._update_covariance()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Acceptance rate (chain </span><span class="si">{}</span><span class="s1">): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">naccepted_steps</span> <span class="o">/</span> <span class="n">nsteps</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_run_emcee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">emcee</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">initguess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span> <span class="o">==</span> <span class="n">size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initguess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hi from process </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_backup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="p">)</span>
                <span class="n">seeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seeds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">seeds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">initguess</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>

        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span><span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">,</span> <span class="n">sampler</span><span class="o">.</span><span class="n">lnprobability</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#self.emcee_convergence = sampler.get_autocorr_time()</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">_run_montecarlo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span> <span class="o">==</span> <span class="n">size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hi from process </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">seeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="p">)</span>
                <span class="n">seeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seeds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchains</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">seeds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Block </span><span class="si">{}</span><span class="s1">: Monte-Carlo sampling of </span><span class="si">{}</span><span class="s1"> likelihood points...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span><span class="p">,</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emulate_like</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">normalised_random_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
            <span class="n">like</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">(</span><span class="n">normalised_random_points</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">nsteps</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">like</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">like</span><span class="p">))</span>
            <span class="n">random_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">normalised_random_points</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">random_points</span> <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">,</span> <span class="n">like</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">random_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
            <span class="n">like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike</span><span class="p">(</span><span class="n">point</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnlike_args</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">random_points</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">nsteps</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">like</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">like</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">random_points</span><span class="p">[</span><span class="n">mask</span><span class="p">,:]</span> <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">,</span> <span class="n">like</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">plot_mcmc_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.16</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.84</span><span class="p">],</span>
                           <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">fix_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">plot_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_chains</span><span class="p">(</span><span class="n">burnin</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">corner</span>
            <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="k">if</span> <span class="n">fix_bounds</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span> <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">labels</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">,</span>
                        <span class="n">show_titles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">title_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
                        <span class="nb">range</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">truths</span><span class="o">=</span><span class="n">target_values</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">plot_points</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yi</span><span class="p">):</span>
                            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="n">xi</span><span class="p">],</span><span class="n">point</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                            <span class="c1"># ax.axvline(target_values[xi], color=&quot;r&quot;)</span>
                            <span class="c1"># ax.axhline(target_values[yi], color=&quot;r&quot;)</span>
            <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
                <span class="n">plot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span><span class="o">+</span><span class="s1">&#39;_MCMC_contours&#39;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_name</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">papertype</span> <span class="o">=</span> <span class="s1">&#39;b10&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="s2">&quot;Saved the plot &quot;</span> <span class="o">+</span> <span class="n">plot_name</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">plot_mcmc_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_chains</span><span class="p">(</span><span class="n">burnin</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span> <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">labels</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchains</span><span class="p">):</span>
                <span class="n">add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="o">%</span><span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="o">!=</span><span class="mi">2</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="o">%</span><span class="mi">2</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">add</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;chain n &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="n">y</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span><span class="n">c</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span><span class="n">dim</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">target_values</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;N steps&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
                    <span class="n">plot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span><span class="o">+</span><span class="s1">&#39;_MCMC_chain&#39;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_name</span><span class="o">+</span><span class="s1">&#39;_chain&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">papertype</span> <span class="o">=</span> <span class="s1">&#39;b10&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="s2">&quot;Saved the plot &quot;</span><span class="o">+</span> <span class="n">plot_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">plot_mcmc_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_chains</span><span class="p">(</span><span class="n">burnin</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;N steps&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ln(\mathcal</span><span class="si">{L}</span><span class="s1">)$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_lnlike</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_lnlike</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
                <span class="n">plot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_fname</span><span class="o">+</span><span class="s1">&#39;_MCMC_lnlikelihood&#39;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_name</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="s2">&quot;Saved the plot &quot;</span><span class="o">+</span> <span class="n">plot_name</span> <span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>


    <span class="k">def</span> <span class="nf">transform_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_rotation</span><span class="p">:</span>
            <span class="c1">#Get x into the eigenbasis</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            R = self.lhc_rotation_matrix.T</span>
<span class="sd">            xR = np.array([np.dot(R, xi) for xi in x])</span>
<span class="sd">            xR -= self.lhc_rot_points_means</span>
<span class="sd">            xR /= self.lhc_rot_points_stddevs</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rotation_matrix</span><span class="o">.</span><span class="n">T</span>
            <span class="n">xR</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]))</span> <span class="c1">#np.dot(R.T,x.T).T</span>
            <span class="n">xR</span> <span class="o">=</span> <span class="n">xR</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_means</span>
            <span class="n">xR</span> <span class="o">=</span> <span class="n">xR</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">lhc_rot_points_stddevs</span>
            <span class="c1">#import ipdb; ipdb.set_trace()</span>
            <span class="k">return</span> <span class="n">xR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_hyperspace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_merge_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">burnin</span><span class="p">):</span>

        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;montecarlo&#39;</span><span class="p">:</span>
            <span class="n">burnin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;emcee&#39;</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
            <span class="n">bindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">burnin</span><span class="o">*</span><span class="n">nsteps</span><span class="p">)</span> <span class="k">if</span> <span class="n">burnin</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">burnin</span>

            <span class="k">if</span> <span class="n">bindex</span> <span class="o">&gt;=</span> <span class="n">nsteps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;The burn-in is </span><span class="si">{}</span><span class="s2">, the length of the chain is </span><span class="si">{}</span><span class="s2">. You do not want a burn-in larger than the chain, do you?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">burnin</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;emcee&#39;</span><span class="p">:</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)[:,</span><span class="n">bindex</span><span class="p">:,</span> <span class="p">:]</span>
                <span class="n">merged_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">)[:,</span><span class="n">bindex</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)[</span><span class="n">bindex</span><span class="p">:,</span> <span class="p">:]</span>
                <span class="n">merged_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">)[</span><span class="n">bindex</span><span class="p">:]</span>

            <span class="n">merged_chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">)),</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">merged_lnlike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">merged_lnlike</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">merged_lnlike</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">merged_chains</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">merged_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">merged_lnlike</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;emcee&#39;</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
            <span class="n">bindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">burnin</span><span class="o">*</span><span class="n">nsteps</span><span class="p">)</span> <span class="k">if</span> <span class="n">burnin</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">burnin</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;emcee&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)[:,</span><span class="n">bindex</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">merged_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">)[:,</span><span class="n">bindex</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)[</span><span class="n">bindex</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndims</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">merged_lnlike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lnlike</span><span class="p">)[</span><span class="n">bindex</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_lims68</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lims68&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_marginalised_stats</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="n">latex</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sigma_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span>
                <span class="n">sigma_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">latex</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tails68</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
                    <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]))))</span>
                    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$&lt; {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tails68</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                    <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span>
                    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$&gt; {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sigma_r</span><span class="o">/</span><span class="n">sigma_l</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="mf">0.03</span><span class="p">:</span>
                        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sigma_l</span><span class="o">+</span><span class="n">sigma_r</span><span class="p">)</span>
                        <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma</span><span class="p">))))</span>
                        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;${:.</span><span class="si">{zeropos}</span><span class="s1">f} \pm {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zeropos_l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma_l</span><span class="p">))))</span>
                        <span class="n">zeropos_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma_r</span><span class="p">))))</span>
                        <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">zeropos_l</span><span class="p">,</span> <span class="n">zeropos_r</span><span class="p">])</span>
                        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;${:.</span><span class="si">{zeropos}</span><span class="s1">f}^{{+{:.</span><span class="si">{zeropos}</span><span class="s1">f}}}_{{-{:.</span><span class="si">{zeropos}</span><span class="s1">f}}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">sigma_r</span><span class="p">,</span> <span class="n">sigma_l</span><span class="p">,</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lims95</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lims95&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_marginalised_stats</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_lims95</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="n">latex</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sigma_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span>
                <span class="n">sigma_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">latex</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tails95</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
                    <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]))))</span>
                    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$&lt; {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tails95</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                    <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span>
                    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$&gt; {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sigma_r</span><span class="o">/</span><span class="n">sigma_l</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="mf">0.03</span><span class="p">:</span>
                        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sigma_l</span><span class="o">+</span><span class="n">sigma_r</span><span class="p">)</span>
                        <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma</span><span class="p">))))</span>
                        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;${:.</span><span class="si">{zeropos}</span><span class="s1">f} \pm {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zeropos_l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma_l</span><span class="p">))))</span>
                        <span class="n">zeropos_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma_r</span><span class="p">))))</span>
                        <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">zeropos_l</span><span class="p">,</span> <span class="n">zeropos_r</span><span class="p">])</span>
                        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;${:.</span><span class="si">{zeropos}</span><span class="s1">f}^{{+{:.</span><span class="si">{zeropos}</span><span class="s1">f}}}_{{-{:.</span><span class="si">{zeropos}</span><span class="s1">f}}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">sigma_r</span><span class="p">,</span> <span class="n">sigma_l</span><span class="p">,</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lims99</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lims99&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_marginalised_stats</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_lims99</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="n">latex</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sigma_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span>
                <span class="n">sigma_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">latex</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tails99</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
                    <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]))))</span>
                    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$&lt; {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tails99</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                    <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span>
                    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$&gt; {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sigma_r</span><span class="o">/</span><span class="n">sigma_l</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="mf">0.03</span><span class="p">:</span>
                        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sigma_l</span><span class="o">+</span><span class="n">sigma_r</span><span class="p">)</span>
                        <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma</span><span class="p">))))</span>
                        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;${:.</span><span class="si">{zeropos}</span><span class="s1">f} \pm {:.</span><span class="si">{zeropos}</span><span class="s1">f}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zeropos_l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma_l</span><span class="p">))))</span>
                        <span class="n">zeropos_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigma_r</span><span class="p">))))</span>
                        <span class="n">zeropos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">zeropos_l</span><span class="p">,</span> <span class="n">zeropos_r</span><span class="p">])</span>
                        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;${:.</span><span class="si">{zeropos}</span><span class="s1">f}^{{+{:.</span><span class="si">{zeropos}</span><span class="s1">f}}}_{{-{:.</span><span class="si">{zeropos}</span><span class="s1">f}}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">sigma_r</span><span class="p">,</span> <span class="n">sigma_l</span><span class="p">,</span> <span class="n">zeropos</span><span class="o">=</span><span class="n">zeropos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_marginalised_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#mean of the posterior PDF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">median</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1">#median of the posterior PDF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#mode (peak) of the posterior PDF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bestfit</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#set of parameters which maximise the likelihood</span>

            <span class="n">max_lkl_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_lnlike</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span> <span class="n">pi</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span> <span class="n">pi</span><span class="p">])</span>
                <span class="n">histo</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span> <span class="n">pi</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;doane&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">approx_marg_like</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">histo</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">centers</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">centers</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">intp_lkl</span> <span class="o">=</span> <span class="n">approx_marg_like</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">intp_lkl</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bestfit</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[</span><span class="n">max_lkl_arg</span><span class="p">,</span><span class="n">pi</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lims68</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tails68</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">):</span>
                <span class="n">histo</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span> <span class="n">pi</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">histo</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># prob = trapz(histo[histo&gt;threshold], dx=dx)</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">])</span><span class="o">*</span><span class="n">dx</span>
                    <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.6827</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">threshold</span> <span class="o">*=</span> <span class="mf">0.98</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">centers</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails68</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails68</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails68</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;two&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tails95</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">):</span>
                <span class="n">histo</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span> <span class="n">pi</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">histo</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># prob = trapz(histo[histo&gt;threshold], dx=dx)</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">])</span><span class="o">*</span><span class="n">dx</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.9545</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">histo</span><span class="p">)):</span>
                        <span class="k">break</span>
                    <span class="n">threshold</span> <span class="o">*=</span> <span class="mf">0.98</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">centers</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails95</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims95</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails95</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails95</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;two&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lims99</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tails99</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">):</span>
                <span class="n">histo</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[:,</span> <span class="n">pi</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">histo</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># prob = trapz(histo[histo&gt;threshold], dx=dx)</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">])</span><span class="o">*</span><span class="n">dx</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.99973</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">histo</span><span class="p">)):</span>
                        <span class="k">break</span>
                    <span class="n">threshold</span> <span class="o">*=</span> <span class="mf">0.98</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">centers</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="n">histo</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails99</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lims99</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails99</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tails99</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;two&#39;</span>

    <span class="k">def</span> <span class="nf">get_marginalised_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_chains</span><span class="p">(</span><span class="n">burnin</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_get_marginalised_stats</span><span class="p">()</span>

            <span class="n">cl68</span> <span class="o">=</span> <span class="s1">&#39;-- 68 </span><span class="si">% c</span><span class="s1">onfidence levels---&#39;</span>
            <span class="n">cl68</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                format: mean, lower, upper&#39;</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                <span class="n">cl68</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cl68</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                ----------------------------&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cl68</span><span class="p">)</span>

            <span class="n">cl95</span> <span class="o">=</span> <span class="s1">&#39;-- 95 </span><span class="si">% c</span><span class="s1">onfidence levels---&#39;</span>
            <span class="n">cl95</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                format: mean, lower, upper&#39;</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lims95</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                <span class="n">cl95</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cl95</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                ----------------------------&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cl95</span><span class="p">)</span>

            <span class="n">cl99</span> <span class="o">=</span> <span class="s1">&#39;-- 99 </span><span class="si">% c</span><span class="s1">onfidence levels---&#39;</span>
            <span class="n">cl99</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                format: mean, lower, upper&#39;</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lims99</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                <span class="n">cl99</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cl99</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                ----------------------------&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cl99</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">get_latex_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="mi">68</span><span class="p">,</span> <span class="n">compilation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.tex&#39;</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.tex&#39;</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">endl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\documentclass</span><span class="si">{article}</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\begin</span><span class="si">{document}</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\thispagestyle</span><span class="si">{empty}</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\section*{{</span><span class="si">{}</span><span class="s1">\</span><span class="si">% li</span><span class="s1">mits}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\begin</span><span class="si">{tabular}</span><span class="s1">{l l}&#39;</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lims</span> <span class="o">==</span> <span class="mi">99</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &amp; </span><span class="si">{}</span><span class="s1"> </span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lims99</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">lims</span> <span class="o">==</span> <span class="mi">95</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &amp; </span><span class="si">{}</span><span class="s1"> </span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lims95</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_names</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &amp; </span><span class="si">{}</span><span class="s1"> </span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\end</span><span class="si">{tabular}</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\end</span><span class="si">{document}</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">endl</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">compilation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">os</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;pdflatex -interaction=nonstopmode  &#39;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39; &gt; log.txt &amp;&amp; rm log.txt &amp;&amp; rm &#39;</span> <span class="o">+</span>
                          <span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.log &amp;&amp; rm &#39;</span><span class="o">+</span><span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.aux &amp;&amp; xdg-open &#39;</span><span class="o">+</span><span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.pdf &amp;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_multvar_gauss_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhc_points</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Constructing multivariate Gaussian...&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">multivariate_normal</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lhc_points</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">lhc_points</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lnlike_mult_gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lhc_points</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lhc_points</span><span class="p">)):</span>
            <span class="n">lnlike_mult_gauss</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">lognormpdf</span><span class="p">(</span><span class="n">lhc_points</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lnlike_mult_gauss</span></div>


<span class="k">def</span> <span class="nf">Load_ArrSim</span><span class="p">(</span><span class="n">Arr_Snap</span><span class="p">,</span> <span class="n">targ_snap</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">Nsnap</span><span class="p">,</span> <span class="n">dm_file</span> <span class="o">=</span> <span class="s1">&#39;snapshot&#39;</span><span class="p">,</span>
                    <span class="n">halo_file</span> <span class="o">=</span> <span class="s1">&#39;fof_subhalo_history_tab_orph_wweight&#39;</span><span class="p">,</span>
                     <span class="n">load_dm</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">load_fof</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">load_sub</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">use_orphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma8</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">total_snapshots</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">Files_Clean</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load the fof of a simulation to an array, so it can be re-read it</span>

<span class="sd">    Arr_Snap - &gt; [0] is the index of the array of snapshot to use.</span>
<span class="sd">                 [1] is the array with the simulations.</span>
<span class="sd">                 [2] is the snapshots of the simulations.</span>
<span class="sd">    eg. Arr_Snap = np.zeros(3,dtype=object)</span>
<span class="sd">        Arr_Snap[0] = 0</span>
<span class="sd">        Arr_Snap[1] = np.zeros(Nsnap,dtype=object)</span>
<span class="sd">        Arr_Snap[2] = np.zeros(Nsnap,dtype=int)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="c1"># for Paired Simulations we provide a list of  basedirs</span>
        <span class="n">sim1</span> <span class="o">=</span> <span class="n">Load_ArrSim</span><span class="p">(</span><span class="n">Arr_Snap</span><span class="o">=</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">targ_snap</span><span class="o">=</span><span class="n">targ_snap</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="n">basedir</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">Nsnap</span><span class="o">=</span><span class="n">Nsnap</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">load_dm</span><span class="o">=</span><span class="n">load_dm</span><span class="p">,</span> <span class="n">load_fof</span><span class="o">=</span><span class="n">load_fof</span><span class="p">,</span>
            <span class="n">load_sub</span><span class="o">=</span><span class="n">load_sub</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">,</span> <span class="n">sigma8</span><span class="o">=</span><span class="n">sigma8</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">total_snapshots</span> <span class="o">=</span> <span class="n">total_snapshots</span><span class="p">,</span> <span class="n">Files_Clean</span><span class="o">=</span><span class="n">Files_Clean</span><span class="p">)</span>

        <span class="n">sim2</span> <span class="o">=</span> <span class="n">Load_ArrSim</span><span class="p">(</span><span class="n">Arr_Snap</span><span class="o">=</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">targ_snap</span><span class="o">=</span><span class="n">targ_snap</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="n">basedir</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">Nsnap</span><span class="o">=</span><span class="n">Nsnap</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">load_dm</span><span class="o">=</span><span class="n">load_dm</span><span class="p">,</span> <span class="n">load_fof</span><span class="o">=</span><span class="n">load_fof</span><span class="p">,</span>
            <span class="n">load_sub</span><span class="o">=</span><span class="n">load_sub</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">,</span> <span class="n">sigma8</span><span class="o">=</span><span class="n">sigma8</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">total_snapshots</span> <span class="o">=</span> <span class="n">total_snapshots</span><span class="p">,</span> <span class="n">Files_Clean</span><span class="o">=</span><span class="n">Files_Clean</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PairedSimulation</span><span class="p">((</span><span class="n">sim1</span><span class="p">,</span> <span class="n">sim2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">load_dm</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">Files_Clean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dmf</span> <span class="o">=</span> <span class="n">dm_file</span>
    <span class="k">elif</span> <span class="n">load_dm</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">Files_Clean</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">dmf</span> <span class="o">=</span> <span class="s1">&#39;snapdir_</span><span class="si">%03d</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">targ_snap</span><span class="p">,</span><span class="n">dm_file</span><span class="p">,</span><span class="n">targ_snap</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dmf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">load_fof</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">Files_Clean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">foff</span> <span class="o">=</span> <span class="n">halo_file</span>
    <span class="k">elif</span> <span class="n">load_fof</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">Files_Clean</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">foff</span> <span class="o">=</span> <span class="s1">&#39;groups_</span><span class="si">%03d</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">targ_snap</span><span class="p">,</span><span class="n">halo_file</span><span class="p">,</span><span class="n">targ_snap</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">foff</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">load_sim</span><span class="p">():</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="n">basedir</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span>
                    <span class="n">dm_file</span><span class="o">=</span><span class="n">dmf</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">foff</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">=</span><span class="n">targ_snap</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
                    <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">,</span> <span class="n">sigma8</span><span class="o">=</span><span class="n">sigma8</span><span class="p">,</span> <span class="n">total_snapshots</span> <span class="o">=</span> <span class="n">total_snapshots</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">load_dm</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">dm</span>
        <span class="k">if</span> <span class="n">load_fof</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">fof</span>
        <span class="k">if</span> <span class="n">load_sub</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">sub</span>
        <span class="k">return</span> <span class="n">sim</span>

    <span class="k">if</span> <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">targ_Sim</span> <span class="o">=</span> <span class="n">load_sim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nsnap</span><span class="p">):</span>
            <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">targ_Sim</span><span class="p">)</span>
            <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">targ_snap</span>

    <span class="k">if</span> <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sim_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nsnap</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">Nsnap</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">targ_snap</span><span class="p">):</span>
                <span class="n">sim_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">targ_Sim</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Simulation at snapshot </span><span class="si">%d</span><span class="s2"> already in memory&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">targ_snap</span><span class="p">))</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sim_found</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">targ_Sim</span> <span class="o">=</span> <span class="n">load_sim</span><span class="p">()</span>
            <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="n">Nsnap</span><span class="p">]</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="n">Nsnap</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">targ_Sim</span><span class="p">)</span>
            <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="n">Nsnap</span><span class="p">]</span> <span class="o">=</span> <span class="n">targ_snap</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Simulation at snapshot </span><span class="si">%d</span><span class="s2"> not in memory. Using index </span><span class="si">%d</span><span class="s2">. Loading...&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">targ_snap</span><span class="p">,</span><span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">Arr_Snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">targ_Sim</span>

<span class="k">def</span> <span class="nf">construct_emulator</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">etype</span><span class="o">=</span><span class="s1">&#39;gpy&#39;</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lengthscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">num_restarts</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fix_hyperparams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_fitted</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise_stdev</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">fix_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix_variance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="k">if</span> <span class="n">ln_ln</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s1">&#39;gpy&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">GPy</span>
        <span class="n">deepGP</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">deepGP</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">deepgp</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="c1">#import ipdb; ipdb.set_trace()</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hidden</span><span class="p">,</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">inits</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PCA&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">kernels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">kernels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">GPy</span><span class="o">.</span><span class="n">kern</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="n">deepgp</span><span class="o">.</span><span class="n">DeepGP</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">X</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                               <span class="n">inits</span><span class="o">=</span><span class="n">inits</span><span class="p">,</span>
                               <span class="n">kernels</span><span class="o">=</span><span class="n">kernels</span><span class="p">,</span> <span class="c1"># the kernels for each layer</span>
                               <span class="n">num_inducing</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">back_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gp</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
                <span class="n">gp</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Gaussian_noise</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">initialize_parameter</span><span class="p">()</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">optimize_restarts</span><span class="p">(</span><span class="n">num_restarts</span> <span class="o">=</span> <span class="n">num_restarts</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            gp = deepgp.DeepGP([np.vstack(values).shape[1] , hidden, coordinates.shape[1]], Y=np.vstack(values), X=coordinates, inits=[&#39;PCA&#39;,&#39;PCA&#39;],</span>
<span class="sd">                               kernels=[GPy.kern.RBF(hidden,ARD=True),</span>
<span class="sd">                                        GPy.kern.RBF(coordinates.shape[1],ARD=True)],</span>
<span class="sd">                               num_inducing=20, back_constraint=False)</span>
<span class="sd">            gp.initialize_parameter()</span>


<span class="sd">            for i in range(len(gp.layers)):</span>
<span class="sd">                #output_var = gp.layers[i].Y.var() if i==0 else gp.layers[i].Y.mean.var()</span>
<span class="sd">                #gp.layers[i].Gaussian_noise.variance = output_var*0.01</span>
<span class="sd">                gp.layers[i].Gaussian_noise.variance.fix(0)</span>
<span class="sd">                gp.layers[i].rbf.lengthscale.unfix()</span>
<span class="sd">            #gp.optimize_restarts(num_restarts = num_restarts)</span>
<span class="sd">            gp.optimize(&#39;bfgs&#39;,messages=True,max_iters=200)</span>

<span class="sd">            for layer in gp.layers:</span>
<span class="sd">                layer.likelihood.variance.constrain_positive(warning=False)</span>
<span class="sd">            gp.optimize(messages=True,max_iters=1000)</span>
<span class="sd">            gp.staged_optimize(messages=(True,True,True))</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">GPy</span><span class="o">.</span><span class="n">kern</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">variance</span><span class="o">=</span><span class="n">variance</span><span class="p">,</span> <span class="n">lengthscale</span><span class="o">=</span><span class="n">lengthscale</span><span class="p">)</span>
            <span class="c1">#kernel = GPy.kern.Poly(coordinates.shape[1], order=1.0)</span>
            <span class="n">vv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_values</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="n">GPy</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GPRegression</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">vv</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fix_hyperparams</span><span class="p">:</span>
                <span class="c1">#fix_noise = np.mean(noise_stdev)</span>
                <span class="k">if</span> <span class="n">fix_noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gp</span><span class="o">.</span><span class="n">Gaussian_noise</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">fix_noise</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fix_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">lengthscale</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">fix_length</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fix_variance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">fix_variance</span><span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="s1">&#39;bfgs&#39;</span><span class="p">,</span><span class="n">messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">optimize_restarts</span><span class="p">(</span><span class="n">num_restarts</span> <span class="o">=</span> <span class="n">num_restarts</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            if fix_hyperparams == True:</span>
<span class="sd">                #lengthscale=2.</span>
<span class="sd">                #variance=238515203.</span>
<span class="sd">                kernel = GPy.kern.RBF(coordinates.shape[1], variance=variance, lengthscale=lengthscale)</span>
<span class="sd">                vv = np.array(_values)[:,None]</span>
<span class="sd">                yerr=np.mean(noise_stdev) #7963.6860#np.mean(noise_stdev)</span>
<span class="sd">                logger.info(&#39;var, lengthscale, noise_std: {}, {}, {}&#39;.format(variance, lengthscale, yerr))</span>
<span class="sd">                gp = GPy.models.GPRegression(coordinates, vv, kernel, noise_var=yerr)</span>
<span class="sd">            &#39;&#39;&#39;</span>
    <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s1">&#39;sklearn&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="k">import</span> <span class="n">GaussianProcessRegressor</span>
        <span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="k">import</span> <span class="n">RBF</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span>
        <span class="c1"># Instantiate a Gaussian Process model</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">))</span>
        <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="n">num_restarts</span><span class="p">)</span>
        <span class="c1"># Fit to data using Maximum Likelihood Estimation of the parameters</span>
        <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">_values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s1">&#39;george&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">george</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span>
        <span class="c1"># Define the objective function (negative log-likelihood in this case).</span>
        <span class="k">def</span> <span class="nf">nll</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">ll</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e25</span>
        <span class="c1"># And the gradient of the objective function.</span>
        <span class="k">def</span> <span class="nf">grad_nll</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">gp</span><span class="o">.</span><span class="n">grad_log_likelihood</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">nll_fixedls</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ls</span><span class="p">):</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">ll</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e25</span>
        <span class="c1"># And the gradient of the objective function.</span>
        <span class="k">def</span> <span class="nf">grad_nll_fixedls</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ls</span><span class="p">):</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">gp</span><span class="o">.</span><span class="n">grad_log_likelihood</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">fix_hyperparams</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">variance</span> <span class="o">*</span> <span class="n">george</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">ExpSquaredKernel</span><span class="p">(</span><span class="n">lengthscale</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="n">george</span><span class="o">.</span><span class="n">GP</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_values</span><span class="p">),</span> <span class="n">fit_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">george</span><span class="o">.</span><span class="n">HODLRSolver</span><span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span><span class="n">noise_stdev</span><span class="p">)</span>
            <span class="c1"># Run the optimization routine.</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">use_fitted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">use_fitted</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                    <span class="n">pminimized</span> <span class="o">=</span> <span class="n">use_fitted</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p0_fixed</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">nll_fixedls</span><span class="p">,</span> <span class="n">p0_fixed</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">grad_nll_fixedls</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">lengthscale</span><span class="p">)</span>
                    <span class="n">pminimized</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">use_fitted</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">gp</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">pminimized</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">nll</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">grad_nll</span><span class="p">)</span>
                <span class="n">gp</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;var, lengthscale: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="k">if</span> <span class="n">fix_hyperparams</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">variance</span> <span class="o">*</span> <span class="n">george</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">ExpSquaredKernel</span><span class="p">(</span><span class="n">lengthscale</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="n">george</span><span class="o">.</span><span class="n">GP</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="n">noise_stdev</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">yerr</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fixing emulator hyperparameters ...&#39;</span><span class="p">)</span>
            <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">variance</span><span class="p">,</span><span class="n">lengthscale</span><span class="p">]</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;var, lengthscale, noise_std: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variance</span><span class="p">,</span> <span class="n">lengthscale</span><span class="p">,</span> <span class="n">noise_stdev</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;emulator type </span><span class="si">{}</span><span class="s1"> not valid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etype</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gp</span>

<span class="k">def</span> <span class="nf">evaluate_emulator</span><span class="p">(</span><span class="n">emulator</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">etype</span><span class="o">=</span><span class="s1">&#39;gpy&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Warning, if ln_ln is use, cov will probably make no sense</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s1">&#39;gpy&#39;</span><span class="p">:</span>
        <span class="n">deepGP</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">deepGP</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="n">evalues</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="n">evalues</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s1">&#39;sklearn&#39;</span><span class="p">:</span>
        <span class="n">evalues</span><span class="p">,</span> <span class="n">cov</span>  <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">return_cov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s1">&#39;george&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
            <span class="n">evalues</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">);</span> <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">evalues</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">return_var</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;emulator type </span><span class="si">{}</span><span class="s1"> not valid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etype</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ln_ln</span><span class="p">:</span> <span class="n">evalues</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">evalues</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">evalues</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">iterative_likelihood_emulator</span><span class="p">(</span><span class="n">lnlike</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_true</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_true_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_scatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lnlike_scatter_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">par_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">nadd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">add_points_method</span><span class="o">=</span><span class="s1">&#39;mcmc&#39;</span><span class="p">,</span> <span class="n">convergence_crit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">mcmc_convergence_crit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">convergence_nmean</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                  <span class="n">mcmc_nwalkers</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">mcmc_nchains</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mcmc_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mcmc_method</span><span class="o">=</span><span class="s1">&#39;emcee&#39;</span><span class="p">,</span> <span class="n">divide_by_multvar_gaussian</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">mcmc_nsteps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">emul_mcmc_nsteps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">mcmc_burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">mcmc_maxrepetitions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mcmc_seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">file</span><span class="o">=</span> <span class="s1">&#39;emulator_data.hdf5&#39;</span><span class="p">,</span> <span class="n">hyperspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">space_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">add_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_likes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lhc_seed</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lhc_spread</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lhc_nbuild</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">gp</span><span class="o">=</span><span class="s1">&#39;george&#39;</span><span class="p">,</span>
                                  <span class="n">gp_variance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gp_lengthscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gp_num_restarts</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">gp_seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gp_realisation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">gp_fix_hyperparams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gp_fix_hyperparams_after_first_iter</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">gp_noise_stdev</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fix_noise</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                  <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name_plots</span><span class="o">=</span><span class="s1">&#39;_iteremulator_&#39;</span><span class="p">,</span> <span class="n">dir_plots</span><span class="o">=</span><span class="s1">&#39;plots/&#39;</span><span class="p">,</span> <span class="n">plot_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_args</span><span class="p">):</span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function emulating the likelihood with gaussian process and suggesting new points with bayesian optimization</span>

<span class="sd">    Summary: This function is the main function to produce the scientific results of arxiv.org/abs/1912.08806. This function accepts the likelihood function and generates a grid of Latin-Hypercube evaluations of it. Then, it interpolates and extrapolates a gaussian process to it. New pointswhere the likelihood function will be computed are then  suggested with a choice of acquisition function to make the gaussian process fit more accurate. </span>

<span class="sd">    Parameters:</span>
<span class="sd">    lnlike: function. ln(Likelihood) to be emulated. Default None.</span>
<span class="sd">    lnlike_true: function. ln(likelihood) without scatter noise if known. Default None.</span>
<span class="sd">    lnlike_args: function arguments. Arguments of lnlike. Default None.</span>
<span class="sd">    lnlike_true_args: function arguments. Arguments of lnlike_true.Default None.</span>
<span class="sd">    lnlike_scatter: function. Function to theoretically compute the scatter in the likelihood (if known). Default None.</span>
<span class="sd">    lnlike_scatter_args: function arguments. Arguments of lnlike_scatter. Default None.</span>
<span class="sd">    ndims: integer. Number of dimensions. Default None.</span>
<span class="sd">    par_names: string array. Parameters names, if None default values will be assigned.</span>
<span class="sd">    ln_ln: Boolean. If True, gaussian emulator uses log(values) for its predictions, else, nothing is changed. Default False.</span>
<span class="sd">    nadd: integer. Number of sampling points to be added at each iteration, default value is 1.</span>
<span class="sd">    add_points_method: string. Method used to find points to add, choose among mcmc (default) and rejsamp.</span>
<span class="sd">    divide_by_multvar_gaussian: boolean. If True a multivariate function is fitted to the input and then, divided by it before emulation. Default False.</span>
<span class="sd">    convergence_crit: float. Convergence criterion for the iterative process, K-L-Divergence &lt; crit , default is 0.1.</span>
<span class="sd">    mcmc_convergence_crit: float. Convergence criterion for the emulated mcmc. Gelman-Rubin criteria by default.</span>
<span class="sd">    convergence_nmean: integer. Last N iteration where the mean for the convergence will be computed , default is 5.</span>
<span class="sd">    max_iter: integer. Maximum number of iterations, default is 100.</span>
<span class="sd">    alpha: float. The sampling points probability is given by L*(1+alpha*deltaL/L) with L being the likelihood, default is 0.,</span>
<span class="sd">    mcmc_nwalkers: integer. Walkers for emcee, default is 12.</span>
<span class="sd">    mcmc_nchains: integer. Number of parallel chains , default is 1.</span>
<span class="sd">    mcmc_bounds: float array. Boundaries of mcmc, default is None.</span>
<span class="sd">    mcmc_method: string. MCMC method, default is &#39;emcee&#39;, &#39;montecarlo&#39; and &#39;metropolis&#39; are options</span>
<span class="sd">    mcmc_nsteps: integer. Number of steps of the heavy (with true likelihood) mcmc. Default is 5000.</span>
<span class="sd">    emul_mcmc_nsteps: integer. Number of steps of the emulated (with interpolated likelihood) mcmc. Default is 5000. </span>
<span class="sd">    mcmc_burnin: integer. MCMC burn-in. Default is 1000</span>
<span class="sd">    mcmc_maxrepetitions: integer. If using emcee, amount of times to recover the computation if the convergence is not achieved. Default is 1</span>
<span class="sd">    mcmc_seeds: integer. Seed of the MCMCs. Default is None.</span>
<span class="sd">    file: string. File to read/save the emulator latin-hypercube and subsequent iterations, default is &#39;emulator_data.hdf5&#39;</span>
<span class="sd">    hyperspace: float array. Boundaries for the emulator, default is mcmc_bounds.</span>
<span class="sd">    space_rotation: boolean. True for rotating and renormalising the emulator hyperspace, default is False</span>
<span class="sd">    add_points: integer. Number of points to be added to the latin hypercube, default is None</span>
<span class="sd">    add_likes: float. Likelihood values to be added to the latin hypercube, if none, they will be computed. Default is None</span>
<span class="sd">    lhc_seed: integer. Latin hypercube seed, default is 5.</span>
<span class="sd">    lhc_spread: boolean. Latin hypercube projected distances between points maximised if True, default is True.</span>
<span class="sd">    lhc_nbuild: integer. Latin hypercube number of sammpling points, default is 30.</span>
<span class="sd">    gp: string. Gaussian process to be used, default is &#39;george&#39;, &#39;sklearn&#39; and &#39;gpy&#39; are options</span>
<span class="sd">    gp_variance:  float. Guess of kernel variance. Default is 1.</span>
<span class="sd">    gp_lengthscale: float. Guess of kernel correlation length. Default is 1.</span>
<span class="sd">    gp_num_restarts : integer. Number of restart of the optimisation of gp, default is 9.</span>
<span class="sd">    gp_seed: integer. Seed for the kernel minimization. Default is 1.</span>
<span class="sd">    gp_realisation: Boolean. If True, not the mean but a random realisation of the emulator will be used, default is False.</span>
<span class="sd">    gp_fix_hyperparams_after_first_iter: string. Fit the hyperparams with the lh, then fix them; choose among none, all, lengthscale.</span>
<span class="sd">    plot: Boolean. If True, it produces plots of each iteration. Default is False.</span>
<span class="sd">    name_plots: string. Name of the plots produced + number of iteration. Default is None.</span>
<span class="sd">    dir_plots: string. Plots directory, default is &#39;plots/&#39;.</span>
<span class="sd">    verbose: boolean. if True, more info is provided. Default is None -&gt; value in the config</span>
<span class="sd">    **plot_args: arguments for the contours plot</span>

<span class="sd">    returns: </span>
<span class="sd">    &#39;sampler&#39;: iterative class, </span>
<span class="sd">    &#39;means&#39;: parameter values, </span>
<span class="sd">    &#39;std&#39;: standard deviations, </span>
<span class="sd">    &#39;convergence&#39;: convergence achieved, </span>
<span class="sd">    &#39;sampler_truth&#39;: true mcmc class (if asked for), </span>
<span class="sd">    &#39;Npoints&#39;: number of points used  </span>

<span class="sd">    example: test_iterative_process.py</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>

    <span class="n">mpi</span> <span class="o">=</span> <span class="n">MPI</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">verbose</span>
    <span class="n">par_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">)]</span> <span class="k">if</span> <span class="n">par_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">par_names</span>
    <span class="n">means_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span>
    <span class="n">stds_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gp_fix_hyperparams_after_first_iter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;lengthscale&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">add_points_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mcmc&#39;</span><span class="p">,</span> <span class="s1">&#39;rejsamp&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">corner</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">dir_plots</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
        <span class="c1">######################running real MCMC chains for comparison ##################</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;true_likelihood_chains_ndims&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">):</span>
            <span class="n">load_backup</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load_backup</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">sttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BOUNDS MCMC:&#39;</span><span class="p">,</span> <span class="n">mcmc_bounds</span><span class="p">)</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;emcee&#39;</span><span class="p">,</span> <span class="n">lnlike</span><span class="o">=</span><span class="n">lnlike_true</span><span class="p">,</span> <span class="n">lnlike_args</span><span class="o">=</span><span class="n">lnlike_true_args</span><span class="p">,</span>
                          <span class="n">nchains</span><span class="o">=</span><span class="n">mcmc_nchains</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">mcmc_bounds</span><span class="p">,</span> <span class="n">par_names</span><span class="o">=</span><span class="n">par_names</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="n">mcmc_nwalkers</span><span class="p">,</span> <span class="n">convergence_crit</span><span class="o">=</span><span class="n">mcmc_convergence_crit</span><span class="p">,</span>
                          <span class="n">backup_fname</span><span class="o">=</span><span class="s1">&#39;true_likelihood_chains_ndims&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndims</span><span class="p">),</span><span class="n">load_backup</span><span class="o">=</span><span class="n">load_backup</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;true_likelihood_chains_ndims&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">):</span>
            <span class="n">sampler</span><span class="o">.</span><span class="n">initialize_run</span><span class="p">(</span><span class="n">lh_spread</span><span class="o">=</span><span class="n">lhc_spread</span><span class="p">)</span>
            <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">nsteps</span><span class="o">=</span><span class="n">mcmc_nsteps</span><span class="p">,</span> <span class="n">maxrepetitions</span><span class="o">=</span><span class="n">mcmc_maxrepetitions</span><span class="p">)</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">get_marginalised_stats</span><span class="p">(</span><span class="n">burnin</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span> <span class="c1">#Taking 1/3 of the chain as burn-in</span>

        <span class="n">lims68_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">1</span><span class="p">]),</span>
                                  <span class="n">sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span>

        <span class="c1">#FOR FIXING THE PRIORS TO THE 4 68% REGION</span>
        <span class="c1">#mcmc_bounds =np.array([[sampler.get_lims68(par=p)[:][0]-4.*(sampler.get_lims68(par=p)[:][0]-sampler.get_lims68(par=p)[:][1]),</span>
        <span class="c1">#                        sampler.get_lims68(par=p)[:][0]+4.*(sampler.get_lims68(par=p)[:][2]-sampler.get_lims68(par=p)[:][0])] for p in par_names])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Length of MCMC chain = &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">)</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mcmc_nwalkers</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ppp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The estimatied boundaries are </span><span class="si">{}</span><span class="s1"> --&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ppp</span><span class="p">],</span> <span class="n">mcmc_bounds</span><span class="p">[</span><span class="n">ppp</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MCMC finished in ---------&gt; </span><span class="si">{}</span><span class="s1"> minutes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">sttime</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        #ONLY FOR 9 DIMS WHEN NOISE IS INCLUDED</span>
<span class="sd">        sampler_noscatter = Sampler(method=&#39;emcee&#39;, lnlike=lnlike_true, lnlike_args=lnlike_true_args,</span>
<span class="sd">                                    nchains=mcmc_nchains, ndims=ndims, bounds=mcmc_bounds, par_names=par_names, nwalkers=mcmc_nwalkers, convergence_crit=mcmc_convergence_crit,</span>
<span class="sd">                                    backup_fname=&#39;true_likelihood_chains_ndims9_noscatter&#39;,load_backup=True)</span>
<span class="sd">        sampler_noscatter.get_marginalised_stats(burnin=int(sampler.chain.shape[1]/3))</span>
<span class="sd">        &#39;&#39;&#39;</span>

    <span class="n">gp_fitted_hp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">start_with_mcmc</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">start_with_mcmc</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">start_mcmc_nsteps</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">start_mcmc_maxrepetitions</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;start_mcmc_bounds_chains_ndims&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">):</span>
            <span class="n">load_backup</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load_backup</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting with short mcmc to reduce the parameter boundaries to more reasonable ones&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The estimation of the boundaries by the mcmc is using </span><span class="si">{}</span><span class="s1"> steps, if you think it is too few, increase start_mcmc_nsteps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_mcmc_nsteps</span><span class="p">))</span>
        <span class="n">start_sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;emcee&#39;</span><span class="p">,</span> <span class="n">lnlike</span><span class="o">=</span><span class="n">lnlike</span><span class="p">,</span> <span class="n">lnlike_args</span><span class="o">=</span><span class="n">lnlike_args</span><span class="p">,</span>
                                <span class="n">nchains</span><span class="o">=</span><span class="n">mcmc_nchains</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">mcmc_bounds</span><span class="p">,</span> <span class="n">par_names</span><span class="o">=</span><span class="n">par_names</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="n">mcmc_nwalkers</span><span class="p">,</span>
                                <span class="n">backup_fname</span><span class="o">=</span><span class="s1">&#39;start_mcmc_bounds_chains_ndims&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndims</span><span class="p">),</span><span class="n">load_backup</span><span class="o">=</span><span class="n">load_backup</span><span class="p">)</span>
        <span class="n">start_sampler</span><span class="o">.</span><span class="n">initialize_run</span><span class="p">(</span><span class="n">lh_spread</span><span class="o">=</span><span class="n">lhc_spread</span><span class="p">)</span>
        <span class="n">start_sampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">nsteps</span><span class="o">=</span><span class="n">start_mcmc_nsteps</span><span class="p">,</span> <span class="n">maxrepetitions</span><span class="o">=</span><span class="n">start_mcmc_maxrepetitions</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="n">mcmc_seeds</span><span class="p">)</span>
        <span class="n">start_sampler</span><span class="o">.</span><span class="n">get_marginalised_stats</span><span class="p">(</span><span class="n">burnin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mcmc_bounds</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">start_sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">3.5</span><span class="o">*</span><span class="p">(</span><span class="n">start_sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">start_sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">1</span><span class="p">]),</span><span class="n">start_sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">3.5</span><span class="o">*</span><span class="p">(</span><span class="n">start_sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">start_sampler</span><span class="o">.</span><span class="n">get_lims68</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">p</span><span class="p">)[:][</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The estimation new boundaries are </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mcmc_bounds</span><span class="p">))</span>

    <span class="n">space_rotation_points</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_KL</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">sttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">itersampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">mcmc_method</span><span class="p">,</span> <span class="n">lnlike</span><span class="o">=</span><span class="n">lnlike</span><span class="p">,</span> <span class="n">lnlike_args</span><span class="o">=</span><span class="n">lnlike_args</span><span class="p">,</span> <span class="n">lnlike_scatter</span><span class="o">=</span><span class="n">lnlike_scatter</span><span class="p">,</span>
                              <span class="n">lnlike_scatter_args</span><span class="o">=</span><span class="n">lnlike_scatter_args</span><span class="p">,</span>
                              <span class="n">nchains</span><span class="o">=</span><span class="n">mcmc_nchains</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mcmc_bounds</span><span class="p">),</span>
                              <span class="n">par_names</span><span class="o">=</span><span class="n">par_names</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="n">mcmc_nwalkers</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">itersampler</span><span class="o">.</span><span class="n">emulate_likelihood</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">hyperspace</span><span class="o">=</span><span class="n">hyperspace</span><span class="p">,</span> <span class="n">space_rotation</span><span class="o">=</span><span class="n">space_rotation</span><span class="p">,</span> <span class="n">space_rotation_points</span><span class="o">=</span><span class="n">space_rotation_points</span><span class="p">,</span>
                                       <span class="n">divide_by_multvar_gaussian</span><span class="o">=</span><span class="n">divide_by_multvar_gaussian</span><span class="p">,</span>
                                       <span class="n">add_points</span><span class="o">=</span><span class="n">add_points</span><span class="p">,</span> <span class="n">add_likes</span><span class="o">=</span><span class="n">add_likes</span><span class="p">,</span> <span class="n">lhc_seed</span><span class="o">=</span><span class="n">lhc_seed</span><span class="p">,</span>
                                       <span class="n">lhc_spread</span><span class="o">=</span><span class="n">lhc_spread</span><span class="p">,</span> <span class="n">lhc_nbuild</span><span class="o">=</span><span class="n">lhc_nbuild</span><span class="p">,</span> <span class="n">gp</span><span class="o">=</span><span class="n">gp</span><span class="p">,</span>
                                       <span class="n">gp_variance</span><span class="o">=</span><span class="n">gp_variance</span><span class="p">,</span> <span class="n">gp_lengthscale</span><span class="o">=</span><span class="n">gp_lengthscale</span><span class="p">,</span>
                                       <span class="n">gp_num_restarts</span> <span class="o">=</span> <span class="n">gp_num_restarts</span><span class="p">,</span> <span class="n">gp_seed</span><span class="o">=</span><span class="n">gp_seed</span><span class="p">,</span> <span class="n">gp_realisation</span> <span class="o">=</span> <span class="n">gp_realisation</span><span class="p">,</span>
                                       <span class="n">gp_fix_hyperparams</span><span class="o">=</span><span class="n">gp_fix_hyperparams</span><span class="p">,</span> <span class="n">use_fitted</span><span class="o">=</span><span class="n">gp_fitted_hp</span><span class="p">,</span> <span class="n">gp_noise_stdev</span><span class="o">=</span><span class="n">gp_noise_stdev</span><span class="p">,</span> <span class="n">fix_noise</span><span class="o">=</span><span class="n">fix_noise</span><span class="p">,</span> <span class="n">ln_ln</span><span class="o">=</span><span class="n">ln_ln</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gp_fix_hyperparams_after_first_iter</span> <span class="o">==</span> <span class="s1">&#39;lengthscale&#39;</span><span class="p">:</span>
            <span class="n">gp_fitted_hp</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">gp_lengthscale</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">gp_fix_hyperparams_after_first_iter</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">gp_fitted_hp</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()</span>
            <span class="n">gp_variance</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">gp_lengthscale</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">gp_noise_stdev</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">add_points_method</span><span class="o">==</span><span class="s1">&#39;mcmc&#39;</span> <span class="ow">or</span> <span class="n">ii</span><span class="o">==</span><span class="n">max_iter</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span>

            <span class="n">itersampler</span><span class="o">.</span><span class="n">initialize_run</span><span class="p">(</span><span class="n">lh_spread</span><span class="o">=</span><span class="n">lhc_spread</span><span class="p">,</span> <span class="n">initguess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;lhc_ndims&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_nbuild_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lhc_nbuild</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">{}</span><span class="s1"> for emulating likelihood...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
            <span class="n">itersampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">nsteps</span><span class="o">=</span><span class="n">emul_mcmc_nsteps</span><span class="p">,</span> <span class="n">maxrepetitions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="n">mcmc_seeds</span><span class="p">)</span>
            <span class="n">itersampler</span><span class="o">.</span><span class="n">get_marginalised_stats</span><span class="p">(</span><span class="n">burnin</span><span class="o">=</span><span class="n">mcmc_burnin</span><span class="p">)</span>

            <span class="n">space_rotation_points</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#copy.deepcopy(itersampler.mergedchains)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">plot</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;Plot_step&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;STARTING MAKING THE PLOT...&#39;</span><span class="p">)</span>

                <span class="kn">import</span> <span class="nn">chainconsumer</span> <span class="k">as</span> <span class="nn">CC</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">ChainConsumer</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">ndims</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
                        <span class="c1">#fig = sampler.plot_mcmc_contours(fix_bounds=True,</span>
                        <span class="c1">#                                 show_plot=False, save_plot=False,</span>
                        <span class="c1">#                                 name=par_names,</span>
                        <span class="c1">#                                 color=&#39;black&#39;, levels=None, ranges=None, smooth=False)</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PLOTTING TRUE LIKELIHOOD...&#39;</span><span class="p">)</span>
                        <span class="c1">#fig = corner.corner(sampler.mergedchains, labels=par_names, color=&#39;black&#39;, **plot_args)</span>
                        <span class="n">c2</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">par_names</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MCMC&quot;</span><span class="p">)</span>
                       
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PLOTTING EMULATED LIKELIHOOD...&#39;</span><span class="p">)</span>
                    <span class="c1">#fig_it = corner.corner(itersampler.mergedchains, labels=par_names, fig=fig, color=&#39;red&#39;, **plot_args)</span>
                    <span class="n">c2</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">par_names</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Iterative&quot;</span><span class="p">)</span>
                    <span class="n">c2</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">label_font_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">tick_font_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;frameon&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">legend_location</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">diagonal_tick_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">fig_it</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">15.</span><span class="p">,</span><span class="mf">15.</span><span class="p">))</span>
                    
                    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    ###########################TEST FOR ROTATION #############################################################################</span>
<span class="sd">                    from scipy import linalg</span>
<span class="sd">                    rot_cov = np.cov(itersampler.mergedchains.T)</span>
<span class="sd">                    ww, RR = linalg.eig(rot_cov)</span>
<span class="sd">                    xR = np.dot(RR.T,itersampler.mergedchains.T).T</span>
<span class="sd">                    xR = xR - np.mean(xR,axis=0)</span>
<span class="sd">                    xR = xR/np.std(xR, 0)</span>
<span class="sd">                    import ipdb; ipdb.set_trace()</span>
<span class="sd">                    fig_it = corner.corner(xR, labels=par_names, fig=fig, color=&#39;red&#39;)</span>
<span class="sd">                    ##########################################################################################################################</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ndims</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
                            <span class="n">fig_it</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()[</span><span class="n">jj</span><span class="o">*</span><span class="n">ndims</span><span class="o">+</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par_names</span><span class="p">[</span><span class="n">jj</span><span class="p">]],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                        <span class="n">fig_it</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()[</span><span class="n">jj</span><span class="o">*</span><span class="n">ndims</span><span class="o">+</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par_names</span><span class="p">[</span><span class="n">jj</span><span class="p">]],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

                    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fig_it</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ndims</span><span class="p">,</span> <span class="n">ndims</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yi</span><span class="p">):</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="n">xi</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">15.</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">add_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PLOTTING ADDED POINTS...&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">add_points</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span>
                                <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yi</span><span class="p">):</span>
                                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
                                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="n">xi</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tomato&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>


                        <span class="k">if</span> <span class="n">divide_by_multvar_gaussian</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Multiplying by multivariate Gaussian fit...&#39;</span><span class="p">)</span>
                            <span class="n">pred</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">transform_coordinates</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">),</span> <span class="n">gp</span><span class="p">,</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">)</span>
                            <span class="n">loglike_multvar_gauss</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">compute_multvar_gauss_fit</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">)</span>
                            <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">*</span><span class="n">itersampler</span><span class="o">.</span><span class="n">Amp_mulvar_gauss_fit</span><span class="o">*</span><span class="n">loglike_multvar_gauss</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;FINISHED MAKING THE PLOT...&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig_it</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">))</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">sampler</span><span class="o">.</span><span class="n">merged_lnlike</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">itersampler</span><span class="o">.</span><span class="n">merged_lnlike</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;emulated&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="c1">#plt.plot(itersampler.emulator_lhc_points, itersampler.emulator_lhc_lnlike, ls=&#39;&#39;, marker=&#39;s&#39;,c=&#39;black&#39;,label=&#39;old points&#39;)</span>
                    <span class="c1">#add_points new points</span>
                    <span class="c1">#itersampler.emulator_lhc_lnlike loglike points</span>
                    <span class="k">if</span> <span class="n">add_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">renorm_points</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">transform_coordinates</span><span class="p">(</span><span class="n">add_points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ndims</span><span class="p">))</span>
                        <span class="c1">#import ipdb; ipdb.set_trace()</span>
                        <span class="n">add_lnlike</span><span class="o">=</span><span class="n">evaluate_emulator</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">renorm_points</span><span class="p">,</span> <span class="n">etype</span><span class="o">=</span> <span class="n">gp</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">divide_by_multvar_gaussian</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Multiplying by multivariate Gaussian fit...&#39;</span><span class="p">)</span>
                            <span class="n">loglike_multvar_gauss</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">compute_multvar_gauss_fit</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">)</span>
                            <span class="n">add_lnlike</span> <span class="o">=</span> <span class="n">add_lnlike</span><span class="o">*</span><span class="n">itersampler</span><span class="o">.</span><span class="n">Amp_mulvar_gauss_fit</span><span class="o">*</span><span class="n">loglike_multvar_gauss</span>

                        <span class="n">renorm_points_emul</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">transform_coordinates</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ndims</span><span class="p">)))</span>
                        <span class="n">add_lnlike_emul</span><span class="p">,</span> <span class="n">var_emul</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">renorm_points_emul</span><span class="p">),</span><span class="n">etype</span><span class="o">=</span><span class="n">gp</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">,</span><span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ln_ln</span><span class="o">=</span><span class="n">ln_ln</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">divide_by_multvar_gaussian</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Multiplying by multivariate Gaussian fit...&#39;</span><span class="p">)</span>
                            <span class="n">loglike_multvar_gauss</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">compute_multvar_gauss_fit</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">)</span>
                            <span class="n">add_lnlike_emul</span> <span class="o">=</span> <span class="n">add_lnlike_emul</span><span class="o">*</span><span class="n">itersampler</span><span class="o">.</span><span class="n">Amp_mulvar_gauss_fit</span><span class="o">*</span><span class="n">loglike_multvar_gauss</span>


                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">add_points</span><span class="p">,</span><span class="n">add_lnlike</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;new points&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span><span class="n">add_lnlike_emul</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_emul</span><span class="p">)</span> <span class="p">,</span><span class="n">add_lnlike_emul</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_emul</span><span class="p">)</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                #FOR MAKING 2D PLOTS IN A SEQUENCE WAY </span>
<span class="sd">                import matplotlib.gridspec as gridspec</span>
<span class="sd">                gs = gridspec.GridSpec(3,2,hspace=0.3, width_ratios=[2.5,5])</span>
<span class="sd">                axes[1,0].set_position(gs[0,0].get_position(fig_it))</span>
<span class="sd">                axes[1,0].set_ylim(mcmc_bounds[1])</span>
<span class="sd">                axes[1,0].set_xlim(mcmc_bounds[0])</span>
<span class="sd">                axes[0,0].set_position(gs[1,0].get_position(fig_it))</span>
<span class="sd">                axes[0,0].set_xlim(mcmc_bounds[0])</span>
<span class="sd">                axes[1,1].set_position(gs[2,0].get_position(fig_it))</span>
<span class="sd">                axes[1,1].set_xlim(mcmc_bounds[1])</span>
<span class="sd">                fig_it.set_size_inches(11, 11)</span>
<span class="sd">                axes[1,0].set_xlabel(par_names[0],fontsize=25)</span>
<span class="sd">                axes[1,0].set_ylabel(par_names[1],fontsize=25)</span>
<span class="sd">                axes[0,0].set_xlabel(par_names[0],fontsize=25,labelpad=10.2)</span>
<span class="sd">                axes[1,1].set_xlabel(par_names[1],fontsize=25,labelpad=10.2)</span>
<span class="sd">                axes[0,0].xaxis.set_major_locator(plt.MultipleLocator(0.001))</span>
<span class="sd">                axes[0,0].yaxis.set_major_locator(plt.MultipleLocator(200.))</span>
<span class="sd">                axes[1,1].yaxis.set_major_locator(plt.MultipleLocator(40.))</span>
<span class="sd">                axes[0,0].tick_params(axis=&#39;x&#39;, which=&#39;both&#39;, labelbottom=False, bottom=False, labelsize=20)</span>
<span class="sd">                axes[0,0].tick_params(axis=&#39;y&#39;, which=&#39;both&#39;, labelleft=False, left=False, labelsize=20)</span>
<span class="sd">                axes[1,1].tick_params(axis=&#39;y&#39;, which=&#39;both&#39;, labelleft=False, left=False, labelsize=20)</span>
<span class="sd">                axes[1,1].tick_params(axis=&#39;x&#39;, which=&#39;both&#39;, labelbottom=False, bottom=False, labelsize=20)</span>
<span class="sd">                axes[0,0].set_aspect(&#39;auto&#39;)</span>
<span class="sd">                axes[1,0].set_aspect(&#39;auto&#39;)</span>
<span class="sd">                axes[1,1].set_aspect(&#39;auto&#39;)</span>
<span class="sd">                axes[1,0].set_title(&#39;Iteration {}: Npoints={}&#39;.format(ii,len(itersampler.emulator_lhc_points)), size=30)</span>
<span class="sd">                fig_it.savefig(dir_plots+name_plots+&#39;ndims_{}_iter_{}.pdf&#39;.format(ndims,ii))</span>
<span class="sd">                os.system(&#39;pdfcrop &#39;+dir_plots+name_plots+&#39;ndims_{}_iter_{}.pdf&#39;.format(ndims,ii)+&#39; &#39;+dir_plots+name_plots+&#39;ndims_{}_iter_{}.pdf&#39;.format(ndims,ii))</span>
<span class="sd">                #import ipdb; ipdb.set_trace()</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="n">fig_it</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">{}</span><span class="s1">: Npoints=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">)),</span> <span class="n">size</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
                <span class="n">fig_it</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">dir_plots</span><span class="o">+</span><span class="n">name_plots</span><span class="o">+</span><span class="s1">&#39;ndims_</span><span class="si">{}</span><span class="s1">_iter_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndims</span><span class="p">,</span><span class="n">ii</span><span class="p">))</span>
                <span class="c1">#plt.show()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">mergedchains</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">add_points</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1">#add_likes = None</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mergedchains</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">mergedchains</span>
                <span class="c1">#mergedchains =comm.bcast(mergedchains, root=0)</span>
                <span class="n">effect_nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mergedchains</span><span class="p">)</span>
                <span class="n">acquisition_is_likelihood</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">acquisition_is_sigma_level</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">acquisition_is_likelihood</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Acquisition function is the likelihood...&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">alpha</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
                        <span class="n">traspoints</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">transform_coordinates</span><span class="p">(</span><span class="n">mergedchains</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ndims</span><span class="p">))</span>
                        <span class="n">pred</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">traspoints</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="n">ln_ln</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pred</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                            <span class="n">ww</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">effect_nsteps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">var_LN</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pred</span><span class="o">+</span><span class="n">var</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">var_LN</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                <span class="n">ww</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">effect_nsteps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ww</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_LN</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="c1">#1. + alpha*np.sqrt(var)/np.abs(pred)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">ww</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">effect_nsteps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">ww</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">ww</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">divide_by_multvar_gaussian</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Multiplying by multivariate Gaussian fit...&#39;</span><span class="p">)</span>
                        <span class="n">loglike_multvar_gauss</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">compute_multvar_gauss_fit</span><span class="p">(</span><span class="n">traspoints</span><span class="p">)</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">*</span><span class="n">itersampler</span><span class="o">.</span><span class="n">Amp_mulvar_gauss_fit</span><span class="o">*</span><span class="n">loglike_multvar_gauss</span>
                    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                if acquisition_is_sigma_level:</span>
<span class="sd">                    if verbose: logger.info(&#39;Acquisition function is the cumulative distribution function...&#39;)</span>
<span class="sd">                    import ipdb; ipdb.set_trace()</span>
<span class="sd">                    #ww = sigma_levels(mergedchains.reshape(-1,ndims), itersampler, gp, ndims, ln_ln)</span>
<span class="sd">                    points_ran = np.random.random(size=(1000*nadd*ndims,ndims))</span>
<span class="sd">                    #Recall to change from range [old_min,old_max] to [new_min, new_max] the linear transf is:</span>
<span class="sd">                    #new_value = ( (old_value - old_min) / (old_max - old_min) ) * (new_max - new_min) + new_min</span>
<span class="sd">                    points_ran = points_ran*(mcmc_bounds[:,1]-mcmc_bounds[:,0])+mcmc_bounds[:,0]</span>
<span class="sd">                    ww = sigma_levels(points_ran, itersampler, gp, ndims, ln_ln)</span>
<span class="sd">                    weights = ww/np.max(ww)</span>
<span class="sd">                    mask = np.random.choice(points_ran.shape[0], nadd, p=weights/np.sum(weights), replace=False)</span>
<span class="sd">                    add_points = points_ran[mask]</span>
<span class="sd">                import ipdb; ipdb.set_trace()</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                <span class="k">if</span> <span class="n">acquisition_is_sigma_level</span><span class="p">:</span>
                    <span class="n">ww</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">sigma_levels</span><span class="p">(</span><span class="n">mergedchains</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ndims</span><span class="p">),</span> <span class="n">itersampler</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">ln_ln</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="p">:</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="n">ww</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">ww</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="n">ww</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">ww</span><span class="p">)</span><span class="o">*</span><span class="n">var</span><span class="o">/</span><span class="n">pred</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pred</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hey you just divided by zero, you can check your prediction here:&#39;</span><span class="p">)</span>
                            <span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span> 
 

                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">effect_nsteps</span><span class="p">,</span> <span class="n">nadd</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">weights</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">add_points</span> <span class="o">=</span> <span class="n">mergedchains</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">means_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span>
                    <span class="n">stds_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span>
                    <span class="n">lims68_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">means_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">means_vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span> <span class="p">))</span>
                    <span class="n">stds_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">stds_vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span> <span class="p">))</span>
                    <span class="n">lims68_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span> <span class="n">lims68_iter</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lims68</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span> <span class="p">))</span>

                <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;=</span> <span class="n">convergence_nmean</span><span class="p">:</span>
                    <span class="c1">#Old convergence criteria</span>
                    <span class="c1">#converge = np.std(np.mean(means_vec,axis=1)[-convergence_nmean:]) / np.mean(np.mean(stds_vec,axis=1)[-convergence_nmean:])</span>
                    <span class="n">converge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">means_vec</span><span class="p">[</span><span class="o">-</span><span class="n">convergence_nmean</span><span class="p">:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stds_vec</span><span class="p">[</span><span class="o">-</span><span class="n">convergence_nmean</span><span class="p">:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">converge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">converge</span><span class="p">)</span>
                    <span class="c1"># Use Kullback-Leibler divergence as your convergence test</span>
                    <span class="n">use_KL</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">use_KL</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using Kullback-Leibler divergence as convergence test...&#39;</span><span class="p">)</span>
                        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                        KL_fname = &#39;Emulator_for_Kullback-Leibler_conv.txt&#39;</span>
<span class="sd">                        if os.path.exists(KL_fname):</span>
<span class="sd">                            xx = np.loadtxt(KL_fname, usecols=(1,2,3,4,5,6,7,8,9))</span>
<span class="sd">                            #xx = np.loadtxt(KL_fname, usecols=(1,))</span>
<span class="sd">                            pred_KL_prev = np.loadtxt(KL_fname, usecols=(0,))</span>

<span class="sd">                        else:</span>
<span class="sd">                            xx = itersampler.transform_coordinates(np.random.uniform(low=mcmc_bounds[:,0], high=mcmc_bounds[:,1],size=(100, ndims)))</span>

<span class="sd">                        pred_KL, var_KL = evaluate_emulator(itersampler.lnlike_emulator, xx.reshape(-1,ndims), gp, itersampler.emulator_lhc_lnlike, ln_ln = ln_ln)</span>
<span class="sd">                        if os.path.exists(KL_fname):</span>
<span class="sd">                            converge = scipy.stats.entropy(pred_KL,pred_KL_prev)</span>

<span class="sd">                            with open(&quot;Convergence.txt&quot;, &quot;a&quot;) as myfile:</span>
<span class="sd">                                myfile.write(&#39;%.10f\t&#39;%converge)</span>
<span class="sd">                                myfile.write(&#39;\n&#39;)</span>
<span class="sd">                        np.savetxt(KL_fname,np.append(np.vstack(pred_KL),xx.reshape(-1,ndims),axis=1))</span>
<span class="sd">                        &#39;&#39;&#39;</span>
                        <span class="n">mean_emul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">])</span> <span class="c1">#np.mean(itersampler.mergedchains,axis=0)</span>
                        <span class="n">cov_emul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">mergedchains</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                        <span class="n">mean_emul_prev_fname</span> <span class="o">=</span> <span class="s1">&#39;Mean_for_Kullback-Liebler_conv.txt&#39;</span>
                        <span class="n">cov_emul_prev_fname</span> <span class="o">=</span> <span class="s1">&#39;Cov_for_Kullback-Leibler_conv.txt&#39;</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mean_emul_prev_fname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cov_emul_prev_fname</span><span class="p">):</span>
                            <span class="n">mean_emul_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mean_emul_prev_fname</span><span class="p">)</span> <span class="c1">#mean_emul #np.mean(sampler.mergedchains,axis=0)</span>
                            <span class="n">cov_emul_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">cov_emul_prev_fname</span><span class="p">)</span> <span class="c1">#cov_emul #np.cov(sampler.mergedchains.T)</span>
                            <span class="n">first_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_emul</span><span class="p">),</span><span class="n">cov_emul_prev</span><span class="p">))</span>
                            <span class="n">second_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mean_emul</span><span class="o">-</span><span class="n">mean_emul_prev</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_emul</span><span class="p">),</span> <span class="n">mean_emul</span><span class="o">-</span><span class="n">mean_emul_prev</span><span class="p">))</span>
                            <span class="n">third_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cov_emul</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cov_emul_prev</span><span class="p">))</span>
                            <span class="n">converge</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">first_term</span> <span class="o">+</span> <span class="n">second_term</span> <span class="o">-</span> <span class="n">ndims</span> <span class="o">+</span> <span class="n">third_term</span><span class="p">)</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Convergence_Kullback_Liebler_ndims&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
                                <span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">converge</span><span class="p">,</span><span class="n">first_term</span><span class="p">,</span><span class="n">second_term</span><span class="p">,</span><span class="n">third_term</span><span class="p">))</span>

                        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">mean_emul_prev_fname</span><span class="p">,</span><span class="n">mean_emul</span><span class="p">)</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">cov_emul_prev_fname</span><span class="p">,</span><span class="n">cov_emul</span><span class="p">)</span>

                    <span class="n">conv_vec</span> <span class="o">=</span> <span class="n">converge</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="n">convergence_nmean</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">conv_vec</span><span class="p">,</span> <span class="n">converge</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Convergence Value = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">converge</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">converge</span> <span class="o">&lt;</span> <span class="n">convergence_crit</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Attention, not enough points to compute converegence, setting it to zero!&#39;</span><span class="p">)</span>
                    <span class="n">conv_vec</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">{}</span><span class="s1"> finished in ---------&gt; </span><span class="si">{}</span><span class="s1"> minutes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">,(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">sttime</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>

            <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sampler&#39;</span><span class="p">:</span> <span class="n">itersampler</span><span class="p">,</span> <span class="s1">&#39;means&#39;</span><span class="p">:</span> <span class="n">means_vec</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">stds_vec</span><span class="p">,</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">conv_vec</span><span class="p">),</span> <span class="s1">&#39;Npoints&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">)</span> <span class="p">}</span>
            <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
                <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sampler&#39;</span><span class="p">:</span> <span class="n">itersampler</span><span class="p">,</span> <span class="s1">&#39;means&#39;</span><span class="p">:</span> <span class="n">means_vec</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">stds_vec</span><span class="p">,</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">conv_vec</span><span class="p">),</span> <span class="s1">&#39;sampler_truth&#39;</span><span class="p">:</span> <span class="n">sampler</span><span class="p">,</span>
                               <span class="s1">&#39;Npoints&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_points</span><span class="p">),</span> <span class="s1">&#39;lims68_iter&#39;</span><span class="p">:</span> <span class="n">lims68_iter</span><span class="p">,</span> <span class="s1">&#39;lims68_truth&#39;</span><span class="p">:</span> <span class="n">lims68_truth</span><span class="p">,</span> <span class="s1">&#39;mcmc_true_bounds&#39;</span> <span class="p">:</span> <span class="n">mcmc_bounds</span>  <span class="p">}</span>
            <span class="n">add_points</span> <span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">add_points</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">{}</span><span class="s1"> for emulating likelihood...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#acquisition_args = (itersampler, gp)</span>
                <span class="c1">#add_points = utils.rejection_sampling(acquisition_function, nadd, bounds, max_iter=100, func_args=acquisition_args)</span>
                <span class="n">acquisition_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">itersampler</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">ln_ln</span><span class="p">)</span>
                <span class="n">add_points</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">rejection_sampling</span><span class="p">(</span><span class="n">sigma_levels</span><span class="p">,</span> <span class="n">nadd</span><span class="p">,</span> <span class="n">mcmc_bounds</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">90000</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="n">acquisition_args</span><span class="p">)</span>

            <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sampler&#39;</span><span class="p">:</span> <span class="n">itersampler</span><span class="p">}</span>
            <span class="n">add_points</span> <span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">add_points</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#mask2 = np.argpartition(itersampler.emulator_lhc_lnlike.squeeze(),-mcmc_nchains*mcmc_nwalkers)[-mcmc_nchains*mcmc_nwalkers:]</span>
        <span class="c1">#initguess = itersampler.emulator_lhc_points[mask2]</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    if plot:</span>
<span class="sd">        try:</span>
<span class="sd">            import imageio</span>
<span class="sd">            images=[imageio.imread(dir_plots+name_plots+&#39;iter_{}.png&#39;.format(i)) for i in range(ii+1)]</span>
<span class="sd">            imageio.mimsave(dir_plots + name_plots + &#39;.gif&#39;, images,duration=2.2)</span>
<span class="sd">        except:</span>
<span class="sd">            logger.info(&#39;If you want to create a GIF, please install imageio (pip install imageio)&#39;)</span>
<span class="sd">        for i in range(ii+1): os.system(&#39;rm {}iter_{}.png&#39;.format(dir_plots+name_plots,i))</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#return {&#39;sampler&#39;: itersampler, &#39;means&#39;: means_vec, &#39;std&#39;: stds_vec, &#39;convergence&#39;: np.atleast_1d(conv_vec) }</span>
    <span class="k">return</span> <span class="n">dictionary</span>

<span class="k">def</span> <span class="nf">acquisition_function</span><span class="p">(</span><span class="n">point</span><span class="p">,</span><span class="n">itersampler</span><span class="p">,</span> <span class="n">gp</span><span class="p">):</span>
    <span class="n">f_min</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">))</span>
    <span class="n">pred_lhc</span><span class="p">,</span> <span class="n">var_lhc</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">transform_coordinates</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">point</span><span class="p">])),</span> <span class="n">gp</span><span class="p">,</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_lhc</span><span class="p">)</span>
    <span class="n">chi_lhc</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_min</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pred_lhc</span><span class="p">))</span> <span class="o">/</span> <span class="n">std</span>
    <span class="n">Phi_lhc</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">chi_lhc</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">phi_lhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">chi_lhc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">var_lhc</span><span class="p">)</span>
    <span class="n">A_ei_lhc</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_min</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pred_lhc</span><span class="p">))</span> <span class="o">*</span> <span class="n">Phi_lhc</span> <span class="o">+</span> <span class="n">var_lhc</span> <span class="o">*</span> <span class="n">phi_lhc</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">A_ei_lhc</span>


<span class="k">def</span> <span class="nf">sigma_levels</span><span class="p">(</span><span class="n">_xx</span><span class="p">,</span> <span class="n">itersampler</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">ln_ln</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
    <span class="c1">#gg = stats.multivariate_normal(np.zeros(ndims), np.identity(ndims))</span>
    <span class="c1">#mu = 1.0-gg.cdf(np.full(ndims,0.99))</span>
    <span class="c1">#mu = 1.0-gg.cdf(np.full(ndims,0.68))</span>
    <span class="c1">#mu=0.2</span>
    <span class="n">transpoints</span> <span class="o">=</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">transform_coordinates</span><span class="p">(</span><span class="n">_xx</span><span class="p">)</span>
    <span class="n">pred</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="n">itersampler</span><span class="o">.</span><span class="n">lnlike_emulator</span><span class="p">,</span> <span class="n">transpoints</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">itersampler</span><span class="o">.</span><span class="n">emulator_lhc_lnlike</span><span class="p">,</span> <span class="n">ln_ln</span> <span class="o">=</span> <span class="n">ln_ln</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="c1"># In 1D for standard normal</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.99</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">((</span><span class="n">mu</span><span class="o">-</span><span class="n">pred</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">var</span><span class="p">)),</span> <span class="n">pred</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lognormpdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">S</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">linalg</span>
    <span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
    <span class="sd">&quot;&quot;&quot; Calculate gaussian probability density of x, when x ~ N(mu,sigma) &quot;&quot;&quot;</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="n">norm_coeff</span> <span class="o">=</span> <span class="n">nx</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">S</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">mu</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">S</span><span class="p">)):</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">spln</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">norm_coeff</span><span class="o">+</span><span class="n">numerator</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">norm_pdf_multivariate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;The covariance matrix can&#39;t be singular&quot;</span><span class="p">)</span>

        <span class="n">norm_const</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">det</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">x_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_mu</span> <span class="o">*</span> <span class="n">inv</span> <span class="o">*</span> <span class="n">x_mu</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">norm_const</span> <span class="o">*</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;The dimensions of the input don&#39;t match&quot;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Raul E. Angulo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>