

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bacco.cosmology &mdash; bacco 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> bacco
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bacco</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bacco.cosmology</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bacco.cosmology</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of the &#39;Cosmology&#39; class and helper functions</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">)</span>

<span class="c1">##__all__ = [&quot;Cosmology&quot;]</span>

<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">integrate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">special</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">do_profile</span><span class="p">,</span> <span class="n">pk2xi</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;bacco.cosmo&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">basestring</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span>


<span class="c1"># We now define and implement the cosmology class∆íget</span>
<div class="viewcode-block" id="Cosmology"><a class="viewcode-back" href="../../code.html#bacco.Cosmology">[docs]</a><span class="k">class</span> <span class="nc">Cosmology</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that implements a cosmological model</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hubble</span><span class="o">=</span><span class="mf">0.73</span><span class="p">,</span> <span class="n">omega_cdm</span><span class="o">=</span><span class="mf">0.205</span><span class="p">,</span> <span class="n">omega_baryon</span><span class="o">=</span><span class="mf">0.045</span><span class="p">,</span> <span class="n">omega_de</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">omega_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="n">use_radiation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">neutrino_mass</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma8</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="mf">0.9611</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.0952</span><span class="p">,</span> <span class="n">de_model</span><span class="o">=</span><span class="s1">&#39;LCDM&#39;</span><span class="p">,</span>
                 <span class="n">w0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DeltaNeff</span><span class="o">=</span><span class="mf">3.046</span><span class="p">,</span> <span class="n">approx_nu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ReNormalizeInputSpectrum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">pkfile_expfactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pkfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_growth_expfac</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">mDM</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param hubble: Hubble parameter in units of 100 kms/sec/Mpc</span>
<span class="sd">        :omega_*     : Density of each component in units of the critial density</span>
<span class="sd">        :param de_model: Dark Energy model. Valid options are &#39;LCDM&#39;(default),&#39;w0wa&#39;,&#39;w0wa_steigerwald&#39;,</span>
<span class="sd">                         a callable function or file name</span>
<span class="sd">        :param pkfile: File name with the linear-theory power spectrum in units of h/Mpc.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">=</span> <span class="n">expfactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Normalization</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ReNormalizeInputSpectrum</span> <span class="o">=</span> <span class="n">ReNormalizeInputSpectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_radiation</span> <span class="o">=</span> <span class="n">use_radiation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_growth_expfac</span> <span class="o">=</span> <span class="n">initial_growth_expfac</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;Default&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tag</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising &#39;</span><span class="si">{0}</span><span class="s2">&#39; at z=</span><span class="si">{1:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Storing cosmological parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hubble</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_s</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">A_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">A_s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">A_s</span><span class="p">)</span> <span class="c1">#logarithmic pass of A_s</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omega_baryon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omega_cdm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span>

        <span class="c1"># Let&#39;s implement a degenerate case for neutrinos</span>
        <span class="c1"># If approx_nu is True, neutrinos are always treated as nonrelativistic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;approx_nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">approx_nu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">neutrino_mass</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutrino_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Neffective&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.046</span>  <span class="c1"># - self.num_massive_neutrinos</span>
        <span class="c1"># DeltaNeff is the effective number of relativistic neutrino</span>
        <span class="c1"># species at late times. With no massive neutrinos it is the usual</span>
        <span class="c1"># 3.046. For respectively 1, 2 or 3 massive neutrinos it is</span>
        <span class="c1"># 2.0328, 1.0196 and 0.00641 (if your temperature to mass ratio is</span>
        <span class="c1"># fudged to have m_nu/(Omega_nu h^2) = 93.14)</span>
        <span class="n">DeltaNeffTab</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">3.046</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">2.0328</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">1.0196</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.00641</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DeltaNeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeltaNeffTab</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]]</span>
        <span class="c1"># The neutrino to photon temperature GammaNu</span>
        <span class="c1"># This value is the computed accounting for non-instantaneous neutrino</span>
        <span class="c1"># decoupling and spectral distortions induced by the reheating due to</span>
        <span class="c1"># e+/- anihilation (see Mangano et al 2005 for details)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GammaNu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.71611</span>

        <span class="c1"># Converting neutrino masses to density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">93.14</span> <span class="o">/</span> <span class="n">hubble</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_radiation</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># A couple of parameters related to radiation</span>
            <span class="c1"># For now, this is hard-coded</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;photon_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.7255</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_photons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.472183911270666e-05</span> <span class="o">/</span> <span class="n">hubble</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#2.472183911270666e-05 value of L-Gadget3, this make a perfect omega_k = 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_photons&#39;</span><span class="p">]</span> <span class="o">*</span>
                                      <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DeltaNeff&#39;</span><span class="p">]</span> <span class="o">*</span>
                                       <span class="p">(</span><span class="mf">7.0</span><span class="o">/</span><span class="mf">8.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)))</span>
            <span class="c1">#WARNING TODO This value of omega_rad only valid for kspace_neutrino</span>
            <span class="c1"># self.pars[&#39;omega_rad&#39;] = (self.pars[&#39;omega_photons&#39;] *</span>
            <span class="c1">#                          ((self.pars[&#39;Neffective&#39;]-self.pars[&#39;num_massive_neutrinos&#39;]) *</span>
            <span class="c1">#                          (7.0/8.0) * (4.0/11.0)**(4.0/3.0)))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;photon_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.7255</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_photons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">=</span> <span class="n">de_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;boltzmann_solver&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pkfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pkfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkfile_expfactor</span> <span class="o">=</span> <span class="n">pkfile_expfactor</span>

        <span class="k">if</span> <span class="n">omega_de</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">omega_k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must provide either omega_de or omega_k for non-flat cosmologies!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omega_k</span> <span class="k">if</span> <span class="n">omega_k</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">omega_de</span>
                                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omega_de</span> <span class="k">if</span> <span class="n">omega_de</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span>
                                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cosmology</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">):</span>
            <span class="c1"># file containing two columns: z and w(z)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; reading Dark Energy file...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift_de</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_z_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">=</span> <span class="s1">&#39;from_file&#39;</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="c1"># ndarray of two columns: z and w(z)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift_de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_z_de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">=</span> <span class="s1">&#39;from_arrays&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; initialising Dark Energy with the provided arrays...&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_z_de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">=</span> <span class="s1">&#39;from_function&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">de_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LCDM&quot;</span><span class="p">,</span> <span class="s2">&quot;w0wa&quot;</span><span class="p">,</span> <span class="s2">&quot;w0wa_steigerwald&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dark Energy model </span><span class="si">{0}</span><span class="s2"> not supported&quot;</span><span class="p">,</span> <span class="n">de_model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mDM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;mDM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mDM</span>
            <span class="n">gx</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># Internal degrees of freedom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.4</span><span class="p">)</span><span class="o">**</span><span class="mf">0.15</span> <span class="o">*</span>
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.65</span><span class="p">)</span><span class="o">**</span><span class="mf">1.3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">mDM</span><span class="p">)</span><span class="o">**</span><span class="mf">1.15</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span><span class="o">/</span><span class="n">gx</span><span class="p">)</span><span class="o">**</span><span class="mf">1.3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleTime</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleKaiser</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Define a dictionary with lazy attributes already computed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   initialization took </span><span class="si">{0:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;-----------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;Cosmology &quot;</span><span class="si">{0}</span><span class="s1">&quot;, de_model &quot;</span><span class="si">{1}</span><span class="s1">&quot; </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;- Paramerers: Omega_cdm = </span><span class="si">{2}</span><span class="s1">, Omega_b = </span><span class="si">{3}</span><span class="s1">, Omega_de = </span><span class="si">{4}</span><span class="s1">, </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;Hubble=</span><span class="si">{5}</span><span class="s1">, Sigma_8=</span><span class="si">{6}</span><span class="s1">, A_s=</span><span class="si">{7}</span><span class="s1">, ns=</span><span class="si">{8}</span><span class="s1">, neutrino_mass=</span><span class="si">{9}</span><span class="s1">, </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;Omega_r=</span><span class="si">{10}</span><span class="s1">, Omega_k=</span><span class="si">{11}</span><span class="s1">, tau=</span><span class="si">{12}</span><span class="s1">, w0=</span><span class="si">{13}</span><span class="s1">, wa=</span><span class="si">{14}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;- Power Spectrum: </span><span class="si">{15}</span><span class="s1">,&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;   Expansion Factor: </span><span class="si">{16}</span><span class="s1">,&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;   ReNormalizeInputSpectrum: </span><span class="si">{17}</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-----------------------------------------------&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReNormalizeInputSpectrum</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="n">descr</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

<span class="c1">#   ============================</span>
<span class="c1">#   Background quantities</span>
<span class="c1">#   ============================</span>

<span class="c1">#   Distances</span>
<span class="c1">#   ---------</span>
    <span class="k">def</span> <span class="nf">comoving_radial_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">comoving_radial_distance_integrand</span><span class="p">(</span><span class="n">redshift</span><span class="p">):</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">3.e3</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>

        <span class="n">redshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>
        <span class="n">r_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">redshift</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">redshift</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;redshifts not sorted!&quot;</span><span class="p">)</span>
        <span class="n">r_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">comoving_radial_distance_integrand</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">redshift</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbins</span><span class="p">):</span>
            <span class="n">r_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_z</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">comoving_radial_distance_integrand</span><span class="p">,</span>
                                              <span class="n">redshift</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">redshift</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">r_z</span>

<div class="viewcode-block" id="Cosmology.redshift_to_comoving_distance"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.redshift_to_comoving_distance">[docs]</a>    <span class="k">def</span> <span class="nf">redshift_to_comoving_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to compute the redshift correponding to a given radial comoving distance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">root_scalar</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comoving_radial_distance</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">d</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;brentq&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">root</span>
        <span class="k">return</span> <span class="n">z</span></div>

    <span class="k">def</span> <span class="nf">luminosity_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comoving_radial_distance</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">comoving_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
        <span class="n">area_steradians</span> <span class="o">=</span> <span class="n">area</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comoving_radial_distance</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
                                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">comoving_radial_distance</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">area_steradians</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>


<span class="c1">#   Densities</span>
<span class="c1">#   ----------</span>
    <span class="k">def</span> <span class="nf">Ez_function_norad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_de</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">Ez_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_omega_neutrino_E2</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_de</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dHubble_dz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="n">redshift</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">z_1</span> <span class="o">=</span> <span class="n">redshift</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">z_1</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span>
                                                    <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">z_1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                                    <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">z_1</span> <span class="o">+</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_de</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">z_1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_omega_neutrino_E2</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">z_1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">lookback_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="n">redshift</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">redshift</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="mf">3.17098e-17</span><span class="o">/</span><span class="mf">3.086e19</span><span class="p">)</span><span class="o">*</span><span class="n">integral</span>  <span class="c1"># in Gyrs</span>

    <span class="k">def</span> <span class="nf">time_to_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">expfactor</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">100</span><span class="o">*</span><span class="n">integral</span>  <span class="c1"># in internal units</span>

<div class="viewcode-block" id="Cosmology.rhocrit_z"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.rhocrit_z">[docs]</a>    <span class="k">def</span> <span class="nf">rhocrit_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the critical density in units of Msun /Mpc^3 h^2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">43.0071</span> <span class="c1"># Mpc/(1e10 M_solar) km^2 / s^2</span>
        <span class="c1"># To transform G to kms gr/s^3 multiply by 3.085678e24/1.989e43</span>
        <span class="n">rhocrit_0</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">/</span><span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e4</span>  <span class="c1"># * self.omega_matter_z(1.0)</span>
        <span class="k">return</span> <span class="mf">1e10</span> <span class="o">*</span> <span class="n">rhocrit_0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># / self.omega_matter_z(expfactor)</span></div>

<div class="viewcode-block" id="Cosmology.rhoback_z"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.rhoback_z">[docs]</a>    <span class="k">def</span> <span class="nf">rhoback_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the background density in units of 1e10 Msun /Mpc^3 /h^2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span></div>

    <span class="k">def</span> <span class="nf">omega_cdm_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">omega_baryons_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">omega_matter_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">omega_cold_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">omega_de_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_de</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">omega_rad_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">4</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<div class="viewcode-block" id="Cosmology.omega_neutrino_z"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.omega_neutrino_z">[docs]</a>    <span class="k">def</span> <span class="nf">omega_neutrino_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time dependent neutrino energy density fraction</span>

<span class="sd">        Note that if pars[&#39;approx_nu&#39;] is True, neutrinos are treated as</span>
<span class="sd">        nonrelativistic at all times.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega_neutrino_E2</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span></div>

<div class="viewcode-block" id="Cosmology.omega_neutrino_nonrel"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.omega_neutrino_nonrel">[docs]</a>    <span class="k">def</span> <span class="nf">omega_neutrino_nonrel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time dependent non-relativistic neutrino fraction</span>

<span class="sd">        Note that if pars[&#39;approx_nu&#39;] is True, neutrinos are treated as</span>
<span class="sd">        nonrelativistic at all times.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutrino_eos</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">On</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_neutrino_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">On</span></div>

<div class="viewcode-block" id="Cosmology.omega_neutrino_rel"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.omega_neutrino_rel">[docs]</a>    <span class="k">def</span> <span class="nf">omega_neutrino_rel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time dependent relativistic neutrino fraction</span>

<span class="sd">        Note that if pars[&#39;approx_nu&#39;] is True, neutrinos are treated as</span>
<span class="sd">        nonrelativistic at all times.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutrino_eos</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">On</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_neutrino_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">On</span></div>

<div class="viewcode-block" id="Cosmology.neutrino_fluid_speed_of_sound"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.neutrino_fluid_speed_of_sound">[docs]</a>    <span class="k">def</span> <span class="nf">neutrino_fluid_speed_of_sound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time dependent neutrino sound speed in km / s</span>

<span class="sd">        See Blas et al (2014) for details</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">134.423</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cosmology.neutrino_fluid_free_streaming_scale"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.neutrino_fluid_free_streaming_scale">[docs]</a>    <span class="k">def</span> <span class="nf">neutrino_fluid_free_streaming_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">MPC</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time dependent neutrino free streaming scale</span>
<span class="sd">        Output is by default in h/Mpc</span>
<span class="sd">        If MPC is set to True, output is in 1/Mpc</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">Ob</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">E</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Oc</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">E</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">On</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_neutrino_nonrel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">Om</span> <span class="o">=</span> <span class="n">Ob</span> <span class="o">+</span> <span class="n">Oc</span> <span class="o">+</span> <span class="n">On</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutrino_fluid_speed_of_sound</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">kfs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">Om</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="o">/</span> <span class="n">cs</span>
        <span class="k">return</span> <span class="n">kfs</span> <span class="k">if</span><span class="p">(</span><span class="n">MPC</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="n">kfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Cosmology.neutrino_nonrel_transition"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.neutrino_nonrel_transition">[docs]</a>    <span class="k">def</span> <span class="nf">neutrino_nonrel_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Expansion factor at the time on non-rel transition</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">znr</span> <span class="o">=</span> <span class="mf">1890.0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">znr</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_omega_neutrino_E2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time dependent neutrino contribution to the Hubble rate (Omega_nu E^2)</span>

<span class="sd">        Note that if pars[&#39;approx_nu&#39;] is True, neutrinos are treated as</span>
<span class="sd">        nonrelativistic at all times.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="c1"># Boltzmann&#39;s constant</span>
        <span class="n">_kb</span> <span class="o">=</span> <span class="mf">8.617342e-5</span>  <span class="c1"># eV K^{-1}</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;approx_nu&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">onu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">der_onu</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">onu</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">onu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="n">der_onu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">KT</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GammaNu&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]</span> <span class="o">*</span>
                  <span class="n">_kb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;photon_temperature&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">KT</span>

            <span class="n">onu</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">15.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GammaNu&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_photons&#39;</span><span class="p">]</span> <span class="o">*</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">der_onu</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">onu</span>

        <span class="k">if</span> <span class="n">derivative</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">der_onu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">onu</span>

        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="Cosmology.neutrino_eos"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.neutrino_eos">[docs]</a>    <span class="k">def</span> <span class="nf">neutrino_eos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time dependent neutrino pressure parameter.</span>

<span class="sd">        Note that if pars[&#39;approx_nu&#39;] is True, neutrinos are treated as</span>
<span class="sd">        nonrelativistic at all times.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="c1"># Boltzmann&#39;s constant</span>
        <span class="n">_kb</span> <span class="o">=</span> <span class="mf">8.617342e-5</span>  <span class="c1"># eV K^{-1}</span>

        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;approx_nu&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

        <span class="n">KT</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GammaNu&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]</span> <span class="o">*</span>
              <span class="n">_kb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;photon_temperature&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">KT</span>

        <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_G</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">w</span></div>

    <span class="k">def</span> <span class="nf">rho_de</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">r_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>
            <span class="n">deriv_rd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span>
                <span class="n">r_de</span> <span class="o">=</span> <span class="n">expfactor</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">deriv_rd</span> <span class="o">=</span> <span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="n">expfactor</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ww</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span>
                <span class="n">r_de</span> <span class="o">=</span> <span class="n">expfactor</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">ww</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">expfactor</span><span class="p">))</span>
                <span class="n">deriv_rd</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">expfactor</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">ww</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">expfactor</span><span class="p">))</span><span class="o">*</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">ww</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">expfactor</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">DE_integrand</span><span class="p">(</span><span class="n">redshift</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">DE_EoS</span><span class="p">(</span><span class="n">redshift</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span>

            <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">redshift</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

            <span class="n">integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">expfactor</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">expfactor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">integral</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">DE_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">redshift</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbins</span><span class="p">):</span>
                <span class="n">integral</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">integral</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">DE_integrand</span><span class="p">,</span> <span class="n">redshift</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">redshift</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">r_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">integral</span><span class="p">)</span>
            <span class="n">deriv_rd</span> <span class="o">=</span> <span class="n">r_de</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">DE_integrand</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">derivative</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deriv_rd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r_de</span>

<span class="c1">#--------------------------------------------------------------------</span>
<span class="c1"># Define useful transformations</span>

<div class="viewcode-block" id="Cosmology.radius_to_mass"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.radius_to_mass">[docs]</a>    <span class="k">def</span> <span class="nf">radius_to_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the mass M [Msun/h] enclosed in a radius R [h/Mpc]</span>
<span class="sd">        Note that this is always computed for the cold matter component (baryons</span>
<span class="sd">        and cdm), which is different from the total matter fraction when</span>
<span class="sd">        neutrinos are considered.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rhocrit_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># units: M_solar/Mpc^3 h^2</span>
        <span class="n">omega_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_cold_z</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># as omega_matter if there are not neutrinos</span>
        <span class="k">return</span> <span class="mf">4.</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rhocrit_z</span> <span class="o">*</span> <span class="n">omega_z</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">3</span></div>

    <span class="k">def</span> <span class="nf">radius_to_eulerian_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">overdensity</span><span class="o">=</span><span class="mf">200.</span><span class="p">):</span>
        <span class="n">rhocrit_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>  <span class="c1"># units: M_solar/Mpc^3 h^2</span>
        <span class="k">return</span> <span class="mf">4.</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">overdensity</span> <span class="o">*</span> <span class="n">rhocrit_z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">3</span>

<div class="viewcode-block" id="Cosmology.mass_to_radius"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.mass_to_radius">[docs]</a>    <span class="k">def</span> <span class="nf">mass_to_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the radius R [Mpc/h] enclosing a mass M [Msun/h]</span>
<span class="sd">        Note that this is always computed for the cold matter component (baryons</span>
<span class="sd">        and cdm), which is different from the total matter fraction when</span>
<span class="sd">        neutrinos are considered.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rhocrit_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># units: M_solar/Mpc^3 h^2</span>
        <span class="n">omega_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_cold_z</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># as omega_matter if there are not neutrinos</span>
        <span class="k">return</span> <span class="n">special</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="n">mass</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rhocrit_z</span> <span class="o">*</span> <span class="n">omega_z</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">mass_to_eulerian_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">overdensity</span><span class="o">=</span><span class="mf">200.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">mass</span>
        <span class="n">rhocrit_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>  <span class="c1"># units: M_solar/Mpc^3 h^2</span>
        <span class="k">return</span> <span class="n">special</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="n">_mass</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">overdensity</span> <span class="o">*</span> <span class="n">rhocrit_z</span> <span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span>

<div class="viewcode-block" id="Cosmology.mass_to_overdensity"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.mass_to_overdensity">[docs]</a>    <span class="k">def</span> <span class="nf">mass_to_overdensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enclosed_mass</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the enclosed overdensity relative to the critical density</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rhocrit_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>  <span class="c1"># units: M_solar/Mpc^3 h^2</span>
        <span class="k">return</span> <span class="n">enclosed_mass</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">rhocrit_z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Cosmology.mass_to_nu"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.mass_to_nu">[docs]</a>    <span class="k">def</span> <span class="nf">mass_to_nu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;mo&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Peak height nu given a mass M, at time given by expfact.</span>
<span class="sd">        Note that this is always computed for the cold matter component (which</span>
<span class="sd">        is different from the total matter fraction when neutrinos are considered)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span> <span class="o">/</span>
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span></div>

    <span class="k">def</span> <span class="nf">nu_to_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;mo&#39;</span><span class="p">):</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span> <span class="o">/</span> <span class="n">nu</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_to_mass</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nu_to_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nu_to_mass</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">))</span>

<div class="viewcode-block" id="Cosmology.delta_c"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.delta_c">[docs]</a>    <span class="k">def</span> <span class="nf">delta_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;mo&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Critical overdensity for collapse. We use the redshift-dependence of Kitayama &amp; Suto (1996)</span>
<span class="sd">        -- as used in Despali et al 2016 -- alternatively, we can use the value derived in \S5.1</span>
<span class="sd">        of the Mo, van den Bosch and White&#39;s book.</span>

<span class="sd">        Note on the neutrino case: works such as Castorina et el 2015 found that</span>
<span class="sd">        the critical overdensity for collapse in cosmologies that include massive</span>
<span class="sd">        neutrinos is still well approximated by the usual 1.6865 (default value</span>
<span class="sd">        here if no correction is specified). No study to my knowledge assessed</span>
<span class="sd">        this issue for the kitayama or mo correction. TODO: it should be in</span>
<span class="sd">        principle easy to check if omega_matter or omega_cold should be used in</span>
<span class="sd">        this case (I would bet on omega_cold).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">omega_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">correction</span> <span class="o">==</span> <span class="s1">&#39;kitayama&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">20.</span> <span class="o">*</span> <span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.0123</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">omega_z</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">correction</span> <span class="o">==</span> <span class="s1">&#39;mo&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">3.</span><span class="o">/</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">omega_z</span><span class="o">**</span><span class="mf">0.0055</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">3.</span><span class="o">/</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span></div>

<span class="c1">#--------------------------------------------------------------------</span>

<span class="c1">#--------------------------------------------------------------------</span>
<span class="c1"># Define interpolating tables (_tab*) as lazy attributes</span>

    <span class="c1"># First, compute the z=0 properties. Then, higher-z versions. At this point, we can build</span>
    <span class="c1"># interpolating tables. Finally, we define the get_XX methods, which use the interpotations</span>

    <span class="c1">#-------------------- z=0 versions ----------------------</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabPowerSpectrum_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabPowerSpectrum_z0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CAMB&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_per_logint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_mass&#39;</span><span class="p">]</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_cold&#39;</span><span class="p">]</span>
            <span class="n">transfer</span> <span class="o">=</span> <span class="s1">&#39;Not implemented for CAMB&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_class_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_per_logint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">compute_transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_mass&#39;</span><span class="p">]</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_cold&#39;</span><span class="p">]</span>
            <span class="n">transfer</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;transfer&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   reading pk file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">))</span>
                <span class="n">_kk</span><span class="p">,</span> <span class="n">_pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">_kk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1"># probably the file is in log10 units</span>
                    <span class="n">_kk</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">_kk</span>
                    <span class="n">_pk</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">_pk</span>
                <span class="c1"># probably the file is in P(k)*k**3</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_kk</span><span class="p">[</span><span class="n">_kk</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_pk</span><span class="p">[</span><span class="n">_kk</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">_pk</span> <span class="o">=</span> <span class="n">_pk</span><span class="o">/</span><span class="n">_kk</span><span class="o">**</span><span class="mi">3</span>
                <span class="n">kk</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_highk</span><span class="p">(</span><span class="n">_kk</span><span class="p">,</span> <span class="n">_pk</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Assuming Pk in file </span><span class="si">{}</span><span class="s1"> refers to cold matter&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReNormalizeInputSpectrum</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">pk</span> <span class="o">*=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile_expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">kk</span><span class="p">,</span> <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">kk</span><span class="p">,</span> <span class="n">pk</span>
                <span class="n">transfer</span> <span class="o">=</span> <span class="s1">&#39;Not implemented for filePK&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;file not found &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">)</span>

        <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pk_cold</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># Normalize to sigma8</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReNormalizeInputSpectrum</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Normalization</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Normalization</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">/</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk_cold</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">pk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Normalization</span>
        <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">pk_cold</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Normalization</span>

        <span class="n">intkk</span> <span class="o">=</span> <span class="n">kk</span>
        <span class="n">intpk</span> <span class="o">=</span> <span class="n">pk</span>
        <span class="n">intpk_cold</span> <span class="o">=</span> <span class="n">pk_cold</span>
        <span class="k">if</span> <span class="n">intkk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="o">&lt;</span> <span class="n">intkk</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># on large scales, a power law is a good approximation</span>
            <span class="n">klow</span> <span class="o">=</span> <span class="n">intkk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span>
            <span class="n">low_pk_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intpk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intpk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">intpk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intkk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">intkk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">klow</span><span class="o">/</span><span class="n">intkk</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">low_pk_cold_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intpk_cold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intpk_cold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">intpk_cold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intkk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">intkk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">klow</span><span class="o">/</span><span class="n">intkk</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">intkk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klow</span><span class="p">,</span> <span class="n">intkk</span><span class="p">)</span>
            <span class="n">intpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low_pk_val</span><span class="p">,</span> <span class="n">intpk</span><span class="p">)</span>
            <span class="n">intpk_cold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low_pk_cold_val</span><span class="p">,</span> <span class="n">intpk_cold</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;   created Pk(z=0) tab from k </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> h/Mpc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kk</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">kk</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intkk</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intpk</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intkk</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intpk_cold</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span><span class="o">!=</span><span class="mf">1.0</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="n">kk</span><span class="o">&lt;</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;kextend&#39;</span><span class="p">]]</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">pk_cold</span><span class="p">[</span><span class="n">kk</span><span class="o">&lt;</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;kextend&#39;</span><span class="p">]]</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span><span class="p">[</span><span class="n">kk</span><span class="o">&lt;</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;kextend&#39;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">kk</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;y_cold&#39;</span><span class="p">:</span> <span class="n">pk_cold</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;interp_cold&#39;</span><span class="p">:</span> <span class="n">interp_cold</span><span class="p">,</span> <span class="s1">&#39;transfer&#39;</span><span class="p">:</span> <span class="n">transfer</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabPowerSpectrum_nonlinear_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabPowerSpectrum_nonlinear_z0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating the _tabPowerSpectrum_nonlinear_z0&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;halofit&quot;</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halofit</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halofit</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">e2py</span>
            <span class="n">s8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span>
            <span class="n">cosm</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;om_b&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;om_m&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;n_s&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span> <span class="s1">&#39;w_0&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span> <span class="s1">&#39;sigma_8&#39;</span><span class="p">:</span> <span class="n">s8</span><span class="p">}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">e2py</span><span class="o">.</span><span class="n">get_pnonlin</span><span class="p">(</span><span class="n">cosm</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">nlpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;P_nonlin&#39;</span><span class="p">])))</span>
            <span class="n">nlpk_cold</span> <span class="o">=</span> <span class="n">nlpk</span>


        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pk</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pk_cold</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;y_cold&#39;</span><span class="p">:</span> <span class="n">pk_cold</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;interp_cold&#39;</span><span class="p">:</span> <span class="n">interp_cold</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabVariance_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabVariance_z0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">5e2</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span>
            <span class="n">radius</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">variance</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">inv_interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">variance</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">radius</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">variance</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;inv_interp&#39;</span><span class="p">:</span><span class="n">inv_interp</span><span class="p">}</span>  <span class="c1"># , &#39;uni_interp&#39;:uni_interp}</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>  <span class="c1"># REA: Not sure why this line was commented out</span>
            <span class="c1">#kk = np.logspace(np.log10(1e-3), np.log10(10), 200)</span>
            <span class="n">Scold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius</span><span class="p">)))</span>
            <span class="n">Smatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expfactor</span><span class="p">):</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Scold</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Smatter</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Sinterp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Smatter</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Sinterp_cold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Scold</span><span class="p">))</span>

            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span>
                <span class="n">radius</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabCorrelationFunction_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabCorrelationFunction_z0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">xi_cold</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi_cold</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="s1">&#39;y_cold&#39;</span><span class="p">:</span> <span class="n">xi_cold</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;interp_cold&#39;</span><span class="p">:</span> <span class="n">interp_cold</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabCorrelationFunction_nonlinear_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabCorrelationFunction_nonlinear_z0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">xi_cold</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear_z0</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi_cold</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="s1">&#39;y_cold&#39;</span><span class="p">:</span> <span class="n">xi_cold</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;interp_cold&#39;</span><span class="p">:</span> <span class="n">interp_cold</span><span class="p">}</span>

    <span class="c1">#-------------------- arbitrary z versions ----------------------</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabMassFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabMassFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mlow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mf">1e8</span><span class="p">,</span> <span class="mf">1e8</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span><span class="p">])</span>
        <span class="n">mhigh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">1e16</span><span class="p">,</span> <span class="mf">1e16</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span><span class="p">])</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mlow</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mhigh</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_massfunction</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;dn_dlnM&#39;</span><span class="p">)</span>
        <span class="n">nn_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_massfunction</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;dn_dlnM_sub&#39;</span><span class="p">)</span>
        <span class="n">nufnu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_massfunction</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;nufnu&#39;</span><span class="p">)</span>
        <span class="n">nufnu_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_massfunction</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;nufnu_sub&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Computation of halo mass function returned None&#39;</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sub_interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nn_sub</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_nufnu</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nufnu</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sub_interp_nufnu</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nufnu_sub</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">nn</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;sub_interp&#39;</span><span class="p">:</span><span class="n">sub_interp</span><span class="p">,</span> <span class="s1">&#39;interp_nufnu&#39;</span><span class="p">:</span> <span class="n">interp_nufnu</span><span class="p">,</span> <span class="s1">&#39;sub_interp_nufnu&#39;</span><span class="p">:</span><span class="n">sub_interp_nufnu</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabConcentration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabConcentration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e16</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_concentration</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">cc_z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_concentration</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Computation of concentrations returned None&#39;</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="n">cc</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_z0</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="n">cc_z0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">cc</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;y_z0&#39;</span><span class="p">:</span><span class="n">cc_z0</span><span class="p">,</span> <span class="s1">&#39;interp_z0&#39;</span><span class="p">:</span><span class="n">interp_z0</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabPowerSpectrum_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabPowerSpectrum_nonlinear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;halofit&quot;</span><span class="p">:</span>
            <span class="n">nlpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halofit</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">boltzmann_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">nlpk_cold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halofit</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span>
                                         <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boltzmann_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">e2py</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Boundaries of Euclid Emulator:</span>
<span class="sd">            0.0217 &lt;= œâb &lt;= 0.0233</span>
<span class="sd">            0.1326 &lt;= œâm &lt;= 0.1526</span>
<span class="sd">            0.9345 &lt;= ns &lt;= 0.9965</span>
<span class="sd">            0.6251 &lt;= h &lt;= 0.7211</span>
<span class="sd">            -1.250 &lt;= w0 &lt;= -0.750</span>
<span class="sd">            0.7684 &lt;= œÉ8 &lt;= 0.8614</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">s8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span>
            <span class="n">cosm</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;om_b&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;om_m&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;n_s&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span> <span class="s1">&#39;w_0&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span> <span class="s1">&#39;sigma_8&#39;</span><span class="p">:</span> <span class="n">s8</span><span class="p">}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">e2py</span><span class="o">.</span><span class="n">get_pnonlin</span><span class="p">(</span><span class="n">cosm</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">nlpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;P_nonlin&#39;</span><span class="p">])))</span>
            <span class="n">nlpk_cold</span> <span class="o">=</span> <span class="n">nlpk</span>

        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nlpk</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nlpk_cold</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">nlpk</span><span class="p">,</span> <span class="s1">&#39;y_cold&#39;</span><span class="p">:</span> <span class="n">nlpk_cold</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;interp_cold&#39;</span><span class="p">:</span> <span class="n">interp_cold</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabGrowth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabGrowth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="c1"># expfactor = np.logspace(np.log10(2e-3), np.log10(10.0), num=150, endpoint=True)</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">10.0</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">growth</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">expfactor</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">growth</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;reps&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;WARNING:  mnu!=0 but growth method is not reps =&gt; this is probably not correct and a number of unpredictable outcomes can occur. Are you sure about this?&#39;</span><span class="p">)</span>
            <span class="n">initexp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_growth_expfac</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span> <span class="k">else</span> <span class="mf">1e-4</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">initexp</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">expfactor</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reps_boundary_conditions</span><span class="p">(</span><span class="n">expfactor</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">fb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span>
            <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reps_growth</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

            <span class="n">growth</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dmatter&#39;</span><span class="p">]</span>
            <span class="n">growth_cold</span> <span class="o">=</span> <span class="n">fb</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dbaryon&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fc</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dcdm&#39;</span><span class="p">]</span>

            <span class="n">grate</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;fmatter&#39;</span><span class="p">]</span>
            <span class="n">prefac_b</span> <span class="o">=</span> <span class="n">fb</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dbaryon&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">growth_cold</span>
            <span class="n">prefac_c</span> <span class="o">=</span> <span class="n">fc</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dcdm&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">growth_cold</span>
            <span class="n">grate_cold</span> <span class="o">=</span> <span class="n">prefac_b</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;fbaryon&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">prefac_c</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;fcdm&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">growth</span><span class="p">)))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;nan found at a=</span><span class="si">{}</span><span class="s1"> k=</span><span class="si">{}</span><span class="s1">; Gb=</span><span class="si">{}</span><span class="s1"> Gcdm=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">expfactor</span><span class="p">,</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dbaryon&#39;</span><span class="p">],</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dcdm&#39;</span><span class="p">]))</span>
                <span class="kn">import</span> <span class="nn">pdb</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;cubic&#39;</span>  <span class="c1"># possible: linear, cubic or quintic</span>
            <span class="n">Dinterp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">expfactor</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">growth</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">Dinterp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">expfactor</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">growth_cold</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>

            <span class="n">Ginterp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">grate</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">Ginterp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">grate_cold</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">expfactor</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="n">growth</span><span class="p">,</span> <span class="s1">&#39;Dinterp&#39;</span><span class="p">:</span> <span class="n">Dinterp</span><span class="p">,</span> <span class="s1">&#39;Dinterp_cold&#39;</span><span class="p">:</span> <span class="n">Dinterp_cold</span><span class="p">,</span>
                                                              <span class="s1">&#39;Ginterp&#39;</span><span class="p">:</span> <span class="n">Ginterp</span><span class="p">,</span> <span class="s1">&#39;Ginterp_cold&#39;</span><span class="p">:</span> <span class="n">Ginterp_cold</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabCorrelationFunction_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabCorrelationFunction_nonlinear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">xi_cold</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi_cold</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="s1">&#39;y_cold&#39;</span><span class="p">:</span> <span class="n">xi_cold</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;interp_cold&#39;</span><span class="p">:</span> <span class="n">interp_cold</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_tabCorrelationFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_tabCorrelationFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">xi_cold</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrelRadius</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">interp_cold</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">xi_cold</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="s1">&#39;y_cold&#39;</span><span class="p">:</span> <span class="n">xi_cold</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;interp_cold&#39;</span><span class="p">:</span> <span class="n">interp_cold</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Gammas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Gammas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># Steigerwald,Bel and Marinoni 2014  ( https://arxiv.org/pdf/1403.0898.pdf )</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
            <span class="n">gammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="o">/</span><span class="mi">11</span>
            <span class="n">gammas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">15</span><span class="o">/</span><span class="mi">2057</span>
            <span class="n">gammas</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">410</span><span class="o">/</span><span class="mi">520421</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa_steigerwald&#39;</span><span class="p">:</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">wp</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span>
                <span class="n">gammas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]))</span> <span class="o">/</span> \
                    <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">gammas</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">485</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1015</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">559.270</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]))))</span><span class="o">/</span><span class="p">(</span>
                    <span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">18</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">W0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">wp</span>
                <span class="n">W1</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">/</span> \
                    <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]))</span>
                <span class="n">W2</span> <span class="o">=</span> <span class="o">-</span><span class="n">W1</span>
                <span class="n">gammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span>
                <span class="n">gammas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="n">W1</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">gammas</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">23</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">))</span>
                             <span class="o">*</span> <span class="n">W1</span><span class="o">-</span><span class="mi">72</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">W1</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">W2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span>
                    <span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">18</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gamma0&#39;</span><span class="p">:</span> <span class="n">gammas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;gamma1&#39;</span><span class="p">:</span> <span class="n">gammas</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;gamma2&#39;</span><span class="p">:</span> <span class="n">gammas</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">As</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span>
        <span class="n">_cosmo</span> <span class="o">=</span>  <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#Must be after _cosmo =  copy.deepcopy(self)</span>
        <span class="n">_cosmo</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">_cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">],</span> <span class="n">_cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">2e-9</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">_sigma8</span> <span class="o">=</span> <span class="n">_cosmo</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="o">=</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">],</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_As</span> <span class="o">=</span> <span class="n">_cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">_sigma8</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">_cosmo</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">_cosmo</span>
        <span class="k">return</span> <span class="n">_As</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sigma8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y_cold&#39;</span><span class="p">],</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#------------------------------------------</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;_tabPowerSpectrum_z0&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;transfer&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;transfer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">struct_cleanup</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_expfactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">=</span> <span class="n">expfactor</span>

    <span class="k">def</span> <span class="nf">set_rescaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_expfactor</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;a_in_original&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_expfactor</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;a_in_target&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scaleLength&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleTime</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scaleTime&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scaleMass&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scaleLength&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleKaiser</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scaleKaiser&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_initial_growth_expfac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_growth_expfac</span> <span class="o">=</span> <span class="n">expfactor</span>

    <span class="k">def</span> <span class="nf">set_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixed_omega_matter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;neutrino_mass&#39;</span> <span class="ow">or</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;hubble&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">DeltaNeffTab</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">3.046</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">2.0328</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">1.0196</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.00641</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DeltaNeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeltaNeffTab</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]]</span>
            <span class="n">old_omega_neutrino</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">93.14</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">fixed_omega_matter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">old_omega_neutrino</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;sigma8&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ReNormalizeInputSpectrum</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;A_s&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ReNormalizeInputSpectrum</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;omega_baryon&#39;</span> <span class="ow">and</span> <span class="n">fixed_omega_matter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;omega_matter&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;I assume you want a new omega_matter even if fixed_omega_matter is True&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;changing omega_matter in cosmology leaving fixed omega_baryons&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;omega_de&#39;</span> <span class="ow">and</span> <span class="n">geometry</span> <span class="o">==</span><span class="s1">&#39;flat&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;I assume you want a new omega_matter even if fixed_omega_matter is True&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;changing omega_matter in cosmology to have a new Omega_de and a flat cosmology&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">=</span> <span class="s1">&#39;w0wa&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cosmology</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span> <span class="ow">and</span> <span class="s1">&#39;_tabPowerSpectrum_z0&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;transfer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span>

<span class="c1">#--------------------------------------------------------------------</span>
<span class="c1"># Define functions that access tabulated quantities trought spline interpolation</span>

    <span class="c1"># Nonlinear Scale used to apply the large-scale correction</span>
    <span class="k">def</span> <span class="nf">get_nonlinear_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">knl</span> <span class="o">=</span> <span class="mf">0.462340</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">knl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">knl</span><span class="p">)</span>

    <span class="c1"># Growth Functions</span>
    <span class="c1">#----------------------------</span>
    <span class="k">def</span> <span class="nf">get_growth_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_loggrowth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_loggrowth_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># if self.pars[&#39;neutrino_mass&#39;] == 0.0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabGrowth</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="n">derivative</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">#if x out of the interval: ext=0 -&gt; extrapolate; ext=1 -&gt; return 0, ext=2 -&gt; ValueError; ext=3 -&gt; boundary value</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;You should provide k!&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should provide k!&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">derivative</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># raise ValueError(&#39;Logarithmic derivative not implemented for massive neutrinos&#39;)</span>
                <span class="c1"># we return f = d ln D / d ln a</span>
                <span class="k">if</span> <span class="n">cold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabGrowth</span><span class="p">[</span><span class="s1">&#39;Ginterp_cold&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabGrowth</span><span class="p">[</span><span class="s1">&#39;Ginterp&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))))</span>

            <span class="k">if</span> <span class="n">cold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabGrowth</span><span class="p">[</span><span class="s1">&#39;Dinterp_cold&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabGrowth</span><span class="p">[</span><span class="s1">&#39;Dinterp&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)))</span>

    <span class="c1">#Logarithmic derivative of the growth factor (this corresponds to alpha_eff in Diemer &amp; Joyce (2018))</span>
    <span class="k">def</span> <span class="nf">get_alpha_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loggrowth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">derivative</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Variance Functions</span>
    <span class="c1">#----------------------------</span>
    <span class="k">def</span> <span class="nf">get_logvariance_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">invert</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">_sigma</span> <span class="o">=</span> <span class="n">radius</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;reps&#39;</span><span class="p">):</span>
                <span class="n">log_growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loggrowth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_sigma</span><span class="p">)</span><span class="o">-</span><span class="n">log_growth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;inv_interp&#39;</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="n">derivative</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># raise ValueError(&quot;inv_interp not implemented for masssive neutrinos&quot;)</span>
                <span class="n">_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">5e2</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">_log_var_at_expfact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;Sinterp_cold&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_log_var_at_expfact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;Sinterp&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>
                <span class="n">inv_log_var_at_expfact</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">_log_var_at_expfact</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_sigma</span><span class="p">),</span> <span class="n">inv_log_var_at_expfact</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">derivative</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;reps&#39;</span><span class="p">):</span>
                <span class="n">log_growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loggrowth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_rr</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="n">derivative</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_growth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;Sinterp_cold&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_rr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;Sinterp&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_rr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># The lenght scaling is taking care of by get_logvariance</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_variance_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># The lenght scaling is taking care of by get_logvariance</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_variance_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># The lenght scaling is taking care of by get_logvariance</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_dlnS_dlnR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="n">which_var</span> <span class="o">=</span> <span class="s1">&#39;Sinterp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;Sinterp_cold&#39;</span>
            <span class="n">_R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">_log_var_at_expfact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="n">which_var</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R</span><span class="p">),</span> <span class="n">_log_var_at_expfact</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">_rr</span><span class="p">),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">which_var</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span>
            <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">_rr</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="n">which_var</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


    <span class="c1"># Correlation Functions</span>
    <span class="c1">#----------------------------</span>
    <span class="k">def</span> <span class="nf">get_correlationfunction_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="n">which_cf</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;interp_cold&#39;</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_rr</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabCorrelationFunction_z0</span><span class="p">[</span><span class="n">which_cf</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="o">/</span> <span class="n">_rr</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">bias</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">semilogx_int_ext</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="p">,</span> <span class="n">_rr</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xi</span><span class="p">(</span><span class="n">_rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">_rr</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_correlationfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Note that scaling is already taken care of by get_correlationfunction_z()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_correlationfunction_z</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_nlcorrelationfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="n">which_cf</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;interp_cold&#39;</span>
            <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_rr</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabCorrelationFunction_nonlinear</span><span class="p">[</span><span class="n">which_cf</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">_rr</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">bias</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">semilogx_int_ext</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nlpowerspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="p">,</span> <span class="n">_rr</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xi</span><span class="p">(</span><span class="n">_rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">_rr</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_nlcorrelationfunction_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="n">which_cf</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;interp_cold&#39;</span>
            <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_rr</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabCorrelationFunction_nonlinear_z0</span><span class="p">[</span><span class="n">which_cf</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">_rr</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">bias</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">semilogx_int_ext</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nlpowerspec_z0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="p">,</span> <span class="n">_rr</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xi</span><span class="p">(</span><span class="n">_rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">_rr</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_nlcorrelationfunction_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">semilogx_int_ext</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nlpowerspec_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="p">,</span> <span class="n">_rr</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xi</span><span class="p">(</span><span class="n">_rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">_rr</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_zcorrelationfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">semilogx_int_ext</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zpowerspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="p">,</span> <span class="n">_rr</span><span class="p">,</span> <span class="n">jn</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">sgn</span> <span class="o">*</span> <span class="n">xi</span><span class="p">(</span><span class="n">_rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">_rr</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_nlzcorrelationfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">_rr</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">radius</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">semilogx_int_ext</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nlzpowerspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pk2xi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="p">,</span> <span class="n">_rr</span><span class="p">,</span> <span class="n">jn</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">sgn</span> <span class="o">*</span> <span class="n">xi</span><span class="p">(</span><span class="n">_rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">_rr</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Power spectra</span>
    <span class="c1">#----------------------------</span>
    <span class="k">def</span> <span class="nf">get_nlpowerspec_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_kk</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">wavemode</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">which_pk</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;interp_cold&#39;</span>
        <span class="k">return</span> <span class="n">_vv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_kk</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear_z0</span><span class="p">[</span><span class="n">which_pk</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_nlpowerspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">_kk</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">wavemode</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">which_pk</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;interp_cold&#39;</span>
        <span class="k">return</span> <span class="n">_vv</span> <span class="o">*</span> <span class="n">bias</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_kk</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear</span><span class="p">[</span><span class="n">which_pk</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_nlzpowerspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># Note that the volume scaling is already taken care of by get_nlpowerspec_z()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleKaiser</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kaiser_boost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span> <span class="o">*</span> <span class="n">bias</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_nlpowerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_nlzpowerspec_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># Note that the volume scaling is already taken care of by get_nlpowerspec_z()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleKaiser</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kaiser_boost</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span> <span class="o">*</span> <span class="n">bias</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_nlpowerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_nlpowerspec_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_kk</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">wavemode</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">nlpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halofit</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">boltzmann_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_vv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_kk</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nlpk</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">get_powerspec_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">_kk</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">wavemode</span>
        <span class="k">if</span> <span class="s1">&#39;mDM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">:</span>
            <span class="n">_vv</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">_kk</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># which_pk = &#39;interp&#39; if cold==False else &#39;interp_cold&#39;</span>
        <span class="c1"># which_pk is always &#39;interp&#39; and never &#39;interp_cold&#39;, because the</span>
        <span class="c1"># growths computed by REPS are referred to the total matter Pk,</span>
        <span class="c1"># such that Pcb(a,k) = Dcb(a,k) * Pm(1,k)</span>
        <span class="n">which_pk</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_vv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_kk</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="n">which_pk</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loggrowth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">_kk</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">))</span> <span class="o">*</span> <span class="n">bias</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;requested k </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">, requested a </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_kk</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">_kk</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;original  k </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;scaleLength </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_powerspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># Note that the volume scaling is already taken care of by get_powerspec_z()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_zpowerspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># Note that the volume scaling is already taken care of by get_powerspec_z()</span>
        <span class="n">k_kaiser</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleKaiser</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kaiser_boost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_kaiser</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_zpowerspec_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># Note that the volume scaling is already taken care of by get_powerspec_z()</span>
        <span class="n">k_kaiser</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleKaiser</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kaiser_moments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_kaiser</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_zpowerspec_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># Note that the volume scaling is already taken care of by get_powerspec_z()</span>
        <span class="n">k_kaiser</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleKaiser</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kaiser_boost</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_kaiser</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_powerspec_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">_kk</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">wavemode</span>
        <span class="n">which_pk</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;interp_cold&#39;</span>
        <span class="k">return</span> <span class="n">_vv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_kk</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="n">which_pk</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_dlnP_dlnk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavemode</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_kk</span> <span class="o">=</span> <span class="n">wavemode</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">wavemode</span>
        <span class="n">which_pk</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">cold</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;interp_cold&#39;</span>
        <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_kk</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="n">which_pk</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Concentrations</span>
    <span class="c1">#----------------------------</span>
    <span class="k">def</span> <span class="nf">get_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">mass</span>
        <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_mass</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabConcentration</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_concentration_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">mass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_mass</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabConcentration</span><span class="p">[</span><span class="s1">&#39;interp_z0&#39;</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;requested masses: </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_mass</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_mass</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;original table: </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabConcentration</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabConcentration</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="k">raise</span>


    <span class="c1"># Mass Functions</span>
    <span class="c1">#----------------------------</span>
    <span class="k">def</span> <span class="nf">get_halomassfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;dn_dlnM&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">mass</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">which_mf</span> <span class="o">=</span> <span class="s1">&#39;interp&#39;</span> <span class="k">if</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;dn_dlnM&#39;</span> <span class="k">else</span> <span class="s1">&#39;interp_nufnu&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_mass</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabMassFunction</span><span class="p">[</span><span class="n">which_mf</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">_vv</span>

    <span class="k">def</span> <span class="nf">get_subhalomassfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;dn_dlnM&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">mass</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleVolume</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">which_mf</span> <span class="o">=</span> <span class="s1">&#39;sub_interp&#39;</span> <span class="k">if</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;dn_dlnM&#39;</span> <span class="k">else</span> <span class="s1">&#39;sub_interp_nufnu&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_mass</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabMassFunction</span><span class="p">[</span><span class="n">which_mf</span><span class="p">],</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">_vv</span>

    <span class="c1"># Mass functions</span>
    <span class="c1">#----------------------------</span>
    <span class="k">def</span> <span class="nf">get_nu_from_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;mo&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span>
        <span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleMass</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">mass</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">_mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span>

<span class="c1">#---------------------------------------------------------------</span>
<span class="c1">#    Internal Functions</span>
<span class="c1">#---------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_check_cosmology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> \
        <span class="s1">&#39;Invalid negative neutrino mass=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> \
        <span class="s1">&#39;A_s=</span><span class="si">{}</span><span class="s1"> and sigma8=</span><span class="si">{}</span><span class="s1">, only one normalisation should be provided!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_tot&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span> \
        <span class="s1">&#39;omega_k=</span><span class="si">{}</span><span class="s1"> and omega_tot=</span><span class="si">{}</span><span class="s1">, this Cosmology is inconsistent!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_tot&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>\
        <span class="s1">&#39;de_model is LCDM but w0=</span><span class="si">{}</span><span class="s1"> and wa=</span><span class="si">{}</span><span class="s1">, are you sure you want a LambdaCDM model?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">93.14</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> \
        <span class="s1">&#39;omega_neutrino=</span><span class="si">{}</span><span class="s1">, neutrino_mass=</span><span class="si">{}</span><span class="s1"> and hubble=</span><span class="si">{}</span><span class="s1"> are not consistent&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_neutrino&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">,</span> <span class="s1">&#39;reps is required for neutrino cosmologies&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_radiation</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">,</span> <span class="s1">&#39;reps is required for including radiation&#39;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_compute_camb_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_per_logint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">bardeen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nonlinear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="s1">&#39;matter&#39;</span><span class="p">,</span>
                               <span class="n">ret_transfer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calls camb with the current cosmological parameters and returns a</span>
<span class="sd">        dictionary with the following keys:</span>
<span class="sd">        kk, pk_mass, fsigma8, sigma8, hubble.</span>
<span class="sd">        If ret_transfer is True, camb&#39;s transfer function table is returned</span>
<span class="sd">        instead.</span>

<span class="sd">        Through the species keyword the following power spectra can be obtained:</span>
<span class="sd">        matter, cdm, baryons, neutrinos, cold matter (cdm+baryons), photons,</span>
<span class="sd">        divergence of the cdm velocity field, divergence of the baryon velocity</span>
<span class="sd">        field, divergence of the cdm-baryon relative velocity field</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">camb</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Try installing &#39;camb&#39; (&gt; pip install --egg camb) to generate the power spectrum&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">camb</span> <span class="k">import</span> <span class="n">model</span><span class="p">,</span> <span class="n">initialpower</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Set up a new set of parameters for CAMB</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">CAMBparams</span><span class="p">()</span>

        <span class="c1"># This function sets up CosmoMC-like settings, with one massive neutrino and helium set using BBN consistency</span>
        <span class="c1"># Set neutrino-related parameters</span>
        <span class="n">camb</span><span class="o">.</span><span class="n">set_halofit_version</span><span class="p">(</span><span class="s1">&#39;takahashi&#39;</span><span class="p">)</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">set_cosmology</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span>
                           <span class="n">ombh2</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                           <span class="n">omch2</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                           <span class="n">neutrino_hierarchy</span><span class="o">=</span><span class="s1">&#39;degenerate&#39;</span><span class="p">,</span>
                           <span class="n">num_massive_neutrinos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">],</span>
                           <span class="n">mnu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">],</span>
                           <span class="n">standard_neutrino_neff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Neffective&#39;</span><span class="p">],</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">A_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A_s</span> <span class="o">=</span> <span class="mf">1e-2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Normalization</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa_steigerwald&#39;</span><span class="p">:</span>
            <span class="n">pars</span><span class="o">.</span><span class="n">set_dark_energy</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span> <span class="n">sound_speed</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dark_energy_model</span><span class="o">=</span><span class="s1">&#39;fluid&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;CAMB power spectrum does not support Dynamical Dark Energy. Computing matter P(k) with a constant w(z)=w0&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">!=</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;CAMB power spectrum does not support Dynamical Dark Energy. Computing matter P(k) with a constant w(z)=-1&quot;</span><span class="p">)</span>

        <span class="n">pars</span><span class="o">.</span><span class="n">InitPower</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="n">As</span><span class="o">=</span><span class="n">A_s</span><span class="p">)</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">YHe</span> <span class="o">=</span> <span class="mf">0.24</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">omegak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">set_matter_power</span><span class="p">(</span><span class="n">redshifts</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span>
                              <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">],</span> <span class="n">k_per_logint</span><span class="o">=</span><span class="n">k_per_logint</span><span class="p">),</span>
<span class="c1">#                                accurate_massive_neutrino_transfers=config[&#39;pk&#39;][&#39;accurate_neutrino&#39;])</span>

        <span class="k">if</span> <span class="n">nonlinear</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pars</span><span class="o">.</span><span class="n">NonLinear</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">NonLinear_none</span>
        <span class="k">if</span> <span class="n">nonlinear</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pars</span><span class="o">.</span><span class="n">NonLinear</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">NonLinear_both</span>

        <span class="n">pars</span><span class="o">.</span><span class="n">WantCls</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">WantScalars</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">Want_CMB</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">DoLensing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># calculate results for these parameters</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="c1">#kh, z, pk_m = results.get_matter_power_spectrum(minkh=1e-4/self.pars[&#39;hubble&#39;], maxkh=kmax/self.pars[&#39;hubble&#39;], npoints = 200)</span>
        <span class="c1"># kh, z, pk_m = results.get_matter_power_spectrum(minkh=config[&#39;camb_minkh&#39;], maxkh=kmax/self.pars[&#39;hubble&#39;], npoints=config[&#39;camb_npoints&#39;])</span>
        <span class="c1"># pk_mass=pk_m[0,:]</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        results = camb.get_transfer_functions(pars)</span>
<span class="sd">        #kh, z, pk_tot = results.get_linear_matter_power_spectrum(var1=&#39;delta_tot&#39;,var2=&#39;delta_tot&#39;, nonlinear=False)</span>
<span class="sd">        kh, z, pk_cdm = results.get_linear_matter_power_spectrum(var1=&#39;delta_cdm&#39;,var2=&#39;delta_cdm&#39;, nonlinear=nonlinear)</span>
<span class="sd">        kh, z, pk_bar = results.get_linear_matter_power_spectrum(var1=&#39;delta_baryon&#39;,var2=&#39;delta_baryon&#39;, nonlinear=nonlinear)</span>
<span class="sd">        #kh, z, pk_nu = results.get_linear_matter_power_spectrum(var1=&#39;delta_nu&#39;,var2=&#39;delta_nu&#39;, nonlinear=False)</span>
<span class="sd">        pk_mass = ((pk_cdm[0,:] * self.pars[&#39;omega_cdm&#39;] + pk_bar[0,:] * self.pars[&#39;omega_baryon&#39;])</span>
<span class="sd">                    /(self.pars[&#39;omega_cdm&#39;] + self.pars[&#39;omega_baryon&#39;]))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ret_transfer</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_matter_transfer_data</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">T</span>
        <span class="c1"># T = results.get_matter_transfer_data()</span>

        <span class="n">speciesdic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cdm&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;baryons&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="s1">&#39;photons&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                      <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                      <span class="s1">&#39;neutrinos&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                      <span class="s1">&#39;neutrino&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                      <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                      <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                      <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                      <span class="s1">&#39;nonu&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                      <span class="s1">&#39;cb&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                      <span class="s1">&#39;cold&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                      <span class="s1">&#39;vel_cdm&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                      <span class="s1">&#39;vel_b&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                      <span class="s1">&#39;vel_b_cdm&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">speciesdic</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
        <span class="n">kh</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_linear_matter_power_spectrum</span><span class="p">(</span><span class="n">var1</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">index</span><span class="p">),</span>
                                                             <span class="n">var2</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">index</span><span class="p">),</span>
                                                             <span class="n">hubble_units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="n">have_power_spectra</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                             <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">pk_mass</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">speciesdic</span><span class="p">[</span><span class="s1">&#39;cold&#39;</span><span class="p">]</span>
        <span class="n">kh</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_linear_matter_power_spectrum</span><span class="p">(</span><span class="n">var1</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">index</span><span class="p">),</span>
                                                             <span class="n">var2</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">index</span><span class="p">),</span>
                                                             <span class="n">hubble_units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="n">have_power_spectra</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                             <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># pk_interp = {}</span>
        <span class="c1"># pk_interp[&#39;mass_z&#39;] = results.get_matter_power_interpolator(nonlinear=False,</span>
        <span class="c1">#                                                   var1=6, var2=6)</span>
        <span class="c1"># pk_interp[&#39;cold_z&#39;] = results.get_matter_power_interpolator(nonlinear=False,</span>
        <span class="c1">#                                                   var1=7, var2=7)</span>

        <span class="n">sigma8</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_sigma8</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fsigma8</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_fsigma8</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hz</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">hubble_parameter</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">kk</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_highk</span><span class="p">(</span><span class="n">kh</span><span class="p">,</span> <span class="n">pk_mass</span><span class="p">)</span>
        <span class="n">kk</span><span class="p">,</span> <span class="n">pk_cold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_highk</span><span class="p">(</span><span class="n">kh</span><span class="p">,</span> <span class="n">pk_cold</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   computed CAMB power spectrum at z=</span><span class="si">{0:.2f}</span><span class="s2"> in </span><span class="si">{1:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;kk&#39;</span><span class="p">:</span> <span class="n">kk</span><span class="p">,</span> <span class="s1">&#39;pk_mass&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;pk_cold&#39;</span><span class="p">:</span> <span class="n">pk_cold</span><span class="p">,</span>
                <span class="s1">&#39;sigma8&#39;</span><span class="p">:</span> <span class="n">sigma8</span><span class="p">,</span> <span class="s1">&#39;fsigma8&#39;</span><span class="p">:</span> <span class="n">fsigma8</span><span class="p">,</span> <span class="s1">&#39;hubble&#39;</span><span class="p">:</span> <span class="n">hz</span>
                <span class="c1">#                &#39;transfer&#39;:T</span>
                <span class="c1">#, &#39;kh&#39;:kh, &#39;pk_cdm&#39;:pk_cdm[0,:]</span>
                <span class="c1"># ,&#39;pk_bar&#39;:pk_bar[0,:], &#39;pk_nu&#39;:pk_nu[0,:]</span>
                <span class="p">}</span>

    <span class="c1">#@do_profile()</span>
    <span class="k">def</span> <span class="nf">_compute_class_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_per_logint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nonlinear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">species</span><span class="o">=</span><span class="s1">&#39;matter&#39;</span><span class="p">,</span> <span class="n">compute_transfer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">classy</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Install CLASS and its python wrapper &#39;classy&#39; to generate the power spectrum:&quot;</span> <span class="o">+</span>
                         <span class="s2">&quot; https://github.com/lesgourg/class_public&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">classy</span> <span class="k">import</span> <span class="n">Class</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cosmo_class</span> <span class="o">=</span> <span class="n">Class</span><span class="p">()</span>
        <span class="n">redshift</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">redshift_initial</span> <span class="o">=</span> <span class="mf">110.0</span>

        <span class="c1"># Set up a new set of parameters for CLASS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">A_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A_s</span> <span class="o">=</span> <span class="mf">2e-7</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Normalization</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="s1">&#39;mPk,mTk,vTk&#39;</span><span class="p">,</span>
            <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Omega_b&#39;</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Omega_cdm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">],</span>
            <span class="s1">&#39;lensing&#39;</span><span class="p">:</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span>
            <span class="s1">&#39;z_pk&#39;</span><span class="p">:</span> <span class="n">redshift_initial</span><span class="p">,</span>
            <span class="s1">&#39;n_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span>
            <span class="s1">&#39;P_k_max_h/Mpc&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">],</span>
            <span class="s1">&#39;A_s&#39;</span><span class="p">:</span> <span class="n">A_s</span><span class="p">,</span>
            <span class="s1">&#39;N_ur&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DeltaNeff&#39;</span><span class="p">],</span>
            <span class="s1">&#39;tau_reio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span>
            <span class="s1">&#39;YHe&#39;</span><span class="p">:</span> <span class="mf">0.24</span><span class="p">,</span>
            <span class="s1">&#39;N_ncdm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">]</span>
            <span class="c1"># &#39;gauge&#39; : &#39;newt&#39;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">nonlinear</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;non linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;halofit&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Omega_fld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa_steigerwald&#39;</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;w0_fld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;wa_fld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;General Dark Energy EoS is not yet implemented in CLASS. Computing matter P(k) within a LambdaCDM model&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]:</span>
            <span class="n">mnustring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">])</span>
            <span class="n">tnustring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GammaNu&#39;</span><span class="p">]</span>
            <span class="n">degstring</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">mnustring</span> <span class="o">=</span> <span class="n">mnustring</span> <span class="o">+</span> \
                    <span class="s1">&#39;, </span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">])</span>
                <span class="n">tnustring</span> <span class="o">=</span> <span class="n">tnustring</span><span class="o">+</span><span class="s1">&#39;, </span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GammaNu&#39;</span><span class="p">])</span>
                <span class="n">degstring</span> <span class="o">=</span> <span class="n">degstring</span><span class="o">+</span><span class="s1">&#39;, 1&#39;</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;m_ncdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mnustring</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;T_ncdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tnustring</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;deg_ncdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">degstring</span>
            <span class="c1"># The following are precision parameters controlling the massless and</span>
            <span class="c1"># massive neutrino computations in CLASS. Allowed fluid approximations</span>
            <span class="c1"># are 0, 1, 2, correponding to Ma&amp;Bertschinger, Hu, CLASS (default).</span>
            <span class="c1"># If set to 3, the fluid approximation is switched off.</span>
            <span class="c1"># These parameters can slow down CLASS to a point it takes hours to</span>
            <span class="c1"># compute a spectrum and are therefore intendend for debugging</span>
            <span class="c1"># purposes only.</span>
            <span class="c1"># params[&#39;tol_perturb_integration&#39;] = &#39;1.e-6&#39;</span>
            <span class="c1"># params[&#39;ur_fluid_approximation&#39;] = &#39;2&#39;</span>
            <span class="c1"># params[&#39;ur_fluid_trigger_tau_over_tau_k&#39;] = &#39;50.&#39;</span>
            <span class="c1"># params[&#39;ncdm_fluid_approximation&#39;] = &#39;3&#39;</span>
            <span class="c1"># params[&#39;tol_ncdm_bg&#39;] = &#39;1.e-10&#39;</span>
            <span class="c1"># params[&#39;l_max_ncdm&#39;] = &#39;100.0&#39;</span>

        <span class="c1"># calculate results for these parameters</span>
        <span class="n">cosmo_class</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cosmo_class</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">sigma8</span> <span class="o">=</span> <span class="n">cosmo_class</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="n">cosmo_class</span><span class="o">.</span><span class="n">h</span><span class="p">(),</span> <span class="n">redshift</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cosmo_class</span><span class="o">.</span><span class="n">scale_independent_growth_factor_f</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>
        <span class="n">fsigma8</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">sigma8</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">cosmo_class</span><span class="o">.</span><span class="n">scale_independent_growth_factor</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>
        <span class="n">hz</span> <span class="o">=</span> <span class="n">cosmo_class</span><span class="o">.</span><span class="n">Hubble</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">*</span><span class="mi">300000</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">cosmo_class</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">redshift</span><span class="p">)</span>

        <span class="n">speciesdic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cdm&#39;</span><span class="p">:</span> <span class="s1">&#39;d_cdm&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;d_cdm&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;baryon&#39;</span><span class="p">:</span> <span class="s1">&#39;d_b&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;baryons&#39;</span><span class="p">:</span> <span class="s1">&#39;d_b&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;d_b&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;photons&#39;</span><span class="p">:</span> <span class="s1">&#39;d_g&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="s1">&#39;d_g&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;neutrinos&#39;</span><span class="p">:</span> <span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;neutrino&#39;</span><span class="p">:</span> <span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;tot&#39;</span><span class="p">:</span> <span class="s1">&#39;d_tot&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="s1">&#39;d_tot&#39;</span><span class="p">}</span>

        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>

        <span class="n">kclass</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]</span>
        <span class="n">cfrac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">])</span>
        <span class="n">bfrac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">])</span>
        <span class="n">t_cb_class</span> <span class="o">=</span> <span class="n">cfrac</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bfrac</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">]</span>
        <span class="n">p0class</span> <span class="o">=</span> <span class="n">A_s</span><span class="o">*</span><span class="p">(</span><span class="n">kclass</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.05</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">p0class</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">kclass</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">kh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;mink&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]),</span>
                         <span class="n">num</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;npoints&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># first compute the Pk for the requested species</span>

        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]:</span>
            <span class="n">pk_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cosmo_class</span><span class="o">.</span><span class="n">pk</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">cosmo_class</span><span class="o">.</span><span class="n">h</span><span class="p">(),</span> <span class="n">redshift</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kh</span><span class="p">])</span>
            <span class="n">pk_mass</span> <span class="o">=</span> <span class="n">pk_m</span><span class="o">*</span><span class="n">cosmo_class</span><span class="o">.</span><span class="n">h</span><span class="p">()</span><span class="o">**</span><span class="mi">3</span>
            <span class="c1"># pk_cold=np.exp(np.interp(np.log(kh),np.log(kclass),np.log(p0class*t_cb_class**2)))</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kclass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p0class</span><span class="o">*</span><span class="n">t_cb_class</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pk_cold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kh</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cb&#39;</span><span class="p">,</span> <span class="s1">&#39;cold&#39;</span><span class="p">]:</span>
                <span class="n">tclass</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">speciesdic</span><span class="p">[</span><span class="n">species</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tclass</span> <span class="o">=</span> <span class="n">t_cb_class</span>
            <span class="c1"># pk_mass = np.exp(np.interp(np.log(kh),np.log(kclass),np.log(p0class*tclass**2)))</span>
            <span class="c1"># pk_cold = np.exp(np.interp(np.log(kh),np.log(kclass),np.log(p0class*t_cb_class**2)))</span>
            <span class="n">pk_mass</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kclass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p0class</span><span class="o">*</span><span class="n">tclass</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kclass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p0class</span><span class="o">*</span><span class="n">t_cb_class</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="n">pk_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pk_mass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kh</span><span class="p">)))</span>
            <span class="n">pk_cold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pk_cold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kh</span><span class="p">)))</span>

        <span class="n">kk</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_highk</span><span class="p">(</span><span class="n">kh</span><span class="p">,</span> <span class="n">pk_mass</span><span class="p">)</span>
        <span class="n">kk</span><span class="p">,</span> <span class="n">pk_cold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_highk</span><span class="p">(</span><span class="n">kh</span><span class="p">,</span> <span class="n">pk_cold</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   computed CLASS power spectrum at z=</span><span class="si">{0:.2f}</span><span class="s2"> in </span><span class="si">{1:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">compute_transfer</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;kk&#39;</span><span class="p">:</span> <span class="n">kk</span><span class="p">,</span> <span class="s1">&#39;pk_mass&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;pk_cold&#39;</span><span class="p">:</span> <span class="n">pk_cold</span><span class="p">,</span> <span class="s1">&#39;transfer&#39;</span><span class="p">:</span> <span class="n">cosmo_class</span><span class="p">,</span> <span class="s1">&#39;sigma8&#39;</span><span class="p">:</span> <span class="n">sigma8</span><span class="p">,</span> <span class="s1">&#39;fsigma8&#39;</span><span class="p">:</span> <span class="n">fsigma8</span><span class="p">,</span> <span class="s1">&#39;hubble&#39;</span><span class="p">:</span> <span class="n">hz</span><span class="p">,</span> <span class="s1">&#39;growthrate&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;growthfactor&#39;</span><span class="p">:</span> <span class="n">g</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cosmo_class</span><span class="o">.</span><span class="n">struct_cleanup</span><span class="p">()</span>
            <span class="n">cosmo_class</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;kk&#39;</span><span class="p">:</span> <span class="n">kk</span><span class="p">,</span> <span class="s1">&#39;pk_mass&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;pk_cold&#39;</span><span class="p">:</span> <span class="n">pk_cold</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_add_highk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="k">import</span> <span class="n">erf</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kh</span><span class="p">)):</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="n">kh</span> <span class="o">&lt;</span> <span class="n">kmax</span><span class="p">]</span>
            <span class="n">kh</span> <span class="o">=</span> <span class="n">kh</span><span class="p">[</span><span class="n">kh</span> <span class="o">&lt;</span> <span class="n">kmax</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kh</span><span class="p">)</span>

        <span class="n">kextend</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;kextend&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleLength</span>

        <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">kh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">kmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">kextend</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">MatchingKIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">kh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;extrapolation_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">pk_highk</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">kk</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;extrapolation_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;powerlaw&#39;</span><span class="p">:</span>
            <span class="n">pk_highk</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">kk</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kh</span><span class="p">[</span><span class="n">kh</span> <span class="o">&gt;</span> <span class="n">kmax</span><span class="o">*</span><span class="mf">0.5</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="n">kh</span> <span class="o">&gt;</span> <span class="n">kmax</span><span class="o">*</span><span class="mf">0.5</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pk_highk</span> <span class="o">=</span> <span class="n">kk</span><span class="o">**</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;extrapolation_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bardeen&#39;</span><span class="p">:</span>
            <span class="n">p_primordial</span> <span class="o">=</span> <span class="p">((</span><span class="n">kk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.05</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                            <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">])</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DeltaNeff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">7.</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">11.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span><span class="o">/</span><span class="mf">1.691</span>
            <span class="n">qq</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">*</span> <span class="n">theta</span><span class="o">**</span><span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">tb86</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.34</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.34</span> <span class="o">*</span> <span class="n">qq</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="mf">3.89</span> <span class="o">*</span> <span class="n">qq</span> <span class="o">+</span> <span class="p">(</span><span class="mf">16.1</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                                                           <span class="o">+</span> <span class="p">(</span><span class="mf">5.46</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">6.71</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">4.0</span><span class="p">))</span>

            <span class="n">pk_highk</span> <span class="o">=</span> <span class="n">p_primordial</span> <span class="o">*</span> <span class="n">tb86</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;extrapolation_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;eisenstein&#39;</span><span class="p">:</span>
            <span class="n">pk_highk</span> <span class="o">=</span> <span class="n">kk</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transferEisensteinHu</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Making sure it&#39;s continous</span>
        <span class="n">pk_highk</span> <span class="o">=</span> <span class="n">pk_highk</span><span class="o">*</span><span class="n">pk</span><span class="p">[</span><span class="n">MatchingKIndex</span><span class="p">]</span><span class="o">/</span><span class="n">pk_highk</span><span class="p">[</span><span class="n">MatchingKIndex</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">smoothfunction</span><span class="p">(</span><span class="n">edge0</span><span class="p">,</span> <span class="n">edge1</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="n">edge0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">edge1</span> <span class="o">-</span> <span class="n">edge0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

        <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">smoothfunction</span><span class="p">(</span><span class="n">kmax</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">kh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kk</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weight</span> <span class="o">*</span> <span class="n">pk</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">pk_highk</span><span class="p">[:</span><span class="n">MatchingKIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">pk_highk</span><span class="p">[</span><span class="n">MatchingKIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="k">def</span> <span class="nf">_transferEisensteinHu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">Om0</span><span class="p">,</span> <span class="n">Ob0</span><span class="p">,</span> <span class="n">Tcmb0</span><span class="o">=</span><span class="mf">2.7255</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           Eisenstein &amp; Hu power spectrum from colossus</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define shorter expressions</span>
        <span class="n">omc</span> <span class="o">=</span> <span class="n">Om0</span> <span class="o">-</span> <span class="n">Ob0</span>
        <span class="n">ombom0</span> <span class="o">=</span> <span class="n">Ob0</span> <span class="o">/</span> <span class="n">Om0</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">om0h2</span> <span class="o">=</span> <span class="n">Om0</span> <span class="o">*</span> <span class="n">h2</span>
        <span class="n">ombh2</span> <span class="o">=</span> <span class="n">Ob0</span> <span class="o">*</span> <span class="n">h2</span>
        <span class="n">theta2p7</span> <span class="o">=</span> <span class="n">Tcmb0</span> <span class="o">/</span> <span class="mf">2.7</span>
        <span class="n">theta2p72</span> <span class="o">=</span> <span class="n">theta2p7</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">theta2p74</span> <span class="o">=</span> <span class="n">theta2p72</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Convert kh from h/Mpc to 1/Mpc</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">h</span>

        <span class="c1"># Equation 2</span>
        <span class="n">zeq</span> <span class="o">=</span> <span class="mf">2.50e4</span> <span class="o">*</span> <span class="n">om0h2</span> <span class="o">/</span> <span class="n">theta2p74</span>

        <span class="c1"># Equation 3</span>
        <span class="n">keq</span> <span class="o">=</span> <span class="mf">7.46e-2</span> <span class="o">*</span> <span class="n">om0h2</span> <span class="o">/</span> <span class="n">theta2p72</span>

        <span class="c1"># Equation 4</span>
        <span class="n">b1d</span> <span class="o">=</span> <span class="mf">0.313</span> <span class="o">*</span> <span class="n">om0h2</span><span class="o">**-</span><span class="mf">0.419</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.607</span> <span class="o">*</span> <span class="n">om0h2</span><span class="o">**</span><span class="mf">0.674</span><span class="p">)</span>
        <span class="n">b2d</span> <span class="o">=</span> <span class="mf">0.238</span> <span class="o">*</span> <span class="n">om0h2</span><span class="o">**</span><span class="mf">0.223</span>
        <span class="n">zd</span> <span class="o">=</span> <span class="mf">1291.0</span> <span class="o">*</span> <span class="n">om0h2</span><span class="o">**</span><span class="mf">0.251</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.659</span> <span class="o">*</span> <span class="n">om0h2</span><span class="o">**</span><span class="mf">0.828</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b1d</span> <span class="o">*</span> <span class="n">ombh2</span><span class="o">**</span><span class="n">b2d</span><span class="p">)</span>

        <span class="c1"># Equation 5</span>
        <span class="n">Rd</span> <span class="o">=</span> <span class="mf">31.5</span> <span class="o">*</span> <span class="n">ombh2</span> <span class="o">/</span> <span class="n">theta2p74</span> <span class="o">/</span> <span class="p">(</span><span class="n">zd</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">)</span>
        <span class="n">Req</span> <span class="o">=</span> <span class="mf">31.5</span> <span class="o">*</span> <span class="n">ombh2</span> <span class="o">/</span> <span class="n">theta2p74</span> <span class="o">/</span> <span class="p">(</span><span class="n">zeq</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">)</span>

        <span class="c1"># Equation 6</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="n">keq</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="n">Req</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">Rd</span><span class="p">)</span> <span class="o">+</span>
                                                           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Rd</span> <span class="o">+</span> <span class="n">Req</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Req</span><span class="p">)))</span>

        <span class="c1"># Equation 7</span>
        <span class="n">ksilk</span> <span class="o">=</span> <span class="mf">1.6</span> <span class="o">*</span> <span class="n">ombh2</span><span class="o">**</span><span class="mf">0.52</span> <span class="o">*</span> <span class="n">om0h2</span><span class="o">**</span><span class="mf">0.73</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">10.4</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.95</span><span class="p">)</span>

        <span class="c1"># Equation 10</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">kh</span> <span class="o">/</span> <span class="mf">13.41</span> <span class="o">/</span> <span class="n">keq</span>

        <span class="c1"># Equation 11</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">46.9</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.670</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">32.1</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.532</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.424</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">45.0</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.582</span><span class="p">)</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">a1</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">ombom0</span><span class="p">)</span> <span class="o">*</span> <span class="n">a2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">ombom0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Equation 12</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="mf">0.944</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">458.0</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.708</span><span class="p">)</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.395</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.0266</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b1</span> <span class="o">*</span> <span class="p">((</span><span class="n">omc</span> <span class="o">/</span> <span class="n">Om0</span><span class="p">)</span><span class="o">**</span><span class="n">b2</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>

        <span class="c1"># Equation 15</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zeq</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zd</span><span class="p">)</span>
        <span class="n">Gy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
                  <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)))</span>

        <span class="c1"># Equation 14</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="mf">2.07</span> <span class="o">*</span> <span class="n">keq</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">Rd</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Gy</span>

        <span class="c1"># Get CDM part of transfer function</span>

        <span class="c1"># Equation 18</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">kh</span> <span class="o">*</span> <span class="n">s</span> <span class="o">/</span> <span class="mf">5.4</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Equation 20</span>
        <span class="n">C</span> <span class="o">=</span> <span class="mf">14.2</span> <span class="o">/</span> <span class="n">ac</span> <span class="o">+</span> <span class="mf">386.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">69.9</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mf">1.08</span><span class="p">)</span>

        <span class="c1"># Equation 19</span>
        <span class="n">T0t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">bc</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">bc</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>

        <span class="c1"># Equation 17</span>
        <span class="n">C1bc</span> <span class="o">=</span> <span class="mf">14.2</span> <span class="o">+</span> <span class="mf">386.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">69.9</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mf">1.08</span><span class="p">)</span>
        <span class="n">T0t1bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">bc</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">bc</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">C1bc</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">Tc</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">T0t1bc</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">T0t</span>

        <span class="c1"># Get baryon part of transfer function</span>

        <span class="c1"># Equation 24</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">ombom0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">ombom0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">17.2</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">17.2</span> <span class="o">*</span> <span class="n">om0h2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Equation 23</span>
        <span class="n">bnode</span> <span class="o">=</span> <span class="mf">8.41</span> <span class="o">*</span> <span class="n">om0h2</span><span class="o">**</span><span class="mf">0.435</span>

        <span class="c1"># Equation 22</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">bnode</span> <span class="o">/</span> <span class="n">kh</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bnode</span> <span class="o">/</span> <span class="n">kh</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bnode</span> <span class="o">/</span> <span class="n">kh</span> <span class="o">/</span> <span class="n">s</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>

        <span class="c1"># Equation 21</span>
        <span class="n">C11</span> <span class="o">=</span> <span class="mf">14.2</span> <span class="o">+</span> <span class="mf">386.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">69.9</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mf">1.08</span><span class="p">)</span>
        <span class="n">T0t11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">C11</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">Tb</span> <span class="o">=</span> <span class="p">(</span><span class="n">T0t11</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">kh</span> <span class="o">*</span> <span class="n">s</span> <span class="o">/</span> <span class="mf">5.2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ab</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">bb</span> <span class="o">/</span> <span class="n">kh</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">kh</span> <span class="o">/</span> <span class="n">ksilk</span><span class="p">)</span><span class="o">**</span><span class="mf">1.4</span><span class="p">))</span> \
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">kh</span> <span class="o">*</span> <span class="n">st</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">kh</span> <span class="o">*</span> <span class="n">st</span><span class="p">)</span>

        <span class="c1"># Total transfer function</span>
        <span class="n">Tk</span> <span class="o">=</span> <span class="n">ombom0</span> <span class="o">*</span> <span class="n">Tb</span> <span class="o">+</span> <span class="n">omc</span> <span class="o">/</span> <span class="n">Om0</span> <span class="o">*</span> <span class="n">Tc</span>

        <span class="k">return</span> <span class="n">Tk</span>

    <span class="k">def</span> <span class="nf">_sigma2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">growth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes eq A4 of Takahashi et al 2013</span>
<span class="sd">        https://arxiv.org/pdf/1208.2701.pdf</span>

<span class="sd">        :param rr: filter size in Mpc/h</span>
<span class="sd">        :growth: the growth factor to apply to P_matter(k,z=0) to get P_i(k,z)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">logk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>

        <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">dsigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">d2sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>

        <span class="n">which_pk</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">):</span>
            <span class="n">kR2</span> <span class="o">=</span> <span class="p">(</span><span class="n">kk</span> <span class="o">*</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">growth</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="n">which_pk</span><span class="p">]</span> <span class="o">*</span> <span class="n">kk</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kR2</span><span class="p">),</span> <span class="n">logk</span><span class="p">)</span>
            <span class="n">dsigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">growth</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="n">which_pk</span><span class="p">]</span>
                                         <span class="o">*</span> <span class="n">kk</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kR2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kR2</span><span class="p">),</span> <span class="n">logk</span><span class="p">)</span>
            <span class="n">d2sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">growth</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="n">which_pk</span><span class="p">]</span>
                                          <span class="o">*</span> <span class="n">kk</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kR2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">kR2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">kR2</span><span class="p">)),</span> <span class="n">logk</span><span class="p">)</span>

        <span class="n">d1</span> <span class="o">=</span> <span class="o">-</span><span class="n">dsigma</span><span class="o">/</span><span class="n">sigma</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="o">-</span><span class="n">d1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">d2sigma</span><span class="o">/</span><span class="n">sigma</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span>

    <span class="c1">#@do_profile()</span>
<div class="viewcode-block" id="Cosmology.compute_sigmaR_z0"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_sigmaR_z0">[docs]</a>    <span class="k">def</span> <span class="nf">compute_sigmaR_z0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pk_interpolated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mass variance, \sigma(R), for a given power spectrum and cosmology</span>

<span class="sd">        :param rr: filter size in Mpc/h</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>

        <span class="k">if</span> <span class="n">kk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;A power spectrum should be provided&quot;</span><span class="p">)</span>

        <span class="n">_rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>

        <span class="n">sigma</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">_rr</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cosmology.growthfactor"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.growthfactor">[docs]</a>    <span class="k">def</span> <span class="nf">growthfactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that compute growth factor at high redshift (i.e. matter-radiation regime) analytically,</span>
<span class="sd">        using Equation 5 in Gnedin et al. 2011 (http://adsabs.harvard.edu/abs/2011ApJS..194...46G), while</span>
<span class="sd">        at low redshift (i.e. matter-dark energy regime) through integration. The two regimes are linearly</span>
<span class="sd">        interpoleted following e.g.  Benedikt Diemer 2017 (https://arxiv.org/pdf/1712.04512.pdf).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">nelements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;approximate&#39;</span><span class="p">:</span>
            <span class="n">Omega_lz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_de_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">Omega_mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">gz</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">Omega_mz</span> <span class="o">/</span> <span class="p">(</span><span class="n">Omega_mz</span><span class="o">**</span><span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">7.</span><span class="p">)</span> <span class="o">-</span>
                                       <span class="n">Omega_lz</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">Omega_mz</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">Omega_lz</span><span class="o">/</span><span class="mf">70.</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">!=</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span><span class="o">+</span><span class="s2">&quot; model not valid with this growth approximation&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">gz</span> <span class="o">*</span> <span class="n">expfactor</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int_hubble&#39;</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int_growthrate&#39;</span><span class="p">:</span>

            <span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>
            <span class="n">method</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int_hubble&#39;</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>
            <span class="n">_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">growth</span><span class="p">(</span><span class="n">_aa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">],</span> <span class="n">method</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">)</span>

            <span class="c1">#if np.asarray(gg).ndim &gt; 1:</span>
            <span class="c1">#    gg = np.squeeze(gg)</span>
            <span class="c1">#    gg[i] = np.atleast_1d(gz)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ode&#39;</span><span class="p">:</span>
            <span class="c1"># sorting the expfactor array</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">expfactor</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">expfactor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="nb">sorted</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
                <span class="n">expfactor</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">sorted</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># defining the three different regimes</span>
            <span class="n">a_trans</span> <span class="o">=</span> <span class="mf">0.0001</span>
            <span class="n">trans_width</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">at1</span> <span class="o">=</span> <span class="n">a_trans</span><span class="o">/</span><span class="n">trans_width</span>
            <span class="n">at2</span> <span class="o">=</span> <span class="n">a_trans</span><span class="o">*</span><span class="n">trans_width</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>

            <span class="n">early</span> <span class="o">=</span> <span class="n">expfactor</span> <span class="o">&lt;</span> <span class="n">at1</span>
            <span class="n">late</span> <span class="o">=</span> <span class="n">expfactor</span> <span class="o">&gt;</span> <span class="n">at2</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="p">(</span><span class="n">expfactor</span> <span class="o">&gt;</span> <span class="n">at1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">expfactor</span> <span class="o">&lt;</span> <span class="n">at2</span><span class="p">)</span>

            <span class="n">exp_early</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">early</span><span class="p">]</span>
            <span class="n">exp_late</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">late</span><span class="p">]</span>
            <span class="n">exp_trans</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">trans</span><span class="p">]</span>

            <span class="c1"># high redshift</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gg</span><span class="p">[</span><span class="n">early</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_early</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">exp_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">exp_early</span><span class="o">/</span><span class="n">exp_eq</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">gg</span><span class="p">[</span><span class="n">early</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_early</span><span class="o">+</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">exp_eq</span><span class="o">+</span><span class="n">exp_eq</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">B</span>

            <span class="n">gg_early</span> <span class="o">=</span> <span class="n">gg</span><span class="p">[</span><span class="n">early</span><span class="p">]</span>

            <span class="c1"># low redshift</span>
            <span class="n">n_late</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_late</span><span class="p">)</span>
            <span class="n">gg_late</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gg</span><span class="p">[</span><span class="n">late</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">gg</span><span class="p">[</span><span class="n">late</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">ode</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
                    <span class="n">G</span><span class="p">,</span> <span class="n">G1</span> <span class="o">=</span> <span class="n">y</span>
                    <span class="n">X_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_de_z</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">dyda</span> <span class="o">=</span> <span class="p">[</span><span class="n">G1</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DE_EoS</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">X_a</span><span class="p">))</span><span class="o">*</span><span class="mi">3</span> <span class="o">*</span>
                            <span class="n">G1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">X_a</span><span class="o">*</span><span class="n">G</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">X_a</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
                    <span class="c1"># dyda=[G1,-(7/2-3/2*self.DE_EoS(1/a-1)/(1+X_a))*G1/(a)-3/2*(1-self.DE_EoS(1/a-1))*G/(2*(1+X_a)*a**2)]</span>
                    <span class="k">return</span> <span class="n">dyda</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">g0</span> <span class="o">=</span> <span class="mf">1e-4</span>
                <span class="n">deriv_g0</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="p">[</span><span class="n">g0</span><span class="p">,</span> <span class="n">deriv_g0</span><span class="p">]</span>
                <span class="n">GG</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">gg_late</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">exp_late</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">GG</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">derivative</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">GG</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">deriv_gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">GG</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gf&#39;</span><span class="p">:</span> <span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;deriv&#39;</span><span class="p">:</span> <span class="n">deriv_gg</span><span class="p">}</span>
                <span class="n">gg</span><span class="p">[</span><span class="n">late</span><span class="p">]</span> <span class="o">=</span> <span class="n">gg_late</span>
                <span class="c1"># transition</span>
                <span class="n">exp_earlate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">exp_early</span><span class="p">,</span> <span class="n">exp_late</span><span class="p">))</span>
                <span class="n">gg_earlate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">gg_early</span><span class="p">,</span> <span class="n">gg_late</span><span class="p">))</span>
                <span class="n">gg_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">exp_trans</span><span class="p">,</span> <span class="n">exp_earlate</span><span class="p">,</span> <span class="n">gg_earlate</span><span class="p">)</span>

                <span class="n">gg</span><span class="p">[</span><span class="n">trans</span><span class="p">]</span> <span class="o">=</span> <span class="n">gg_trans</span>
            <span class="k">if</span> <span class="nb">sorted</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">gg</span> <span class="o">=</span> <span class="n">gg</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">gg</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">wavemode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">wavemode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">wavemode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabGrowth</span><span class="p">[</span><span class="s1">&#39;Dinterp_cold&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">wavemode</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabGrowth</span><span class="p">[</span><span class="s1">&#39;Dinterp&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">wavemode</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))))</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;no_cengine&#39;</span><span class="p">:</span>
            <span class="c1"># sorting the expfactor array</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">expfactor</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">expfactor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="nb">sorted</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
                <span class="n">expfactor</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">sorted</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># defining the three different regimes</span>
            <span class="n">a_trans</span> <span class="o">=</span> <span class="mf">0.0001</span>
            <span class="n">trans_width</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">at1</span> <span class="o">=</span> <span class="n">a_trans</span><span class="o">/</span><span class="n">trans_width</span>
            <span class="n">at2</span> <span class="o">=</span> <span class="n">a_trans</span><span class="o">*</span><span class="n">trans_width</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>

            <span class="n">early</span> <span class="o">=</span> <span class="n">expfactor</span> <span class="o">&lt;</span> <span class="n">at1</span>
            <span class="n">late</span> <span class="o">=</span> <span class="n">expfactor</span> <span class="o">&gt;</span> <span class="n">at2</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="p">(</span><span class="n">expfactor</span> <span class="o">&gt;</span> <span class="n">at1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">expfactor</span> <span class="o">&lt;</span> <span class="n">at2</span><span class="p">)</span>

            <span class="n">exp_early</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">early</span><span class="p">]</span>
            <span class="n">exp_late</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">late</span><span class="p">]</span>
            <span class="n">exp_trans</span> <span class="o">=</span> <span class="n">expfactor</span><span class="p">[</span><span class="n">trans</span><span class="p">]</span>

            <span class="c1"># high redshift</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gg</span><span class="p">[</span><span class="n">early</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_early</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">exp_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">exp_early</span><span class="o">/</span><span class="n">exp_eq</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">gg</span><span class="p">[</span><span class="n">early</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_early</span><span class="o">+</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">exp_eq</span><span class="o">+</span><span class="n">exp_eq</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">B</span>

            <span class="n">gg_early</span> <span class="o">=</span> <span class="n">gg</span><span class="p">[</span><span class="n">early</span><span class="p">]</span>

            <span class="c1"># low redshift</span>
            <span class="n">n_late</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_late</span><span class="p">)</span>
            <span class="n">gg_late</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gg</span><span class="p">[</span><span class="n">late</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">gg</span><span class="p">[</span><span class="n">late</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">growth_integrand</span><span class="p">(</span><span class="n">expfactor</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
                        <span class="n">eta</span> <span class="o">=</span> <span class="n">expfactor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
                        <span class="n">gi</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">eta</span><span class="o">**</span><span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gi</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">expfactor</span>
                    <span class="k">return</span> <span class="n">gi</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
                    <span class="c1"># See, e.g. http://arxiv.org/pdf/astro-ph/0006089v3.pdf</span>
                    <span class="n">integral</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">growth_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exp_late</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">gg_late</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="o">/</span><span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">exp_late</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">integral</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_late</span><span class="p">):</span>
                        <span class="n">integral</span> <span class="o">+=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">growth_integrand</span><span class="p">,</span> <span class="n">exp_late</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">exp_late</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">norm</span> <span class="o">=</span> <span class="mi">5</span><span class="o">/</span><span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">exp_late</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">gg_late</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">integral</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa_steigerwald&#39;</span><span class="p">:</span>
                    <span class="c1"># See, e.g. https://arxiv.org/pdf/astro-ph/0507263.pdf</span>
                    <span class="n">integral</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">growth_integrand</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">exp_late</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">gg_late</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_late</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">integral</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_late</span><span class="p">):</span>
                        <span class="n">integral</span> <span class="o">+=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">growth_integrand</span><span class="p">,</span> <span class="n">exp_late</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">exp_late</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">gg_late</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_late</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">integral</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># See, e.g.   https://arxiv.org/pdf/astro-ph/0305286.pdf</span>
                    <span class="c1">#     and    http://home.fnal.gov/~dodelson/pritchard.pdf</span>
                    <span class="k">def</span> <span class="nf">ode</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
                        <span class="n">G</span><span class="p">,</span> <span class="n">G1</span> <span class="o">=</span> <span class="n">y</span>
                        <span class="n">X_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_de_z</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="n">dyda</span> <span class="o">=</span> <span class="p">[</span><span class="n">G1</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DE_EoS</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">X_a</span><span class="p">))</span><span class="o">*</span><span class="mi">3</span> <span class="o">*</span>
                                <span class="n">G1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">X_a</span><span class="o">*</span><span class="n">G</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">X_a</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
                        <span class="c1"># dyda=[G1,-(7/2-3/2*self.DE_EoS(1/a-1)/(1+X_a))*G1/(a)-3/2*(1-self.DE_EoS(1/a-1))*G/(2*(1+X_a)*a**2)]</span>
                        <span class="k">return</span> <span class="n">dyda</span>

                    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="n">g0</span> <span class="o">=</span> <span class="mf">1e-4</span>
                    <span class="n">deriv_g0</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="p">[</span><span class="n">g0</span><span class="p">,</span> <span class="n">deriv_g0</span><span class="p">]</span>
                    <span class="n">GG</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">gg_late</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">exp_late</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">GG</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">derivative</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">GG</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="n">deriv_gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">GG</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gf&#39;</span><span class="p">:</span> <span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;deriv&#39;</span><span class="p">:</span> <span class="n">deriv_gg</span><span class="p">}</span>

                <span class="n">gg</span><span class="p">[</span><span class="n">late</span><span class="p">]</span> <span class="o">=</span> <span class="n">gg_late</span>

                <span class="c1"># transition</span>
                <span class="n">exp_earlate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">exp_early</span><span class="p">,</span> <span class="n">exp_late</span><span class="p">))</span>
                <span class="n">gg_earlate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">gg_early</span><span class="p">,</span> <span class="n">gg_late</span><span class="p">))</span>
                <span class="n">gg_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">exp_trans</span><span class="p">,</span> <span class="n">exp_earlate</span><span class="p">,</span> <span class="n">gg_earlate</span><span class="p">)</span>

                <span class="n">gg</span><span class="p">[</span><span class="n">trans</span><span class="p">]</span> <span class="o">=</span> <span class="n">gg_trans</span>

            <span class="k">if</span> <span class="nb">sorted</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">gg</span> <span class="o">=</span> <span class="n">gg</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">gg</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">reps_boundary_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundary_expfactor</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]):</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.02</span>
        <span class="n">amean</span> <span class="o">=</span> <span class="n">boundary_expfactor</span>
        <span class="n">aplus</span> <span class="o">=</span> <span class="n">boundary_expfactor</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">aminus</span> <span class="o">=</span> <span class="n">boundary_expfactor</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">tol</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CAMB&#39;</span><span class="p">:</span>
            <span class="c1"># T0     = self._compute_camb_spectrum(expfactor=1.0,  ret_transfer=True)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">amean</span><span class="p">,</span>  <span class="n">ret_transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Tplus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">aplus</span><span class="p">,</span>  <span class="n">ret_transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Tminus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">aminus</span><span class="p">,</span> <span class="n">ret_transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># T0     = T.transfer_data</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">transfer_data</span>
            <span class="n">Tplus</span> <span class="o">=</span> <span class="n">Tplus</span><span class="o">.</span><span class="n">transfer_data</span>
            <span class="n">Tminus</span> <span class="o">=</span> <span class="n">Tminus</span><span class="o">.</span><span class="n">transfer_data</span>

            <span class="n">k</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">betab</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fzib</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Tplus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tminus</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fzic</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Tplus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tminus</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">Tc</span><span class="p">,</span> <span class="n">Tb</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">betan</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">Dn</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># / T0[5].flatten()</span>
                <span class="n">fzin</span> <span class="o">=</span> <span class="p">((</span><span class="n">Tplus</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">Tminus</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">/</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">/</span> <span class="n">Dn</span>
                <span class="n">Tn</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">betan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                <span class="n">fzin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                <span class="n">Tn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span><span class="p">:</span>
            <span class="c1"># aclass = min([1.0, amean, aplus, aminus])</span>
            <span class="c1"># class_transfers = self._compute_class_spectrum(expfactor=aclass,  ret_transfer=True)</span>
            <span class="k">if</span> <span class="s1">&#39;transfer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_tabPowerSpectrum_z0&#39;</span><span class="p">])</span>
            <span class="n">class_transfers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;transfer&#39;</span><span class="p">]</span>
            <span class="c1"># T0     = class_transfers.get_transfer(z=1.0/1.0-1.0)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">class_transfers</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">amean</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">Tplus</span> <span class="o">=</span> <span class="n">class_transfers</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">aplus</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">Tminus</span> <span class="o">=</span> <span class="n">class_transfers</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">aminus</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="n">k</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]</span>
            <span class="n">betab</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">]</span>
            <span class="n">fzib</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Tplus</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tminus</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span>
            <span class="n">fzic</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Tplus</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tminus</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span>

            <span class="n">Tc</span><span class="p">,</span> <span class="n">Tb</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_radiation</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.545454</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
                <span class="n">betab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">betab</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
                <span class="n">gammab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fzib</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">fzic</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
                <span class="n">cdm_frac</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">gammab</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">betab</span> <span class="o">*</span> <span class="n">gammab</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">])</span>
                <span class="n">fzic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_cold_z</span><span class="p">(</span><span class="n">amean</span><span class="p">)</span><span class="o">**</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">cdm_frac</span><span class="p">)</span>
                <span class="n">fzib</span> <span class="o">=</span> <span class="n">gammab</span> <span class="o">*</span> <span class="n">fzic</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">betan</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">])</span>
                <span class="n">Dn</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span>  <span class="c1"># / T0[&#39;d_ncdm[0]&#39;]</span>
                <span class="n">fzin</span> <span class="o">=</span> <span class="p">((</span><span class="n">Tplus</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tminus</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span> <span class="o">/</span> <span class="n">Dn</span>
                <span class="n">Tn</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">betan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]))</span>
                <span class="n">fzin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]))</span>
                <span class="n">Tn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Error: bacco.Cosmology.pkfile = </span><span class="si">{}</span><span class="s1"> does not support transfers. A trasfer will be assigned via CLASS&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Warning: this method can be very slow as it calls CLASS multiple times. &#39;</span>
                           <span class="o">+</span> <span class="s1">&#39;Please, consider running a cosmology with pkfile = CLASS/CAMB.&#39;</span><span class="p">)</span>
            <span class="n">aclass</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">amean</span><span class="p">,</span> <span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">])</span>
            <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_class_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">aclass</span><span class="p">,</span>  <span class="n">compute_transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">class_transfers</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="s1">&#39;transfer&#39;</span><span class="p">]</span>
            <span class="c1"># class_transfers = self._tabPowerSpectrum_z0[&#39;transfer&#39;]</span>
            <span class="c1"># T0     = class_transfers.get_transfer(z=1.0/1.0-1.0)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">class_transfers</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">amean</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">Tplus</span> <span class="o">=</span> <span class="n">class_transfers</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">aplus</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">Tminus</span> <span class="o">=</span> <span class="n">class_transfers</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">aminus</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="n">k</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]</span>
            <span class="n">betab</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">]</span>
            <span class="n">fzib</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Tplus</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tminus</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span>
            <span class="n">fzic</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Tplus</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tminus</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span>

            <span class="n">Tc</span><span class="p">,</span> <span class="n">Tb</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_b&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">betan</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_cdm&#39;</span><span class="p">])</span>
                <span class="n">Dn</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span>  <span class="c1"># / T0[&#39;d_ncdm[0]&#39;]</span>
                <span class="n">fzin</span> <span class="o">=</span> <span class="p">((</span><span class="n">Tplus</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tminus</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aplus</span> <span class="o">/</span> <span class="n">aminus</span><span class="p">))</span> <span class="o">/</span> <span class="n">Dn</span>
                <span class="n">Tn</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="s1">&#39;d_ncdm[0]&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">betan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]))</span>
                <span class="n">fzin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]))</span>
                <span class="n">Tn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;k (h/Mpc)&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fzin</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;in REPS boundary conditions, fzin contains nan values&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;   computed boundary conditions for reps using </span><span class="si">{0}</span><span class="s1"> in </span><span class="si">{1:.3}</span><span class="s1"> secs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tstart</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;boundary_expfactor&#39;</span><span class="p">:</span> <span class="n">boundary_expfactor</span><span class="p">,</span>
                       <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                       <span class="s1">&#39;betab&#39;</span><span class="p">:</span> <span class="n">betab</span><span class="p">,</span>
                       <span class="s1">&#39;betan&#39;</span><span class="p">:</span> <span class="n">betan</span><span class="p">,</span>
                       <span class="s1">&#39;fzib&#39;</span><span class="p">:</span> <span class="n">fzib</span><span class="p">,</span>
                       <span class="s1">&#39;fzic&#39;</span><span class="p">:</span> <span class="n">fzic</span><span class="p">,</span>
                       <span class="s1">&#39;fzin&#39;</span><span class="p">:</span> <span class="n">fzin</span><span class="p">,</span>
                       <span class="s1">&#39;kmax&#39;</span><span class="p">:</span> <span class="n">kmax</span><span class="p">,</span>
                       <span class="s1">&#39;boltz_Tc&#39;</span> <span class="p">:</span> <span class="n">Tc</span><span class="p">,</span>
                       <span class="s1">&#39;boltz_Tb&#39;</span> <span class="p">:</span> <span class="n">Tb</span><span class="p">,</span>
                       <span class="s1">&#39;boltz_Tn&#39;</span> <span class="p">:</span> <span class="n">Tn</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">reps_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">betab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">betan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fzib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fzic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fzin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_expfactor</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                    <span class="n">kmax</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]):</span>

        <span class="kn">from</span> <span class="nn">bacco.reps.reps</span> <span class="k">import</span> <span class="n">_getgrowths</span>

        <span class="n">tab_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/reps/FF_GG_func_tab.dat&#39;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;repsBC&#39;</span><span class="p">):</span>
            <span class="n">boundary_expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;boundary_expfactor&#39;</span><span class="p">]</span>
            <span class="n">kmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;kmax&#39;</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
            <span class="n">betab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;betab&#39;</span><span class="p">]</span>
            <span class="n">betan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;betan&#39;</span><span class="p">]</span>
            <span class="n">fzib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;fzib&#39;</span><span class="p">]</span>
            <span class="n">fzic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;fzic&#39;</span><span class="p">]</span>
            <span class="n">fzin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;fzin&#39;</span><span class="p">]</span>

        <span class="n">z_initial</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">boundary_expfactor</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">z</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># sort works in-place</span>

        <span class="n">db</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fm</span> <span class="o">=</span> <span class="n">_getgrowths</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">betab</span><span class="p">,</span> <span class="n">betan</span><span class="p">,</span>
                                                     <span class="n">fzib</span><span class="p">,</span> <span class="n">fzic</span><span class="p">,</span> <span class="n">fzin</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_photons&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">],</span>
                                                     <span class="n">kmax</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DeltaNeff&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">],</span>
                                                     <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;approx_nu&#39;</span><span class="p">]),</span>
                                                     <span class="n">tab_dir</span><span class="p">,</span>
                                                     <span class="n">z_initial</span><span class="p">,</span>
                                                     <span class="n">z</span><span class="p">,</span>
                                                     <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s1">&#39;Dbaryon&#39;</span><span class="p">:</span> <span class="n">db</span><span class="p">,</span>
                <span class="s1">&#39;Dcdm&#39;</span><span class="p">:</span> <span class="n">dc</span><span class="p">,</span>
                <span class="s1">&#39;Dneutrino&#39;</span><span class="p">:</span> <span class="n">dn</span><span class="p">,</span>
                <span class="s1">&#39;Dmatter&#39;</span><span class="p">:</span> <span class="n">dm</span><span class="p">,</span>
                <span class="s1">&#39;fbaryon&#39;</span><span class="p">:</span> <span class="n">fb</span><span class="p">,</span>
                <span class="s1">&#39;fcdm&#39;</span><span class="p">:</span> <span class="n">fc</span><span class="p">,</span>
                <span class="s1">&#39;fneutrino&#39;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span>
                <span class="s1">&#39;fmatter&#39;</span><span class="p">:</span> <span class="n">fm</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">growthfactorD2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_u32_integrand</span><span class="p">(</span><span class="n">expfactor</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">expfactor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span><span class="o">**</span><span class="mf">3.0</span>

        <span class="k">def</span> <span class="nf">_u52_integrand</span><span class="p">(</span><span class="n">expfactor</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">expfactor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span><span class="o">**</span><span class="mf">5.0</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;reps&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Warning! 2LPT growth factor with reps not yet implemented&#39;</span><span class="p">)</span>
            <span class="n">D1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Om</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">Ol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_de_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">hubble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="n">u32fac</span> <span class="o">=</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hubble</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_u32_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u52fac</span> <span class="o">=</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">hubble</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_u52_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ggD2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">7.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">D1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Om</span><span class="o">/</span><span class="mf">4.0</span> <span class="o">-</span> <span class="n">Ol</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">((</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">u52fac</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">u32fac</span><span class="p">)))</span><span class="o">/</span><span class="n">u32fac</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">ggD2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">growthfactorD3a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;reps&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Warning! 3LPT growth factor (3a) with reps not yet implemented&#39;</span><span class="p">)</span>
            <span class="n">Di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="o">-</span><span class="n">Di</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">4.</span><span class="o">/</span><span class="mf">275.</span><span class="p">)</span><span class="o">/</span><span class="mf">9.</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">growthfactorD3b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;reps&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;  Warning! 3LPT growth factor (3b) with reps not yet implemented&#39;</span><span class="p">)</span>
            <span class="n">Di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">Di</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">269.</span><span class="o">/</span><span class="mf">17875.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">5.</span><span class="o">/</span><span class="mf">42.</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">dgrowthfactor_dz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">growthfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">growthfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">growthfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">growthfactor</span> <span class="o">*</span> <span class="n">expfactor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">gamma_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa&#39;</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">redshift</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span>
            <span class="c1"># Linder 2005 ( https://arxiv.org/pdf/astro-ph/0507263.pdf )</span>
            <span class="n">fact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">redshift</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">redshift</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DE_EoS</span><span class="p">(</span><span class="n">redshift</span><span class="o">=</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">fact</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.02</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fact</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.55</span><span class="o">+</span><span class="n">fact</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">DE_EoS</span><span class="p">(</span><span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Steigerwald,Bel and Marinoni 2014  ( https://arxiv.org/pdf/1403.0898.pdf )</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">omega_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">gamma</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gammas</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">omega_a</span><span class="p">)</span><span class="o">**</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gamma</span>

    <span class="k">def</span> <span class="nf">growthrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa_steigerwald&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="s1">&#39;reps&#39;</span><span class="p">]):</span>
            <span class="n">omega_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">gamma_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">omega_a</span><span class="p">,</span> <span class="n">gamma_a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">:</span>  <span class="c1"># TODO: better integration between nuCDM and wCDM models</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># This is a sensible k as it is already in the scale independent limit but not too much in the nonlinear regime</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loggrowth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span> <span class="c1"># with nus, get_loggrowth_z returns f</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># gr = self.growthfactor(expfactor, derivative=True)[</span>
            <span class="c1">#     &#39;deriv&#39;]*expfactor/self.growthfactor(expfactor, derivative=True)[&#39;gf&#39;]</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;deriv&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">expfactor</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;gf&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">gr</span>

    <span class="k">def</span> <span class="nf">DE_EoS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>
        <span class="n">redshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;LCDM&#39;</span><span class="p">:</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">redshift</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa_steigerwald&#39;</span><span class="p">:</span>
            <span class="c1"># Steigerwald,Bel and Marinoni 2014  ( https://arxiv.org/pdf/1403.0898.pdf )</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Gammas</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">expfactor</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wi</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;w0wa&#39;</span><span class="p">:</span>
            <span class="c1"># Polarski and Linder Parametrization (Polarski,2001;Linder,2003)</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">redshift</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;from_function&#39;</span><span class="p">:</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_z_de</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;from_file&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_model</span> <span class="o">==</span> <span class="s1">&#39;from_arrays&#39;</span><span class="p">:</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">redshift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift_de</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_z_de</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dark Energy EoS not valid&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wz</span>

    <span class="k">def</span> <span class="nf">sigma8_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fsigma8_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma8_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>

<div class="viewcode-block" id="Cosmology.Kaiser_boost"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.Kaiser_boost">[docs]</a>    <span class="k">def</span> <span class="nf">Kaiser_boost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the Kaiser boost at a given expfactor and for a given bias</span>
<span class="sd">        parameter (default = 1), for different multipole expansion orders:</span>
<span class="sd">        l = 0, monopole</span>
<span class="sd">        l = 2, quadrupole</span>
<span class="sd">        l = 4, hexadecapole</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">bias</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">35.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">K</span></div>

<div class="viewcode-block" id="Cosmology.Kaiser_moments"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.Kaiser_moments">[docs]</a>    <span class="k">def</span> <span class="nf">Kaiser_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the Kaiser boost at a given expfactor and for a given bias</span>
<span class="sd">        parameter (default = 1), for different moments of the power spectrum:</span>
<span class="sd">        l = 0, l = 2,  l = 4</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">bias</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="mf">5.0</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">5.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="mf">7.0</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">9.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">K</span></div>

<div class="viewcode-block" id="Cosmology.vel_factor"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.vel_factor">[docs]</a>    <span class="k">def</span> <span class="nf">vel_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the multiplicative factor Dv: v(q) = Dv Psi(q), where Psi is the displacemnt field</span>

<span class="sd">        In case of scaling with massive neutrinos:</span>
<span class="sd">        growthrate will be taken by default at k = 0.5 h/Mpc. This is fine</span>
<span class="sd">        as long as this correction is applied to scales below the free streaming scale,</span>
<span class="sd">        while for larger scales the matching of velocities is taken care of by the</span>
<span class="sd">        large scale correction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hubble_a</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">d_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expfactor</span> <span class="o">*</span> <span class="n">hubble_a</span> <span class="o">*</span> <span class="n">d_rate</span></div>

<div class="viewcode-block" id="Cosmology.compute_massfunction"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_massfunction">[docs]</a>    <span class="k">def</span> <span class="nf">compute_massfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;nufnu&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">][</span><span class="s1">&#39;mass_function&#39;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">qty</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nufnu&#39;</span><span class="p">,</span> <span class="s1">&#39;dn_dlnM&#39;</span><span class="p">,</span> <span class="s1">&#39;dn_dlnM_sub&#39;</span><span class="p">,</span> <span class="s1">&#39;nufnu_sub&#39;</span><span class="p">,</span> <span class="s1">&#39;fnu&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;despali16&#39;</span><span class="p">,</span> <span class="s1">&#39;angulo12&#39;</span><span class="p">,</span> <span class="s1">&#39;musso12&#39;</span><span class="p">,</span> <span class="s1">&#39;jenkins01&#39;</span><span class="p">,</span> <span class="s1">&#39;PS74&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span>

        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;At least one, nu or Mass, should be provided&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not yet implemented&quot;</span><span class="p">)</span>
        <span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span>

        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">_mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">delta_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">nu</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;despali16&#39;</span><span class="p">:</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="mf">0.7689</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="mf">0.2536</span>
            <span class="n">Amp</span> <span class="o">=</span> <span class="mf">0.3295</span>
            <span class="c1">#nu_p = a * delta_c**2 / sigma**2</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#    Delta = mass_so.densityThreshold(z, mdef)</span>
        <span class="c1">#    Delta_vir = mass_so.densityThreshold(z, &#39;vir&#39;)</span>
        <span class="c1">#    x = np.log10(Delta / Delta_vir)</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="mf">0.4332</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.2263</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.7665</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1151</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.2554</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.2488</span>
            <span class="n">Amp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1362</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.3292</span>

            <span class="n">aanu</span> <span class="o">=</span> <span class="n">aa</span><span class="o">*</span><span class="n">nu</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">nufnu</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">Amp</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">aanu</span><span class="o">**-</span><span class="n">pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">aanu</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">aanu</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;musso12&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">special</span> <span class="k">as</span> <span class="n">sp</span>
            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">nu</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">X</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">W1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span>
            <span class="k">def</span> <span class="nf">W2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">W1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span>

            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">)</span>
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">pk</span><span class="o">*</span><span class="n">W1</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">R</span><span class="p">])</span>
            <span class="n">sigma0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
            <span class="c1">#nu = 1.686/sigma0</span>

            <span class="n">var_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">k</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">pk</span><span class="o">*</span><span class="n">W2</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">R</span><span class="p">])</span>
            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_x</span><span class="p">)</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">k</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">pk</span><span class="o">*</span><span class="n">W1</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">W2</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">R</span><span class="p">])</span><span class="o">/</span><span class="n">sigma0</span><span class="o">/</span><span class="n">sigma_x</span>
            <span class="n">Gamma</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">Gamma</span><span class="o">*</span><span class="n">nu</span>

            <span class="n">nufnu</span> <span class="o">=</span> <span class="n">nu</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;angulo12&#39;</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">delta_c</span><span class="o">/</span><span class="n">nu</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="mf">0.7689</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="mf">0.2536</span>
            <span class="n">Amp</span> <span class="o">=</span> <span class="mf">0.3295</span>
            <span class="n">nufnu</span> <span class="o">=</span> <span class="n">Amp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">aa</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">**</span><span class="n">pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">aa</span><span class="o">*</span><span class="n">nu</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">aa</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span>
            <span class="n">nufnu</span> <span class="o">=</span> <span class="mf">0.201</span> <span class="o">*</span> <span class="p">((</span><span class="mf">2.08</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mf">1.7</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.172</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;_sub&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qty</span><span class="p">:</span>
                <span class="n">nufnu</span> <span class="o">=</span> <span class="mf">0.201</span> <span class="o">*</span> <span class="p">((</span><span class="mf">2.08</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mf">1.7</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.172</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nufnu</span> <span class="o">=</span> <span class="mf">0.265</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.675</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mf">1.9</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.4</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;PS74&#39;</span><span class="p">:</span>
            <span class="n">nufnu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">nu</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;jenkins01&#39;</span><span class="p">:</span>
            <span class="n">nufnu</span> <span class="o">=</span> <span class="mf">0.315</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.61</span><span class="p">)</span><span class="o">**</span><span class="mf">3.8</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   computed mass function relation at z=</span><span class="si">{0:.2f}</span><span class="s2"> in </span><span class="si">{1:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;nufnu&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nufnu</span>

        <span class="k">if</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;fnu&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nufnu</span><span class="o">/</span><span class="n">nu</span>

        <span class="k">if</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;dn_dlnM&#39;</span> <span class="ow">or</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;dn_dlnM_sub&#39;</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">_mass</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_cold_z</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dlnS_dlnR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dlnS_dlnR</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">dn_dlnM</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">nufnu</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">/</span> <span class="n">_mass</span> <span class="o">*</span> <span class="n">dlnS_dlnR</span>
            <span class="k">return</span> <span class="n">dn_dlnM</span>

        <span class="k">return</span> <span class="n">nufnu</span><span class="o">*</span><span class="n">nu</span></div>


<div class="viewcode-block" id="Cosmology.compute_biasfunction"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_biasfunction">[docs]</a>    <span class="k">def</span> <span class="nf">compute_biasfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Delta</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mowhite96&#39;</span><span class="p">,</span> <span class="s1">&#39;sheth01&#39;</span><span class="p">,</span> <span class="s1">&#39;tinker10&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span>

        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;At least one, nu or Mass, should be provided&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not yet implemented&quot;</span><span class="p">)</span>
<span class="c1">#            mass = self.nu_to_mass(nu, expfactor=expfactor)</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">delta_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">nu</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   computed bias function relation at z=</span><span class="si">{0:.2f}</span><span class="s2"> in </span><span class="si">{1:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="mf">1.</span><span class="o">/</span><span class="n">expfactor</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;mowhite96&#39;</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">nu</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta_c</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;sheth01&#39;</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">0.707</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">0.6</span>
            <span class="n">roota</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">anu2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">nu</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">anu2c</span> <span class="o">=</span> <span class="n">anu2</span><span class="o">**</span><span class="n">c</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">roota</span> <span class="o">*</span> <span class="n">delta_c</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">roota</span> <span class="o">*</span> <span class="n">anu2</span> <span class="o">+</span> <span class="n">roota</span> <span class="o">*</span>
                                                    <span class="n">b</span> <span class="o">*</span> <span class="n">anu2</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">anu2c</span> <span class="o">/</span> <span class="p">(</span><span class="n">anu2c</span> <span class="o">+</span> <span class="n">t1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;tinker10&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Delta</span><span class="p">)</span>

            <span class="n">A</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.24</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">0.44</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">0.88</span>
            <span class="n">B</span> <span class="o">=</span> <span class="mf">0.183</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="n">C</span> <span class="o">=</span> <span class="mf">0.019</span> <span class="o">+</span> <span class="mf">0.107</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.19</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">2.4</span>

            <span class="n">bias</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">A</span> <span class="o">*</span> <span class="n">nu</span><span class="o">**</span><span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="n">nu</span><span class="o">**</span><span class="n">a</span> <span class="o">+</span> <span class="mf">1.68647</span><span class="o">**</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">nu</span><span class="o">**</span><span class="n">b</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">nu</span><span class="o">**</span><span class="n">c</span>

        <span class="k">return</span> <span class="n">bias</span></div>

    <span class="c1">#@do_profile()</span>
<div class="viewcode-block" id="Cosmology.compute_halofit"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_halofit">[docs]</a>    <span class="k">def</span> <span class="nf">compute_halofit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boltzmann_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementation of Halofit alla Takahashi et al 2013: http://arxiv.org/pdf/1208.2701v2.pdf</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span>

        <span class="k">if</span> <span class="n">boltzmann_solver</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CAMB&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span>
                    <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">bardeen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nonlinear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_class_spectrum</span><span class="p">(</span>
                    <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">nonlinear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pk_nonlinear</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_mass&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cold</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_cold&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">omega_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_cold_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
                <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>

            <span class="n">f1</span> <span class="o">=</span> <span class="n">omega_z</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0307</span><span class="p">)</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="n">omega_z</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0585</span><span class="p">)</span>
            <span class="n">f3</span> <span class="o">=</span> <span class="n">omega_z</span><span class="o">**</span><span class="p">(</span><span class="mf">0.0743</span><span class="p">)</span>

            <span class="c1"># Construct sigma2 (eq. A4)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sigma2</span><span class="p">,</span> <span class="n">dlogSigma</span><span class="p">,</span> <span class="n">dlogSigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma2</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">growth</span><span class="o">=</span><span class="n">growth</span><span class="p">)</span>
            <span class="c1"># sigma2 *= growth**2</span>

            <span class="n">R_nonlinear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">radius</span><span class="p">))))</span>
            <span class="n">neff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R_nonlinear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">dlogSigma</span><span class="p">)</span>
            <span class="n">CC</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R_nonlinear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">dlogSigma2</span><span class="p">)</span>

            <span class="n">kk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">*</span> <span class="n">R_nonlinear</span>

            <span class="n">aa_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5222</span> <span class="o">+</span> <span class="mf">2.8553</span><span class="o">*</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">2.3706</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.9903</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span>
                         <span class="mf">0.2250</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mf">0.6038</span><span class="o">*</span><span class="n">CC</span> <span class="o">+</span> <span class="mf">0.1749</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_de</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]))</span>
            <span class="n">bb_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5642</span> <span class="o">+</span> <span class="mf">0.5864</span><span class="o">*</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">0.5716</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.5474</span><span class="o">*</span><span class="n">CC</span> <span class="o">+</span>
                         <span class="mf">0.2279</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_de</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]))</span>
            <span class="n">cc_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">0.3698</span> <span class="o">+</span> <span class="mf">2.0404</span><span class="o">*</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">0.8161</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5869</span><span class="o">*</span><span class="n">CC</span><span class="p">)</span>
            <span class="n">gamma_n</span> <span class="o">=</span> <span class="mf">0.1971</span> <span class="o">-</span> <span class="mf">0.0843</span><span class="o">*</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">0.8460</span><span class="o">*</span><span class="n">CC</span>
            <span class="n">alpha_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="mf">6.0835</span> <span class="o">+</span> <span class="mf">1.3373</span><span class="o">*</span><span class="n">neff</span> <span class="o">-</span> <span class="mf">0.1959</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">5.5274</span><span class="o">*</span><span class="n">CC</span><span class="p">)</span>
            <span class="n">beta_n</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0379</span> <span class="o">-</span> <span class="mf">0.7354</span><span class="o">*</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">0.3157</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1.2490</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span>
                      <span class="mf">0.3980</span><span class="o">*</span><span class="n">neff</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mf">0.1682</span><span class="o">*</span><span class="n">CC</span><span class="p">)</span>
            <span class="n">mu_n</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">nu_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">5.2105</span> <span class="o">+</span> <span class="mf">3.6902</span><span class="o">*</span><span class="n">neff</span><span class="p">)</span>

            <span class="n">PL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">Delta_L</span> <span class="o">=</span> <span class="n">kk</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">PL</span> <span class="o">*</span> <span class="n">growth</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">Delta_Q</span> <span class="o">=</span> <span class="p">(</span><span class="n">Delta_L</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Delta_L</span><span class="p">)</span><span class="o">**</span><span class="n">beta_n</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha_n</span> <span class="o">*</span> <span class="n">Delta_L</span><span class="p">))</span>
                       <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yy</span><span class="o">/</span><span class="mf">4.0</span> <span class="o">-</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">8.0</span><span class="p">))</span>

            <span class="n">Delta_Hprime</span> <span class="o">=</span> <span class="n">aa_n</span> <span class="o">*</span> <span class="n">yy</span><span class="o">**</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">f1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bb_n</span><span class="o">*</span><span class="n">yy</span><span class="o">**</span><span class="n">f2</span> <span class="o">+</span> <span class="p">(</span><span class="n">cc_n</span><span class="o">*</span><span class="n">f3</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">gamma_n</span><span class="p">))</span>
            <span class="n">Delta_H</span> <span class="o">=</span> <span class="n">Delta_Hprime</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu_n</span> <span class="o">/</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">nu_n</span><span class="o">/</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">Delta</span> <span class="o">=</span> <span class="n">Delta_Q</span> <span class="o">+</span> <span class="n">Delta_H</span>
            <span class="n">pk_nonlinear</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">kk</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">Delta</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   computed halofit at z=</span><span class="si">{0:.2f}</span><span class="s2"> for &#39;</span><span class="si">{1}</span><span class="s2">&#39; in </span><span class="si">{2:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="mf">1.</span><span class="o">/</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pk_nonlinear</span></div>


    <span class="k">def</span> <span class="nf">compute_bispectrum_k3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">k1</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>


<div class="viewcode-block" id="Cosmology.compute_bihalofit"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_bihalofit">[docs]</a>    <span class="k">def</span> <span class="nf">compute_bihalofit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementation of Halofit alla Takahashi et al 2019: 1911.07886</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span>

        <span class="n">omega_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_cold_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">cold</span><span class="o">=</span><span class="n">cold</span><span class="p">)</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="n">omega_z</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0307</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">omega_z</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0585</span><span class="p">)</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">omega_z</span><span class="o">**</span><span class="p">(</span><span class="mf">0.0743</span><span class="p">)</span>

        <span class="c1"># Construct sigma2 (eq. B1)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sigma2</span><span class="p">,</span> <span class="n">dlogSigma</span><span class="p">,</span> <span class="n">dlogSigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma2</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">growth</span><span class="o">=</span><span class="n">growth</span><span class="p">)</span>
        <span class="c1"># sigma2 *= growth**2</span>

        <span class="n">R_nonlinear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">radius</span><span class="p">))))</span>
        <span class="n">neff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R_nonlinear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">dlogSigma</span><span class="p">)</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span>

        <span class="n">k1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">k1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">k1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">k2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">k2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">k3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">k1</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>

        <span class="n">kmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">k3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">k3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="n">kmin</span> <span class="o">/</span> <span class="n">kmax</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">kmid</span> <span class="o">+</span> <span class="n">kmin</span> <span class="o">-</span> <span class="n">kmax</span><span class="p">)</span> <span class="o">/</span> <span class="n">kmax</span>

        <span class="n">l_sigma_8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span><span class="p">)</span>

        <span class="n">alpha_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span> <span class="o">-</span><span class="mf">4.348</span> <span class="o">-</span> <span class="mf">3.006</span> <span class="o">*</span> <span class="n">neff</span> <span class="o">-</span> <span class="mf">0.5745</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.9</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">neff</span><span class="p">)</span> <span class="o">*</span> <span class="n">r2</span> <span class="p">,</span> <span class="n">r2</span> <span class="o">/</span> <span class="n">r2</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">ns</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">beta_n</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.731</span> <span class="o">-</span> <span class="mf">2.845</span> <span class="o">*</span> <span class="n">neff</span> <span class="o">-</span> <span class="mf">1.4995</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.2811</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mf">0.007</span> <span class="o">*</span> <span class="n">r2</span>
        <span class="n">gamma_n</span> <span class="o">=</span> <span class="mf">0.182</span> <span class="o">+</span> <span class="mf">0.570</span> <span class="o">*</span> <span class="n">neff</span>
        <span class="n">aa_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.167</span> <span class="o">-</span> <span class="mf">2.944</span> <span class="o">*</span> <span class="n">l_sigma_8</span> <span class="o">-</span> <span class="mf">1.106</span> <span class="o">*</span> <span class="n">l_sigma_8</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.865</span> <span class="o">*</span> <span class="n">l_sigma_8</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mf">0.310</span> <span class="o">*</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">gamma_n</span><span class="p">)</span>
        <span class="n">bb_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">3.428</span> <span class="o">-</span> <span class="mf">2.681</span> <span class="o">*</span> <span class="n">l_sigma_8</span> <span class="o">+</span> <span class="mf">1.624</span> <span class="o">*</span> <span class="n">l_sigma_8</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.095</span> <span class="o">*</span> <span class="n">l_sigma_8</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">cc_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">0.159</span> <span class="o">-</span> <span class="mf">1.107</span> <span class="o">*</span> <span class="n">neff</span><span class="p">)</span>

        <span class="n">mu_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">15.312</span> <span class="o">+</span> <span class="mf">22.977</span> <span class="o">*</span> <span class="n">neff</span> <span class="o">+</span> <span class="mf">10.9579</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1.6586</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">nu_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">1.347</span> <span class="o">+</span> <span class="mf">1.246</span> <span class="o">*</span> <span class="n">neff</span> <span class="o">+</span> <span class="mf">0.4525</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ff_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">10.533</span> <span class="o">-</span> <span class="mf">16.838</span> <span class="o">*</span> <span class="n">neff</span> <span class="o">-</span> <span class="mf">9.3048</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.8263</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">gg_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">2.787</span> <span class="o">+</span> <span class="mf">2.405</span> <span class="o">*</span> <span class="n">neff</span> <span class="o">+</span> <span class="mf">0.4577</span> <span class="o">*</span> <span class="n">neff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">hh_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.118</span> <span class="o">-</span> <span class="mf">0.394</span> <span class="o">*</span> <span class="n">neff</span><span class="p">)</span>
        <span class="n">mm_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.605</span> <span class="o">-</span> <span class="mf">2.434</span> <span class="o">*</span> <span class="n">l_sigma_8</span> <span class="o">+</span> <span class="mf">5.710</span> <span class="o">*</span> <span class="n">l_sigma_8</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">nn_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">4.468</span> <span class="o">-</span> <span class="mf">3.080</span> <span class="o">*</span> <span class="n">l_sigma_8</span> <span class="o">+</span> <span class="mf">1.035</span> <span class="o">*</span> <span class="n">l_sigma_8</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pp_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">0.071</span> <span class="o">-</span> <span class="mf">0.433</span> <span class="o">*</span> <span class="n">neff</span><span class="p">)</span>
        <span class="n">dd_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.483</span> <span class="o">+</span> <span class="mf">0.892</span> <span class="o">*</span> <span class="n">l_sigma_8</span> <span class="o">-</span> <span class="mf">0.086</span> <span class="o">*</span> <span class="n">omega_z</span><span class="p">)</span>
        <span class="n">ee_n</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.632</span> <span class="o">+</span> <span class="mf">0.646</span> <span class="o">*</span> <span class="n">neff</span><span class="p">)</span>

        <span class="n">knl</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">R_nonlinear</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">/</span> <span class="n">knl</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">/</span> <span class="n">knl</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">k3</span> <span class="o">/</span> <span class="n">knl</span>

        <span class="k">def</span> <span class="nf">II</span><span class="p">(</span><span class="n">qq</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ee_n</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">PPE</span><span class="p">(</span><span class="n">qq</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ff_n</span> <span class="o">*</span> <span class="n">qq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">gg_n</span> <span class="o">*</span> <span class="n">qq</span> <span class="o">+</span> <span class="n">hh_n</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">knl</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span> <span class="o">+</span>
                    <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">mm_n</span> <span class="o">*</span> <span class="n">qq</span><span class="o">**</span><span class="n">mu_n</span> <span class="o">+</span> <span class="n">nn_n</span> <span class="o">*</span> <span class="n">qq</span><span class="o">**</span><span class="n">nu_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">pp_n</span> <span class="o">*</span> <span class="n">qq</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">F2</span><span class="p">(</span><span class="n">kk1</span><span class="p">,</span> <span class="n">kk2</span><span class="p">,</span> <span class="n">ttheta</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">7.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">kk1</span> <span class="o">/</span> <span class="n">kk2</span> <span class="o">+</span> <span class="n">kk2</span> <span class="o">/</span> <span class="n">kk1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ttheta</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">7.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ttheta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">B1h</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">aa_n</span> <span class="o">*</span> <span class="n">q1</span><span class="o">**</span><span class="n">alpha_n</span> <span class="o">+</span> <span class="n">bb_n</span> <span class="o">*</span> <span class="n">q1</span><span class="o">**</span><span class="n">beta_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">cc_n</span> <span class="o">*</span> <span class="n">q1</span><span class="p">))))</span> <span class="o">*</span>
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">aa_n</span> <span class="o">*</span> <span class="n">q2</span><span class="o">**</span><span class="n">alpha_n</span> <span class="o">+</span> <span class="n">bb_n</span> <span class="o">*</span> <span class="n">q2</span><span class="o">**</span><span class="n">beta_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">cc_n</span> <span class="o">*</span> <span class="n">q2</span><span class="p">))))</span> <span class="o">*</span>
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">aa_n</span> <span class="o">*</span> <span class="n">q3</span><span class="o">**</span><span class="n">alpha_n</span> <span class="o">+</span> <span class="n">bb_n</span> <span class="o">*</span> <span class="n">q3</span><span class="o">**</span><span class="n">beta_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">cc_n</span> <span class="o">*</span> <span class="n">q3</span><span class="p">))))</span> <span class="p">)</span>

        <span class="n">B3h</span> <span class="o">=</span> <span class="p">(</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">F2</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">dd_n</span> <span class="o">*</span> <span class="n">q3</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span> <span class="o">*</span> <span class="n">PPE</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PPE</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span> <span class="o">+</span>
                <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">F2</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">dd_n</span> <span class="o">*</span> <span class="n">q2</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span> <span class="o">*</span> <span class="n">PPE</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PPE</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span> <span class="o">+</span>
                <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">F2</span><span class="p">(</span><span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">dd_n</span> <span class="o">*</span> <span class="n">q1</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span> <span class="o">*</span> <span class="n">II</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span> <span class="o">*</span> <span class="n">PPE</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span> <span class="o">*</span> <span class="n">PPE</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   computed bihalofit at z=</span><span class="si">{0:.2f}</span><span class="s2"> for &#39;</span><span class="si">{1}</span><span class="s2">&#39; in </span><span class="si">{2:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="mf">1.</span><span class="o">/</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">B1h</span> <span class="o">+</span> <span class="n">B3h</span></div>


<div class="viewcode-block" id="Cosmology.compute_tree_level_bispectrum"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_tree_level_bispectrum">[docs]</a>    <span class="k">def</span> <span class="nf">compute_tree_level_bispectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute tree level bispectrum, see the review by Bernardeau et al (2002)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">k1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">k1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">k1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">k2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">k2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">k3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">k1</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">F2</span><span class="p">(</span><span class="n">kk1</span><span class="p">,</span> <span class="n">kk2</span><span class="p">,</span> <span class="n">ttheta</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">7.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">kk1</span> <span class="o">/</span> <span class="n">kk2</span> <span class="o">+</span> <span class="n">kk2</span> <span class="o">/</span> <span class="n">kk1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ttheta</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">7.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ttheta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
        <span class="n">p3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>

        <span class="n">Btree</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">F2</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">p1</span> <span class="o">*</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">F2</span><span class="p">(</span><span class="n">k3</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">p3</span> <span class="o">*</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">F2</span><span class="p">(</span><span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">p3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Btree</span></div>


<div class="viewcode-block" id="Cosmology.compute_halomodel"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_halomodel">[docs]</a>    <span class="k">def</span> <span class="nf">compute_halomodel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the nonlinear power spectrum with the halo model Cooray &amp; Sheth (2012)</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Cosmology.compute_concentration"><a class="viewcode-back" href="../../code.html#bacco.Cosmology.compute_concentration">[docs]</a>    <span class="k">def</span> <span class="nf">compute_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Einasto</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate c(M) alla Ludlow et al (2016)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">][</span><span class="s1">&#39;concentration&#39;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;prada12&#39;</span><span class="p">,</span> <span class="s1">&#39;ludlow16&#39;</span><span class="p">,</span> <span class="s1">&#39;ludlow16_approx&#39;</span><span class="p">,</span> <span class="s1">&#39;diemer15&#39;</span><span class="p">,</span> <span class="s1">&#39;diemer18&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span>
        <span class="n">statistic</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span> <span class="c1">#or &quot;mean&quot;</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">redshift</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
            <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this could be better, but the important thing is to take a k well withing the horizon at all redshifts</span>
            <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">rhocrit_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>  <span class="c1"># units: M_solar/Mpc^3/h^2</span>

        <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;prada12&#39;</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">cmin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="mf">3.681</span> <span class="o">+</span> <span class="p">(</span><span class="mf">5.033</span> <span class="o">-</span> <span class="mf">3.681</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">6.948</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.424</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">smin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="mf">1.047</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.646</span> <span class="o">-</span> <span class="mf">1.047</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">7.386</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.526</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_de_z</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="mf">1.</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">expfactor</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">cmin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">cmin</span><span class="p">(</span><span class="mf">1.393</span><span class="p">)</span>
            <span class="n">B1</span> <span class="o">=</span> <span class="n">smin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">smin</span><span class="p">(</span><span class="mf">1.393</span><span class="p">)</span>
            <span class="n">temp_sig</span> <span class="o">=</span> <span class="mf">1.686</span> <span class="o">/</span> <span class="n">nu</span>
            <span class="n">temp_sigp</span> <span class="o">=</span> <span class="n">temp_sig</span> <span class="o">*</span> <span class="n">B1</span>
            <span class="n">temp_C</span> <span class="o">=</span> <span class="mf">2.881</span> <span class="o">*</span> <span class="p">((</span><span class="n">temp_sigp</span> <span class="o">/</span> <span class="mf">1.257</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.022</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.06</span> <span class="o">/</span> <span class="n">temp_sigp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">c200c</span> <span class="o">=</span> <span class="n">B0</span> <span class="o">*</span> <span class="n">temp_C</span>

            <span class="k">return</span> <span class="n">c200c</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;ludlow16_planck&quot;</span><span class="p">:</span>
            <span class="c1"># Implements the fitting functions of Apendix C valid for Planck&#39;s cosmology</span>

            <span class="n">cc0</span> <span class="o">=</span> <span class="mf">3.395</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.215</span><span class="p">)</span>
            <span class="n">bet</span> <span class="o">=</span> <span class="mf">0.307</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.540</span><span class="p">)</span>
            <span class="n">gam1</span> <span class="o">=</span> <span class="mf">0.628</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.047</span><span class="p">)</span>
            <span class="n">gam2</span> <span class="o">=</span> <span class="mf">0.317</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.893</span><span class="p">)</span>

            <span class="n">nu0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.135</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.564</span> <span class="o">/</span> <span class="n">expfactor</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.210</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.0557</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                   <span class="o">-</span> <span class="mf">0.00348</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cc0</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu</span><span class="o">/</span><span class="n">nu0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">gam1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">nu</span><span class="o">/</span><span class="n">nu0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">bet</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="n">bet</span><span class="o">*</span><span class="p">(</span><span class="n">gam1</span><span class="o">-</span><span class="n">gam2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ludlow16&#39;</span><span class="p">:</span>

            <span class="c1"># free model parameters (Ludlow et al, 2016)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="mf">650.</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mf">0.02</span>
            <span class="n">alpha_rho</span> <span class="o">=</span> <span class="mf">0.18</span>  <span class="c1"># shape parameter for Einasto concentrations</span>

            <span class="n">c_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c1">#WARNING: if interpolation fail change the lower limit</span>
            <span class="n">delta_sc_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">/</span> <span class="n">growth</span>

            <span class="n">Mratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">c_array</span><span class="p">)</span><span class="o">-</span><span class="n">c_array</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">c_array</span><span class="p">))</span>
            <span class="n">rho_2</span> <span class="o">=</span> <span class="mf">200.</span> <span class="o">*</span> <span class="n">c_array</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">Mratio</span> <span class="o">/</span> <span class="n">A</span>

            <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span>
            <span class="n">expfactor2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">special</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">rho_2</span> <span class="o">=</span> <span class="n">rho_2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">c_array</span> <span class="o">=</span> <span class="n">c_array</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Mratio</span> <span class="o">=</span> <span class="n">Mratio</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">expfactor2</span> <span class="o">=</span> <span class="n">expfactor2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;reps&#39;</span><span class="p">):</span>
                <span class="n">delta_sc_z2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor2</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: this needs to be tested</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">expfactor2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">aa</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">delta_sc_z2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                <span class="n">delta_sc_z2</span> <span class="o">=</span> <span class="n">delta_sc_z2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">radius2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

            <span class="n">sig2_fM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="n">radius2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">sig2_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

            <span class="n">arg2</span> <span class="o">=</span> <span class="n">special</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">delta_sc_z2</span> <span class="o">-</span> <span class="n">delta_sc_0</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig2_fM</span> <span class="o">-</span> <span class="n">sig2_M</span><span class="p">))))</span>

            <span class="n">c_nfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass</span><span class="p">)):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">Mratio</span> <span class="o">-</span> <span class="n">arg2</span><span class="p">[:,</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">c_array</span><span class="p">)</span>
                <span class="n">c_nfw</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c_nfw</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Computation of the concentration resulted in nan values&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">c_nfw</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;diemer15&#39;</span><span class="p">:</span>
            <span class="c1"># Let&#39;s first compute the power-law index of the power spcetrum as a function of mass</span>
            <span class="n">DIEMER15_KAPPA</span> <span class="o">=</span> <span class="mf">0.69</span>
            <span class="n">DIEMER15_MEDIAN_PHI_0</span> <span class="o">=</span> <span class="mf">6.58</span>
            <span class="n">DIEMER15_MEDIAN_PHI_1</span> <span class="o">=</span> <span class="mf">1.37</span>
            <span class="n">DIEMER15_MEDIAN_ETA_0</span> <span class="o">=</span> <span class="mf">6.82</span>
            <span class="n">DIEMER15_MEDIAN_ETA_1</span> <span class="o">=</span> <span class="mf">1.42</span>
            <span class="n">DIEMER15_MEDIAN_ALPHA</span> <span class="o">=</span> <span class="mf">1.12</span>
            <span class="n">DIEMER15_MEDIAN_BETA</span> <span class="o">=</span> <span class="mf">1.69</span>

            <span class="n">DIEMER15_MEAN_PHI_0</span> <span class="o">=</span> <span class="mf">7.14</span>
            <span class="n">DIEMER15_MEAN_PHI_1</span> <span class="o">=</span> <span class="mf">1.60</span>
            <span class="n">DIEMER15_MEAN_ETA_0</span> <span class="o">=</span> <span class="mf">4.10</span>
            <span class="n">DIEMER15_MEAN_ETA_1</span> <span class="o">=</span> <span class="mf">0.75</span>
            <span class="n">DIEMER15_MEAN_ALPHA</span> <span class="o">=</span> <span class="mf">1.40</span>
            <span class="n">DIEMER15_MEAN_BETA</span> <span class="o">=</span> <span class="mf">0.67</span>

            <span class="c1">#New Diemer15 parameters corrected in Diemer &amp; Joice (2018)</span>
            <span class="n">DIEMER15_KAPPA</span> <span class="o">=</span> <span class="mf">1.00</span>
            <span class="n">DIEMER15_MEDIAN_PHI_0</span> <span class="o">=</span> <span class="mf">6.58</span>
            <span class="n">DIEMER15_MEDIAN_PHI_1</span> <span class="o">=</span> <span class="mf">1.27</span>
            <span class="n">DIEMER15_MEDIAN_ETA_0</span> <span class="o">=</span> <span class="mf">7.28</span>
            <span class="n">DIEMER15_MEDIAN_ETA_1</span> <span class="o">=</span> <span class="mf">1.56</span>
            <span class="n">DIEMER15_MEDIAN_ALPHA</span> <span class="o">=</span> <span class="mf">1.08</span>
            <span class="n">DIEMER15_MEDIAN_BETA</span>  <span class="o">=</span> <span class="mf">1.77</span>

            <span class="n">DIEMER15_MEAN_PHI_0</span> <span class="o">=</span> <span class="mf">6.66</span>
            <span class="n">DIEMER15_MEAN_PHI_1</span> <span class="o">=</span> <span class="mf">1.37</span>
            <span class="n">DIEMER15_MEAN_ETA_0</span> <span class="o">=</span> <span class="mf">5.41</span>
            <span class="n">DIEMER15_MEAN_ETA_1</span> <span class="o">=</span> <span class="mf">1.06</span>
            <span class="n">DIEMER15_MEAN_ALPHA</span> <span class="o">=</span> <span class="mf">1.22</span>
            <span class="n">DIEMER15_MEAN_BETA</span>  <span class="o">=</span> <span class="mf">1.22</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
            <span class="n">k_R</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">DIEMER15_KAPPA</span>

            <span class="n">slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dlnP_dlnk</span><span class="p">(</span><span class="n">k_R</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">statistic</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                <span class="n">floor</span> <span class="o">=</span> <span class="n">DIEMER15_MEDIAN_PHI_0</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">DIEMER15_MEDIAN_PHI_1</span>
                <span class="n">nu0</span> <span class="o">=</span> <span class="n">DIEMER15_MEDIAN_ETA_0</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">DIEMER15_MEDIAN_ETA_1</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">DIEMER15_MEDIAN_ALPHA</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="n">DIEMER15_MEDIAN_BETA</span>
            <span class="k">elif</span> <span class="n">statistic</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                <span class="n">floor</span> <span class="o">=</span> <span class="n">DIEMER15_MEAN_PHI_0</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">DIEMER15_MEAN_PHI_1</span>
                <span class="n">nu0</span> <span class="o">=</span> <span class="n">DIEMER15_MEAN_ETA_0</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">DIEMER15_MEAN_ETA_1</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">DIEMER15_MEAN_ALPHA</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="n">DIEMER15_MEAN_BETA</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown statistic.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">floor</span> <span class="o">*</span> <span class="p">((</span><span class="n">nu0</span> <span class="o">/</span> <span class="n">nu</span><span class="p">)</span><span class="o">**</span><span class="n">alpha</span> <span class="o">+</span> <span class="p">(</span><span class="n">nu</span> <span class="o">/</span> <span class="n">nu0</span><span class="p">)</span><span class="o">**</span><span class="n">beta</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;diemer18&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">statistic</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                    <span class="n">kappa</span>             <span class="o">=</span> <span class="mf">0.41</span>
                    <span class="n">a_0</span>               <span class="o">=</span> <span class="mf">2.45</span>
                    <span class="n">a_1</span>               <span class="o">=</span> <span class="mf">1.82</span>
                    <span class="n">b_0</span>               <span class="o">=</span> <span class="mf">3.20</span>
                    <span class="n">b_1</span>               <span class="o">=</span> <span class="mf">2.30</span>
                    <span class="n">c_alpha</span>           <span class="o">=</span> <span class="mf">0.21</span>
            <span class="k">elif</span> <span class="n">statistic</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                    <span class="n">kappa</span>             <span class="o">=</span> <span class="mf">0.42</span>
                    <span class="n">a_0</span>               <span class="o">=</span> <span class="mf">2.37</span>
                    <span class="n">a_1</span>               <span class="o">=</span> <span class="mf">1.74</span>
                    <span class="n">b_0</span>               <span class="o">=</span> <span class="mf">3.39</span>
                    <span class="n">b_1</span>               <span class="o">=</span> <span class="mf">1.82</span>
                    <span class="n">c_alpha</span>           <span class="o">=</span> <span class="mf">0.20</span>
            <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Statistic </span><span class="si">%s</span><span class="s1"> not implmented in diemer18 model.&#39;</span> <span class="o">%</span> <span class="n">statistic</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_diemer18_func</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">n_eff</span><span class="p">,</span> <span class="n">A_n</span><span class="p">,</span> <span class="n">B_n</span><span class="p">):</span>
                <span class="n">mu_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">c</span><span class="p">))</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="n">mu_c</span><span class="o">**</span><span class="p">((</span><span class="mf">5.0</span> <span class="o">+</span> <span class="n">n_eff</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">A_n</span> <span class="o">/</span> <span class="n">nu</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">nu</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">B_n</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">-</span> <span class="n">rhs</span>
                <span class="k">return</span> <span class="n">ret</span>

            <span class="c1"># Compute peak height, n_eff, and alpha_eff</span>
            <span class="n">n_eff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dlnS_dlnR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nu_to_radius</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">scaleindep_k</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;reps&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">alpha_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alpha_eff</span><span class="p">(</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">scaleindep_k</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">alpha_eff</span><span class="p">)</span>

            <span class="c1"># Compute input parameters</span>
            <span class="n">A_n</span> <span class="o">=</span> <span class="n">a_0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">a_1</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_eff</span> <span class="o">+</span> <span class="mf">3.0</span><span class="p">))</span>
            <span class="n">B_n</span> <span class="o">=</span> <span class="n">b_0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b_1</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_eff</span> <span class="o">+</span> <span class="mf">3.0</span><span class="p">))</span>
            <span class="n">C_alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c_alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha_eff</span><span class="p">)</span>

            <span class="c1"># Invert G(c) function</span>
            <span class="n">c200c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nu</span><span class="p">)):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_eff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">A_n</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">B_n</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">c_min</span> <span class="o">=</span> <span class="mf">0.4</span>
                <span class="k">if</span> <span class="n">_diemer18_func</span><span class="p">(</span><span class="n">c_min</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">c200c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">_diemer18_func</span><span class="p">,</span> <span class="n">c_min</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c200c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

            <span class="c1"># Multiply with C(alpha) dependence</span>
            <span class="n">c200c</span> <span class="o">*=</span> <span class="n">C_alpha</span>
            <span class="k">return</span> <span class="n">c200c</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   computed C-M relation at z=</span><span class="si">{0:.2f}</span><span class="s2"> in </span><span class="si">{1:.3f}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span></div>


    <span class="c1">## Some neutrino-related functions #########################################</span>

    <span class="k">def</span> <span class="nf">_F_integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_G_integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_F</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_G</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_G_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span> <span class="o">*</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_G_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_neutrino_integral_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_neutrino_integral_tab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/reps/FF_GG_func_tab.dat&#39;</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
        <span class="n">Finterp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>
        <span class="n">Ginterp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;logFinterp&#39;</span><span class="p">:</span> <span class="n">Finterp</span><span class="p">,</span> <span class="s1">&#39;logGinterp&#39;</span><span class="p">:</span> <span class="n">Ginterp</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_FF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neutrino_integral_tab</span><span class="p">[</span><span class="s1">&#39;logFinterp&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_GG</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neutrino_integral_tab</span><span class="p">[</span><span class="s1">&#39;logGinterp&#39;</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

    <span class="c1">### End of the neutrino-related section ####################################</span>

    <span class="k">def</span> <span class="nf">plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span>
        <span class="kn">import</span> <span class="nn">matplotlib.lines</span> <span class="k">as</span> <span class="nn">mlines</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   creating plots&quot;</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s2">&quot;Cosmology Plots&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="c1"># pk</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">expfactor</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mf">4.</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                      <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_nonlinear</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">expfactor</span><span class="p">:</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">kk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">aa</span><span class="p">),</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">kk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halofit</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CAMB&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">bardeen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">data_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span>
                        <span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span> <span class="n">bardeen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nonlinear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_class_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span>
                    <span class="n">data_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_class_spectrum</span><span class="p">(</span>
                        <span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span> <span class="n">nonlinear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_mass&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">data_nl</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">],</span> <span class="n">data_nl</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_nl</span><span class="p">[</span><span class="s1">&#39;pk_mass&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">5e-3</span><span class="p">,</span> <span class="mf">2e1</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">8e-1</span><span class="p">,</span> <span class="mf">2e3</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k\,[h \,{Mpc^{-1}}]$&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k\,P(k)$&#39;</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Linear&quot;</span><span class="p">),</span>
                 <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Nonlinear&quot;</span><span class="p">),</span>
                 <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Nonlinear (&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">)]</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

        <span class="c1"># sigma</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;variance&#39;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CAMB&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span><span class="n">bardeen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_class_spectrum</span><span class="p">()</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sigmaR_z0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">kk</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">],</span> <span class="n">pk</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk_mass&#39;</span><span class="p">])</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabVariance_z0</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]),</span> <span class="n">var</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">8e-2</span><span class="p">,</span> <span class="mf">2e1</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\log\,M\,\left[M_\odot/h\right]$&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log\,\sigma^2(R)$&#39;</span><span class="p">)</span>

        <span class="c1"># mass function</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabMassFunction</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabMassFunction</span><span class="p">[</span><span class="s1">&#39;nufnu&#39;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">expfactor</span><span class="p">:</span>
                <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_massfunction</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mf</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]),</span> <span class="n">mf</span><span class="p">[</span><span class="s1">&#39;nufnu&#39;</span><span class="p">])</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">2e-4</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log\,M\,\left[M_\odot/h\right]$&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log\,\nu f(\nu)$&#39;</span><span class="p">)</span>

        <span class="c1"># concentration</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabConcentration</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabConcentration</span><span class="p">[</span><span class="s1">&#39;c_nfw&#39;</span><span class="p">]),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">expfactor</span><span class="p">:</span>
                <span class="n">new_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_concentration</span><span class="p">(</span><span class="n">new_c</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">new_c</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">new_c</span><span class="p">[</span><span class="s1">&#39;c_nfw&#39;</span><span class="p">]),</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">new_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_concentration</span><span class="p">(</span><span class="n">new_c</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">new_c</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                    <span class="n">new_c</span><span class="p">[</span><span class="s1">&#39;c_nfw&#39;</span><span class="p">]),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log\,M\,\left[M_\odot/h\right]$&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log\,c_</span><span class="si">{nfw}</span><span class="s1">$&#39;</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fitting function&quot;</span><span class="p">),</span>
                 <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Full expression&quot;</span><span class="p">)]</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

        <span class="c1"># sigma-nu</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e15</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expfactor</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">expfactor</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span>
                <span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">aa</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;z = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">aa</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.09</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log\,M\,\left[M_\odot/h\right]$&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\nu$&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Raul E. Angulo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>