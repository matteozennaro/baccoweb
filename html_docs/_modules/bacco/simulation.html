

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bacco.simulation &mdash; bacco 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> bacco
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bacco</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bacco.simulation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bacco.simulation</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of the &#39;Simulation&#39; class and helper functions</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Simulation&quot;</span><span class="p">,</span> <span class="s2">&quot;PairedSimulation&quot;</span><span class="p">,</span> <span class="s2">&quot;ScaledSimulation&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">cosmology</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">LazyDict</span><span class="p">,</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">do_profile</span><span class="p">,</span> <span class="n">find_BinA</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Try installing &#39;h5py&#39;: pip install h5py --user&quot;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;bacco.sims&#39;</span><span class="p">)</span>

<span class="n">N_TYPE</span> <span class="o">=</span> <span class="mi">6</span>

<span class="k">class</span> <span class="nc">ScaledSimulation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cosmology</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conc_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lss_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">use_orphans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">baryons</span><span class="o">=</span><span class="p">{},</span> <span class="n">Arr_Snap1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Arr_Snap2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Nsnap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">interpolate_snaps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl_sdm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scl_halos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scl_sub</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fof_props</span><span class="o">=</span><span class="p">[],</span> <span class="n">sub_props</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">use_half</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">scaler_kwargs</span><span class="p">):</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.scaler</span> <span class="k">import</span> <span class="n">Scaler</span><span class="p">,</span> <span class="n">runmin_cleanup</span>
        <span class="k">if</span> <span class="n">baryons</span><span class="p">:</span> <span class="kn">from</span> <span class="nn">.baryons</span> <span class="k">import</span> <span class="n">Baryons</span>
        <span class="k">if</span> <span class="n">Arr_Snap1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="kn">from</span>  <span class="nn">.sampler</span> <span class="k">import</span>  <span class="n">Load_ArrSim</span>
        <span class="n">bdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;0.00&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">paired</span> <span class="k">else</span> <span class="n">basedir</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="n">bdir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cosmology</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ocosmo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">snaplist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span> <span class="o">=</span> <span class="n">interpolate_snaps</span>
        <span class="k">del</span> <span class="n">s</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ocosmo</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">)</span>
        <span class="n">run</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">runmin</span><span class="p">(</span><span class="n">cosmology</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">snaps</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">find_two_closest_snaps_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">,</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;a_in_original&#39;</span><span class="p">],</span> <span class="n">use_half</span> <span class="o">=</span> <span class="n">use_half</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">snaps</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">find_closest_snaps_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">,</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;a_in_original&#39;</span><span class="p">])</span>

        <span class="n">scl_dm</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">dm_file</span><span class="o">==</span><span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">scl_halos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scl_halos</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">halo_file</span><span class="o">==</span><span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">scl_sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scl_sub</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">halo_file</span><span class="o">==</span><span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">scl_sdm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scl_sdm</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">halo_file</span><span class="o">==</span><span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">baryons</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;halo_rs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">:</span>
                <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_rs&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;halo_logrho0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">:</span>
                <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_logrho0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;halo_conc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">:</span>
                <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_conc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;remeasure_halo_profiles&#39;</span> <span class="ow">in</span> <span class="n">scaler_kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scaler_kwargs</span><span class="p">[</span><span class="s1">&#39;remeasure_halo_profiles&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;halo_radial_shells&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">):</span>
                    <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_radial_shells&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;halo_dilution_factor&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">):</span>
                    <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_dilution_factor&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;halo_density_profile&#39;</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;halo_radial_bins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">):</span>
                    <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;halo_r200c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">):</span>
                    <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scl_halos</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;halo_pos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">):</span>
                <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;halo_vel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">):</span>
                <span class="n">fof_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scl_sub</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;pos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_props</span><span class="p">):</span>
                <span class="n">sub_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;vel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_props</span><span class="p">):</span>
                <span class="n">sub_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vel&#39;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_\d+&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">snap</span> <span class="ow">in</span> <span class="n">snaps</span><span class="p">:</span>
            <span class="n">dm_file</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">{0:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snap</span><span class="p">),</span> <span class="n">dm_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">halo_file</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">{0:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snap</span><span class="p">),</span> <span class="n">halo_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Arr_Snap1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s0</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">)</span>
                    <span class="n">s1</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;3.14&#39;</span><span class="p">),</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">)</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">PairedSimulation</span><span class="p">([</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">])</span>
                    <span class="k">del</span> <span class="n">s0</span><span class="p">;</span> <span class="k">del</span> <span class="n">s1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">Load_ArrSim</span><span class="p">([</span><span class="n">Arr_Snap1</span><span class="p">,</span><span class="n">Arr_Snap2</span><span class="p">],</span> <span class="n">snap</span><span class="p">,</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;0.00&#39;</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;3.14&#39;</span><span class="p">)],</span><span class="n">Nsnap</span><span class="p">,</span>
                    <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">load_fof</span> <span class="o">=</span> <span class="n">scl_halos</span><span class="p">,</span> <span class="n">load_sub</span> <span class="o">=</span> <span class="n">scl_sub</span><span class="p">,</span><span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">A_s</span> <span class="o">=</span> <span class="n">A_s</span><span class="p">,</span> <span class="n">Files_Clean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Arr_Snap1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="n">basedir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">Load_ArrSim</span><span class="p">(</span><span class="n">Arr_Snap1</span><span class="p">,</span> <span class="n">snap</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">Nsnap</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">load_fof</span> <span class="o">=</span> <span class="n">scl_halos</span><span class="p">,</span>
                            <span class="n">load_sub</span> <span class="o">=</span> <span class="n">scl_sub</span><span class="p">,</span><span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">A_s</span> <span class="o">=</span> <span class="n">A_s</span><span class="p">,</span> <span class="n">Files_Clean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#Should we use deepcopy()?</span>

            <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scl_dm</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dm</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dm</span>
                <span class="k">if</span> <span class="n">scl_halos</span> <span class="ow">or</span> <span class="n">conc_correction</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span>
                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">:</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">scl_sdm</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sdm</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sdm</span>
                <span class="k">if</span> <span class="n">scl_sub</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span>
                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">sub_props</span><span class="p">:</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scl_dm</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">dm</span>
                <span class="k">if</span> <span class="n">scl_halos</span> <span class="ow">or</span> <span class="n">conc_correction</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">fof</span>
                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">fof_props</span><span class="p">:</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">scl_sdm</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sdm</span>
                <span class="k">if</span> <span class="n">scl_sub</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">sub</span>
                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">sub_props</span><span class="p">:</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>

            <span class="n">scale_snaplist</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">scl_sub</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">_ssim</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">scale_simulation</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">scl_dm</span><span class="o">=</span><span class="n">scl_dm</span><span class="p">,</span> <span class="n">scl_sdm</span><span class="o">=</span><span class="n">scl_sdm</span><span class="p">,</span> <span class="n">scl_halos</span><span class="o">=</span><span class="n">scl_halos</span><span class="p">,</span>
                                            <span class="n">scl_sub</span><span class="o">=</span><span class="n">scl_sub</span><span class="p">,</span> <span class="n">lss_correction</span><span class="o">=</span><span class="n">lss_correction</span><span class="p">,</span> <span class="n">conc_correction</span><span class="o">=</span><span class="n">conc_correction</span><span class="p">,</span> <span class="n">scale_snaplist</span><span class="o">=</span><span class="n">scale_snaplist</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">scaler_kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">baryons</span><span class="p">:</span>
                <span class="n">bsim</span> <span class="o">=</span> <span class="n">Baryons</span><span class="p">(</span><span class="n">_ssim</span><span class="p">,</span> <span class="o">**</span><span class="n">baryons</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">_ssim</span>
                <span class="n">_ssim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bsim</span><span class="o">.</span><span class="n">Simulation</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">bsim</span>
            <span class="k">del</span> <span class="n">sim</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ssim</span><span class="p">)</span>

        <span class="n">expfactor</span> <span class="o">=</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;a_in_original&#39;</span><span class="p">]</span>
        <span class="n">runmin_cleanup</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">run</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_in_original</span> <span class="o">=</span> <span class="n">expfactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_times</span> <span class="o">=</span> <span class="n">times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snaps</span> <span class="o">=</span> <span class="n">snaps</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="p">(</span><span class="n">expfactor</span><span class="o">-</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a0</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="p">)</span>
            <span class="n">tim</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;minutes&#39;</span><span class="p">)</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="s1">&#39;Gigabytes&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e9</span><span class="p">)</span> <span class="k">else</span> <span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="s1">&#39;Megabytes&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time to create the Scaled Simulation: </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory used to create the Scaled Simulation: </span><span class="si">{}</span><span class="s2"> Gigabytes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mem</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span>
        <span class="k">for</span> <span class="n">sim_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">sim_i</span>

    <span class="k">def</span> <span class="nf">_interp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span><span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">y0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a0</span> <span class="o">+</span> <span class="n">y1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span>

    <span class="k">def</span> <span class="nf">_get_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">interp_log</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span> <span class="n">interp_log</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attr</span><span class="p">)[</span><span class="n">qty</span><span class="p">],</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">attr</span><span class="p">)[</span><span class="n">qty</span><span class="p">],</span> <span class="n">log</span> <span class="o">=</span> <span class="n">interp_log</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attr</span><span class="p">)[</span><span class="n">qty</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="k">def</span> <span class="nf">_compute_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">interp_log</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span> <span class="n">interp_log</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">func</span><span class="p">)(</span><span class="n">args</span><span class="p">)[</span><span class="n">qty</span><span class="p">],</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">func</span><span class="p">)(</span><span class="n">args</span><span class="p">)[</span><span class="n">qty</span><span class="p">],</span> <span class="n">log</span> <span class="o">=</span> <span class="n">interp_log</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">func</span><span class="p">)(</span><span class="n">args</span><span class="p">)[</span><span class="n">qty</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">q</span>


    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sim_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">:</span>
            <span class="n">sim_i</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;Power&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Power</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;sdmPower&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sdmPower</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;zPower&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">zPower</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmzPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmzPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;sdmzPower&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sdmzPower</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">haloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;haloPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;haloPower&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">haloPower</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">haloPower_100particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;haloPower_100particles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;haloPower_100particles&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">haloPower_100particles</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zhaloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zhaloPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;zhaloPower&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">zhaloPower</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zhaloPower_100particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zhaloPower_100particles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;zhaloPower_100particles&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">zhaloPower_100particles</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subPower&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subPower</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zsubPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zsubPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;zsubPower&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">zsubPower</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subhalo_power_vpeak&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vpeak</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vpeak_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vpeak_real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subhalo_power_vpeak_real&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vpeak_real</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_pmulti_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_pmulti_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subhalo_power_vpeak_real&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vpeak_real</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">at</span> <span class="o">!=</span> <span class="s1">&#39;pkmulti&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">P</span><span class="p">[</span><span class="s1">&#39;pkmulti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P</span><span class="p">[</span><span class="s1">&#39;pkmulti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_pmulti_vpeak</span><span class="p">[</span><span class="s2">&quot;pkmulti&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subhalo_power_vmax&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vmax</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vmax_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vmax_real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subhalo_power_vmax_real&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vmax_real</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_multipoles_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_multipoles_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subhalo_multipoles_vpeak&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_multipoles_vpeak</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_multipoles_vmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_multipoles_vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;subhalo_multipoles_vmax&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_multipoles_vmax</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">SubhaloMassFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;SubhaloMassFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;SubhaloMassFunction&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">interp_log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SubhaloMassFunction</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">BiasMass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;BiasMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;BiasMass&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">BiasMass</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">ConcentrationMass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;ConcentrationMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;ConcentrationMass&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ConcentrationMass</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">MassFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;MassFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;MassFunction&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">MassFunction</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">VpeakFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;VpeakFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;VpeakFunction&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">VpeakFunction</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">VmaxFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;VmaxFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity</span><span class="p">(</span><span class="s1">&#39;VmaxFunction&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">VmaxFunction</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="k">def</span> <span class="nf">compute_haloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_haloPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span><span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span>                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;k&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;pk&#39;</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span><span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span>    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk_theory_lin&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span>     <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk_theory_nl&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span>        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shotnoise&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span>           <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nmodes&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;r&#39;</span> <span class="p">:</span>               <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;xi&#39;</span> <span class="p">:</span>              <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;xi1&#39;</span> <span class="p">:</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi1&quot;</span><span class="p">],</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi1&quot;</span><span class="p">],</span> <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;xi2&#39;</span> <span class="p">:</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi2&quot;</span><span class="p">],</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi2&quot;</span><span class="p">],</span> <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_haloPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span><span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_halo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_halo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;xi&#39;</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_halo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_halo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_halo_multipoles</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;xi_l0&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l2&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l4&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_halo_multipoles</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;mpeak&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.11</span><span class="p">,</span> <span class="n">Mask_Type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alive_allsats</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span> <span class="n">Mask_Type</span> <span class="o">=</span> <span class="n">Mask_Type</span><span class="p">,</span> <span class="n">alive_allsats</span> <span class="o">=</span> <span class="n">alive_allsats</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span>                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;k&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;pk&#39;</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;pk_paired&#39;</span><span class="p">:</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk_paired&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;pk_paired&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span>    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk_theory_lin&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span>     <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk_theory_nl&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span>        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shotnoise&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span>           <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nmodes&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;r&#39;</span> <span class="p">:</span>               <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;xi&#39;</span> <span class="p">:</span>              <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;xi1&#39;</span> <span class="p">:</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi1&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi1&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;xi2&#39;</span> <span class="p">:</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi2&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi2&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span>
                    <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span> <span class="n">Mask_Type</span> <span class="o">=</span> <span class="n">Mask_Type</span><span class="p">,</span> <span class="n">alive_allsats</span> <span class="o">=</span> <span class="n">alive_allsats</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;xi&#39;</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span>
            <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="n">no_destruction</span><span class="p">,</span><span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_multipoles</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span> <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;xi_l0&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l2&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l4&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_multipoles</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span>
                                        <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span>
                                        <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_multipoles_JN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_multipoles_JN</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span> <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="n">n_jn3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;xi_l0&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l2&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l4&#39;</span><span class="p">:</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l0_err&#39;</span><span class="p">:</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l0_err&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l0_err&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l2_err&#39;</span><span class="p">:</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l2_err&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l2_err&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;xi_l4_err&#39;</span><span class="p">:</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xi_l4_err&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xi_l4_err&quot;</span><span class="p">],</span>  <span class="n">log</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_multipoles_JN</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span>
                                        <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span>
                                        <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="n">n_jn3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_snaps</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="n">no_destruction</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">interp_log</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">qty</span> <span class="o">!=</span> <span class="s1">&#39;nmodes&#39;</span> <span class="k">else</span> <span class="kc">False</span>
                <span class="n">res</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">qty</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">qty</span><span class="p">],</span> <span class="n">log</span> <span class="o">=</span> <span class="n">interp_log</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span>
                            <span class="n">compute_noOrphans</span><span class="o">=</span><span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="n">no_destruction</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PairedSimulation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_list</span><span class="p">):</span>
        <span class="c1"># We can have as input a list of simulation parameters or directly</span>
        <span class="c1"># instances of the simulation class</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim_list</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This simulation list corresponds neither to&#39;</span>
                           <span class="s1">&#39;paired couples nor tetrads. &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">sim_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;Simulation&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sim_i</span> <span class="ow">in</span> <span class="n">sim_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sim_i</span> <span class="ow">in</span> <span class="n">sim_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Simulation</span><span class="p">(</span><span class="o">**</span><span class="n">sim_i</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nsim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>

        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The PairedSimulation snapshots have different Times: </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The PairedSimulation snapshots have different Times: </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialPhase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;InitialPhase&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">InitialPhase</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InitialPhase</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">))</span>

        <span class="c1"># Define a dictionary with lazy attributes already computed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span>
        <span class="k">for</span> <span class="n">sim_j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">sim_j</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sim_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">:</span>
            <span class="n">sim_i</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Power</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sdmPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">zPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmzPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmzPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sdmzPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">qPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;qPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">qPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zqPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zqPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">zqPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">totPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;totPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">totPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">haloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;haloPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">haloPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">haloPower_100particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;haloPower_100particles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">haloPower_100particles</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zhaloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zhaloPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">zhaloPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zhaloPower_100particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zhaloPower_100particles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">zhaloPower_100particles</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">subPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zsubPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zsubPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">zsubPower</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_multipoles_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_multipoles_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_multipoles_vpeak</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vpeak</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vpeak_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vpeak_real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vpeak_real</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_multipoles_vmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_multipoles_vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_multipoles_vmax</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vmax</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vmax_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vmax_real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">subhalo_power_vmax_real</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">SubhaloMassFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;SubhaloMassFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SubhaloMassFunction</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">BiasMass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;BiasMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">BiasMass</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">ConcentrationMass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;ConcentrationMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ConcentrationMass</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">MassFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;MassFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">MassFunction</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">VpeakFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;VpeakFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">VpeakFunction</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">VmaxFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;VmaxFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">VmaxFunction</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>


    <span class="k">def</span> <span class="nf">store_and_load_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">force_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">linear_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dilution</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">stat_dict</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">store_and_load_statistics</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span>
            <span class="n">force_recompute</span><span class="o">=</span><span class="n">force_recompute</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="n">clean_dm</span><span class="p">,</span> <span class="n">dilution</span><span class="o">=</span><span class="n">dilution</span><span class="p">,</span> <span class="n">linear_field</span><span class="o">=</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="n">lpt_field</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;k&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span><span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_paired&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shotnoise&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_single&#39;</span><span class="p">:</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">linear_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lpt_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field_paired&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field_paired2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">store_and_load_sdm_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">force_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">linear_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">stat_dict</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">store_and_load_sdm_statistics</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span>
            <span class="n">force_recompute</span><span class="o">=</span><span class="n">force_recompute</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="n">clean_dm</span><span class="p">,</span> <span class="n">linear_field</span><span class="o">=</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="n">lpt_field</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;k&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span><span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span><span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_paired&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shotnoise&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_single&#39;</span><span class="p">:</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">linear_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lpt_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field_paired&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field_paired2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">store_and_load_xspectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="s1">&#39;brute-force&#39;</span><span class="p">,</span>
                                <span class="n">force_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dilution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linear_field</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">stat_dict</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">store_and_load_xspectra</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span>
            <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span> <span class="n">force_recompute</span><span class="o">=</span><span class="n">force_recompute</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="n">clean_dm</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="n">lpt_field</span><span class="p">,</span>
            <span class="n">dilution</span><span class="o">=</span><span class="n">dilution</span><span class="p">,</span> <span class="n">linear_field</span><span class="o">=</span><span class="n">linear_field</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;k&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span><span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pk_paired&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;pk_single&#39;</span><span class="p">:</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">linear_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lpt_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field_paired&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field_paired2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">compute_haloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_haloPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span><span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pk0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pk1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">compute_halo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_halo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="s1">&#39;xi&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_paired&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">compute_halo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_halo_multipoles</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                     <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="s1">&#39;xi_l0&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l0_pair&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2_pair&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4_pair&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">compute_subPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;mpeak&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">,</span><span class="n">Mask_Type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alive_allsats</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span> <span class="n">Mask_Type</span> <span class="o">=</span> <span class="n">Mask_Type</span><span class="p">,</span> <span class="n">alive_allsats</span> <span class="o">=</span> <span class="n">alive_allsats</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span>                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;k&quot;</span><span class="p">],</span>
                <span class="s1">&#39;pk&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;pk_paired&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span>    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk_theory_lin&quot;</span><span class="p">],</span>
                <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span>     <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pk_theory_nl&quot;</span><span class="p">],</span>
                <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span>        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shotnoise&quot;</span><span class="p">],</span>
                <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span>           <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nmodes&quot;</span><span class="p">],</span>
                <span class="s1">&#39;r&#39;</span> <span class="p">:</span>               <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="s1">&#39;xi&#39;</span> <span class="p">:</span>              <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi1&#39;</span> <span class="p">:</span>             <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi1&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi2&#39;</span> <span class="p">:</span>             <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mergertime_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="n">no_destruction</span><span class="p">,</span><span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="s1">&#39;xi&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_paired&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_multipoles</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span><span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                     <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="s1">&#39;xi_l0&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l0_pair&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2_pair&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4_pair&#39;</span><span class="p">:</span>        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_multipoles_JN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="c1">#Technically, the JN error should not be average. This error should be considered as a upper limit of the error</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_multipoles_JN</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="n">no_destruction</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="n">mergertime_factor</span><span class="p">,</span><span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">,</span><span class="n">n_jn3</span><span class="o">=</span><span class="n">n_jn3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span>                     <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="s1">&#39;xi_l0&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l0_pair&#39;</span><span class="p">:</span>          <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2_pair&#39;</span><span class="p">:</span>          <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4&#39;</span><span class="p">:</span>               <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4_pair&#39;</span><span class="p">:</span>          <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l0_err&#39;</span><span class="p">:</span>           <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0_err&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l0_pair_err&#39;</span><span class="p">:</span>      <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l0_err&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2_err&#39;</span><span class="p">:</span>           <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2_err&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l2_pair_err&#39;</span><span class="p">:</span>      <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l2_err&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4_err&#39;</span><span class="p">:</span>           <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4_err&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;xi_l4_pai_errr&#39;</span><span class="p">:</span>      <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;xi_l4_err&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_0_pi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="n">Mhalo_lim</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="n">compute_noOrphans</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="n">no_destruction</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">compute_sdm_bispectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>

        <span class="n">cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span> <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cosmology</span>

        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                   <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                   <span class="n">bs_num_triangles</span><span class="o">=</span><span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="n">bs_deltak</span><span class="p">,</span>
                                   <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">compute_hmm_bispectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_crossspectrum</span>

        <span class="n">cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span> <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cosmology</span>

        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_crossspectrum</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                   <span class="n">pos1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span> <span class="n">pos2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                   <span class="n">vel1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">],</span> <span class="n">vel2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                   <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                   <span class="n">bs_num_triangles</span><span class="o">=</span><span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="n">bs_deltak</span><span class="p">,</span>
                                   <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">compute_halo_bispectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>

        <span class="n">cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span> <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cosmology</span>

        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">],</span>
                                   <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                   <span class="n">bs_num_triangles</span><span class="o">=</span><span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="n">bs_deltak</span><span class="p">,</span>
                                   <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>


<div class="viewcode-block" id="Simulation"><a class="viewcode-back" href="../../code.html#bacco.Simulation">[docs]</a><span class="k">class</span> <span class="nc">Simulation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that defines a cosmological simulation</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tree_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lgals_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sim_cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parameter_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Nmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;Default&quot;</span><span class="p">,</span> <span class="n">pkfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma8</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sim_format</span><span class="o">=</span><span class="s2">&quot;gadget_hdf5&quot;</span><span class="p">,</span> <span class="n">do_compression</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fixedPk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">RaylQuantile</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_relativistic_effects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lpicola</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pinocchio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">total_snapshots</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">numpart</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span> <span class="o">=</span> <span class="n">basedir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpicola</span> <span class="o">=</span> <span class="n">lpicola</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio</span> <span class="o">=</span> <span class="n">pinocchio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapnum</span> <span class="o">=</span> <span class="n">snapnum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span> <span class="o">=</span> <span class="n">use_orphans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RaylQuantile</span> <span class="o">=</span> <span class="n">RaylQuantile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_relativistic_effects</span> <span class="o">=</span> <span class="n">add_relativistic_effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_snapshots</span> <span class="o">=</span> <span class="n">total_snapshots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numpart</span> <span class="o">=</span> <span class="n">numpart</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">lpicola</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_ids&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;lpicola and load_ids are incompatible&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">do_compression</span> <span class="o">=</span> <span class="n">do_compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dask</span> <span class="o">=</span> <span class="n">dask</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dask</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">do_compression</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Dask and do_compression options are incompatible&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Incompatible options&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">dm_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">halo_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">desc_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">desc_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">tree_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">tree_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgals_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">lgals_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">lgals_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="k">if</span> <span class="n">dm_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qdata_dm_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="s1">&#39;.qdata&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qdata_halo_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;.qdata&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qdata_sdm_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;._sdm_qdata&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_orphans</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdata_sub_file</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;_orph.qdata&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdata_sub_file</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;_sub.qdata&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halo_nfw_pars_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;._halo_nfw_pars&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c_speed</span> <span class="o">=</span> <span class="mf">3.0e5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Softening</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="k">if</span> <span class="n">sim_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gadget2&#39;</span><span class="p">,</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">,</span> <span class="s1">&#39;gadget_hdf5&#39;</span><span class="p">,</span><span class="s1">&#39;TNG&#39;</span><span class="p">,</span> <span class="s1">&#39;TNG_onlyDM&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">=</span> <span class="n">sim_format</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;simulation format &#39;</span><span class="si">{0}</span><span class="s2">&#39; not available&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sim_format</span><span class="p">))</span>

        <span class="c1"># Legacy options for old-format simulation</span>
        <span class="k">if</span> <span class="n">fixedPk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FixedInitialAmplitude</span> <span class="o">=</span> <span class="n">fixedPk</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">InitialPhase</span> <span class="o">=</span> <span class="n">phase</span>
        <span class="k">if</span> <span class="n">Nmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nmesh</span> <span class="o">=</span> <span class="n">Nmesh</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nmesh</span> <span class="o">=</span> <span class="mi">128</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising simulation </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>

        <span class="c1"># The cosmology is either provided by the user or read from the parameter&#39;s file</span>
        <span class="k">if</span> <span class="n">sim_cosmology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sim_cosmology</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;Cosmology&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Provided cosmology is not of a valid class&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sim_cosmology</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpicola</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#params = utils.read_parameter_file(parameter_file)</span>
            <span class="c1">#raise RuntimeError(&quot;Need to make sure that reading a parameter file is compatible with reading the header from a HDF5 simulation&quot;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_s</span> <span class="o">=</span> <span class="n">A_s</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span> <span class="o">=</span> <span class="n">sigma8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FixedInitialAmplitude</span> <span class="o">=</span> <span class="n">fixedPk</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">InitialPhase</span> <span class="o">=</span> <span class="n">phase</span>

            <span class="n">initial_growth_expfac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TimeBegin&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;TimeBegin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">else</span> <span class="mf">0.01</span>

            <span class="n">c_pars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Omega&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaNu&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;omega_de&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaLambda&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;omega_baryon&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;hubble&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;neutrino_mass&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaNu&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">93.14</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                      <span class="s1">&#39;sigma8&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Sigma8&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;w0&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;wa&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;A_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;expfactor&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span><span class="p">],</span> <span class="c1">#We do this so the input power spectrum doesn&#39;t get re-normalised to match sigma8</span>
                      <span class="s1">&#39;pkfile&#39;</span><span class="p">:</span> <span class="n">pkfile</span><span class="p">,</span>
                      <span class="s1">&#39;pkfile_expfactor&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TimeBegin&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WhichSpectrum&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
                      <span class="s1">&#39;use_radiation&#39;</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UseRadiation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="s1">&#39;initial_growth_expfac&#39;</span><span class="p">:</span> <span class="n">initial_growth_expfac</span>
                      <span class="p">}</span>
            <span class="k">if</span> <span class="n">A_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c_pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_s</span>
                <span class="n">c_pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">sigma8</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c_pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">c_pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma8</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">c_pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">c_pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">c_pars</span><span class="p">[</span><span class="s1">&#39;de_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;w0wa&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">(</span><span class="o">**</span><span class="n">c_pars</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">damping_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_nonlinear_scale</span><span class="p">()</span>

        <span class="c1"># Define a dictionary with lazy attributes already computed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sim_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gadget_hdf5&quot;</span><span class="p">,</span><span class="s1">&#39;TNG&#39;</span><span class="p">,</span> <span class="s1">&#39;TNG_onlyDM&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_snapshot_arr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_snapshots</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;...done in </span><span class="si">{0:.3}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;FixedInitialAmplitude&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;InitialPhase&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sim_desc</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot; ICs: </span><span class="se">\t</span><span class="s2"> Fixed Amplitude = </span><span class="si">{0}</span><span class="s2">, Seed = </span><span class="si">{1}</span><span class="s2">, InitialPhase = </span><span class="si">{2}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot; Data: </span><span class="se">\t</span><span class="s2"> FileFormat = </span><span class="si">{3}</span><span class="s2">, Compression = </span><span class="si">{4}</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">)</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;InitialPhase&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_compression</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sim_desc</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot; ICs: </span><span class="se">\t</span><span class="s2"> Seed = </span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot; Data: </span><span class="se">\t</span><span class="s2"> FileFormat = </span><span class="si">{1}</span><span class="s2">, Compression = </span><span class="si">{2}</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">)</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_compression</span><span class="p">))</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Simulation </span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span> <span class="n">sim_desc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span>
<span class="c1">#--------------------------------------------------------------------</span>
<span class="c1">#----- I/O routines -------------------------------------------------</span>
<span class="c1">#--------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_load_dark_matter_gadget_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_compression</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">h5py</span>

        <span class="k">if</span> <span class="n">dask</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">dd</span>

            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">])]</span>

            <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;Coordinates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>

            <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;Velocities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">]</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>

            <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;ParticleIDs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">]</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">ids</span>

        <span class="k">def</span> <span class="nf">_wrap</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">wrapbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">):</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wrapbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">wrapbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wrapbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">wrapbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wrapbox</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">wrapbox</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">dp</span>

        <span class="k">if</span> <span class="n">do_compression</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]):</span>

            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> \
                <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumPart_ThisFile&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">do_compression</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># Let&#39;s transform all the particles</span>
                    <span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;Coordinates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span>
                                               <span class="mi">256</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                    <span class="c1"># Let&#39;s improve the compression for particles in halos</span>
                    <span class="n">cumnhalos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cumnhalos</span><span class="p">[</span><span class="n">ifile</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">][</span><span class="n">ifile</span><span class="p">],</span> <span class="n">cumnhalos</span><span class="p">[</span><span class="n">ifile</span><span class="p">]):</span>
                        <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
                        <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>

                        <span class="c1">#dx = 3*sim.Cosmology.mass_to_eulerian_radius(sim.fof[&#39;halo_mfof&#39;][ihalo])/256</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="mi">3</span><span class="o">/</span><span class="mf">256.</span>
                        <span class="n">ddx</span> <span class="o">=</span> <span class="n">_wrap</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;Coordinates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">i0</span> <span class="o">-</span>
                                                                         <span class="n">istart</span><span class="p">:</span><span class="n">i1</span><span class="o">-</span><span class="n">istart</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">,</span> <span class="p">:])</span>
                        <span class="n">pos</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ddx</span><span class="o">/</span><span class="n">dx</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;Coordinates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;Velocities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">ids</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;PartType1&#39;</span><span class="p">][</span><span class="s1">&#39;ParticleIDs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> \
                    <span class="mi">1</span>  <span class="c1"># Somehow G4 IDs start at 1, not 0</span>

                <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Read data for </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> particles...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">])))</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]),</span> <span class="n">ids</span>

    <span class="k">def</span> <span class="nf">_load_header_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">h5py</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_file</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;try </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.0.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;header file is None&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">pkeys</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">hkeys</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;ns&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;PrimordialIndex&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;PrimordialIndex&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PrimordialIndex not found in the snapshot file neither was provided&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;w0&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span><span class="p">:</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">if</span> <span class="s1">&#39;wa&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span><span class="p">:</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span><span class="p">:</span>
            <span class="n">renorm</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">renorm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">As</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;As&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">As</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">As</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">As</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s8</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Sigma8&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">As</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">numpart</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumPart_Total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;NumPart_Total&#39;</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumPart_Total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numpart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpart</span>
        <span class="n">GRAVITY</span> <span class="o">=</span> <span class="mf">6.672e-8</span>
        <span class="n">Mpc_in_cm</span> <span class="o">=</span> <span class="mf">3.085678e+24</span>
        <span class="n">km_in_cm</span> <span class="o">=</span> <span class="mf">1e5</span>
        <span class="n">NewtonsConstant</span> <span class="o">=</span>  <span class="p">(</span><span class="n">GRAVITY</span> <span class="o">/</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UnitMass_in_g&#39;</span><span class="p">]</span> <span class="o">*</span>
                                    <span class="p">(</span> <span class="n">Mpc_in_cm</span> <span class="o">/</span> <span class="n">km_in_cm</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#The km/s/Mpc should not change, since the units include an h factor with H = h * 100 km/s/Mpc</span>

        <span class="k">if</span> <span class="s1">&#39;MassTable&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TNG&#39;</span><span class="p">]:</span>
                <span class="n">particle_mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">100</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">NewtonsConstant</span><span class="p">))</span> <span class="o">*</span>
                               <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">numpart</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">particle_mass</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">100</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">NewtonsConstant</span><span class="p">))</span> <span class="o">*</span>
                              <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">numpart</span><span class="p">)</span>
        <span class="c1">#The h factor is remove, since is include in the units, and the 100 is add since it was missing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">particle_mass</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;MassTable&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;BoxSize&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TNG&#39;</span><span class="p">,</span> <span class="s1">&#39;TNG_onlyDM&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span>
                  <span class="s2">&quot;Omega&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;OmegaBaryon&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;OmegaBaryonCAMB&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;OmegaBaryonCAMB&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;OmegaLambda&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;OmegaLambda&#39;</span><span class="p">],</span>
                  <span class="c1"># f[&#39;Parameters&#39;].attrs[&#39;PowerSpectrumFile&#39;],</span>
                  <span class="s2">&quot;PowerSpectrumFile&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span> <span class="o">+</span> <span class="s2">&quot;/inputspec_snap.txt&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Sigma8&quot;</span><span class="p">:</span> <span class="n">s8</span><span class="p">,</span>
                  <span class="s2">&quot;As&quot;</span><span class="p">:</span> <span class="n">As</span><span class="p">,</span>
                  <span class="s2">&quot;OutputDir&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;OutputDir&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;Redshift&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Redshift&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;ParticleMass&quot;</span><span class="p">:</span> <span class="n">particle_mass</span><span class="p">,</span>
                  <span class="s2">&quot;NpartTotal&quot;</span><span class="p">:</span> <span class="n">numpart</span><span class="p">,</span>
                  <span class="s2">&quot;Nfiles&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumFilesPerSnapshot&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;NumFilesPerSnapshot&#39;</span> <span class="ow">in</span> <span class="n">hkeys</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;Nsample&quot;</span><span class="p">:</span>     <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Nsample&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="s2">&quot;HubbleParam&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;TimeBegin&quot;</span><span class="p">:</span>    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;TimeBegin&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;Seed&quot;</span><span class="p">:</span>         <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;Seed&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="s2">&quot;ns&quot;</span><span class="p">:</span>           <span class="n">ns</span><span class="p">,</span>
                  <span class="s2">&quot;w0&quot;</span><span class="p">:</span>           <span class="n">w0</span><span class="p">,</span>
                  <span class="s2">&quot;wa&quot;</span><span class="p">:</span>           <span class="n">wa</span><span class="p">,</span>
                  <span class="s2">&quot;ReNormalizeInputSpectrum&quot;</span><span class="p">:</span> <span class="n">renorm</span><span class="p">,</span>
                  <span class="s2">&quot;tau&quot;</span><span class="p">:</span>          <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;tau&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
                  <span class="s2">&quot;OmegaNu&quot;</span><span class="p">:</span>      <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;OmegaNu&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;OmegaNu&#39;</span> <span class="ow">in</span> <span class="n">hkeys</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="s2">&quot;WhichSpectrum&quot;</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;WhichSpectrum&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;UseRadiation&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="s2">&quot;UseRadiation&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UseRadiation&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;UseRadiation&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="s2">&quot;Softening&quot;</span><span class="p">:</span>    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;SofteningComovingClass0&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SofteningComovingClass0&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Softening</span><span class="p">,</span>
                  <span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FixedInitialAmplitude&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;FixedInitialAmplitude&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">FixedInitialAmplitude</span><span class="p">,</span>
                  <span class="s2">&quot;Nmesh&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nmesh&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Nmesh&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nmesh</span><span class="p">,</span>
                  <span class="s2">&quot;UnitLength_in_cm&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;UnitLength_in_cm&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="mf">3.085678e+24</span><span class="p">,</span>
                  <span class="s2">&quot;NewtonsConstant&quot;</span> <span class="p">:</span> <span class="n">NewtonsConstant</span><span class="p">,</span>
                  <span class="s2">&quot;InitialPhase&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;InitPhase&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;InitPhase&#39;</span> <span class="ow">in</span> <span class="n">pkeys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialPhase</span>
                  <span class="p">}</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.045</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">header</span>

    <span class="k">def</span> <span class="nf">_load_header_gadget2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">struct</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_file</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;header file not found </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">:</span>
            <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">blockname</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;4s&#39;</span><span class="p">,</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Some parameters could not be set because of Gadget type-1 snapshot. Using defaults.&quot;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;Create a GadgetHeader from a byte range read from a file.&quot;&quot;&quot;</span>
        <span class="n">npart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">redshift</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">npartTotal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">num_files</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">BoxSize</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">Omega0</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">OmegaLambda</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">HubbleParam</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">NallHW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;=IIIIIIddddddddiiIIIIIIiiddddiiIIIIIIiiif48s&quot;</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;There is a bug in load_header() in simulation.py; the header format string is not 256 bytes&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">npart</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">npart</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npart</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">npart</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">npart</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">npart</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
         <span class="n">mass</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mass</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mass</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mass</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mass</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mass</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
         <span class="n">time</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span>  <span class="n">flag_sfr</span><span class="p">,</span> <span class="n">flag_feedback</span><span class="p">,</span>
         <span class="n">npartTotal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">npartTotal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npartTotal</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">npartTotal</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">npartTotal</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">npartTotal</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
         <span class="n">flag_cooling</span><span class="p">,</span> <span class="n">num_files</span><span class="p">,</span> <span class="n">BoxSize</span><span class="p">,</span> <span class="n">Omega0</span><span class="p">,</span> <span class="n">OmegaLambda</span><span class="p">,</span> <span class="n">HubbleParam</span><span class="p">,</span> <span class="n">flag_stellarage</span><span class="p">,</span> <span class="n">flag_metals</span><span class="p">,</span>
         <span class="n">NallHW</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NallHW</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">NallHW</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">NallHW</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">NallHW</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">NallHW</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
         <span class="n">flag_entropy_instead_u</span><span class="p">,</span> <span class="n">flag_doubleprecision</span><span class="p">,</span> <span class="n">flag_ic_info</span><span class="p">,</span> <span class="n">lpt_scalingfactor</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;seed, sigma8, ns, and tau must be provided for Gadget2 headers&quot;</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;BoxSize&quot;</span><span class="p">:</span> <span class="n">BoxSize</span><span class="p">,</span>
                  <span class="s2">&quot;Omega&quot;</span><span class="p">:</span> <span class="n">Omega0</span><span class="p">,</span>
                  <span class="s2">&quot;OmegaBaryon&quot;</span><span class="p">:</span> <span class="mf">0.045</span><span class="p">,</span>
                  <span class="s2">&quot;OmegaLambda&quot;</span><span class="p">:</span> <span class="n">OmegaLambda</span><span class="p">,</span>
                  <span class="c1"># f[&#39;Parameters&#39;].attrs[&#39;PowerSpectrumFile&#39;],</span>
                  <span class="s2">&quot;PowerSpectrumFile&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span> <span class="o">+</span> <span class="s2">&quot;/inputspec_snap.txt&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;OutputDir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="p">,</span>
                  <span class="s2">&quot;Redshift&quot;</span><span class="p">:</span> <span class="n">redshift</span><span class="p">,</span>
                  <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                  <span class="s2">&quot;NpartTotal&quot;</span><span class="p">:</span> <span class="n">npartTotal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                  <span class="s2">&quot;ParticleMass&quot;</span><span class="p">:</span> <span class="n">mass</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                  <span class="s2">&quot;Nfiles&quot;</span><span class="p">:</span> <span class="n">num_files</span><span class="p">,</span>
                  <span class="s2">&quot;HubbleParam&quot;</span><span class="p">:</span> <span class="n">HubbleParam</span><span class="p">,</span>
                  <span class="s2">&quot;Sigma8&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span><span class="p">,</span>
                  <span class="s2">&quot;Seed&quot;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                  <span class="s2">&quot;ns&quot;</span><span class="p">:</span>        <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span>
                  <span class="s2">&quot;tau&quot;</span><span class="p">:</span>       <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
                  <span class="s2">&quot;OmegaNu&quot;</span><span class="p">:</span>   <span class="mi">0</span><span class="p">,</span>
                  <span class="s2">&quot;Softening&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Softening</span><span class="p">,</span>
                  <span class="s2">&quot;WhichSpectrum&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="s2">&quot;ReNormalizeInputSpectrum&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="s2">&quot;UseRadiation&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="s2">&quot;InitialPhase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialPhase</span><span class="p">,</span>
                  <span class="s2">&quot;Nmesh&quot;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">Nmesh</span><span class="p">,</span>
                  <span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">FixedInitialAmplitude</span>
                  <span class="p">}</span>
        <span class="k">return</span> <span class="n">header</span>

    <span class="k">def</span> <span class="nf">_load_tree_gadget2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">struct</span>
        <span class="kn">import</span> <span class="nn">array</span>

        <span class="k">class</span> <span class="nc">TreeStruct</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;Descendant&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;FirstProgenitor&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;NextProgenitor&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;FirstHaloInFOFgroup&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;NextHaloInFOFgroup&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Len&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;M_Mean200&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;M_Crit200&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;M_TopHat200&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Pos0&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Pos1&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Pos2&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Vel0&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Vel1&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Vel2&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;VelDisp&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Vmax&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Spin0&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Spin1&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Spin2&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;CM0&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;CM1&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;CM2&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;SubMostBoundID&#39;</span><span class="p">,</span> <span class="n">c_longlong</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;SnapNum&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;FileNr&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;SubIndex&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;RadMhalf&#39;</span><span class="p">,</span> <span class="n">c_float</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_file</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;tree_file not given&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">Ntreefiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">Ntottrees</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ntreefiles</span><span class="p">):</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_file</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ntreefiles</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">dummy</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dummy</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ntrees</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ntottrees</span> <span class="o">+=</span> <span class="n">Ntrees</span>

        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ntreefiles</span><span class="p">):</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_file</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">Ntreefiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ncells_per_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ntrees</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Nhalos</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ifile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cat</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;TreeLen&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ntottrees</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ntottrees</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
                <span class="n">NtreeLen</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
                <span class="n">NtreeLen</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">Ntrees</span><span class="p">)</span>

                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;TreeLen&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span> <span class="n">Ntrees</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">,</span> <span class="n">Ntrees</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">itree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntrees</span><span class="p">):</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Descendant&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                           <span class="s1">&#39;FirstProgenitor&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                           <span class="s1">&#39;NextProgenitor&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                           <span class="s1">&#39;FirstHaloInFOFgroup&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                           <span class="s1">&#39;NextHaloInFOFgroup&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                           <span class="s1">&#39;SubMostBoundID&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                                           <span class="s1">&#39;SnapNum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                           <span class="s1">&#39;Len&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                           <span class="s1">&#39;Vmax&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                           <span class="s1">&#39;VelDisp&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                           <span class="s1">&#39;Pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                           <span class="s1">&#39;Vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                                           <span class="p">}</span>

                    <span class="k">for</span> <span class="n">inode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NtreeLen</span><span class="p">[</span><span class="n">itree</span><span class="p">]):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">TreeStruct</span><span class="p">()</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;Descendant&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Descendant</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;FirstProgenitor&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">FirstProgenitor</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;NextProgenitor&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">NextProgenitor</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;NextHaloInFOFgroup&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">NextHaloInFOFgroup</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;FirstHaloInFOFgroup&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">FirstHaloInFOFgroup</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;SubMostBoundID&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">SubMostBoundID</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;SnapNum&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">SnapNum</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;Pos&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Pos0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">Pos1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">Pos2</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;Vel&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Vel0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">Vel1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">Vel2</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;Len&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Len</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;Vmax&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Vmax</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Trees&#39;</span><span class="p">][</span><span class="n">itree</span><span class="p">][</span><span class="s1">&#39;VelDisp&#39;</span><span class="p">][</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">VelDisp</span>

                <span class="n">istart</span> <span class="o">+=</span> <span class="n">Ntrees</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  Found </span><span class="si">{0}</span><span class="s1"> Trees&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">istart</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  Total Number of Trees </span><span class="si">{0}</span><span class="s1"> Trees&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Ntottrees</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cat</span>

    <span class="k">def</span> <span class="nf">_load_fof_gadget2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">struct</span>
        <span class="kn">import</span> <span class="nn">array</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]):</span>

            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="p">(</span>
                <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">nhalos_this</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nhalos</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nids_this</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nids</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nfiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ifile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Found the following header&#39;</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;nhalos_this&#39;</span><span class="p">,</span> <span class="n">nhalos_this</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;nhalos&#39;</span><span class="p">,</span> <span class="n">nhalos</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;nids_this&#39;</span><span class="p">,</span> <span class="n">nids_this</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;nids&#39;</span><span class="p">,</span> <span class="n">nids</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;nfiles&#39;</span><span class="p">,</span> <span class="n">nfiles</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ifile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;halo_vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;halo_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;halo_len&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;halo_rvir&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;halo_mvir&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                           <span class="p">}</span>

                <span class="n">nh</span> <span class="o">=</span> <span class="n">nhalos_this</span>
                <span class="c1"># halo len</span>
                <span class="n">tlen</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
                <span class="n">tlen</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">nh</span><span class="p">)</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">nh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tlen</span><span class="p">,</span> <span class="p">(</span><span class="n">nh</span><span class="p">))</span>

                <span class="c1"># group offset</span>
                <span class="n">tlen</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
                <span class="n">tlen</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">nh</span><span class="p">)</span>
                <span class="c1"># cat[&#39;halo_len&#39;][istart:istart+nh] = np.reshape(tlen,(nh))</span>

                <span class="c1"># halo id</span>
                <span class="n">tid</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
                <span class="n">tid</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">nh</span><span class="p">)</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_id&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">nh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="p">(</span><span class="n">nh</span><span class="p">))</span>

                <span class="c1"># halo pos</span>
                <span class="n">tpos</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                <span class="n">tpos</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">nh</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">nh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tpos</span><span class="p">,</span> <span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

                <span class="c1"># halo vel</span>
                <span class="n">tvel</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                <span class="n">tvel</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">nh</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">nh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tvel</span><span class="p">,</span> <span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

                <span class="n">istart</span> <span class="o">+=</span> <span class="n">nh</span>

        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span>
        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_rvir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  Found </span><span class="si">{0}</span><span class="s1"> FoF groups&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">istart</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cat</span>

    <span class="k">def</span> <span class="nf">_create_snapshot_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">create_snapshot_arr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">total_snapshots</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpicola</span><span class="p">:</span>
            <span class="n">_z</span><span class="p">,</span> <span class="n">_nstep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/output_redshifts.dat&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">_z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">_z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio</span><span class="p">:</span>
            <span class="n">_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/output_redshifts.dat&#39;</span><span class="p">)</span>
            <span class="n">_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">_z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">_z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
        <span class="k">elif</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/output.hdf5&#39;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/output.hdf5&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/outputlist.txt&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/outputlist.txt&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;snaplist load from outputlist.dat, probably wrong...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/outputlist.dat&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;snaplist load from outputlist.dat, probably wrong...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;Hz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;LBT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;LBT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">lookback_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">time_to_present</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;Hz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;LBT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">lookback_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">time_to_present</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;Hz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_lgalaxies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">istart_ids</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cum_dm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgals_file</span> <span class="o">+</span> <span class="s1">&#39;_0.h5&#39;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgals_file</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">nfiles</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumTreeFiles&quot;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nfiles</span><span class="p">):</span>
            <span class="n">ngals</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lgals_file</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{0}</span><span class="s1">.h5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ifile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ngals</span> <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;TotGalaxies&quot;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapnum</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nfiles</span><span class="p">):</span>

            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgals_file</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">ifile</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Key &#39;</span><span class="si">{0}</span><span class="s2">&#39; does not exists in the L-Galaxies file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">ifile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngals</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngals</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;mhalo&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;mstar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;sfr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                           <span class="p">}</span>

                <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;TotGalaxies&#39;</span><span class="p">]</span>

                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Pos&#39;</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Vel&#39;</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mhalo&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;CentralMvir&#39;</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mstar&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;StellarMass&#39;</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Sfr&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Read data for </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> galaxies...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">ngals</span><span class="p">))</span>

            <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; L-Galaxies output loaded in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cat</span>


    <span class="k">def</span> <span class="nf">_load_sub_gadget_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.0.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;Subhalo&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Key &#39;Subhalo&#39; does not exists in the halo file&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span> <span class="p">(</span><span class="s2">&quot;Key &#39;Subhalo&#39; does not exists in the halo file&quot;</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dictionary</span> <span class="ow">in</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()}]:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;MassTable&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">Mpc_in_cm</span> <span class="o">=</span> <span class="mf">3.085678e+24</span>
            <span class="n">km_in_cm</span> <span class="o">=</span> <span class="mf">1e5</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TNG&#39;</span><span class="p">]:</span>
                <span class="n">particle_mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">100</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NewtonsConstant&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpart</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">particle_mass</span> <span class="o">=</span> <span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">100</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NewtonsConstant&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpart</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">particle_mass</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;MassTable&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">nfiles</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nfiles</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">{0}</span><span class="s1">.hdf5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)]</span>

        <span class="c1">#_check_files_exist()</span>

        <span class="n">fdtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="n">idtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_count</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">file_count</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_count_tot</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">file_count</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_load_stellarmass</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_read_hdf5_property</span><span class="p">((</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))[:,</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">_read_hdf5_property</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">global_count</span><span class="p">,</span> <span class="n">file_count</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">args</span>
            <span class="c1"># with h5py.File(fname_list[0], &#39;r&#39;) as f:</span>
            <span class="c1">#     if &#39;Norphans_Total&#39; in f[&#39;Header&#39;].attrs and self.use_orphans is False:</span>
            <span class="c1">#         norphans = f[&#39;Header&#39;].attrs[&#39;Norphans_Total&#39;]</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         norphans = 0</span>
            <span class="c1"># norphans = 0</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">]),</span> <span class="n">ndim</span><span class="p">)</span> <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">{0}</span><span class="s2"> items for </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">]),</span> <span class="n">field</span><span class="p">))</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">skeys</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;SnapBecameOrphan&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span><span class="p">:</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SnapBecameOrphan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="sa">u</span><span class="s1">&#39;SubhaloLen&#39;</span> <span class="ow">in</span> <span class="n">skeys</span><span class="p">:</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1">#Always true</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]),</span> <span class="kc">True</span><span class="p">)</span>

                    <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">npts</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                    <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">istart</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">*</span><span class="n">norm</span>

        <span class="k">def</span> <span class="nf">_fill_parent_halo</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">nsub</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="n">BoxSize</span> <span class="o">=</span> <span class="n">args</span>
            <span class="kn">from</span> <span class="nn">.cyengine</span> <span class="k">import</span> <span class="n">cymock</span>

            <span class="n">use_orphans</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">skeys</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">_pos</span> <span class="o">=</span> <span class="n">_read_hdf5_property</span><span class="p">((</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nsub</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;SnapBecameOrphan&#39;</span> <span class="ow">in</span> <span class="n">skeys</span><span class="p">:</span>
                <span class="n">_orphan_snap</span> <span class="o">=</span> <span class="n">_read_hdf5_property</span><span class="p">((</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SnapBecameOrphan&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_orphan_snap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span> <span class="o">=</span> <span class="n">use_orphans</span>

            <span class="n">cat</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mfof&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;m200c&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;r200c&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">cymock</span><span class="o">.</span><span class="n">halo_sub_prop</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mfof&#39;</span><span class="p">],</span>
                                 <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;m200c&#39;</span><span class="p">],</span>
                                 <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;r200c&#39;</span><span class="p">],</span>
                                 <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">],</span>
                                 <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span>
                                 <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">],</span>
                                 <span class="n">_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_nsubs&#39;</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_firstsub&#39;</span><span class="p">],</span>
                                 <span class="n">BoxSize</span>
                                <span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span><span class="p">:</span>
                <span class="n">_pos</span> <span class="o">=</span> <span class="n">_pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nsub</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">_subnr</span> <span class="o">=</span> <span class="n">_read_hdf5_property</span><span class="p">((</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloRankInGr&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">mask_orp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_orphan_snap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">find_BinA</span><span class="p">(</span><span class="n">_subnr</span><span class="p">,</span> <span class="n">_subnr</span><span class="p">[</span><span class="n">mask_orp</span><span class="p">])</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">-</span> <span class="n">_pos</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;m200c&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;m200c&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;r200c&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;r200c&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">_subnr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if not use_orphans, mask orphans and keep those that are still alive</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">_orphan_snap</span><span class="o">==</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span><span class="o">==</span><span class="kc">False</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mfof&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;m200c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;m200c&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;r200c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;r200c&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">_pos</span>
            <span class="k">del</span> <span class="n">_orphan_snap</span>

            <span class="k">return</span> <span class="n">cat</span>

        <span class="k">return</span> <span class="n">LazyDict</span><span class="p">({</span>
            <span class="s1">&#39;nsubs_in_file&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_count</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;pos&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TNG&quot;</span><span class="p">,</span><span class="s2">&quot;TNG_onlyDM&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;vel&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloVel&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;mostboundID&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;MostboundID&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;len&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;subnr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloRankInGr&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;grnr&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGrNr&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;vmax&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloVmax&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;rmax&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloVmaxRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;vpeak&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;peak_time&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;PeakTime&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;mpeak&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMpeak&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TNG&quot;</span><span class="p">,</span><span class="s2">&quot;TNG_onlyDM&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">particle_mass</span><span class="p">)),</span>
            <span class="s1">&#39;vel_core&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloVelCore&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;VelDisp_Mean200&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;id_offsets&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloOffset&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;offsets&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;VelDisp_Mean200&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;mdot_at_mpeak&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMdotAtMpeak&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="n">particle_mass</span><span class="p">)),</span>
            <span class="s1">&#39;mdot&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMdot&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="n">particle_mass</span><span class="p">)),</span>
            <span class="s1">&#39;orphan_snap&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SnapBecameOrphan&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;infall_snap&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;InfallSnap&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;parent_halo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_fill_parent_halo</span><span class="p">,</span> <span class="p">(</span><span class="n">_read_hdf5_count_tot</span><span class="p">(</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">),</span> <span class="n">fdtype</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])),</span>
            <span class="c1">#from here ILLUSTRIS prop</span>
            <span class="c1">#some properties with *speciall* will keep it original units, they are mark with a #***</span>
            <span class="c1">#more info: http://www.tng-project.org/data/docs/specifications/</span>
            <span class="s1">&#39;BHMdot&#39;</span><span class="p">:</span>                   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloBHMdot&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span><span class="c1">#***</span>
            <span class="s1">&#39;StarMetalFractions&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStarMetalFractions&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;WindMass&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloWindMass&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetallicityMaxRad&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetallicityMaxRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;VelDisp&#39;</span><span class="p">:</span>                  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloVelDisp&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;SFR&#39;</span><span class="p">:</span>                      <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloSFR&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span><span class="c1">#Msun/yr, NO h factor!!</span>
            <span class="s1">&#39;StarMetallicityMaxRad&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStarMetallicityMaxRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;SFRinHalfRad&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloSFRinHalfRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;StarMetalFractionsHalfRad&#39;</span><span class="p">:(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStarMetalFractionsHalfRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetalFractionsMaxRad&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetalFractionsMaxRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetallicity&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetallicity&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;BHMass&#39;</span><span class="p">:</span>                   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloBHMass&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;IDMostbound&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloIDMostbound&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;HalfmassRad&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloHalfmassRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)),</span>
            <span class="s1">&#39;Parent&#39;</span><span class="p">:</span>                   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloParent&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;Spin&#39;</span><span class="p">:</span>                     <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloSpin&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)),</span><span class="c1">#(kpc/h)(km/s)</span>
            <span class="s1">&#39;GasMetalFractions&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetalFractions&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;StarMetallicityHalfRad&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStarMetallicityHalfRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;LenType&#39;</span><span class="p">:</span>                  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloLenType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetallicitySfrWeighted&#39;</span><span class="p">:(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetallicitySfrWeighted&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MassInRad&#39;</span><span class="p">:</span>                <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassInRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MassInHalfRad&#39;</span><span class="p">:</span>            <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassInHalfRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;SFRinRad&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloSFRinRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MassInMaxRad&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassInMaxRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;HalfmassRadType&#39;</span><span class="p">:</span>          <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloHalfmassRadType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MassInMaxRadType&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassInMaxRadType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;CM&#39;</span><span class="p">:</span>                       <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloCM&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)),</span>
            <span class="s1">&#39;StarMetallicity&#39;</span><span class="p">:</span>          <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStarMetallicity&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;BfldDisk&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloBfldDisk&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span><span class="c1">#***</span>
            <span class="s1">&#39;GasMetallicityHalfRad&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetallicityHalfRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MassInHalfRadType&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassInHalfRadType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;BfldHalo&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloBfldHalo&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span><span class="c1">#***</span>
            <span class="s1">&#39;Mass&#39;</span><span class="p">:</span>                     <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMass&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)),</span>
            <span class="s1">&#39;Flag&#39;</span><span class="p">:</span>                     <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloFlag&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetalFractionsSfr&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetalFractionsSfr&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MassInRadType&#39;</span><span class="p">:</span>            <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassInRadType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetalFractionsHalfRad&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetalFractionsHalfRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;SFRinMaxRad&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloSFRinMaxRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;StellarPhotometricsRad&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStellarPhotometricsRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)),</span>
            <span class="s1">&#39;StarMetalFractionsMaxRad&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStarMetalFractionsMaxRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetallicitySfr&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetallicitySfr&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MassType&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;MStell&#39;</span><span class="p">:</span>                   <span class="p">(</span><span class="n">_load_stellarmass</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloMassType&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;GasMetalFractionsSfrWeighted&#39;</span><span class="p">:(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloGasMetalFractionsSfrWeighted&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;StellarPhotometricsMassInRad&#39;</span><span class="p">:(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">,</span><span class="s1">&#39;SubhaloStellarPhotometricsMassInRad&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
            <span class="p">})</span>
<span class="c1">#Aditional Info:</span>
<span class="c1">#PartType0 - GAS</span>
<span class="c1">#PartType1 - DM</span>
<span class="c1">#PartType2 - (unused)</span>
<span class="c1">#PartType3 - TRACERS</span>
<span class="c1">#PartType4 - STARS &amp; WIND PARTICLES</span>
<span class="c1">#PartType5 - BLACK HOLES</span>
<span class="c1">#Stellar mass values:</span>
<span class="c1">#SubhaloMassInHalfRadType	float32	N,6	10^10Msun/h	Sum of masses of all particles/cells (split by type) within the stellar half mass radius.</span>
<span class="c1">#SubhaloMassInMaxRadType	float32	N,6	10^10Msun/h	Sum of masses of all particles/cells (split by type) within the radius of Vmax.</span>
<span class="c1">#SubhaloMassInRadType	  float32	N,6	10^10Msun/h	Sum of masses of all particles/cells (split by type) within twice the stellar half mass radius.</span>
<span class="c1">#SubhaloMassType	     float32	N,6	10^10Msun/h	Total mass of all member particle/cells which are bound to this Subhalo, separated by type.</span>
<span class="c1">#                                                   Particle/cells bound to subhaloes of this Subhalo are NOT accounted for. Note: Wind phase</span>
<span class="c1">#                                                   cells are counted as gas (type 0) for SubhaloMassType.</span>
    <span class="k">def</span> <span class="nf">_load_sub_gadget_hdf5_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">istart_ids</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cum_dm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span><span class="o">+</span><span class="s1">&#39;.0.hdf5&#39;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">nfiles</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span>
        <span class="n">atime</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">cum_nhalos_in_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nsubs_in_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nfiles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nfiles</span><span class="p">):</span>

            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="k">if</span> <span class="n">nfiles</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_desc&#39;</span><span class="p">]:</span>
                <span class="n">ffname_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_file</span> <span class="k">if</span> <span class="n">nfiles</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_file</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname_desc</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname_desc</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="k">if</span> <span class="s1">&#39;Subhalo&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Key &#39;Subhalo&#39; does not exists in the halo file&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ifile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;Norphans_Total&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">norphans</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Norphans_Total&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">norphans</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">nhalos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">norphans</span><span class="p">)</span>
                    <span class="c1">#nids = f[u&#39;Header&#39;].attrs[&#39;Nids_Total&#39;]</span>
                    <span class="n">cat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;mostboundID&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                           <span class="s1">&#39;len&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;grnr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;subnr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;vmax&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;rmax&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;vpeak&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;peak_time&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;mpeak&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;vel_core&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;mdot_at_mpeak&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                           <span class="s1">&#39;infall_snap&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;orphan_snap&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;id_offsets&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;Mdot&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                           <span class="p">}</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_desc&#39;</span><span class="p">]:</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;desc_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;desc_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;desc_firstprogflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

                    <span class="c1">#if config[&#39;io&#39;][&#39;load_idsubs&#39;]:</span>
                        <span class="c1">#cat[&#39;pid&#39;] = np.zeros(nids, dtype=np.int64)</span>

                <span class="n">skeys</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;SnapBecameOrphan&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SnapBecameOrphan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1">#Always true</span>

                <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#nids_this = f[&#39;Header&#39;].attrs[&#39;Nids_ThisFile&#39;]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;subnr&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloRankInGr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mostboundID&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;MostboundID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="sa">u</span><span class="s1">&#39;MostboundID&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;rmax&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloVmaxRad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="c1"># + cum_nhalos_in_file[ifile]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;grnr&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloGrNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVmax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVmaxRad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloVmax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;subhalos&#39;</span><span class="p">][</span><span class="s1">&#39;vmax_correction&#39;</span><span class="p">]:</span>
                    <span class="n">pv</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.109</span><span class="p">,</span><span class="mf">1.21</span><span class="p">,</span> <span class="mf">5.97</span><span class="p">,</span> <span class="mf">5.71</span><span class="p">]</span>
                    <span class="n">log_xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVmaxRad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
                    <span class="n">vcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_xx</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">pv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">log_xx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">pv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">log_xx</span><span class="o">**</span><span class="mi">1</span><span class="o">*</span><span class="n">pv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloVmax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                    <span class="n">vmax</span><span class="p">[</span><span class="n">log_xx</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)]</span> <span class="o">*=</span> <span class="n">vcorr</span><span class="p">[</span><span class="n">log_xx</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)]</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span>

                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span>
                             <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SubhaloVpeak&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mpeak&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span>
                             <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloMpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SubhaloMpeak&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id_offsets&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloOffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">istart_ids</span> <span class="k">if</span> <span class="s1">&#39;SubhaloOffset&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;Mdot&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloMdot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SubhaloMdot&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mdot_at_mpeak&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloMdotAtMpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SubhaloMdotAtMpeak&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;peak_time&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span>
                                 <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;PeakTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;PeakTime&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vel_core&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">,</span>
                                <span class="p">:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloVelCore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SubhaloVelCore&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SnapBecameOrphan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SnapBecameOrphan&#39;</span> <span class="ow">in</span> <span class="n">skeys</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;infall_snap&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;InfallSnap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

                <span class="c1">#if config[&#39;io&#39;][&#39;load_idsubs&#39;]:</span>
                <span class="c1">#    cat[&#39;pid&#39;][istart_ids:istart_ids + nids_this] = f[u&#39;IDs&#39;][u&#39;ID&#39;].value - \</span>
                <span class="c1">#        1  # Somehow G4 IDs start at 1, not 0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdm</span><span class="p">:</span>
                        <span class="n">dmnpts</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumPart_ThisFile&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span>
                                   <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">cum_dm</span>
                    <span class="n">cum_dm</span> <span class="o">+=</span> <span class="n">dmnpts</span>

                <span class="n">nsubs_in_file</span><span class="p">[</span><span class="n">ifile</span><span class="p">]</span> <span class="o">=</span> <span class="n">npts</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Read data for </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> subhalos...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">nhalos</span><span class="p">))</span>

            <span class="c1"># We optionally load the descendant catalogue</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_desc&#39;</span><span class="p">]:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname_desc</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;desc_index&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Descendants&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Desc_SubIndex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;desc_file&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Descendants&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Desc_FileNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;desc_firstprogflag&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span>
                                              <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Descendants&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;FirstProgFlag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="c1">#istart_ids += nids_this</span>
            <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; Subhalo loaded done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>


        <span class="c1"># Let&#39;s add two additional properties</span>
        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;nsubs_in_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsubs_in_file</span>
        <span class="c1">#TODO This fails when the simulation has orphans and load_orphans = False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]:</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]),</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span>

            <span class="n">r200c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_eulerian_radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">],</span> <span class="n">overdensity</span><span class="o">=</span><span class="mf">200.</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">.cyengine</span> <span class="k">import</span> <span class="n">cymock</span>
            <span class="n">_pos</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">cymock</span><span class="o">.</span><span class="n">halo_sub_prop</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">],</span>
                                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">],</span>
                                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">],</span>
                                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">],</span>
                                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_index&#39;</span><span class="p">],</span>
                                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">],</span>
                                 <span class="n">_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                <span class="n">r200c</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_nsubs&#39;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_firstsub&#39;</span><span class="p">],</span>
                                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span>
                                <span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">_pos</span>
            <span class="c1">#j = 0</span>
            <span class="c1">#for i1, nsub, m200, r200, mfof in zip(self.fof[&#39;halo_firstsub&#39;], self.fof[&#39;halo_nsubs&#39;], self.fof[&#39;halo_m200c&#39;], self.fof[&#39;halo_r200c&#39;], self.fof[&#39;halo_mfof&#39;]):</span>
                <span class="c1">#subcat[&#39;halo_mfof&#39;][i1:i1+nsub] = mfof</span>
                <span class="c1">#subcat[&#39;halo_m200c&#39;][i1:i1+nsub] = m200</span>
                <span class="c1">#subcat[&#39;halo_r200c&#39;][i1:i1+nsub] = r200</span>
                <span class="c1">#subcat[&#39;halo_index&#39;][i1:i1+nsub] = j</span>
                <span class="c1">#if nsub &gt; 0:</span>
                    <span class="c1">#subcat[&#39;central&#39;][i1] = True</span>
                    <span class="c1">#subcat[&#39;central_dist&#39;][i1:i1+nsub] = np.sum(self._wrap(subcat[&#39;pos&#39;][i1:i1+nsub] - subcat[&#39;pos&#39;][i1])**2, axis=1)</span>
                    <span class="c1">#j +=1</span>
                <span class="c1">#subcat[&#39;nsubs&#39;] = np.sum(nsubs_in_file)</span>
                <span class="c1">#subcat[&#39;central_dist&#39;] = np.sqrt(subcat[&#39;central_dist&#39;])</span>

            <span class="c1">#Let&#39;s deal with orphans</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span><span class="p">:</span>
                <span class="n">mask_orp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">find_BinA</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;subnr&#39;</span><span class="p">],</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;subnr&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">])</span>
                <span class="c1">#index = [ np.where((subcat[&#39;subnr&#39;] == subcat[&#39;subnr&#39;][i]) &amp; (subcat[&#39;len&#39;] != 1))[0][0] for i in mask_orp]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;central_dist&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="c1">#subcat[&#39;len&#39;][index] * self.header[&#39;ParticleMass&#39;]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_index&#39;</span><span class="p">][</span><span class="n">mask_orp</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_index&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>


        <span class="k">return</span> <span class="n">cat</span><span class="p">,</span> <span class="n">nsubs_in_file</span>

    <span class="k">def</span> <span class="nf">_load_neutrinos_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">h5py</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="s1">&#39;.0.hdf5&#39;</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;.0.hdf5&#39;</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Neither snap not groups found&#39;</span><span class="p">)</span>

        <span class="n">LastNeutrinoPowerTime</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;NeutrinoPower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LastNeutrinoPowerTime&#39;</span><span class="p">]</span>
        <span class="n">LastNeutrinoPowerKbin</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;NeutrinoPower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LastNeutrinoPowerKbin&#39;</span><span class="p">]</span>
        <span class="n">LastNeutrinoPower</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;NeutrinoPower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LastNeutrinoPower&#39;</span><span class="p">]</span>
        <span class="c1"># LastNeutrinoPower = f[&#39;NeutrinoPower&#39;].attrs[&#39;LastNeutrinoPower&#39;] * 4.0 * np.pi**2</span>
        <span class="n">LastNeutrinoPower</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;NeutrinoPower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LastNeutrinoPower&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">LastNeutrinoPowerKbin</span>
        <span class="c1"># LastNeutrinoPowerKbin /= self.Cosmology.pars[&#39;hubble&#39;]</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">D_of_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">LastNeutrinoPowerKbin</span><span class="p">)</span>
        <span class="n">D_of_neut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">LastNeutrinoPowerTime</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">LastNeutrinoPowerKbin</span><span class="p">)</span>

        <span class="n">LastNeutrinoPower</span> <span class="o">*=</span> <span class="p">(</span><span class="n">D_of_snap</span> <span class="o">/</span> <span class="n">D_of_neut</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span> <span class="p">:</span> <span class="n">LastNeutrinoPowerKbin</span><span class="p">,</span>  <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">LastNeutrinoPower</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">subhalo_Correl_tmp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1">#WARNING The compute_noOrphans will compute the galaxies that are not orphans from the number density selected.</span>
        <span class="c1">#eg. they will have a number density equal or bellow the one given. Only usefull for comparing the effects of Orphans</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_twopointcorr</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In subhalo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;In subhalo_Correl(). n = </span><span class="si">%f</span><span class="s1"> -&gt; </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">prop</span><span class="p">,</span><span class="n">cut</span><span class="p">))</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_twopointcorr</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Mhalo_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask2</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Mhalo_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Mhalo_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_twopointcorr</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span><span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.20</span><span class="p">,</span> <span class="mi">150</span><span class="p">)),</span><span class="mi">35</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_load_fof_gadget_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.0.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dictionary</span> <span class="ow">in</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()}]:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;MassTable&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TNG&#39;</span><span class="p">]:</span>
                <span class="n">particle_mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">100</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NewtonsConstant&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpart</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">particle_mass</span> <span class="o">=</span> <span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">100</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NewtonsConstant&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpart</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">particle_mass</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;MassTable&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">nfiles</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nfiles</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">{0}</span><span class="s1">.hdf5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)]</span>

        <span class="c1">#_check_files_exist()</span>

        <span class="n">fdtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="n">idtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span><span class="o">==</span><span class="s2">&quot;gadget_hdf5&quot;</span><span class="p">:</span>
            <span class="n">nsdm_not_inhalos</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubsample_Total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_Total&#39;</span><span class="p">]</span>
            <span class="n">nsdm_in_halos</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_Total&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_count</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">file_count</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_count_tot</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">file_count</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_property</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">global_count</span><span class="p">,</span> <span class="n">file_count</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">ndim</span><span class="p">)</span> <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">{0}</span><span class="s2"> items for </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">field</span><span class="p">))</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">npts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>

                    <span class="c1">#cat[&#39;halo_firstsub&#39;][istart:istart + npts] = np.cumsum(f[u&#39;Group&#39;][u&#39;GroupNsubs&#39;].value) + cum_nsubs - f[u&#39;Group&#39;][u&#39;GroupNsubs&#39;].value</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">*</span><span class="n">norm</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_firstsub</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">global_count</span><span class="p">,</span> <span class="n">file_count</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">ndim</span><span class="p">)</span> <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">{0}</span><span class="s2"> items for </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="s1">&#39;halo_firstsub&#39;</span><span class="p">))</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cum_nsubs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">cum_nsubs</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">])[</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>
                    <span class="n">cum_nsubs</span>  <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">_read_halo_offset</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;If you want halo_offsets, you need dm ptcles&#39;</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">],</span> <span class="n">ndim</span><span class="p">)</span> <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">{0}</span><span class="s2"> items for </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">],</span> <span class="s1">&#39;halo_firstsub&#39;</span><span class="p">))</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cum_nsubs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cum_dmnpts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ifile</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">]</span>
                    <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdm</span><span class="p">:</span>
                       <span class="n">dmnpts</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumPart_ThisFile&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">npts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">value</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span> <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">cum_dmnpts</span>
                    <span class="n">cum_dmnpts</span> <span class="o">+=</span> <span class="n">dmnpts</span>

                    <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_derived_property</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">global_count</span><span class="p">,</span> <span class="n">file_count</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">ndim</span><span class="p">)</span> <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">{0}</span><span class="s2"> items for </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">global_count</span><span class="p">],</span> <span class="n">field</span><span class="p">))</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">file_count</span><span class="p">]</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>

                    <span class="c1">#cat[&#39;halo_firstsub&#39;][istart:istart + npts] = np.cumsum(f[u&#39;Group&#39;][u&#39;GroupNsubs&#39;].value) + cum_nsubs - f[u&#39;Group&#39;][u&#39;GroupNsubs&#39;].value</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="o">*</span><span class="n">norm</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_read_hdf5_sdm</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">args</span>

            <span class="n">nsdm_not_in_halos</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubsample_Total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_Total&#39;</span><span class="p">]</span>
            <span class="n">nsdm_in_halos</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_Total&#39;</span><span class="p">]</span>
            <span class="n">ngroups</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">]</span>
            <span class="n">atime</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_not_in_halos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                     <span class="s1">&#39;vel&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_not_in_halos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                     <span class="s1">&#39;ids&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_not_in_halos</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                     <span class="s1">&#39;ih_pos&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_in_halos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                     <span class="s1">&#39;ih_vel&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_in_halos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                     <span class="s1">&#39;ih_ids&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_in_halos</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                     <span class="s1">&#39;offset&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngroups</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                     <span class="s1">&#39;len&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngroups</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                     <span class="p">}</span>
            <span class="n">_halo_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngroups</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">{0}</span><span class="s2"> items for </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsdm_not_in_halos</span><span class="p">,</span> <span class="s2">&quot;sDM&quot;</span><span class="p">))</span>
            <span class="n">cum_slen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cum_sdm_npts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">npts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">]</span>

                    <span class="n">sdm_vel_present</span> <span class="o">=</span> <span class="s1">&#39;Vel&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                    <span class="n">sDM_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">sDM_vel</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;Vel&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">sDM_ids</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;IDs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="s1">&#39;IDs&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">])</span>

                    <span class="c1">#Let&#39;s fill the particles not in halos</span>
                    <span class="n">num_not_in_halos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_ThisFile&#39;</span><span class="p">]</span>
                    <span class="n">num_in_halos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_ThisFile&#39;</span><span class="p">]</span>

                    <span class="n">value</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">cum_sdm_npts</span><span class="p">:</span><span class="n">cum_sdm_npts</span><span class="o">+</span><span class="n">num_not_in_halos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sDM_pos</span><span class="p">[</span><span class="n">num_in_halos</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">],:]</span>
                    <span class="n">value</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">cum_sdm_npts</span><span class="p">:</span><span class="n">cum_sdm_npts</span><span class="o">+</span><span class="n">num_not_in_halos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sDM_vel</span><span class="p">[</span><span class="n">num_in_halos</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">],:]</span>
                    <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="n">cum_sdm_npts</span><span class="p">:</span><span class="n">cum_sdm_npts</span><span class="o">+</span><span class="n">num_not_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_ids</span><span class="p">[</span><span class="n">num_in_halos</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">]]</span>
                    <span class="n">cum_sdm_npts</span> <span class="o">+=</span> <span class="n">num_not_in_halos</span>

                    <span class="k">if</span> <span class="n">npts</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubsampledLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65530</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough precision for holding SubsampledLen&quot;</span><span class="p">)</span>

                        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubsampledLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubsampledOffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">cum_slen</span>
                        <span class="n">_halo_vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">atime</span>

                        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ih_pos&#39;</span><span class="p">][</span><span class="n">cum_slen</span><span class="p">:</span><span class="n">cum_slen</span><span class="o">+</span><span class="n">num_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_pos</span><span class="p">[:</span><span class="n">num_in_halos</span><span class="p">,:]</span>
                        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ih_vel&#39;</span><span class="p">][</span><span class="n">cum_slen</span><span class="p">:</span><span class="n">cum_slen</span><span class="o">+</span><span class="n">num_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_vel</span><span class="p">[:</span><span class="n">num_in_halos</span><span class="p">,:]</span>
                        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ih_ids&#39;</span><span class="p">][</span><span class="n">cum_slen</span><span class="p">:</span><span class="n">cum_slen</span><span class="o">+</span><span class="n">num_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_ids</span><span class="p">[:</span><span class="n">num_in_halos</span><span class="p">]</span>

                        <span class="n">cum_slen</span> <span class="o">+=</span> <span class="n">num_in_halos</span>
                <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>

            <span class="n">value</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># raise RuntimeError(&quot;Code below not yet updated&quot;)</span>
            <span class="k">if</span> <span class="n">sdm_vel_present</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">.cyengine</span> <span class="k">import</span> <span class="n">cymock</span>
                <span class="n">_vel_halo</span> <span class="o">=</span> <span class="n">_halo_vel</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">_halo_vel</span><span class="p">))</span>
                <span class="n">_vel_sdm</span>  <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ih_vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;ih_vel&#39;</span><span class="p">]))</span>
                <span class="n">cymock</span><span class="o">.</span><span class="n">correct_sdm_vel</span><span class="p">(</span><span class="n">_vel_sdm</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">],</span> <span class="n">_vel_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
                <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ih_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_vel_sdm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;ih_vel&#39;</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">_vel_sdm</span><span class="p">,</span> <span class="n">_vel_halo</span>
            <span class="k">del</span> <span class="n">_halo_vel</span>

            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">_fill_with_value</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">nval</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nval</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_copy_array</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">return</span> <span class="n">val</span>

        <span class="n">use_radial</span> <span class="o">=</span> <span class="s2">&quot;radial_bins&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_radial</span><span class="p">:</span>
            <span class="n">_nrbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;radial_bins&quot;</span><span class="p">])</span>
            <span class="n">_R0</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="n">_R1</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="n">_binfac</span> <span class="o">=</span> <span class="n">_nrbins</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R0</span><span class="p">))</span>
            <span class="n">_kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">_nrbins</span><span class="p">)</span>
            <span class="n">_r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">_kk</span><span class="p">)</span> <span class="o">/</span> <span class="n">_binfac</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R0</span><span class="p">));</span>
            <span class="n">_r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">_kk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">_binfac</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R0</span><span class="p">));</span>
            <span class="n">_radial_shells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">_nrbins</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">_binfac</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_R0</span><span class="p">))</span>
            <span class="n">_radial_bins_end</span> <span class="o">=</span> <span class="n">_r1</span>
            <span class="n">_volume_bins</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">_r1</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">_r0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">LazyDict</span><span class="p">({</span>
            <span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_count</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;nhalos&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="n">_read_hdf5_count_tot</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;halo_offsets&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_halo_offset</span><span class="p">,</span> <span class="p">(</span><span class="n">idtype</span><span class="p">)),</span>
            <span class="s1">&#39;halo_pos&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;GroupPos&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TNG&quot;</span><span class="p">,</span><span class="s2">&quot;TNG_onlyDM&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;halo_vel&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;GroupVel&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])),</span>
            <span class="s1">&#39;halo_mfof&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="n">particle_mass</span><span class="p">)),</span>
            <span class="s1">&#39;halo_len&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;halo_nsubs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;halo_mvir&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;Group_M_TopHat200&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;halo_m200c&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;Group_M_Crit200&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;halo_m200b&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;Group_M_Mean200&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="c1">#&#39;halo_rvir&#39;:  (_read_hdf5_property, (&#39;Group&#39;,&#39;Group_M_Crit200&#39;,&#39;Ngroups_Total&#39;,&#39;Ngroups_ThisFile&#39;, 1, fdtype, self.Cosmology.mass_to_radius)),</span>
            <span class="s1">&#39;halo_r200c&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_derived_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;Group_M_Crit200&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_eulerian_radius</span><span class="p">)),</span>
            <span class="c1">#&#39;halo_r200b&#39;:  (_read_hdf5_property, (&#39;Group&#39;,&#39;Group_M_Crit200&#39;,&#39;Ngroups_Total&#39;,&#39;Ngroups_ThisFile&#39;, 1, fdtype, self.Cosmology.mass_to_radius)),</span>
            <span class="s1">&#39;halo_vdisp_vir&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;VelDisp_TopHat&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;halo_vdisp_200c&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;VelDisp_Crit200&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;halo_vdisp_200b&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;VelDisp_Mean200&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
            <span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">:</span>      <span class="p">(</span><span class="n">_copy_array</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;radial_bins&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">use_radial</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;halo_radial_shells&#39;</span> <span class="p">:</span>   <span class="p">(</span><span class="n">_copy_array</span><span class="p">,</span> <span class="p">(</span><span class="n">_radial_shells</span><span class="p">))</span> <span class="k">if</span> <span class="n">use_radial</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;halo_radial_bins_end&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">_copy_array</span><span class="p">,</span> <span class="p">(</span><span class="n">_radial_bins_end</span><span class="p">))</span> <span class="k">if</span> <span class="n">use_radial</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;halo_volume_bins&#39;</span> <span class="p">:</span>     <span class="p">(</span><span class="n">_copy_array</span><span class="p">,</span> <span class="p">(</span><span class="n">_volume_bins</span><span class="p">))</span> <span class="k">if</span> <span class="n">use_radial</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;halo_density_profile&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">_read_hdf5_property</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;DensityProfile&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;radial_bins&#39;</span><span class="p">]),</span> <span class="n">fdtype</span><span class="p">,</span><span class="n">particle_mass</span><span class="p">))</span> <span class="k">if</span> <span class="n">use_radial</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;halo_mbid&#39;</span> <span class="p">:</span>            <span class="p">(</span><span class="n">_fill_with_value</span><span class="p">,</span> <span class="p">(</span><span class="n">_read_hdf5_count_tot</span><span class="p">(</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;halo_dilution_factor&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">_copy_array</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Dilution_factor_per_dim&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span><span class="o">==</span><span class="s2">&quot;gadget_hdf5&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;halo_firstsub&#39;</span>        <span class="p">:</span> <span class="p">(</span><span class="n">_read_hdf5_firstsub</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">,</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">,</span><span class="n">idtype</span><span class="p">)),</span>
            <span class="s1">&#39;halo_sdm&#39;</span> <span class="p">:</span>             <span class="p">(</span><span class="n">_read_hdf5_sdm</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span><span class="o">==</span><span class="s2">&quot;gadget_hdf5&quot;</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">})</span>

    <span class="c1">#@do_profile()</span>
<span class="c1">#    @profile</span>
    <span class="k">def</span> <span class="nf">_load_fof_gadget_hdf5_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cum_dmnpts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cum_slen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cum_sdm_npts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cum_nsubs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cum_nhalos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;.0.hdf5&#39;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">nfiles</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span>
        <span class="n">atime</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">nhalos_in_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nfiles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">fdtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="n">idtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>

        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nfiles</span><span class="p">):</span>

            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="k">if</span> <span class="n">nfiles</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="n">nhalos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Ngroups_Total&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ifile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">),</span>
                           <span class="s1">&#39;halo_vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">),</span>
                           <span class="s1">&#39;halo_mbid&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                           <span class="s1">&#39;halo_len&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                           <span class="s1">&#39;halo_mfof&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                         <span class="p">}</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]:</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_firstsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_nsubs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">idtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_relaxed&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_rvir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vdisp_200c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vdisp_200m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vdisp_tophat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>

                        <span class="k">if</span> <span class="s2">&quot;radial_bins&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;has radial bins&quot;</span><span class="p">)</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;radial_bins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;radial_bins&#39;</span><span class="p">]</span>
                            <span class="n">nrbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;radial_bins&quot;</span><span class="p">])</span>

                            <span class="n">R0</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="n">R1</span> <span class="o">=</span> <span class="mf">2.0</span>
                            <span class="n">binfac</span> <span class="o">=</span> <span class="n">nrbins</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R0</span><span class="p">));</span>
                            <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrbins</span><span class="p">)</span>
                            <span class="n">r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">kk</span><span class="p">)</span> <span class="o">/</span> <span class="n">binfac</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R0</span><span class="p">));</span>
                            <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">binfac</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R0</span><span class="p">));</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;radial_shells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrbins</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">binfac</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R0</span><span class="p">))</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;radial_bins_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;volume_bins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">r1</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">r0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">nrbins</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_sDM&#39;</span><span class="p">]:</span>
                        <span class="n">nsdm_not_inhalos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_Total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_Total&#39;</span><span class="p">]</span>
                        <span class="n">nsdm_in_halos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_Total&#39;</span><span class="p">]</span>

                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sdm_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_not_inhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sdm_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_not_inhalos</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sdm_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_not_inhalos</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dilution_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Dilution_factor_per_dim&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>

                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_sdm_len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">idtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_in_halos</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsdm_in_halos</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsdm_in_halos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_sdm_off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_sdm_off&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

                <span class="n">npts</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">])</span>
                <span class="n">nhalos_in_file</span><span class="p">[</span><span class="n">ifile</span><span class="p">]</span> <span class="o">=</span> <span class="n">npts</span>

                <span class="k">if</span> <span class="n">npts</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">atime</span>

                    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_sDM&#39;</span><span class="p">]:</span>
                        <span class="n">sDM_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">sDM_vel</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">sDM_ids</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;IDs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="s1">&#39;IDs&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;sDM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">])</span>

                        <span class="c1">#Let&#39;s fill the particles not in halos</span>
                        <span class="n">num_not_in_halos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_ThisFile&#39;</span><span class="p">]</span>
                        <span class="n">num_in_halos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_in_groups_ThisFile&#39;</span><span class="p">]</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sdm_pos&#39;</span><span class="p">][</span><span class="n">cum_sdm_npts</span><span class="p">:</span><span class="n">cum_sdm_npts</span><span class="o">+</span><span class="n">num_not_in_halos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sDM_pos</span><span class="p">[</span><span class="n">num_in_halos</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">],:]</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sdm_vel&#39;</span><span class="p">][</span><span class="n">cum_sdm_npts</span><span class="p">:</span><span class="n">cum_sdm_npts</span><span class="o">+</span><span class="n">num_not_in_halos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sDM_vel</span><span class="p">[</span><span class="n">num_in_halos</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">],:]</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sdm_ids&#39;</span><span class="p">][</span><span class="n">cum_sdm_npts</span><span class="p">:</span><span class="n">cum_sdm_npts</span><span class="o">+</span><span class="n">num_not_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_ids</span><span class="p">[</span><span class="n">num_in_halos</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubsample_ThisFile&#39;</span><span class="p">]]</span>
                        <span class="n">cum_sdm_npts</span> <span class="o">+=</span> <span class="n">num_not_in_halos</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubsampledLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65530</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lean&quot;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough precision for holding SubsampledLen&quot;</span><span class="p">)</span>

                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_sdm_len&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubsampledLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_sdm_off&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SubsampledOffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">cum_slen</span>

                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_pos&#39;</span><span class="p">][</span><span class="n">cum_slen</span><span class="p">:</span><span class="n">cum_slen</span><span class="o">+</span><span class="n">num_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_pos</span><span class="p">[:</span><span class="n">num_in_halos</span><span class="p">,:]</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_vel&#39;</span><span class="p">][</span><span class="n">cum_slen</span><span class="p">:</span><span class="n">cum_slen</span><span class="o">+</span><span class="n">num_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_vel</span><span class="p">[:</span><span class="n">num_in_halos</span><span class="p">,:]</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_ids&#39;</span><span class="p">][</span><span class="n">cum_slen</span><span class="p">:</span><span class="n">cum_slen</span><span class="o">+</span><span class="n">num_in_halos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sDM_ids</span><span class="p">[:</span><span class="n">num_in_halos</span><span class="p">]</span>
                        <span class="n">cum_slen</span> <span class="o">+=</span> <span class="n">num_in_halos</span>

                        <span class="c1">#ids = np.arange(npts)</span>
                        <span class="c1">#sdm_len = f[u&#39;Group&#39;][u&#39;SubsampledLen&#39;].value</span>
                        <span class="c1">#cat[&#39;halo_dm_pos&#39;][istart:istart+npts] = [sDM_pos[sdm_offset[ih]:sdm_offset[ih]+sdm_len[ih]] for ih in ids]</span>
                    <span class="c1">#    cat[&#39;halo_dm_vel&#39;][istart:istart+npts] = [sDM_vel[sdm_offset[ih]:sdm_offset[ih]+sdm_len[ih]] + (atime - 1) * cat[&#39;halo_vel&#39;][istart+ih,:] for ih in np.arange(npts)]</span>
                    <span class="c1">#    cat[&#39;halo_dm_ids&#39;][istart:istart+npts] = [sDM_ids[sdm_offset[ih]:sdm_offset[ih]+sdm_len[ih]] for ih in np.arange(npts)]</span>
                    <span class="c1">#    cat[&#39;halo_mbid&#39;][istart:istart+npts] = sDM_ids[sdm_offset]</span>
                    <span class="c1">#    del sDM_pos, sDM_vel, sDM_ids</span>

                    <span class="n">gkeys</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lean&#39;</span><span class="p">]:</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_id&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span>  <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="s1">&#39;GroupNr&#39;</span> <span class="ow">in</span> <span class="n">gkeys</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span> <span class="o">+</span> <span class="n">cum_nhalos</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_nsubs&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Group_M_Crit200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_m200b&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Group_M_Mean200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Group_M_TopHat200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

                        <span class="n">halo_r200c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_eulerian_radius</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Group_M_Crit200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span><span class="n">overdensity</span><span class="o">=</span><span class="mf">200.</span><span class="p">)</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">halo_r200c</span>

                        <span class="k">if</span> <span class="s1">&#39;VelDisp_Crit200&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vdisp_200c&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;VelDisp_Crit200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="s1">&#39;VelDisp_Mean200&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vdisp_200m&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;VelDisp_Mean200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="s1">&#39;VelDisp_TopHat&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vdisp_tophat&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;VelDisp_TopHat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_firstsub&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span> <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">cum_nsubs</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_firstsub&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">])[</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>


                        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;radial_bins&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;DensityProfile&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span>
                                                        <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;DensityProfile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span>


                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdm</span><span class="p">:</span>
                       <span class="n">dmnpts</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumPart_ThisFile&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">npts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span> <span class="o">+</span>
                                           <span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">cum_dmnpts</span>
                    <span class="n">cum_dmnpts</span> <span class="o">+=</span> <span class="n">dmnpts</span>

                <span class="k">if</span> <span class="s1">&#39;Norphans_ThisFile&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">norphans</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Norphans_ThisFile&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">norphans</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">cum_nsubs</span>  <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">]</span>
                <span class="n">cum_nhalos</span> <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Ngroups_ThisFile&#39;</span><span class="p">]</span>
                <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Read data for </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> halos...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">nhalos</span><span class="p">))</span>

        <span class="c1">#We set the halo most bound particle to -1 so we can identify those halos without any associated sDM particle</span>
        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_mbid&#39;</span><span class="p">][</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_sdm_len&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="kn">from</span> <span class="nn">.cyengine</span> <span class="k">import</span> <span class="n">cymock</span>
        <span class="n">_vel_halo</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">]))</span>
        <span class="n">_vel_sdm</span>  <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_vel&#39;</span><span class="p">]))</span>
        <span class="n">cymock</span><span class="o">.</span><span class="n">correct_sdm_vel</span><span class="p">(</span><span class="n">_vel_sdm</span><span class="p">,</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_sdm_off&#39;</span><span class="p">],</span> <span class="n">_vel_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_vel_sdm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;halo_dm_vel&#39;</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">_vel_sdm</span><span class="p">,</span> <span class="n">_vel_halo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; FoF loading done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>

            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nhalos_in_file</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nhalos_in_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cat</span>

    <span class="k">def</span> <span class="nf">_load_dark_matter_gadget2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">array</span>
        <span class="kn">import</span> <span class="nn">struct</span>
        <span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Allocating memory for </span><span class="si">{0}</span><span class="s2"> particles </span><span class="si">{1}</span><span class="s2">Mb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="mf">1024.</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_vel&#39;</span><span class="p">]:</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_ids&#39;</span><span class="p">]:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>

                <span class="c1"># header</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">:</span>
                    <span class="n">ilen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">blockname</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;4s&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">ilen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blockname</span><span class="p">,</span> <span class="n">blen</span><span class="p">))</span>

                <span class="n">hsize1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">nptsall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">):</span>
                    <span class="n">nptsall</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">npts</span> <span class="o">=</span> <span class="n">nptsall</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">):</span>
                    <span class="n">mass</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">redshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">flag_sfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">flag_feedback</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">nptot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">):</span>
                    <span class="n">nptot</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">256</span><span class="o">-</span><span class="mi">120</span><span class="p">)</span>  <span class="c1"># 6*4)</span>
                <span class="n">hsize2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">hsize1</span> <span class="o">==</span> <span class="n">hsize2</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">:</span>
                    <span class="n">ilen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">blockname</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;4s&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">ilen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blockname</span><span class="p">,</span> <span class="n">blen</span><span class="p">))</span>
                    <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">blen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># discard ids for pinocchio</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">:</span>
                    <span class="n">ilen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">blockname</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;4s&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">ilen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blockname</span><span class="p">,</span> <span class="n">blen</span><span class="p">))</span>

                <span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">getPosVel</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_vel&#39;</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">:</span>
                        <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                        <span class="n">blockname</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;4s&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                        <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                        <span class="n">blen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blockname</span><span class="p">,</span> <span class="n">blen</span><span class="p">))</span>

                    <span class="n">vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">getPosVel</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_ids&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span><span class="o">!=</span><span class="s1">&#39;gadget2blocks&#39;</span><span class="p">):</span>

                    <span class="n">ids</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">getID</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>

                <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Read data for </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> particles...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nptot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])))</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]),</span> <span class="n">ids</span>

    <span class="k">def</span> <span class="nf">_load_dark_matter_gadget2_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">struct</span>
        <span class="kn">import</span> <span class="nn">array</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ffname</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>

                <span class="c1"># header</span>
                <span class="n">hsize1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">npts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">):</span>
                    <span class="n">npts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">):</span>
                    <span class="n">mass</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">redshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">flag_sfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">flag_feedback</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">nptot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_TYPE</span><span class="p">):</span>
                    <span class="n">nptot</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># if self.verbose is True:</span>
                <span class="c1">#    for j in range(N_TYPE):</span>
                <span class="c1">#        logger.info(&#39;type {0}: {1}/{2} &#39;.format(j,int(npts[j,0]),int(nptot[j,0])))</span>

                <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">256</span><span class="o">-</span><span class="mi">120</span><span class="p">)</span>  <span class="c1"># 6*4)</span>
                <span class="n">hsize2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">hsize1</span> <span class="o">==</span> <span class="n">hsize2</span>

                <span class="c1"># particle positions</span>
                <span class="n">hsize1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hsize1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

                <span class="n">tpos</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                <span class="n">tpos</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">npts</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">tpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tpos</span><span class="p">,</span> <span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">hsize2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">hsize1</span> <span class="o">==</span> <span class="n">hsize2</span>

                <span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpos</span>

                <span class="c1"># particles velocity</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_vel&#39;</span><span class="p">]:</span>
                    <span class="n">hsize1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hsize1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

                    <span class="n">tvel</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                    <span class="n">tvel</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">npts</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">hsize2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">hsize1</span> <span class="o">==</span> <span class="n">hsize2</span>

                    <span class="n">vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tvel</span><span class="p">,</span> <span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

                <span class="c1"># particles ids</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_ids&#39;</span><span class="p">]:</span>
                    <span class="n">hsize1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hsize1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>

                    <span class="n">tids</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
                    <span class="n">tids</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>
                    <span class="n">hsize2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">hsize1</span> <span class="o">==</span> <span class="n">hsize2</span>

                    <span class="n">ids</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">npts</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tids</span><span class="p">,</span> <span class="p">(</span><span class="n">npts</span><span class="p">))</span>

                <span class="n">istart</span> <span class="o">+=</span> <span class="n">npts</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Read data for </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> particles...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nptot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])))</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]),</span> <span class="n">ids</span>


<span class="c1">#--------------------------------------------------------------------</span>
<span class="c1"># Define lazy attributes</span>
<span class="c1">#--------------------------------------------------------------------</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm_file&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DM Simulation file was not defined, but it&#39;s required for loading the header&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget_hdf5&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;TNG&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;TNG_onlyDM&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_header_hdf5</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_header_gadget2</span><span class="p">()</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;header format not supported&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">dm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;dm_file&#39; file was not defined, but it&#39;s required for loading the simulation particles&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;dm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget_hdf5&#39;</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_dark_matter_gadget_hdf5</span><span class="p">(</span>
                <span class="n">do_compression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_compression</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dask</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">):</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_dark_matter_gadget2</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; DM loading done in </span><span class="si">{0:.3}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">fof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;halo_file&#39; file was not defined, but it&#39;s required for loading the groups particles&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;fof&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gadget_hdf5&#39;</span><span class="p">,</span><span class="s1">&#39;TNG&#39;</span><span class="p">,</span><span class="s1">&#39;TNG_onlyDM&#39;</span><span class="p">]:</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_fof_gadget_hdf5</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">):</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_fof_gadget2</span><span class="p">()</span>

        <span class="n">cat</span><span class="o">.</span><span class="n">_new_lazy_key</span><span class="p">(</span><span class="s1">&#39;halo_logrho0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_halo_nfw_par</span><span class="p">,</span> <span class="s1">&#39;log_rho_0&#39;</span><span class="p">))</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">_new_lazy_key</span><span class="p">(</span><span class="s1">&#39;halo_rs&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_halo_nfw_par</span><span class="p">,</span> <span class="s1">&#39;r_s&#39;</span><span class="p">))</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">_new_lazy_key</span><span class="p">(</span><span class="s1">&#39;halo_conc&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_halo_nfw_par</span><span class="p">,</span> <span class="s1">&#39;concentration&#39;</span><span class="p">))</span>
        <span class="c1">#fofcat = {key:cat[key] for key in cat.keys()}</span>
        <span class="c1">#if (cat[&#39;nhalos&#39;] &gt; 0) and (config[&#39;io&#39;][&#39;load_sDM&#39;]):</span>
            <span class="c1">#for ihalo in range(cat[&#39;nhalos&#39;]):</span>
                <span class="c1">#cat[&#39;halo_dm_vel&#39;][cat[&#39;halo_sdm_off&#39;][ihalo]:cat[&#39;halo_sdm_off&#39;][ihalo+1]] = \</span>
                <span class="c1">#(self.Cosmology.expfactor -1) * cat[&#39;halo_vel&#39;][ihalo] +  \</span>
                <span class="c1">#cat[&#39;halo_dm_vel&#39;][cat[&#39;halo_sdm_off&#39;][ihalo]:cat[&#39;halo_sdm_off&#39;][ihalo+1]]</span>
        <span class="k">return</span> <span class="n">cat</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gadget_hdf5&#39;</span><span class="p">,</span><span class="s1">&#39;TNG&#39;</span><span class="p">,</span><span class="s1">&#39;TNG_onlyDM&#39;</span><span class="p">]:</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_sub_gadget_hdf5</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_format</span> <span class="o">==</span> <span class="s1">&#39;gadget2blocks&#39;</span><span class="p">):</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_sub_gadget2</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;wrong_sublean&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;be aware sub velocities are being modified - only for wrong sublean files&#39;</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">cat</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">lgals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;lgals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_lgalaxies</span><span class="p">()</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;treecat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">treecat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_tree_gadget2</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">treecat</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">orphancat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;orphancat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_subhalo</span><span class="p">(</span><span class="s2">&quot;orphancat&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">fofcat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;fofcat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_subhalo</span><span class="p">(</span><span class="s2">&quot;fofcat&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reconstructing sDM&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm_in_haloes</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]))</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm_in_haloes</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ih_ids&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ids&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ids&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdm_in_haloes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdm_in_haloes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.cyengine</span> <span class="k">import</span> <span class="n">cymock</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ih_pos&#39;</span><span class="p">])</span>
            <span class="n">N2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">])</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ih_pos&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ih_vel&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
            <span class="n">_halo_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">N2</span><span class="p">)</span>
            <span class="n">_halo_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">N2</span><span class="p">)</span>
            <span class="n">cymock</span><span class="o">.</span><span class="n">sdm_in_haloes</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">],</span><span class="n">_halo_pos</span><span class="p">,</span><span class="n">_halo_vel</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">_halo_pos</span><span class="p">,</span> <span class="n">_halo_vel</span>

            <span class="c1"># pos = deepcopy(self.fof[&#39;halo_dm_pos&#39;])</span>
            <span class="c1"># vel = deepcopy(self.fof[&#39;halo_dm_vel&#39;])</span>
            <span class="c1"># for ihalo in range(self.fof[&#39;nhalos&#39;]):</span>
            <span class="c1">#     pos[self.fof[&#39;halo_sdm_off&#39;][ihalo]:self.fof[&#39;halo_sdm_off&#39;][ihalo+1]] += self.fof[&#39;halo_pos&#39;][ihalo]</span>
            <span class="c1">#     vel[self.fof[&#39;halo_sdm_off&#39;][ihalo]:self.fof[&#39;halo_sdm_off&#39;][ihalo+1]] += self.fof[&#39;halo_vel&#39;][ihalo]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">invert</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">vel</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span><span class="p">,</span> <span class="n">compute_mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing sdm-P(k)&quot;</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.085678e+24</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span> <span class="n">unit_in_Mpc</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmzPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmzPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span><span class="p">,</span> <span class="n">compute_mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing sdm- rsd P(k)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing  P(k)&quot;</span><span class="p">)</span>

        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.085678e+24</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_compression</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decompress</span><span class="p">(),</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span> <span class="n">unit_in_Mpc</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_haloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing halo P(k)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All haloes to the CF... carefull with the low mass haloes bellow the resolution limit!</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">])),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In fhaloPower(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing halo P(k) with </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%.02f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">cut</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_twopointcorr</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span> <span class="c1">#Removing the status of &#39;lazy array&#39; to add options to cut in halo mass/ n density</span>
    <span class="k">def</span> <span class="nf">haloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;haloPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing halo P(k)&quot;</span><span class="p">)</span>
<span class="c1">#        logger.info(&quot;{0} {1}&quot;.format(1e-5*self.header[&#39;BoxSize&#39;]**3, self.header[&#39;BoxSize&#39;]))</span>
        <span class="c1"># return self.compute_haloPower(n=2e-5, zspace=False)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_haloPower</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#        return self.compute_haloPower(prop=None, zspace=False)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">haloPower_100particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;haloPower_100particles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing halo P(k) with minimum 100 particles&quot;</span><span class="p">)</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_haloPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zhaloPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zhaloPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute redshift-space halo P(k)&quot;</span><span class="p">)</span>
        <span class="c1"># return self.compute_haloPower(prop = None, zspace = True)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_haloPower</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zhaloPower_100particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zhaloPower_100particles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing halo P(k) with minimum 100 particles&quot;</span><span class="p">)</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_haloPower</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">compute_subPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;mpeak&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">Mask_Type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alive_allsats</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1">#possible prop: vpeak, vmax, mpeak</span>
        <span class="c1"># Aditional testing mask:</span>
        <span class="c1"># Mask_Type = 0 (only centrals) 1 (Central+Satellites) 2 (Centrals+Satellites+Orphans)</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing subhalo P(k)&quot;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">random</span>
        <span class="c1">#nn = len(self.sub[prop])</span>
        <span class="c1">#sub = dict(random.sample(self.sub.items(), nn*self.Cosmology.growthrate(1)**(-0.2)))</span>
        <span class="c1">#sub = self.sub</span>
        <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
            <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">(</span><span class="n">mergertime_factor</span> <span class="o">=</span> <span class="n">mergertime_factor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Mask_Type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">masktype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">Mask_Type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">masktype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">Mask_Type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">masktype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">masktype</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask_alive</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All haloes to the CF... carefull with the low mass haloes bellow the resolution limit!</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In compute_subPower(). &quot;n&quot; &gt; Nsub/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">_mask</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing subhalo P(k) with </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%.02f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span><span class="n">cut</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_mask</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_twopointcorr</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing subhalo P(k)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subPower</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zsubPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zsubPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute redshift-space subhalo P(k)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_subPower</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">nuPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;nuPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute neutrino P(k)&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nupk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_neutrinos_hdf5</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">nupk</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to load neutrino power spectrum&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">nupk</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">totPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;totPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute cdm + baryons + neutrino P(k)&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">log_int_ext</span>

        <span class="n">pk</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdmPower</span><span class="p">)</span>

        <span class="n">nupk</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuPower</span><span class="p">)</span>
        <span class="n">interp_nu_pk</span> <span class="o">=</span> <span class="n">log_int_ext</span><span class="p">(</span><span class="n">nupk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">nupk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span>
        <span class="n">fnu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">omega_neutrino_z</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">pk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fnu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
                   <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">fnu</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fnu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">interp_nu_pk</span><span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>
                   <span class="o">+</span> <span class="n">fnu</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">interp_nu_pk</span><span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>
        <span class="n">pk</span><span class="p">[</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">cold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pk</span><span class="p">[</span><span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_nlpowerspec_z</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">cold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pk</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">BiasMass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;BiasMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing bias-Mass relation&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span><span class="p">,</span> <span class="n">compute_crossspectrum</span>

        <span class="n">mink</span> <span class="o">=</span> <span class="mf">0.06</span> <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.06</span> <span class="k">else</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="n">mbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e5</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
        <span class="n">xbias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

        <span class="n">mpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdmPower</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;nmodes&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdmPower</span><span class="p">[</span><span class="s1">&#39;nmodes&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">pk</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span>
                <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">,</span> <span class="p">:],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
            <span class="n">bias_of_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">mpk</span><span class="p">)</span>
            <span class="n">mask_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mink</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bias_of_k</span><span class="p">[</span><span class="n">mask_k</span><span class="p">])</span>

            <span class="n">dm_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>

            <span class="n">pk</span> <span class="o">=</span> <span class="n">compute_crossspectrum</span><span class="p">(</span>
                <span class="n">pos1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pos2</span><span class="o">=</span><span class="n">dm_pos</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
            <span class="n">bias_of_k</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">mpk</span>
            <span class="n">mask_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mink</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">xbias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bias_of_k</span><span class="p">[</span><span class="n">mask_k</span><span class="p">])</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">mass</span><span class="o">*</span><span class="mf">1e10</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mass</span><span class="o">*</span><span class="mf">1e10</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">:</span><span class="n">nu</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span> <span class="s1">&#39;xbias&#39;</span><span class="p">:</span> <span class="n">xbias</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subHOD</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subHOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing subhalo HOD&quot;</span><span class="p">)</span>

        <span class="n">mbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e5</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">hod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">not_orphan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vthreshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="n">not_orphan</span><span class="p">])[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">volume</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">mhost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">]</span>
            <span class="n">mask_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">mhost</span> <span class="o">&gt;</span> <span class="n">m0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mhost</span> <span class="o">&lt;</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vthreshold</span><span class="p">)</span>
            <span class="c1">#hod[i]= len(np.where(mask_sub == True)[0])</span>
            <span class="n">hod</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_sub</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mass</span><span class="o">*</span><span class="mf">1e10</span><span class="p">,</span> <span class="s1">&#39;hod&#39;</span><span class="p">:</span> <span class="n">hod</span><span class="p">,</span> <span class="s1">&#39;vt&#39;</span><span class="p">:</span> <span class="n">vthreshold</span><span class="p">}</span>



    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">ConcentrationMass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;ConcentrationMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing Concentration-Mass relation&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_concentration</span>

        <span class="n">mbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e6</span><span class="p">),</span> <span class="mi">35</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m1</span><span class="p">)</span>
            <span class="n">mean_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">])[</span><span class="n">mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mf">1e10</span>
            <span class="n">rad_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">mean_rho</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]))))</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rad_mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># We do the fit only if there are more than 5 valid radial measurements</span>
                <span class="n">conc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rs</span><span class="p">,</span> <span class="n">rhoc</span><span class="p">,</span> <span class="n">rho_nfw</span> <span class="o">=</span> <span class="n">compute_concentration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">][</span><span class="n">rad_mask</span><span class="p">],</span> <span class="n">mean_rho</span><span class="p">[</span><span class="n">rad_mask</span><span class="p">])</span>
                <span class="n">conc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">rs</span>

            <span class="c1">#Now for relaxed halos</span>
            <span class="c1"># conc_relax = np.zeros_like(mass)</span>
            <span class="c1"># mask = (self.fof[&#39;halo_mfof&#39;] &gt; m0) &amp; (self.fof[&#39;halo_mfof&#39;] &lt; m1) &amp; (self.fof[&#39;halo_relaxed&#39;])</span>
            <span class="c1"># mean_rho = np.median(np.array(self.fof[&#39;halo_density_profile&#39;])[mask, :], axis=0)</span>
            <span class="c1"># rad_mask = ((mean_rho &gt; 0) &amp;</span>
            <span class="c1">#             (self.fof[&#39;halo_radial_bins&#39;] &lt; 2) &amp;</span>
            <span class="c1">#             (self.fof[&#39;halo_radial_bins&#39;] &gt; 0.015/np.mean(rvir[mask])))</span>
            <span class="c1"># if sum(rad_mask) &lt; 5: # We do the fit only if there are more than 5 valid radial measurements</span>
            <span class="c1">#     conc_relax[i] = 0</span>
            <span class="c1"># else:</span>
            <span class="c1">#     rs, rhoc, rho_nfw = compute_concentration(</span>
            <span class="c1">#         self.fof[&#39;halo_radial_bins&#39;][rad_mask], mean_rho[rad_mask])</span>
            <span class="c1">#     conc_relax[i] = 1/rs</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mass</span><span class="o">*</span><span class="mf">1e10</span><span class="p">,</span> <span class="s1">&#39;conc&#39;</span><span class="p">:</span> <span class="n">conc</span><span class="p">}</span><span class="c1">#, &#39;conc_relax&#39;: conc_relax}</span>


    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">MassFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;MassFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute mass function&quot;</span><span class="p">)</span>

        <span class="c1"># nbins = 40</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="c1"># mrange = np.log([3e9,5e15])</span>
        <span class="n">isOrphan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">mrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mf">11.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span> <span class="mf">5e5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">])</span>
        <span class="n">number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">mrange</span><span class="p">)</span>
        <span class="n">number_m200c</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">mrange</span><span class="p">)</span>
        <span class="n">number_bound</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">][(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_nsubs&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">mrange</span><span class="p">)</span>

        <span class="n">submask</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">isOrphan</span> <span class="o">==</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">satsub_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">submask</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">mrange</span><span class="p">)</span>

        <span class="n">submask</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">isOrphan</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">orpsub_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">submask</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">mrange</span><span class="p">)</span>

        <span class="n">submask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">subnumber</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">submask</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">mrange</span><span class="p">)</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">dlnM</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>

        <span class="c1">#dn_dlnM = -1/3. * nufnu * rho / _mass * dlnS_dlnR</span>
        <span class="n">dn_dlnM</span> <span class="o">=</span> <span class="n">number_m200c</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span>

        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_radius</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">omega_cold_z</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dlnS_dlnR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_dlnS_dlnR</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_nu</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">nufnu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">dn_dlnM</span> <span class="o">*</span> <span class="n">mass</span><span class="o">/</span><span class="n">rho</span> <span class="o">/</span> <span class="n">dlnS_dlnR</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;mass&#39;</span><span class="p">:</span>           <span class="n">mass</span><span class="p">,</span>
                <span class="s1">&#39;nu&#39;</span><span class="p">:</span>             <span class="n">nu</span><span class="p">,</span>
                <span class="s1">&#39;number&#39;</span><span class="p">:</span>         <span class="n">number</span><span class="p">,</span>
                <span class="s1">&#39;nufnu&#39;</span><span class="p">:</span>          <span class="n">nufnu</span><span class="p">,</span>
                <span class="s1">&#39;dndlnM&#39;</span><span class="p">:</span>         <span class="n">number</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;dndlnM_m200c&#39;</span><span class="p">:</span>   <span class="n">number_m200c</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;dndlnM_bound&#39;</span><span class="p">:</span>   <span class="n">number_bound</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;dndlnM_poisson&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;sub_dndlnM&#39;</span><span class="p">:</span>     <span class="n">subnumber</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;sat_sub_dndlnM&#39;</span><span class="p">:</span> <span class="n">satsub_number</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;orpsub_dndlnM&#39;</span><span class="p">:</span>  <span class="n">orpsub_number</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_dn&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_dn_bound&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number_bound</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">number_bound</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_sub_dn&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subnumber</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">subnumber</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_satsub_dn&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">satsub_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">satsub_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_orpsub_dn&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span> <span class="p">}</span>


    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">VmaxFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;VmaxFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute Vmax function&quot;</span><span class="p">)</span>

        <span class="n">nbins</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">vrange</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mf">5e3</span><span class="p">]</span>
        <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">()</span>
        <span class="n">number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vrange</span><span class="p">))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">mask_alive</span>
        <span class="n">cen_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vrange</span><span class="p">))</span>

        <span class="n">mask</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">orpsub_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vrange</span><span class="p">))</span>

        <span class="n">mask</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">no_orph_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vrange</span><span class="p">))</span>

        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">dlnv</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;vcirc&#39;</span><span class="p">:</span>          <span class="n">vmax</span><span class="p">,</span>
                <span class="s1">&#39;dndlnv&#39;</span><span class="p">:</span>         <span class="n">number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cen_dndlnv&#39;</span><span class="p">:</span>     <span class="n">cen_number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;orpsub_dndlnv&#39;</span><span class="p">:</span>  <span class="n">orpsub_number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_dn&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_cen_dn&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cen_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">cen_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                <span class="s1">&#39;cum_orpsub_dn&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span> <span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">VpeakFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;VpeakFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute Vpeak function&quot;</span><span class="p">)</span>

        <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">()</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">]))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span>
        <span class="n">cen_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">]))</span>

        <span class="n">mask</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">orpsub_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">]))</span>

        <span class="n">mask</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">no_orph_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">]))</span>

        <span class="n">vpeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">dlnv</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>

        <span class="k">try</span><span class="p">:</span><span class="c1"># This could (will) crash if not all the snapshot were downloaded</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">()</span>
            <span class="n">only_surv_number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">]))</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;vcirc&#39;</span><span class="p">:</span>            <span class="n">vpeak</span><span class="p">,</span>
                    <span class="s1">&#39;dndlnv&#39;</span><span class="p">:</span>           <span class="n">number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cen_dndlnv&#39;</span><span class="p">:</span>       <span class="n">cen_number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;orpsub_dndlnv&#39;</span><span class="p">:</span>    <span class="n">orpsub_number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;onlysurv_dndlnv&#39;</span><span class="p">:</span>  <span class="n">only_surv_number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cum_dn&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cum_cen_dn&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cen_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">cen_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cum_orpsub_dn&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cum_onlysurv_dn&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">only_surv_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">only_surv_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;vcirc&#39;</span><span class="p">:</span>            <span class="n">vpeak</span><span class="p">,</span>
                    <span class="s1">&#39;dndlnv&#39;</span><span class="p">:</span>           <span class="n">number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cen_dndlnv&#39;</span><span class="p">:</span>       <span class="n">cen_number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;orpsub_dndlnv&#39;</span><span class="p">:</span>    <span class="n">orpsub_number</span><span class="o">/</span><span class="n">dlnv</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;onlysurv_dndlnv&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">)),</span>
                    <span class="s1">&#39;cum_dn&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cum_cen_dn&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cen_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">cen_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cum_orpsub_dn&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s1">&#39;cum_onlysurv_dn&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orpsub_number</span><span class="p">))</span>
                    <span class="p">}</span>


    <span class="k">def</span> <span class="nf">compute_halo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_twopointcorr</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All haloes to the CF... go for a coffee this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute halo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_twopointcorr</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">compute_twopointcorr</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span><span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.32</span><span class="p">,</span> <span class="mi">150</span><span class="p">)),</span><span class="mi">25</span><span class="p">))</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">halo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;halo_Correl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute halo correlation function for n = 1e-3 h^3Mpc^-3&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">halo_zCorrel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;halo_zCorrel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute halo correlation function in redshift space for n = 1e-3 h^3Mpc^-3&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_halo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_multipoles</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All haloes to the CF... go for a coffee this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute halo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_multipoles</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">compute_multipoles</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">halo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;halo_multipoles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute halo multipoles for n = 1e-3 h^3Mpc^-3&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_halo_multipoles</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_subhalos_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">):</span>
        <span class="n">alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_orphans</span><span class="p">:</span>
            <span class="c1"># Maybe in the future we will include stellar+cold gas in SatelliteMass! */</span>
            <span class="n">msat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="c1"># + self.sub[&#39;galaxy_mass&#39;]</span>
            <span class="n">rsat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central_dist&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span>
            <span class="n">mhost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">]</span>
            <span class="n">infall_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span>

            <span class="n">mask_orp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mergertime</span><span class="p">,</span> <span class="n">time_since_accretion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dynamical_friction_time</span><span class="p">(</span><span class="n">mhost</span><span class="p">[</span><span class="n">mask_orp</span><span class="p">],</span> <span class="n">msat</span><span class="p">[</span><span class="n">mask_orp</span><span class="p">],</span> <span class="n">rsat</span><span class="p">[</span><span class="n">mask_orp</span><span class="p">],</span> <span class="n">infall_snap</span><span class="p">[</span><span class="n">mask_orp</span><span class="p">],</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="n">mergertime_factor</span><span class="p">)</span>
            <span class="n">alive</span><span class="p">[</span><span class="n">mask_orp</span><span class="p">[</span><span class="n">mergertime</span> <span class="o">&lt;</span> <span class="n">time_since_accretion</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">alive</span>

    <span class="k">def</span> <span class="nf">get_subhalos_alive_v2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="n">alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">infall_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;infall_snap&#39;</span><span class="p">]</span>
        <span class="n">msat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;mpeak&#39;</span><span class="p">]</span><span class="c1"># + self.sub[&#39;galaxy_mass&#39;]</span>
        <span class="n">mhost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">]</span>

        <span class="n">time_since_accretion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">infall_snap</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">infall_snap</span><span class="p">)]</span>
        <span class="n">alive</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;infall_snap&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#No Ghost</span>
        <span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;infall_snap&#39;</span><span class="p">]))</span>
        <span class="n">mratio</span> <span class="o">=</span> <span class="n">mhost</span><span class="o">/</span><span class="n">msat</span>
        <span class="n">mratio</span><span class="p">[</span><span class="n">mratio</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1">#prob_distr = rand &gt; np.exp(-(a*(time_since_accretion-b)*mratio))</span>
        <span class="n">prob_distr</span> <span class="o">=</span> <span class="n">rand</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">time_since_accretion</span><span class="o">/</span><span class="p">(</span><span class="n">mratio</span><span class="o">**</span><span class="n">b</span><span class="p">)))</span>
        <span class="n">alive</span><span class="p">[</span><span class="n">prob_distr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">alive</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">alive</span>

<div class="viewcode-block" id="Simulation.compute_subhalo_mask"><a class="viewcode-back" href="../../code.html#bacco.Simulation.compute_subhalo_mask">[docs]</a>    <span class="k">def</span> <span class="nf">compute_subhalo_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes 2 masks to apply to subhalo positions and velocities: one mask</span>
<span class="sd">        selects subs according a property (vmax, vpeak), either retaining</span>
<span class="sd">        only the objects that make up the given number density n (if cut is</span>
<span class="sd">        None), or retaining all objects with values of the given propery larger</span>
<span class="sd">        than cut.</span>

<span class="sd">        Inputs:</span>
<span class="sd">                prop:              the property used to sort subs (vmax, vpeak)</span>
<span class="sd">                cut:               the threshold for prop; if None, n is used to</span>
<span class="sd">                                   fix a number density</span>
<span class="sd">                n:                 used when cut is None to fix a number density</span>
<span class="sd">                compute_noOrphans: if True, only subs that are not orphans are</span>
<span class="sd">                                   retained</span>
<span class="sd">                no_destruction:    if False, only consider subs that are still</span>
<span class="sd">                                   alive</span>

<span class="sd">        Outputs:</span>
<span class="sd">                mask, mask_orph:   two masks, the first one that selects the</span>
<span class="sd">                                   subs that comply with the selection criterion</span>
<span class="sd">                                   while mask_orph selects, from the provious</span>
<span class="sd">                                   sample, the ones that are not orphans</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span>
            <span class="n">mask_orph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_orph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask_orph</span></div>

    <span class="k">def</span> <span class="nf">compute_subhalo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">recheck_boundary_condition</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#WARNING The compute_noOrphans will compute the galaxies that are not orphans from the number density selected.</span>
        <span class="c1">#eg. they will have a number density equal or bellow the one given. Only usefull for comparing the effects of Orphans</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_twopointcorr</span>

        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">(</span><span class="n">mergertime_factor</span> <span class="o">=</span> <span class="n">mergertime_factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="c1">#mask = ~utils.get_subhalos_tidally_destroyed(self.sub)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In compute_subhalo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;In compute_subhalo_Correl(). n = </span><span class="si">%f</span><span class="s1"> -&gt; </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">prop</span><span class="p">,</span><span class="n">cut</span><span class="p">))</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_twopointcorr</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Mhalo_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask2</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Mhalo_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Mhalo_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recheck_boundary_condition</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.20</span><span class="p">,</span> <span class="mi">150</span><span class="p">)),</span><span class="mi">35</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_twopointcorr</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="n">rbins</span><span class="p">)</span>
        <span class="c1">#return compute_twopointcorr_jackknife(pos=_pos[mask2], box=self.header[&#39;BoxSize&#39;], method=&#39;Corrfunc&#39;, rbins = rbins, n_jn3=3)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_Correl_JN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">recheck_boundary_condition</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="c1">#WARNING The compute_noOrphans will compute the galaxies that are not orphans from the number density selected.</span>
        <span class="c1">#eg. they will have a number density equal or bellow the one given. Only usefull for comparing the effects of Orphans</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_twopointcorr_jackknife</span>

        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">(</span><span class="n">mergertime_factor</span> <span class="o">=</span> <span class="n">mergertime_factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="c1">#mask = ~utils.get_subhalos_tidally_destroyed(self.sub)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In compute_subhalo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;In compute_subhalo_Correl(). n = </span><span class="si">%f</span><span class="s1"> -&gt; </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">prop</span><span class="p">,</span><span class="n">cut</span><span class="p">))</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_twopointcorr</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.20</span><span class="p">,</span> <span class="mi">150</span><span class="p">)),</span><span class="mi">35</span><span class="p">)</span>

        <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Mhalo_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask2</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Mhalo_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Mhalo_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recheck_boundary_condition</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">compute_twopointcorr_jackknife</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="n">rbins</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="n">n_jn3</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_Correl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function for n = 1e-3 h^3Mpc^-3 with vmax&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_zCorrel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_zCorrel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function for n = 1e-3 h^3Mpc^-3 with vmax in redshift space&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">recheck_boundary_condition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_multipoles</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">(</span><span class="n">mergertime_factor</span> <span class="o">=</span> <span class="n">mergertime_factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">logspace</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_multipoles</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">compute_multipoles</span><span class="p">(</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">logspace</span><span class="o">=</span><span class="n">logspace</span><span class="p">,</span> <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_multipoles</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">logspace</span><span class="o">=</span><span class="n">logspace</span><span class="p">,</span> <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_multipoles_JN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mergertime_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">,</span><span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">recheck_boundary_condition</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_multipoles_jackknife</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">(</span><span class="n">mergertime_factor</span> <span class="o">=</span> <span class="n">mergertime_factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">logspace</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_multipoles</span>
            <span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">recheck_boundary_condition</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">compute_multipoles_jackknife</span><span class="p">(</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">logspace</span><span class="o">=</span><span class="n">logspace</span><span class="p">,</span><span class="n">n_jn3</span><span class="o">=</span><span class="n">n_jn3</span><span class="p">,</span><span class="n">binning</span><span class="o">=</span><span class="n">rbins</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_multipoles_jackknife</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">logspace</span><span class="o">=</span><span class="n">logspace</span><span class="p">,</span><span class="n">n_jn3</span><span class="o">=</span><span class="n">n_jn3</span><span class="p">,</span><span class="n">binning</span><span class="o">=</span><span class="n">rbins</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">_vel</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

        <span class="n">logspace</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_multipoles</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="n">_vel</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">_vel</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_pmulti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum_multipoles_2</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo correlation function&quot;</span><span class="p">)</span>

        <span class="n">_pos</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">_vel</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

        <span class="n">logspace</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zspace</span><span class="p">:</span> <span class="c1">#TODO, pass this to compute_multipoles</span>
            <span class="n">Hubble_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Hubble_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># ONLY TEMPORARY, UNTIL WE FIX THE FILES</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="n">tmp_mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">compute_powerspectrum_multipoles_2</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="n">_vel</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum_multipoles_2</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">_pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">_vel</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_subhalo_hod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">LogMmin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">LogMmax</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                            <span class="n">nbin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_destruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">only_centrals</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_hod</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># All subhaloes to the CF... go for a large beer, this will take a while</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_destruction</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalos_alive</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">only_centrals</span><span class="p">:</span>
                <span class="n">mask_alive</span> <span class="o">=</span> <span class="n">mask_alive</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;In halo_Correl(). &quot;n&quot; &gt; Nhaloes/Vol. Using all haloes &#39;</span><span class="p">)</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">mask_alive</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask_alive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo hod&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">compute_noOrphans</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">compute_hod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;m200c&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">,</span> <span class="n">centrals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">LogMmin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">LogMmax</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">NBin</span><span class="o">=</span><span class="n">nbin</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_multipoles_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_multipoles_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo multipoles for n = 1e-3 h^3Mpc^-3 in vpeak&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_multipoles</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vpeak&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_multipoles_vmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_multipoles_vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo multipoles for n = 1e-3 h^3Mpc^-3 in vpeak&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_multipoles</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo power spectrum for n = 1e-3 h^3Mpc^-3 in vpeak&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vpeak&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vpeak_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vpeak_real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo power spectrum for n = 1e-3 h^3Mpc^-3 in vpeak&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vpeak&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_pmulti_vpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_pmulti_vpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo power spectrum for n = 1e-3 h^3Mpc^-3 in vpeak&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_pmulti</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vpeak&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo power spectrum for n = 1e-3 h^3Mpc^-3 in vpeak&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_power_vmax_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_power_vmax_real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo power spectrum for n = 1e-3 h^3Mpc^-3 in vpeak&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_powerspectrum</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compute_noOrphans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">subhalo_multipoles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;subhalo_multipoles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo multipoles for n = 1e-3 h^3Mpc^-3 in vmax&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_subhalo_Correl</span><span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">Mhalo_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">compute_noOrphans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">SubhaloMassFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;SubhaloMassFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute subhalo_mfof function&quot;</span><span class="p">)</span>

        <span class="n">host_mbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e5</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">host_mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">host_mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">host_mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>

        <span class="n">nsbins</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">subhalo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">host_mass</span><span class="p">),</span> <span class="n">nsbins</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">mumass</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">])</span>
        <span class="n">mumaxmass</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;mpeak&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">])</span>

        <span class="n">number</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mf">1e10</span><span class="p">,</span> <span class="mf">5e14</span><span class="p">]))</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">dlnM</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">smf</span> <span class="o">=</span> <span class="n">number</span><span class="o">/</span><span class="n">dlnM</span><span class="o">/</span><span class="n">volume</span>
        <span class="n">cnum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

        <span class="c1">#dd = halo_mfof - self.sub[&#39;grnr&#39;]</span>
        <span class="c1">#logger.info(&quot;{0} {1}&quot;.format(np.min(dd), np.max(dd)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">host_mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">host_mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central_dist&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;r200c&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">)</span>

            <span class="n">nhalos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;grnr&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nhalos</span><span class="p">,</span> <span class="n">nsbins</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">grnr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;grnr&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])):</span>
                <span class="n">submask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;grnr&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grnr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central_dist&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;r200c&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">)</span>

                <span class="n">number</span><span class="p">,</span> <span class="n">mubins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mumass</span><span class="p">[</span><span class="n">submask</span><span class="p">]),</span>
                                              <span class="n">bins</span><span class="o">=</span><span class="n">nsbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>

                <span class="n">number</span><span class="p">,</span> <span class="n">mubins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mumaxmass</span><span class="p">[</span><span class="n">submask</span><span class="p">]),</span>
                                              <span class="n">bins</span><span class="o">=</span><span class="n">nsbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>

            <span class="n">subhalo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">subhalo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subhalo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">subhalo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">subhalo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subhalo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">dlnmu</span> <span class="o">=</span> <span class="n">mubins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mubins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sub_mf</span> <span class="o">=</span> <span class="n">subhalo</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">dlnmu</span>
        <span class="n">sub_mfmax</span> <span class="o">=</span> <span class="n">subhalo</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">dlnmu</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">mubins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mubins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;host_mass&#39;</span><span class="p">:</span> <span class="n">host_mass</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mass</span><span class="p">,</span> <span class="s1">&#39;cnumber&#39;</span><span class="p">:</span><span class="n">cnum</span><span class="p">,</span> <span class="s1">&#39;dndlnM&#39;</span><span class="p">:</span> <span class="n">smf</span><span class="p">,</span>
                <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="n">mu</span><span class="p">,</span> <span class="s1">&#39;dndlnmu&#39;</span><span class="p">:</span> <span class="n">sub_mf</span><span class="p">,</span> <span class="s1">&#39;dndlnmumax&#39;</span><span class="p">:</span> <span class="n">sub_mfmax</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">qPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;qPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing P(k) from qData&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmqPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmqPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing P(k) from smd_qData&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm_qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>



    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">haloqPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;haloqPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing P(k) from qData&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>

        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.085678e+24</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing redshift-space P(k)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                     <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span> <span class="n">unit_in_Mpc</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">zqPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;zqPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing redshift-space P(k) from qData&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                     <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">thetaPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;thetaPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># from .statistics import compute_powerspectrum</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_crossspectrum_twogrids</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute velocity divergence P(k)&quot;</span><span class="p">)</span>
        <span class="n">totalmass</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># totalmass = 1.0</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]))</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_field</span> <span class="o">/</span> <span class="n">fac</span> <span class="o">/</span> <span class="n">totalmass</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm_theta_field</span> <span class="o">/</span> <span class="n">fac</span> <span class="o">/</span> <span class="n">totalmass</span>
        <span class="k">return</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">deltathetaPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;thetaPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># from .statistics import compute_powerspectrum</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_crossspectrum_twogrids</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute velocity divergence P(k)&quot;</span><span class="p">)</span>
        <span class="n">totalmass</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># totalmass = 1.0</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]))</span>
        <span class="n">field1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_field</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm_density_field</span>
        <span class="n">field2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_field</span> <span class="o">/</span> <span class="n">fac</span> <span class="o">/</span> <span class="n">totalmass</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm_theta_field</span> <span class="o">/</span> <span class="n">fac</span> <span class="o">/</span> <span class="n">totalmass</span>

        <span class="k">if</span> <span class="n">field1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">field1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">field1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">field1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">field1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">assert</span> <span class="n">field1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">field2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="n">field1</span><span class="p">,</span> <span class="n">field2</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">field1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">lptPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_crossspectrum_twogrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;lptPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">dens_from_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span>
        <span class="k">return</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">,</span>
                                              <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lpt_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                              <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Correl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_twopointcorr</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute correlation function&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compute_twopointcorr</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Corrfunc&#39;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">disp_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;disp_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>

        <span class="c1"># _cosmology = copy.copy(self.Cosmology)</span>
        <span class="n">_cosmology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span>

        <span class="c1"># Linearly extrapolate the z=0 result to the desired redshift</span>
        <span class="n">wavemode</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">Di</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">wavemode</span><span class="p">)</span>
        <span class="n">Di2</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Di3a</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">Di3b</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">:</span>
            <span class="c1"># if config[&#39;scaling&#39;][&#39;add_relativistic_effects&#39;]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_relativistic_effects</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">log_int_ext</span>
                <span class="k">if</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">pkfile</span> <span class="o">==</span> <span class="s1">&#39;CLASS&#39;</span><span class="p">:</span>
                    <span class="n">boltz_pk</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">_compute_class_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">boltz_pk</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">_compute_camb_spectrum</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
                <span class="n">power</span> <span class="o">=</span> <span class="n">log_int_ext</span><span class="p">(</span><span class="n">boltz_pk</span><span class="p">[</span><span class="s1">&#39;kk&#39;</span><span class="p">],</span> <span class="n">boltz_pk</span><span class="p">[</span><span class="s1">&#39;pk_cold&#39;</span><span class="p">])</span>
                <span class="n">power</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="n">wavemode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">power</span> <span class="o">*=</span> <span class="n">Di</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">Di</span> <span class="o">=</span>   <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Di</span> <span class="o">/=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">wavemode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating displacement field: Di=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Di</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_cosmology</span><span class="p">))</span>
        <span class="n">LPT_order</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;LPT_order&#39;</span><span class="p">]</span>
        <span class="n">order_by_order</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">return_density</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">growthrate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># this is not used</span>
        <span class="n">redshift_space</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span>
                             <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">growthrate</span><span class="p">,</span> <span class="n">LPT_order</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                             <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">],</span>
                             <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;InitialPhase&quot;</span><span class="p">],</span> <span class="n">return_density</span><span class="p">,</span> <span class="n">redshift_space</span><span class="p">,</span>
                             <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]))</span> <span class="c1">#[::-1,::-1,::-1]</span>

        <span class="c1">#_cosmology.cleanup()</span>
        <span class="k">return</span> <span class="n">Arr</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">linear_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>

        <span class="c1"># Linearly extrapolate the z=0 result to the desired redshift</span>
        <span class="n">Di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Di2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Di3a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">Di3b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating linear field: Di=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Di</span><span class="p">))</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;InitialPhase&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FixedInitialAmplitude&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">return_density</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">LPT_order</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">damping_scale</span> <span class="o">=</span> <span class="mf">1e4</span>
        <span class="n">order_by_order</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">growthrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">redshift_space</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">grid</span><span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
                                     <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">growthrate</span><span class="p">,</span> <span class="n">LPT_order</span><span class="p">,</span> <span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                                     <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">],</span>
                                     <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;InitialPhase&quot;</span><span class="p">],</span> <span class="n">return_density</span><span class="p">,</span> <span class="n">redshift_space</span><span class="p">,</span>
                                     <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]))</span> <span class="c1">#[::-1,::-1,::-1]</span>
        <span class="k">return</span> <span class="n">grid</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">linear_field_zspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>

        <span class="c1"># Linearly extrapolate the z=0 result to the desired redshift</span>
        <span class="n">Di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Di2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Di3a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">Di3b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating linear field: Di=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Di</span><span class="p">))</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;InitialPhase&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FixedInitialAmplitude&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">return_density</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">LPT_order</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">damping_scale</span> <span class="o">=</span> <span class="mf">1e4</span>
        <span class="n">order_by_order</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">growthrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">redshift_space</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">grid</span><span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
                                     <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">growthrate</span><span class="p">,</span> <span class="n">LPT_order</span><span class="p">,</span> <span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                                     <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">],</span>
                                     <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;InitialPhase&quot;</span><span class="p">],</span> <span class="n">return_density</span><span class="p">,</span> <span class="n">redshift_space</span><span class="p">,</span>
                                     <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]))</span> <span class="c1">#[::-1,::-1,::-1]</span>
        <span class="k">return</span> <span class="n">grid</span>



    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">lpt_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>

        <span class="n">_cosmology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span>

        <span class="c1"># Linearly extrapolate the z=0 result to the desired redshift</span>
        <span class="n">wavemode</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">Di</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">wavemode</span><span class="p">)</span>
        <span class="n">Di2</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Di3a</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">Di3b</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">:</span>
            <span class="n">power</span> <span class="o">*=</span> <span class="n">Di</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">Di</span> <span class="o">=</span>   <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Di</span> <span class="o">/=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">wavemode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating linear field: Di=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Di</span><span class="p">))</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;InitialPhase&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FixedInitialAmplitude&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">return_density</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">order_by_order</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">growthrate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># this is not used</span>
        <span class="n">redshift_space</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">grid</span><span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span>
                             <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">growthrate</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;LPT_order&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                             <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">],</span>
                             <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">RaylQuantile</span><span class="p">,</span>
                             <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;InitialPhase&quot;</span><span class="p">],</span> <span class="n">return_density</span><span class="p">,</span> <span class="n">redshift_space</span><span class="p">,</span>
                             <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]))</span> <span class="c1">#[::-1,::-1,::-1]</span>
        <span class="k">return</span> <span class="n">grid</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">density_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;density_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute density field&quot;</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span>  <span class="n">compute_mesh</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                            <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                            <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                            <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="c1"># print(mesh[0].sum()/mesh.shape[1]**3)</span>
        <span class="c1"># mesh /= (mesh[0].sum()/mesh.shape[1]**3)</span>
        <span class="c1"># mesh -= 1.0</span>
        <span class="k">return</span> <span class="n">mesh</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdm_density_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdm_density_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute density field&quot;</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span>  <span class="n">compute_mesh</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                            <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                            <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                            <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="c1"># print(mesh[0].sum()/mesh.shape[1]**3)</span>
        <span class="c1"># mesh /= (mesh[0].sum()/mesh.shape[1]**3)</span>
        <span class="c1"># mesh -= 1.0</span>
        <span class="k">return</span> <span class="n">mesh</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">halo_density_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;halo_density_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute density field&quot;</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span>  <span class="n">compute_mesh</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                            <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span>
                            <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">],</span>
                            <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="c1"># print(mesh[0].sum()/mesh.shape[1]**3)</span>
        <span class="c1"># mesh /= (mesh[0].sum()/mesh.shape[1]**3)</span>
        <span class="c1"># mesh -= 1.0</span>
        <span class="k">return</span> <span class="n">mesh</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">neutrino_density_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;neutrino_density_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>

        <span class="c1"># Linearly extrapolate the z=0 result to the desired redshift</span>
        <span class="n">Di</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Di2</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Di3a</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Di3b</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">wavemode</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuPower</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuPower</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating neutrino field based on gadget outputs&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;InitialPhase&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FixedInitialAmplitude&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">order_by_order</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">LPT_order</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">damping_scale</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="n">return_density</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">grid</span><span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span>
                             <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">LPT_order</span><span class="p">,</span> <span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                             <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">],</span>
                             <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">RaylQuantile</span><span class="p">,</span>
                             <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;InitialPhase&quot;</span><span class="p">],</span> <span class="n">return_density</span><span class="p">,</span>
                             <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]))</span> <span class="c1">#[::-1,::-1,::-1]</span>
        <span class="k">return</span> <span class="n">grid</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">density_field_from_displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;density_field_from_displacements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_density_from_displacements</span>
        <span class="k">return</span> <span class="n">compute_density_from_displacements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_field</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">velocity_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;velocity_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_velocity_mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute velocity field&quot;</span><span class="p">)</span>
        <span class="n">vmesh</span> <span class="o">=</span> <span class="n">compute_velocity_mesh</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                      <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                      <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span>
        <span class="c1"># average velocity in a cell is v_cell / density in that cell</span>
        <span class="c1"># as long as the 2 grids share the same deposit method</span>
        <span class="n">vmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">vmesh</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vmesh</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdm_velocity_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdm_velocity_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_velocity_mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute velocity field&quot;</span><span class="p">)</span>
        <span class="n">vmesh</span> <span class="o">=</span> <span class="n">compute_velocity_mesh</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                      <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                      <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span>
        <span class="c1"># average velocity in a cell is v_cell / density in that cell</span>
        <span class="c1"># as long as the 2 grids share the same deposit method</span>
        <span class="n">vmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm_density_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">vmesh</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm_density_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vmesh</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">theta_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;theta_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute velocity divergence field&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_divergence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity_field</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span>
                                    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdm_theta_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdm_theta_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute velocity divergence field&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_divergence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm_velocity_field</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span>
                                    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">halo_qdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;halo_qdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding lagrangian coordinates of halos in a simulation&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_qdata&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdata_halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_halo_file</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">_qdata</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_halo_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_qdata</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Halo halo-qdata does not exist, creating it...&#39;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">]</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">]</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mbid&#39;</span><span class="p">]</span>

        <span class="n">vel_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">vel_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;allocating memory&#39;</span><span class="p">)</span>
        <span class="n">nbodies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">_qdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                  <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>


        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bias_dependent_displacement&#39;</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">compute_biasfunction</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="mf">1e10</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">nbodies</span><span class="p">)</span>

        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
            <span class="n">iend</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbodies</span><span class="o">/</span><span class="n">nchunks</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nchunks</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">iend</span> <span class="o">=</span> <span class="n">nbodies</span>
            <span class="n">_qpos</span><span class="p">,</span> <span class="n">_qvel</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">find_lagrangian_coordinates</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ids</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span> <span class="n">bias</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span>
                                                           <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;qdata_tolerance&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                           <span class="n">vel_factor</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
            <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qpos</span>
            <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qvel</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="n">iend</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;save_qdata&#39;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_halo_file</span><span class="p">,</span> <span class="n">_qdata</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_qdata</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sub_qdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sub_qdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding lagrangian coordinates of halos in a simulation&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_qdata&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdata_sub_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_sub_file</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">_qdata</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_sub_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;subhalo-qdata does not exist, creating it...&#39;</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;mostboundID&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">_computed_properties</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;mostboundID&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;mostboundID does not exist, defaulting to -1&#39;</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


            <span class="n">vel_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">vel_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;allocating memory&#39;</span><span class="p">)</span>
            <span class="n">nbodies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">_qdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bias_dependent_displacement&#39;</span><span class="p">:</span>
                <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">compute_biasfunction</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="mf">1e10</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;mfof&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">nbodies</span><span class="p">)</span>

            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nchunks</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
                <span class="n">iend</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbodies</span><span class="o">/</span><span class="n">nchunks</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nchunks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">iend</span> <span class="o">=</span> <span class="n">nbodies</span>
                <span class="n">_qpos</span><span class="p">,</span> <span class="n">_qvel</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">find_lagrangian_coordinates</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ids</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span> <span class="n">bias</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span>
                                                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;qdata_tolerance&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">disp_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                               <span class="n">vel_factor</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span>
                                                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
                <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qpos</span>
                <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qvel</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">iend</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;save_qdata&#39;</span><span class="p">]:</span>
                <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
                <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_sub_file</span><span class="p">,</span> <span class="n">_qdata</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; saved halo_qdata&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_qdata</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdm_qdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdm_qdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_sdm_qdata&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdata_sdm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_sdm_file</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">_qdata</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_sdm_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding lagrangian coordinates of the sDM&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_sDM&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;load_sDM must be set to True to scale it&quot;</span><span class="p">)</span>

            <span class="c1"># WARNING: just particles out of halo</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span>

            <span class="n">vel_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">vel_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
            <span class="n">nbodies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;allocating memory for </span><span class="si">{0}</span><span class="s1"> sDM particles&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nbodies</span><span class="p">))</span>

            <span class="n">_qdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>

            <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">nbodies</span><span class="p">)</span>

            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nchunks</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
                <span class="n">iend</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbodies</span><span class="o">/</span><span class="n">nchunks</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nchunks</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">iend</span> <span class="o">=</span> <span class="n">nbodies</span>
                <span class="n">_qpos</span><span class="p">,</span> <span class="n">_qvel</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">find_lagrangian_coordinates</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ids</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span> <span class="n">bias</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span>
                                                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;qdata_tolerance&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">disp_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                               <span class="n">vel_factor</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span>
                                                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
                <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qpos</span>
                <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qvel</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">iend</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;save_sdm_qdata&#39;</span><span class="p">]:</span>
                <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
                <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_sdm_file</span><span class="p">,</span> <span class="n">_qdata</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; saved halo_sdm_qdata&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_qdata</span>


    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">qdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;qdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_qdata&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdata_dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_dm_file</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">_qdata</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_dm_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding lagrangian coordinates of a simulation&#39;</span><span class="p">)</span>

            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span>

            <span class="n">vel_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">vel_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;allocating memory&#39;</span><span class="p">)</span>
            <span class="n">nbodies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">_qdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbodies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">nbodies</span><span class="p">)</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nchunks</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
                <span class="n">iend</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbodies</span><span class="o">/</span><span class="n">nchunks</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nchunks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">iend</span> <span class="o">=</span> <span class="n">nbodies</span>

                <span class="n">_qpos</span><span class="p">,</span> <span class="n">_qvel</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">find_lagrangian_coordinates</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vel</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ids</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span> <span class="n">bias</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">],</span>
                                                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;qdata_tolerance&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">disp_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                               <span class="n">vel_factor</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span>
                                                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
                <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qpos</span>
                <span class="n">_qdata</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_qvel</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">iend</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;save_qdata&#39;</span><span class="p">]:</span>
                <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
                <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qdata_dm_file</span><span class="p">,</span> <span class="n">_qdata</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; saved halo_qdata&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_qdata</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_halo_nfw_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;_halo_nfw_pars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;load_halo_nfw_pars&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_nfw_pars_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_nfw_pars_file</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
            <span class="n">_halo_pars</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_nfw_pars_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing concentrations for all the halos&#39;</span><span class="p">)</span>

            <span class="n">_halo_pars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;r_s&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">]),</span> <span class="s1">&#39;log_rho_0&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_halo_pars</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">],</span> <span class="n">_halo_pars</span><span class="p">[</span><span class="s1">&#39;log_rho_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_halo_profiles</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">.baryons</span> <span class="k">import</span> <span class="n">compute_rho0_nfw</span>
                <span class="n">conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_from_vmax</span><span class="p">()</span>
                <span class="n">_halo_pars</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">conc</span>
                <span class="n">_halo_pars</span><span class="p">[</span><span class="s1">&#39;log_rho_0&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">compute_rho0_nfw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">],</span> <span class="n">_halo_pars</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;save_halo_nfw_pars&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_nfw_pars_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
                <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_nfw_pars_file</span><span class="p">,</span> <span class="n">_halo_pars</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saved nfw_pars_file&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_halo_pars</span>

    <span class="k">def</span> <span class="nf">_get_halo_nfw_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;log_rho_0&#39;</span><span class="p">,</span> <span class="s1">&#39;r_s&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halo_nfw_pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;concentration&#39;</span> <span class="ow">or</span> <span class="n">par</span> <span class="o">==</span> <span class="s1">&#39;conc&#39;</span><span class="p">:</span>
            <span class="n">conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_halo_nfw_pars</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halo_nfw_pars</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span>
            <span class="n">conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">return</span> <span class="n">conc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter </span><span class="si">{}</span><span class="s2"> is not valid!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fit_halo_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_cengine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">check_lss_precision</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fitting the halo density profiles...&#39;</span><span class="p">)</span>

        <span class="n">halo_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">prec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="k">if</span> <span class="n">check_lss_precision</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>

        <span class="n">r200</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">halo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">prec</span><span class="p">))</span>
        <span class="n">rho_r</span> <span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">][</span><span class="n">halo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span><span class="o">*</span><span class="mf">1e10</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r200</span><span class="p">)</span>
        <span class="n">rhoc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r200</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_cengine</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">halo_concentration</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">prec</span><span class="p">),</span> <span class="n">rho_r</span><span class="p">,</span> <span class="n">r200</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">])</span>

            <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">][:][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r200</span> <span class="p">))</span> <span class="p">])</span>
            <span class="n">rhoc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">][:][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r200</span> <span class="p">))</span> <span class="p">])</span>

            <span class="n">rs</span><span class="p">[</span><span class="n">rs</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="n">rs</span><span class="p">[</span><span class="n">rs</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">rhoc</span><span class="p">[</span><span class="n">rhoc</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e20</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e20</span><span class="p">);</span> <span class="n">rhoc</span><span class="p">[</span><span class="n">rhoc</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_concentration</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ihalo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])[</span><span class="n">halo_mask</span><span class="p">]):</span>
                <span class="n">radial_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">rs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rhoc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rho_nfw</span> <span class="o">=</span> <span class="n">compute_concentration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">][</span><span class="n">radial_mask</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">][</span><span class="n">radial_mask</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">)</span>

        <span class="n">fof_rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">])</span>
        <span class="n">fof_rs</span><span class="p">[</span><span class="n">halo_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">rs</span><span class="o">*</span><span class="n">r200</span>
        <span class="n">fof_rhoc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">])</span>
        <span class="n">fof_rhoc</span><span class="p">[</span><span class="n">halo_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhoc</span>
        <span class="k">return</span> <span class="n">fof_rs</span><span class="p">,</span> <span class="n">fof_rhoc</span>

    <span class="k">def</span> <span class="nf">concentration_from_vmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Estimating halo concentrations from the maximum circular velocities...&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">approximate_concentration</span>
        <span class="kn">from</span> <span class="nn">.baryons</span> <span class="k">import</span> <span class="n">compute_rho0_nfw</span>
        <span class="n">mask_halo_wo_subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_nsubs&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">halo_vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">])</span>
        <span class="n">halo_vmax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">]</span> <span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;parent_halo&#39;</span><span class="p">][</span><span class="s1">&#39;central&#39;</span><span class="p">]]</span>
        <span class="n">r200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">]</span>
        <span class="n">M200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">43.0071</span><span class="c1"># Mpc/(1e10 M_solar) km^2 / s^2</span>
        <span class="n">v200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">G</span><span class="o">*</span><span class="n">M200</span><span class="o">/</span><span class="n">r200</span><span class="p">)</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">approximate_concentration</span><span class="p">(</span><span class="n">r200</span><span class="p">,</span><span class="n">M200</span><span class="p">,</span><span class="n">halo_vmax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conc</span>

    <span class="k">def</span> <span class="nf">compute_sdm_bispectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>

        <span class="n">cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span> <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cosmology</span>

        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                     <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                     <span class="n">bs_num_triangles</span><span class="o">=</span><span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="n">bs_deltak</span><span class="p">,</span>
                                     <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_hmm_bispectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_crossspectrum</span>

        <span class="n">cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span> <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cosmology</span>

        <span class="k">return</span> <span class="n">compute_crossspectrum</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                     <span class="n">pos1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span> <span class="n">pos2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                     <span class="n">vel1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">],</span> <span class="n">vel2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                     <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                     <span class="n">bs_num_triangles</span><span class="o">=</span><span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="n">bs_deltak</span><span class="p">,</span>
                                     <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_halo_bispectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>

        <span class="n">cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span> <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cosmology</span>

        <span class="k">return</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_vel&#39;</span><span class="p">],</span>
                                     <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                     <span class="n">bs_num_triangles</span><span class="o">=</span><span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="n">bs_deltak</span><span class="p">,</span>
                                     <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1">#Fix for periodic boundaries</span>
        <span class="k">if</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">wrapbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span>  <span class="n">wrapbox</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
                <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">wrapbox</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
                <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dp</span>

    <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>


        <span class="n">dpos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">])):</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>

            <span class="c1">#dx = 3*sim.Cosmology.mass_to_eulerian_radius(sim.fof[&#39;halo_mfof&#39;][ihalo])/256</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="mi">3</span><span class="o">/</span><span class="mf">256.</span>

            <span class="c1"># We are not wrapping!!</span>
           <span class="c1"># dpos[i0:i1] = _wrap((self.dm[&#39;pos&#39;][i0:i1,:].astype(np.float32) - 128)*dx + self.fof[&#39;halo_pos&#39;][ihalo,:], wrapbox=self.header[&#39;BoxSize&#39;])</span>
            <span class="n">dpos</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> \
                <span class="n">dx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="n">dpos</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

<span class="c1">#--------------------------------------------------------------------</span>
<span class="c1"># Visualization Routines</span>
<span class="c1">#--------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">tetimage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deconvolve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">.qtets</span> <span class="k">import</span> <span class="n">qtets</span>

        <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Making an image with tri-quadratic hexahedral interpolation (</span><span class="si">{0}</span><span class="s1">x</span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if making a picture&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; IDs must be provided if making a picture&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>

        <span class="n">hist2d</span> <span class="o">=</span> <span class="n">qtets</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                             <span class="n">ngrid</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">],</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_deconvolve</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">sizeX</span><span class="p">,</span> <span class="n">sizeY</span><span class="p">):</span>
            <span class="n">InputFFT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftn</span><span class="p">(</span><span class="n">Input</span><span class="p">)</span>

            <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">sizeX</span><span class="p">)</span>
            <span class="n">kvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizeX</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">sizeY</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">sizeX</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">sizeX</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">sizeX</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))))</span>

            <span class="n">fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">sizeX</span>
            <span class="n">fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">sizeY</span>
            <span class="n">psfFFT</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span><span class="o">/</span><span class="n">fx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">fy</span><span class="p">)</span><span class="o">/</span><span class="n">fy</span><span class="p">)</span>
            <span class="n">psfFFT</span><span class="p">[</span><span class="n">fx</span><span class="o">*</span><span class="n">fy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">deconvolved</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfftn</span><span class="p">(</span><span class="n">InputFFT</span><span class="o">/</span><span class="n">psfFFT</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">deconvolved</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">deconvolved</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">deconvolved</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deconvolve</span><span class="p">:</span>
            <span class="n">hist2d</span> <span class="o">=</span> <span class="n">_deconvolve</span><span class="p">(</span><span class="n">hist2d</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hist2d</span>


<span class="c1">#------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">get_halo_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">sDM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sDM</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;vel&#39;</span><span class="p">]:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">ihalo</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">i0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;vel&#39;</span><span class="p">]:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ih_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">prop</span>

    <span class="k">def</span> <span class="nf">set_halo_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">sDM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sDM</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;vel&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;pos&#39;</span> <span class="ow">and</span> <span class="n">wrap</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">i0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;vel&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ih_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">ihalo</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">wrap</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                    <span class="n">halosdm</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">][</span><span class="s1">&#39;ih_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                    <span class="n">sdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sdm</span><span class="p">,</span> <span class="n">halosdm</span><span class="p">]:</span>
                        <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># self.sdm_in_haloes[key][index[ihalo]:index[ihalo+1]][mask] = value + self.fof[&#39;halo_%s&#39;%(key)][ihalo]</span>

    <span class="k">def</span> <span class="nf">load_subhalo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat_type</span><span class="p">,</span> <span class="n">Sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">halotools.sim_manager</span> <span class="k">as</span> <span class="nn">htools</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Halo Simulation file </span><span class="si">%s</span><span class="s2"> does not exist &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Halo Simulation file does not exist&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cat_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fofcat&#39;</span><span class="p">,</span> <span class="s1">&#39;halocat&#39;</span><span class="p">,</span> <span class="s1">&#39;orphancat&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Catalogue type </span><span class="si">%s</span><span class="s2"> not recognised &quot;</span> <span class="o">%</span> <span class="n">cat_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> loading ...&#39;</span> <span class="o">%</span> <span class="n">cat_type</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">num_halos</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">]</span>
        <span class="n">num_orphans</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Norphans_Total&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cat_type</span> <span class="o">==</span> <span class="s2">&quot;fofcat&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;Group&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; FoF loading done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

                <span class="n">firstorphan</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupFirstOrphan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;OrphanSubhalo&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">norphans</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNorphans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;OrphanSubhalo&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">htools</span><span class="o">.</span><span class="n">UserSuppliedHaloCatalog</span><span class="p">(</span><span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Redshift&#39;</span><span class="p">],</span> <span class="n">Lbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="c1"># user_supplied_ptclcat = None,</span>
                                                      <span class="n">particle_mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">],</span>
                                                      <span class="n">halo_x</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupCM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">halo_y</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupCM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">],</span>
                                                      <span class="n">halo_z</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupCM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[:,</span> <span class="mi">2</span><span class="p">],</span>
                                                      <span class="n">halo_pos</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                                      <span class="n">halo_vel</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                                      <span class="n">halo_firstsub</span><span class="o">=</span><span class="p">(</span>
                                                          <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupFirstSub&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                                      <span class="n">halo_nsubs</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;GroupNsubs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                                      <span class="n">halo_firstorphan</span><span class="o">=</span><span class="n">firstorphan</span><span class="p">,</span>
                                                      <span class="n">halo_norphans</span><span class="o">=</span><span class="n">norphans</span><span class="p">,</span>
                                                      <span class="n">halo_rvir</span><span class="o">=</span><span class="p">(</span>
                                                          <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;Group_R_Crit200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                                      <span class="n">halo_len</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                      <span class="n">halo_id</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                                                      <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Key Subhalo does not exists in the halo file&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cat_type</span> <span class="o">==</span> <span class="s2">&quot;halocat&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Subhalo&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; Subhalo loading done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

                <span class="n">group_mass</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;Group_M_Crit200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mf">1e10</span>

                <span class="n">mass</span> <span class="o">=</span> <span class="n">group_mass</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloGrNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
                <span class="n">fof_len</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloGrNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
                <span class="n">halo_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_halos</span><span class="p">)</span>
                <span class="n">host_id</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloGrNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">halo_upid</span> <span class="o">=</span> <span class="n">halo_id</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">host_id</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">host_id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">host_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">halo_upid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">halo_upid</span><span class="p">[</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Applying the correction of Springel+ 2008,</span>
        <span class="c1"># Eq 10 of https://arxiv.org/pdf/0809.0898.pdf</span>
        <span class="c1"># Vmax -&gt; Vmax [1 + (epsilon/rmax)^2]^1/2, where epsilon is the softening length</span>

                <span class="n">vmax</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVmax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVmaxRad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">vpeak</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span> <span class="o">/</span>
                                 <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVpeakRad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#        vmax = f[u&#39;Subhalo&#39;][&#39;SubhaloVmax&#39;].value</span>
<span class="c1">#        vpeak = f[u&#39;Subhalo&#39;][&#39;SubhaloVpeak&#39;].value</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloInfallLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">50</span>
                <span class="k">return</span> <span class="n">htools</span><span class="o">.</span><span class="n">UserSuppliedHaloCatalog</span><span class="p">(</span><span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Redshift&#39;</span><span class="p">],</span> <span class="n">Lbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="c1"># user_supplied_ptclcat = None,</span>
                                                      <span class="n">particle_mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">],</span>
                                                      <span class="n">halo_x</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                    <span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">halo_y</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                    <span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">halo_z</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                    <span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">halo_pos</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                    <span class="n">mask</span><span class="p">],</span>
                    <span class="n">halo_vel</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">halo_subnr</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloRankInGr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">halo_vpeak</span><span class="o">=</span><span class="n">vpeak</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">halo_vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">halo_fmass</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">mass</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">halo_mpeak</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloMpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                    <span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span>
                    <span class="n">halo_len</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">halo_mass</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span>
                    <span class="n">halo_minf</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloInfallLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                    <span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span>
                    <span class="n">halo_id</span><span class="o">=</span><span class="n">halo_id</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">halo_upid</span><span class="o">=</span><span class="n">halo_upid</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">halo_mvir</span><span class="o">=</span><span class="n">mass</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">halo_fof</span><span class="o">=</span><span class="n">fof_len</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Key Subhalo does not exists in the halo file&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cat_type</span> <span class="o">==</span> <span class="s2">&quot;orphancat&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;OrphanSubhalo&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; Orphan loading done in </span><span class="si">%5.3g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
                <span class="n">halo_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_orphans</span><span class="p">)</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;Surviving&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloInfallLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span>  <span class="c1"># | (f[u&#39;OrphanSubhalo&#39;][&#39;Surviving&#39;].value == 2)</span>

                <span class="n">vmax</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVmax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span> <span class="o">/</span>
                                 <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVmaxRad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">vpeak</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span> <span class="o">/</span>
                                 <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVpeakRad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#           vmax = f[u&#39;OrphanSubhalo&#39;][&#39;SubhaloVmax&#39;].value</span>
<span class="c1">#           vpeak = f[u&#39;OrphanSubhalo&#39;][&#39;SubhaloVpeak&#39;].value</span>
                <span class="n">halo_mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span>
                <span class="n">halo_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;SubhaloMass&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                                               <span class="p">[</span><span class="s1">&#39;SubhaloLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]))</span><span class="o">**</span><span class="mf">0.44</span>
                <span class="n">halo_mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">norphans</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norphans</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">htools</span><span class="o">.</span><span class="n">UserSuppliedHaloCatalog</span><span class="p">(</span><span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Redshift&#39;</span><span class="p">],</span> <span class="n">Lbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                          <span class="c1"># user_supplied_ptclcat = None,</span>
                                                          <span class="n">particle_mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">],</span>
                                                          <span class="n">halo_x</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                                  <span class="p">[</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                                          <span class="n">halo_y</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                                  <span class="p">[</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">halo_z</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                                  <span class="p">[</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                                          <span class="n">halo_pos</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                                    <span class="p">[</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                                                          <span class="n">halo_vel</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                                    <span class="p">[</span><span class="s1">&#39;SubhaloVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                                                          <span class="n">halo_grnr</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                                     <span class="p">[</span><span class="s1">&#39;SubhaloGrNr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                                                          <span class="n">halo_vpeak</span><span class="o">=</span><span class="n">vpeak</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                                                          <span class="n">halo_len</span><span class="o">=</span><span class="n">halo_len</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                                                          <span class="n">halo_vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                                                          <span class="n">halo_fmass</span><span class="o">=</span><span class="n">halo_mass</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> \
                                                          <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">]</span>
                                                           <span class="p">[</span><span class="s1">&#39;HostHaloMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                                                          <span class="n">halo_mvir</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;HostHaloMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                        <span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span>
                        <span class="n">halo_minf</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloInfallLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                        <span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span>
                        <span class="n">halo_mpeak</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloMpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span>
                        <span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span>
                        <span class="n">halo_mass</span><span class="o">=</span><span class="n">halo_mass</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span>
                        <span class="n">halo_mergtime</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;OrphanSubhalo&#39;</span><span class="p">][</span><span class="s1">&#39;MergerTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span> <span class="n">halo_id</span><span class="o">=</span><span class="n">halo_id</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Key Subhalo does not exists in the halo file&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_m200_from_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m200_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">])</span>
        <span class="n">r200_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">])</span>
        <span class="n">rhoback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="o">**</span><span class="mi">3</span>
        <span class="c1">##</span>
        <span class="n">l200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_volume_bins&#39;</span><span class="p">]</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins_end&#39;</span><span class="p">]</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">cummass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="c1">#sum the center particle of the halo (right? yes)</span>
        <span class="n">overdensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_overdensity</span><span class="p">(</span><span class="mf">1e10</span><span class="o">*</span><span class="n">cummass</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>

        <span class="n">fr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">foverdensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">overdensity</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1">#mask = np.array(r1 &gt; 0)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">haloes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># There must be more than 2 &#39;True&#39;s</span>
        <span class="n">r200_est</span><span class="p">[</span><span class="n">haloes</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">l200</span><span class="p">,</span> <span class="n">foverdensity</span><span class="p">[</span><span class="n">ihalo</span><span class="p">][</span><span class="n">mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]][:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">fr1</span><span class="p">[</span><span class="n">ihalo</span><span class="p">][</span><span class="n">mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="n">haloes</span><span class="p">])</span>
        <span class="n">r200_est</span><span class="p">[</span><span class="n">haloes</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r200_est</span><span class="p">[</span><span class="n">haloes</span><span class="p">])</span>
        <span class="n">m200_est</span><span class="p">[</span><span class="n">haloes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">radius_to_eulerian_mass</span><span class="p">(</span><span class="n">r200_est</span><span class="p">[</span><span class="n">haloes</span><span class="p">],</span> <span class="n">overdensity</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><span class="o">/</span><span class="mf">1e10</span>
        <span class="c1">##</span>
        <span class="k">return</span> <span class="n">m200_est</span><span class="p">,</span><span class="n">r200_est</span>

    <span class="k">def</span> <span class="nf">select_top_subhalos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">):</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>

        <span class="n">new_sim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_sim</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top</span><span class="p">],</span> <span class="p">:],</span>
                              <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top</span><span class="p">],</span> <span class="p">:],</span>
                              <span class="n">arg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">][</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top</span><span class="p">]]}</span>
        <span class="k">return</span> <span class="n">new_sim</span>

    <span class="k">def</span> <span class="nf">select_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">npart</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">new_sim</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_sim</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span>
                              <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">,</span> <span class="p">:]}</span>
        <span class="k">return</span> <span class="n">new_sim</span>

    <span class="k">def</span> <span class="nf">plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span>

        <span class="c1"># self.Cosmology.plots()</span>
        <span class="c1"># pl.show()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s2">&quot;SimPowerSpectrum&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Data&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">],</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;shotnoise&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Shot Noise&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">162.5</span><span class="o">/</span><span class="mf">16.</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
                  <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Shot Noise&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">WaveVector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">WaveVector</span>
                  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">PowerSpectrum</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">WaveVector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">WaveVector</span>
                  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">PowerSpectrum_nonlinear</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NonLinear&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zPower</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zPower</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">zPower</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">],</span> <span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot; (zSpace)&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">WaveVector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">WaveVector</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">Kaiser_boost</span><span class="p">()</span>
                  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">PowerSpectrum</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">3.1416</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="mf">3.1416</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">256</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;shotnoise&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k [{\rm h Mpc^{-1}}]$&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k P(k)$&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">halotools.mock_observables</span> <span class="k">import</span> <span class="n">radial_profile_3d</span>
        <span class="kn">from</span> <span class="nn">halotools.mock_observables</span> <span class="k">import</span> <span class="n">return_xyz_formatted_array</span>
        <span class="kn">from</span> <span class="nn">halotools.mock_observables</span> <span class="k">import</span> <span class="n">hod_from_mock</span>
        <span class="kn">from</span> <span class="nn">halotools.mock_observables</span> <span class="k">import</span> <span class="n">delta_sigma</span>

        <span class="n">host_mask</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="s1">&#39;halo_upid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e12</span><span class="p">)</span> <span class="o">&amp;</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e13</span><span class="p">))</span>
        <span class="n">group_mass_hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="n">host_mask</span><span class="p">]</span>

        <span class="c1">#group_mass_hosts_pos = group_mass_hosts[&#39;halo_pos&#39;]</span>
        <span class="c1">#group_mass_hosts_pos = return_xyz_formatted_array(group_mass_hosts[&#39;halo_x&#39;], group_mass_hosts[&#39;halo_y&#39;], group_mass_hosts[&#39;halo_z&#39;])</span>

        <span class="c1"># low_mass_mask = ((self.halocat[&#39;halo_mpeak&#39;] &gt; 5e11) &amp;</span>
        <span class="c1">#                (self.halocat[&#39;halo_mpeak&#39;] &lt; 6e11))</span>

        <span class="n">rp_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1">#        pos = np.vstack([self.dm[&#39;x&#39;], self.dm[&#39;y&#39;], self.dm[&#39;z&#39;]]).T</span>

        <span class="n">low_mass_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="s1">&#39;halo_upid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">low_mass_halos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="n">low_mass_mask</span><span class="p">]</span>

        <span class="n">rp</span><span class="p">,</span> <span class="n">deltaSigma</span> <span class="o">=</span> <span class="n">delta_sigma</span><span class="p">(</span><span class="n">low_mass_halos</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">ptlc_table</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rp_bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                     <span class="n">num_threads</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>

        <span class="n">low_mass_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="s1">&#39;halo_upid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">low_mass_halos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="n">low_mass_mask</span><span class="p">]</span>
        <span class="c1">#low_mass_halos_pos = return_xyz_formatted_array(low_mass_halos[&#39;halo_x&#39;], low_mass_halos[&#39;halo_y&#39;], low_mass_halos[&#39;halo_z&#39;])</span>
        <span class="n">low_mass_halos_pos</span> <span class="o">=</span> <span class="n">low_mass_halos</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">]</span>

        <span class="n">rp</span><span class="p">,</span> <span class="n">deltaSigmaSat</span> <span class="o">=</span> <span class="n">delta_sigma</span><span class="p">(</span><span class="n">low_mass_halos</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">ptlc_table</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rp_bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                        <span class="n">num_threads</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">deltaSigma</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">deltaSigmaSat</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">rbins_absolute</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">rbins_midpoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">rbins_absolute</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rbins_absolute</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">radial_profile_3d</span><span class="p">(</span><span class="n">group_mass_hosts</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span> <span class="n">low_mass_halos</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">],</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">low_mass_halos</span><span class="p">[</span><span class="s1">&#39;halo_x&#39;</span><span class="p">])),</span> <span class="n">rbins_absolute</span><span class="o">=</span><span class="n">rbins_absolute</span><span class="p">,</span>
                                           <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="o">.</span><span class="n">Lbox</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">shell_volumes</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">rbins_midpoints</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rbins_absolute</span><span class="p">)</span>
        <span class="n">mean_number_density</span> <span class="o">=</span> <span class="p">(</span><span class="n">counts</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_mass_hosts</span><span class="p">)))</span><span class="o">/</span><span class="n">shell_volumes</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rbins_midpoints</span><span class="p">,</span> <span class="n">mean_number_density</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$  $[Mpc]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\langle dN/dV \rangle$  $[M_{\odot}/{\rm Mpc^</span><span class="si">{3}</span><span class="s1">}]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">group_mass_hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="s1">&#39;halo_upid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">haloprop_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">mean_ncen</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">hod_from_mock</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halocat</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">],</span> <span class="n">group_mass_hosts</span><span class="p">[</span><span class="s1">&#39;halo_mvir&#39;</span><span class="p">],</span> <span class="n">haloprop_bins</span><span class="p">)</span>
        <span class="n">mass_midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">mass_midpoint</span><span class="p">,</span> <span class="n">mean_ncen</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<div class="viewcode-block" id="Simulation.store_and_load_statistics"><a class="viewcode-back" href="../../code.html#bacco.Simulation.store_and_load_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">store_and_load_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">bs_method</span><span class="o">=</span><span class="s1">&#39;sampled&#39;</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">force_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">dilution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gadget_pk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">linear_field</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        To load power spectrum, correlation function &amp; bispectrum from file.</span>

<span class="sd">        If the file does not exist or force_recompute is True, these quantities</span>
<span class="sd">        are computed and stored to file, before being returned.</span>

<span class="sd">        If dilution is not None, it must contain the dilution level expressed as</span>
<span class="sd">        the percentage of particles to RETAIN (so, dilution=0.2 will create a</span>
<span class="sd">        catalogue containing the 20% of the original catalogue).</span>

<span class="sd">        TODO: could possibly become part of self.Power</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.npy&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.npy&#39;</span>

        <span class="c1"># ngrid=self.linear_field.shape[0]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">force_recompute</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;found and loaded </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span><span class="p">,</span> <span class="n">compute_crossspectrum_twogrids</span>
            <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">read_gadget_pk</span>

            <span class="k">if</span> <span class="n">gadget_pk</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">DA</span><span class="p">,</span> <span class="n">KA</span><span class="p">,</span> <span class="n">PK</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="n">KB</span><span class="p">,</span> <span class="n">shotFunc</span><span class="p">,</span> <span class="n">countA</span><span class="p">,</span> <span class="n">countB</span> <span class="o">=</span> <span class="n">read_gadget_pk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s2">&quot;/powerspec/powerspec_</span><span class="si">{0:03d}</span><span class="s2">_z.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapnum</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">DA</span><span class="p">,</span> <span class="n">KA</span><span class="p">,</span> <span class="n">PK</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="n">KB</span><span class="p">,</span> <span class="n">shotFunc</span><span class="p">,</span> <span class="n">countA</span><span class="p">,</span> <span class="n">countB</span> <span class="o">=</span> <span class="n">read_gadget_pk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s2">&quot;/powerspec/powerspec_</span><span class="si">{0:03d}</span><span class="s2">_r.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapnum</span><span class="p">))</span>
                <span class="n">stat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="n">KA</span> <span class="p">,</span><span class="s1">&#39;pk&#39;</span><span class="p">:</span><span class="n">PK</span><span class="p">,</span> <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dilution</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">old_npart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_npart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">old_npart</span> <span class="o">*</span> <span class="n">dilution</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;diluting catalogue: from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> particles (</span><span class="si">{}</span><span class="s1">%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_npart</span><span class="p">,</span> <span class="n">new_npart</span><span class="p">,</span> <span class="n">dilution</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span>
                    <span class="n">indexes_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">old_npart</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">new_npart</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">indexes_to_keep</span><span class="p">,:],</span>
                                                          <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                          <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span>
                                                          <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                                          <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">indexes_to_keep</span><span class="p">,:],</span>
                                                          <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">indexes_to_keep</span><span class="p">,:],</span>
                                                          <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                          <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                          <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span>
                                                          <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                                          <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                          <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                          <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span>
                                                          <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                                          <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                          <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                                          <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                          <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                          <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span>
                                                          <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                                          <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clean_dm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;dm&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span>

            <span class="k">if</span> <span class="n">linear_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lin_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                      <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_dict</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lpt_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lpt_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="p">,</span><span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                          <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                          <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lpt_dict</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lpt_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">[</span><span class="n">stat_dict</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;created </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">stat_dict</span></div>

<div class="viewcode-block" id="Simulation.store_and_load_sdm_statistics"><a class="viewcode-back" href="../../code.html#bacco.Simulation.store_and_load_sdm_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">store_and_load_sdm_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">bs_method</span><span class="o">=</span><span class="s1">&#39;sampled&#39;</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                      <span class="n">force_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">gadget_pk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">linear_field</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        To load power spectrum, correlation function &amp; bispectrum from file.</span>

<span class="sd">        If the file does not exist or force_recompute is True, these quantities</span>
<span class="sd">        are computed and stored to file, before being returned.</span>

<span class="sd">        TODO: could possibly become part of self.sdmPower</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.npy&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.npy&#39;</span>

        <span class="c1"># ngrid=self.linear_field.shape[0]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">force_recompute</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;found and loaded </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span><span class="p">,</span> <span class="n">compute_crossspectrum_twogrids</span>
            <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">read_gadget_pk</span>

            <span class="k">if</span> <span class="n">gadget_pk</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">DA</span><span class="p">,</span> <span class="n">KA</span><span class="p">,</span> <span class="n">PK</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="n">KB</span><span class="p">,</span> <span class="n">shotFunc</span><span class="p">,</span> <span class="n">countA</span><span class="p">,</span> <span class="n">countB</span> <span class="o">=</span> <span class="n">read_gadget_pk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s2">&quot;/powerspec/powerspec_</span><span class="si">{0:03d}</span><span class="s2">_z.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapnum</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">DA</span><span class="p">,</span> <span class="n">KA</span><span class="p">,</span> <span class="n">PK</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="n">KB</span><span class="p">,</span> <span class="n">shotFunc</span><span class="p">,</span> <span class="n">countA</span><span class="p">,</span> <span class="n">countB</span> <span class="o">=</span> <span class="n">read_gadget_pk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaseDir</span><span class="o">+</span><span class="s2">&quot;/powerspec/powerspec_</span><span class="si">{0:03d}</span><span class="s2">_r.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapnum</span><span class="p">))</span>
                <span class="n">stat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="n">KA</span> <span class="p">,</span><span class="s1">&#39;pk&#39;</span><span class="p">:</span><span class="n">PK</span><span class="p">,</span> <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span>
                                                      <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                                      <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                      <span class="n">vel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                                      <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">,</span>
                                                      <span class="n">bs_method</span><span class="o">=</span><span class="n">bs_method</span><span class="p">,</span>
                                                      <span class="n">bs_k1</span><span class="o">=</span><span class="n">bs_k1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clean_dm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdm&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm</span>

            <span class="k">if</span> <span class="n">linear_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lin_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                      <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_dict</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lpt_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lpt_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="p">,</span><span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                          <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                          <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lpt_dict</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lpt_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">[</span><span class="n">stat_dict</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;created </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">stat_dict</span></div>

<div class="viewcode-block" id="Simulation.store_and_load_xspectra"><a class="viewcode-back" href="../../code.html#bacco.Simulation.store_and_load_xspectra">[docs]</a>    <span class="k">def</span> <span class="nf">store_and_load_xspectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">bs_method</span><span class="o">=</span><span class="s1">&#39;brute-force&#39;</span><span class="p">,</span> <span class="n">force_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">dilution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lpt_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linear_field</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        To load cross power spectrum from file.</span>

<span class="sd">        If the file does not exist or force_recompute is True, these quantity</span>
<span class="sd">        is computed and stored to file, before being returned.</span>

<span class="sd">        If dilution is not None, it must contain the dilution level expressed as</span>
<span class="sd">        the percentage of particles to RETAIN (so, dilution=0.2 will create a</span>
<span class="sd">        catalogue containing the 20% of the original catalogue).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_crossspectrum</span><span class="p">,</span> <span class="n">compute_crossspectrum_twogrids</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.npy&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.npy&#39;</span>

        <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">force_recompute</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;found and loaded </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dilution</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">old_npart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_npart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">old_npart</span> <span class="o">*</span> <span class="n">dilution</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;diluting catalogue: from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> particles (</span><span class="si">{}</span><span class="s1">%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_npart</span><span class="p">,</span> <span class="n">new_npart</span><span class="p">,</span> <span class="n">dilution</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span>
                <span class="n">indexes_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">old_npart</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">new_npart</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum</span><span class="p">(</span><span class="n">pos1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">indexes_to_keep</span><span class="p">,:],</span>
                                                      <span class="n">grid2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum</span><span class="p">(</span><span class="n">pos1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">indexes_to_keep</span><span class="p">,:],</span>
                                                      <span class="n">vel1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">indexes_to_keep</span><span class="p">,:],</span>
                                                      <span class="n">grid2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span>
                                                      <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum</span><span class="p">(</span><span class="n">pos1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                      <span class="n">grid2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stat_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum</span><span class="p">(</span><span class="n">pos1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                      <span class="n">vel1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                                                      <span class="n">grid2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span>
                                                      <span class="n">zspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">clean_dm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;dm&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span>

            <span class="k">if</span> <span class="n">linear_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lin_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                      <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_dict</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_linear_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lpt_field</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#lpt_dict = compute_crossspectrum_twogrids(self.density_field_from_displacements,</span>
                <span class="n">lpt_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">linear_field</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">ngrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density_field_from_displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span>
                                                      <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lpt_dict</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
                <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lpt_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">[</span><span class="n">stat_dict</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;created </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">stat_dict</span></div>

    <span class="k">def</span> <span class="nf">get_dynamical_friction_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mhost</span><span class="p">,</span> <span class="n">msat</span><span class="p">,</span> <span class="n">rsat</span><span class="p">,</span> <span class="n">infall_snap</span><span class="p">,</span> <span class="n">mergertime_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">):</span>

        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NewtonsConstant&#39;</span><span class="p">]</span>
        <span class="n">rhost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_eulerian_radius</span><span class="p">(</span><span class="n">mhost</span><span class="o">*</span><span class="mf">1e10</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span>
        <span class="n">vhost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">G</span> <span class="o">*</span> <span class="n">mhost</span> <span class="o">/</span> <span class="n">rhost</span><span class="p">);</span>

        <span class="n">coulomb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mhost</span><span class="o">/</span><span class="n">msat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Binney &amp; Tremaine Eq.7.26</span>
        <span class="n">mergertime</span> <span class="o">=</span> <span class="mf">1.17</span><span class="o">*</span><span class="n">mergertime_factor</span> <span class="o">*</span> <span class="n">rsat</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vhost</span><span class="o">/</span> <span class="p">(</span><span class="n">coulomb</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">msat</span><span class="p">)</span>

        <span class="c1">#Conversion to internal units -- check!</span>
        <span class="n">time_since_accretion</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">infall_snap</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">time_to_present</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>

        <span class="n">mergertime</span><span class="p">[(</span><span class="n">msat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">-</span><span class="mf">99999.9</span>
        <span class="n">time_since_accretion</span><span class="p">[</span><span class="n">infall_snap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">mergertime</span><span class="p">,</span> <span class="n">time_since_accretion</span></div>

<span class="k">def</span> <span class="nf">create_snapshot_arr</span><span class="p">(</span><span class="n">BaseDir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">halo_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">total_snapshots</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function which create a file with a list of snapshots numbers and</span>
<span class="sd">    expansion factors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
    <span class="k">if</span> <span class="n">BaseDir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">BaseDir</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">BaseDir</span> <span class="o">=</span> <span class="n">Basedir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">snaplist_filename</span> <span class="o">=</span> <span class="n">BaseDir</span> <span class="o">+</span> <span class="s1">&#39;/snaplist.txt&#39;</span>

    <span class="n">a_arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">snap_arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">string_arr</span> <span class="o">=</span> <span class="n">dm_file</span>
    <span class="k">elif</span> <span class="n">halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">string_arr</span> <span class="o">=</span> <span class="n">halo_file</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">string_arr</span><span class="o">+</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">))):</span>
            <span class="k">return</span> <span class="mi">1</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">string_arr</span><span class="o">+</span><span class="s1">&#39;.0.hdf5&#39;</span><span class="p">))):</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating snapshot array from </span><span class="si">{0}</span><span class="s2"> because: exists=</span><span class="si">{1}</span><span class="s2">, newer=</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string_arr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">string_arr</span><span class="o">+</span><span class="s1">&#39;.0.hdf5&#39;</span><span class="p">))))</span>

    <span class="kn">import</span> <span class="nn">re</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_\d</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">snap</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">total_snapshots</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">{0:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snap</span><span class="p">),</span> <span class="n">string_arr</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ff</span><span class="o">+</span><span class="s1">&#39;.0.hdf5&#39;</span><span class="p">,</span><span class="s1">&#39;/Header/Time&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">a_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ff</span><span class="o">+</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span><span class="s1">&#39;/Header/Time&#39;</span><span class="p">))</span>
            <span class="n">snap_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">snaplist_filename</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">snap_arr</span><span class="p">,</span> <span class="n">a_arr</span><span class="p">]),[</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">read_snapshot_arr</span><span class="p">(</span><span class="n">BaseDir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">halo_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">total_snapshots</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that read and return the list of snapshot numbers and expansion</span>
<span class="sd">    factor of a simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BaseDir</span><span class="o">+</span><span class="s1">&#39;/snaplist.txt&#39;</span><span class="p">):</span>
        <span class="n">create_snapshot_arr</span><span class="p">(</span><span class="n">BaseDir</span><span class="p">,</span> <span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="p">,</span> <span class="n">total_snapshots</span><span class="p">)</span>
    <span class="n">snaps</span><span class="p">,</span> <span class="n">exps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BaseDir</span><span class="p">,</span><span class="s1">&#39;snaplist.txt&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">snaps</span><span class="p">,</span> <span class="n">exps</span>

<span class="k">def</span> <span class="nf">find_two_closest_snaps_to</span><span class="p">(</span><span class="n">snaplist</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">,</span> <span class="n">use_half</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">id1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">expfactor</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">use_half</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">id1</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">snaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span><span class="p">,</span> <span class="n">id1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">id1</span><span class="p">]</span> <span class="o">-</span> <span class="n">expfactor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">id1</span><span class="o">+</span><span class="mi">3</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span> <span class="k">else</span> <span class="p">[</span><span class="n">id1</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">id1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">snaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">id1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">id1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span> <span class="k">else</span> <span class="p">[</span><span class="n">id1</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">id1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">snaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span><span class="p">,</span> <span class="n">id1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">id1</span><span class="p">]</span> <span class="o">-</span> <span class="n">expfactor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">id1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">id1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">id1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">][</span><span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">][</span><span class="n">snaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span> <span class="p">[</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">snaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>

<span class="k">def</span> <span class="nf">find_closest_snaps_to</span><span class="p">(</span><span class="n">snaplist</span><span class="p">,</span> <span class="n">expfactor</span><span class="p">):</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">expfactor</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;snap&#39;</span><span class="p">][</span><span class="n">id1</span><span class="p">]],</span> <span class="p">[</span><span class="n">snaplist</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="n">id1</span><span class="p">]]</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Raul E. Angulo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>