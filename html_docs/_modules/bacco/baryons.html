

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bacco.baryons &mdash; bacco 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> bacco
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bacco</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bacco.baryons</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bacco.baryons</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of the &#39;Baryons&#39; class and helper functions</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Baryons&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">integrate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">special</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">do_profile</span><span class="p">,</span> <span class="n">pk2xi</span><span class="p">,</span> <span class="n">check_lss_precision</span>
<span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_concentration</span>
<span class="kn">from</span> <span class="nn">.simulation</span> <span class="k">import</span> <span class="n">PairedSimulation</span>
<span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>
<span class="kn">from</span> <span class="nn">.import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">count_particles_per_bin</span><span class="p">,</span> <span class="n">measure_averaged_profiles</span><span class="p">,</span> <span class="n">clean_lazy</span>
<span class="kn">from</span> <span class="nn">.halo</span> <span class="k">import</span> <span class="n">rho_nfw</span><span class="p">,</span> <span class="n">rho_trunc_nfw</span><span class="p">,</span> <span class="n">m_nfw</span><span class="p">,</span> <span class="n">compute_rho0_nfw</span><span class="p">,</span> <span class="n">compute_rho0_trunc_nfw</span><span class="p">,</span> <span class="n">Mass_nfw</span><span class="p">,</span> <span class="n">Mass_trunc_nfw</span><span class="p">,</span> <span class="n">virial_mass_converter</span><span class="p">,</span> <span class="n">virial_concentration_converter</span>
<span class="kn">from</span> <span class="nn">memory_profiler</span> <span class="k">import</span> <span class="n">profile</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;bacco.baryons&#39;</span><span class="p">)</span>


<span class="c1"># We now define and implement the cosmology class Baryons</span>
<div class="viewcode-block" id="Baryons"><a class="viewcode-back" href="../../code.html#bacco.Baryons">[docs]</a><span class="k">class</span> <span class="nc">Baryons</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that implements a baryonic correction model to</span>
<span class="sd">    modify the density field of a gravity-only simulation,</span>
<span class="sd">    following Schneider &amp; Teyssier 2016</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Simulation</span><span class="p">,</span> <span class="n">M_c</span><span class="o">=</span><span class="mf">1.2e14</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">M1</span><span class="o">=</span><span class="mf">1.526e11</span><span class="p">,</span> <span class="n">eject_model</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span>
                    <span class="n">use_dm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_sdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">component_subsample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">single_component</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span><span class="s1">&#39;truncated&#39;</span><span class="p">,</span>
                        <span class="n">ParticlesRadius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">bin</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">20.</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">tauv</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">min_halo_mass</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span> <span class="n">max_halo_mass</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">mass_binning</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nthreads</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">halos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logpars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">SMHM_z_evolution</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thermodynamical_props</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;standardAGN&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        This Class displace the particles of a simulation to mimic baryonic effects on the mass field.</span>



<span class="sd">        Simulation: simulation, the Simulation you want to use to compute the baryonic effects</span>
<span class="sd">        M_c: float, characteristic halo mass for the hot-gas suppression (see Mohammed et al 2015 &lt;arXiv1410.6826&gt;)</span>
<span class="sd">        eta: float, scaling factor of the ejected gas radius as a function of the escape radius, i.e. r_ej=eta*r_esc</span>
<span class="sd">        beta: float, slope of the hot-gas suppression toward small halo masses</span>
<span class="sd">        M1: float, parameter that control both the normalization and the slope of the mass fraction of central galaxy/halo</span>
<span class="sd">        eject_model: str, &#39;A&#39; for modeling the ejected radius proportionally to the halo escape radius e.g. ej_rad = eta * ej_esc;</span>
<span class="sd">                          &#39;B&#39; for a more complex and phisical motivated model, obtained integrating the Maxwell-Boltzmann distribution</span>
<span class="sd">        use_dm: bool, whether to apply the baryon corrections to all the Simulation particles or not</span>
<span class="sd">        use_sdm: bool, whether to apply the baryon corrections to the Simulation particles or not</span>
<span class="sd">        component_subsample: bool, whether to assign the particle to a specific component or not</span>
<span class="sd">        single_component: string, considering the effect of just one component (e.g. eject_gas&#39;, &#39;galaxy&#39;, &#39;bound_gas&#39;, &#39;relax_dark_matter&#39;)</span>
<span class="sd">        mode: string,</span>
<span class="sd">            &#39;truncated&#39; (default) to truncate the density profiles performing long-range displacements (e.g. Aric√≤ et al. 2020);</span>
<span class="sd">            &#39;all&#39; to displace all the particles (e.g. Schneider &amp; Teyssier et al. 2016);</span>
<span class="sd">            &#39;fof&#39; to displace only the particles belonging to the fof halo (warning: this is not formally correct!);</span>
<span class="sd">            &#39;outern&#39; to indicate the radius from the halo center in which displace the particles</span>

<span class="sd">        ParticlesRadius: float, maximum radius within you want to displace particles in outern mode (in r_200 units)</span>
<span class="sd">        bin: Tuple, initial and final radii in r_200 units, and number of shells to compute the profiles</span>
<span class="sd">        plot: bool,</span>
<span class="sd">        tauv: double, truncation of NFW profile; tau = tauv*concentration</span>
<span class="sd">        min_halo_mass: float, minimum halo mass to compute the baryon corrections, in unit of 10^10 solar masses</span>
<span class="sd">        max_halo_mass: float, maximum halo mass to compute the baryon corrections, in unit of 10^10 solar masses</span>
<span class="sd">        mass_binning: bool, wheter to apply the corrections binning the halos in mass or not.</span>
<span class="sd">        halos: list of halos ids for computing the baryon corrections. If None, all the halos wil be considered.</span>
<span class="sd">        thermodynamical_props: Bool, wheter to compute thermodynamical properties as Temperature and Pressure or not</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">,</span><span class="s1">&#39;fof&#39;</span><span class="p">,</span><span class="s1">&#39;outern&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode </span><span class="si">{}</span><span class="s2"> not valid!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M_c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1</span>
        <span class="k">if</span> <span class="n">logpars</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">eject_model</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.75</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eject_model</span> <span class="o">=</span> <span class="n">eject_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span> <span class="o">=</span> <span class="n">ParticlesRadius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Delta_200</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_subsample</span> <span class="o">=</span> <span class="n">component_subsample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">=</span> <span class="n">single_component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_dm</span> <span class="o">=</span> <span class="n">use_dm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_sdm</span> <span class="o">=</span> <span class="n">use_sdm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span> <span class="o">=</span> <span class="n">nthreads</span> <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span> <span class="o">=</span>  <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_halo_mass</span> <span class="o">=</span> <span class="n">min_halo_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_halo_mass</span> <span class="o">=</span> <span class="n">max_halo_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SMHM_z_evolution</span> <span class="o">=</span> <span class="n">SMHM_z_evolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tauv</span> <span class="o">=</span> <span class="n">tauv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_sqrt5</span> <span class="o">=</span> <span class="mf">0.4472135954999579</span> <span class="c1">#1/np.sqrt(5.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermodynamical_props</span> <span class="o">=</span> <span class="n">thermodynamical_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="k">if</span> <span class="n">check_lss_precision</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_subsample</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;You cannot estimate properly the contribution of a</span>
<span class="s2">                single component subsampling the components. Choose either</span>
<span class="s2">                component_subsample=True or single_component=True &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># np.random.seed(321)</span>
        <span class="k">if</span> <span class="n">component_subsample</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">,</span> <span class="s1">&#39;eject_gas&#39;</span><span class="p">,</span> <span class="s1">&#39;galaxy&#39;</span><span class="p">,</span> <span class="s1">&#39;bound_gas&#39;</span><span class="p">,</span> <span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">]</span>

        <span class="c1">#-----------------------------------------------------------------------</span>
        <span class="c1"># Definining the number and position of the shells in which we will compute the</span>
        <span class="c1"># the masses of the different components. The density profiles will be computed</span>
        <span class="c1"># in the middle point between two adiacent shells.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nshell</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">bin</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nshell</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">]:</span>
            <span class="c1">#refine the grid nearby the truncation radius to have more accuracy in the long-Range</span>
            <span class="c1">#displacement. Building the grids in order to have the truncation radio in the mass-density profiles</span>
            <span class="c1"># (the profiles are computed in the geometrical center in between the shells )</span>
            <span class="n">refine</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.84</span><span class="p">,</span><span class="mf">1.004</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span><span class="n">refine</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nshell</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">refine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trunc_radii</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ri</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notrunc_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trunc_radii</span><span class="p">)</span>
        <span class="c1">#bin where the profiles will be truncated (if ParticleRadius= 1, bin where there is r_200)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notrunc_radii</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gravity_only_sim</span> <span class="o">=</span> <span class="n">Simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Simulation</span><span class="p">)</span>
        <span class="n">cleanattr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Power&#39;</span><span class="p">,</span> <span class="s1">&#39;sdmPower&#39;</span><span class="p">,</span> <span class="s1">&#39;Correl&#39;</span><span class="p">,</span> <span class="s1">&#39;sdmCorrel&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">cleanattr</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">compute_baryon_corrections</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">halos</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_baryon_simulation</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">halos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mass_binning</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_baryon_simulation</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">approximate_baryon_simulation</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;ScaledSimulation&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ssim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">ssim</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ssim</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;PairedSimulation&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">psim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ssim</span><span class="o">.</span><span class="n">sim</span><span class="p">):</span>
                        <span class="n">compute_baryon_corrections</span><span class="p">(</span><span class="n">psim</span><span class="p">,</span> <span class="n">halos</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">compute_baryon_corrections</span><span class="p">(</span><span class="n">ssim</span><span class="p">,</span> <span class="n">halos</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">ssim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;PairedSimulation&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">psim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sim</span><span class="p">):</span>
                <span class="n">compute_baryon_corrections</span><span class="p">(</span><span class="n">psim</span><span class="p">,</span> <span class="n">halos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">compute_baryon_corrections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="p">,</span> <span class="n">halos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="p">)</span>
            <span class="n">tim</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;minutes&#39;</span><span class="p">)</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="s1">&#39;Gigabytes&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e9</span> <span class="k">else</span> <span class="p">((</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">begin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="s1">&#39;Megabytes&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time to create the Baryon Simulation: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory used to create the Baryon Simulation: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mem</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;***-----------------------------------------***</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;- </span><span class="si">{}</span><span class="s1"> Cosmology: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;   Model:</span><span class="si">{}</span><span class="s1">, Omega_cdm=</span><span class="si">{}</span><span class="s1">, Omega_b=</span><span class="si">{}</span><span class="s1">, Omega_de=</span><span class="si">{}</span><span class="s1">, </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;   Hubble=</span><span class="si">{}</span><span class="s1">, A_s=</span><span class="si">{}</span><span class="s1">, Sigma_8=</span><span class="si">{}</span><span class="s1">, ns=</span><span class="si">{}</span><span class="s1">, neutrino_mass=</span><span class="si">{}</span><span class="s1">, </span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">+</span>
                  <span class="s1">&#39;   Omega_r=</span><span class="si">{}</span><span class="s1">, Omega_k=</span><span class="si">{}</span><span class="s1"> tau=</span><span class="si">{}</span><span class="s1">, w0=</span><span class="si">{}</span><span class="s1">, wa=</span><span class="si">{}</span><span class="s1">=,  ExpFactor:</span><span class="si">{}</span><span class="s1">. </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;- </span><span class="si">{}</span><span class="s1"> Baryons:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;   Model:</span><span class="si">{}</span><span class="s1">, M_c=</span><span class="si">{}</span><span class="s1">, eta=</span><span class="si">{}</span><span class="s1">, beta=</span><span class="si">{}</span><span class="s1">, M1=</span><span class="si">{}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;- Simulation:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;   BaseDir:</span><span class="si">{}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span>
                  <span class="s1">&#39;   Nparticles=</span><span class="si">{}</span><span class="s1">, BoxSize=</span><span class="si">{}</span><span class="s1">, sDM=</span><span class="si">{}</span><span class="s1">. </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">***-----------------------------------------***&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">de_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_rad&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_k&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M_c&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">BaseDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sdm</span> <span class="p">))</span>
        <span class="k">return</span> <span class="n">descr</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span>

    <span class="k">def</span> <span class="nf">_set_sdm_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An internal function to deal with dm/sdm particles quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dilution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_dilution_factor&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OG_pmass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ParticleMass&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dilution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NpartTotal&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dilution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdm_halo_mask</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_halo_mask</span>

    <span class="k">def</span> <span class="nf">_setup_baryon_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">halos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An internal function to initialise the baryonic simulation.</span>

<span class="sd">        simulation: simulation, the gravity only simulation to be initialise.</span>
<span class="sd">        halos: array of floats, the halos ids where you want to compute the baryonic corrections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span> <span class="o">=</span> <span class="n">simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">Cosmology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMHM_relation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">halos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">halos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_matter_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sdm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdm_halo_mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])</span> <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dm_halo_mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])</span> <span class="p">]</span>

        <span class="k">for</span> <span class="n">_use_sdm</span><span class="p">,</span> <span class="n">apply</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">use_dm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sdm</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">apply</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">=</span> <span class="n">_use_sdm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_sdm_pars</span><span class="p">()</span>
            <span class="n">N_dm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction_dark_matter</span><span class="p">)</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dark_matter&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">N_dm</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;gas&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="o">-</span><span class="n">N_dm</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
            <span class="n">particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">sdm</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="k">else</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">dm</span>
            <span class="n">particles</span><span class="p">[</span><span class="s1">&#39;pmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OG_pmass</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">)</span>
            <span class="n">particles</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;|S32&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermodynamical_props</span><span class="p">:</span>
                <span class="n">particles</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">)</span>
                <span class="n">particles</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">)</span>


<div class="viewcode-block" id="Baryons.create_baryon_simulation"><a class="viewcode-back" href="../../code.html#bacco.Baryons.create_baryon_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">create_baryon_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function which compute and apply the displacement of particles in a simulation,</span>
<span class="sd">        on halo-by-halo basis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">halos</span><span class="p">:</span>
            <span class="n">M_200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>   <span class="c1"># Msun/h /1e10</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">M_200</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_halo_mass</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">M_200</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_halo_mass</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_conc&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">M_200</span> <span class="o">*=</span> <span class="mf">1e10</span>
            <span class="k">if</span> <span class="n">conc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span> <span class="c1">#do not count the halos for which the concentration could not be computed.</span>

            <span class="n">r_200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>

            <span class="c1">#radial_bins in fof are in unit or r_200, density in unit of 10^10 Msun/Mpc^3 h^2:</span>
            <span class="n">radial_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">r_200</span>
            <span class="n">r_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_rs&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">log_rho_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_logrho0&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="mf">1e6</span>
                <span class="n">log_rho_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">compute_rho0_nfw</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">M_200</span><span class="p">,</span><span class="n">r_s</span><span class="p">))</span>
                <span class="n">M_halo</span> <span class="o">=</span> <span class="n">M_200</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauv</span><span class="o">*</span><span class="n">conc</span>
                <span class="n">M_halo</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mass_trunc_nfw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span>
                                            <span class="n">tau</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

            <span class="n">rshell</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_200</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">rshell</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rshell</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>

            <span class="c1">#let&#39;s compute the theoretical profiles and displacements</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
            <span class="n">profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_profiles</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">return_only_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mass_profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">M_200</span> <span class="o">&gt;=</span> <span class="mf">6e13</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">M_200</span> <span class="o">&lt;=</span> <span class="mf">2e14</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span><span class="p">,(</span><span class="n">mass_profiles</span><span class="p">[</span><span class="s1">&#39;galaxy&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation</span><span class="p">]</span><span class="o">+</span><span class="n">mass_profiles</span><span class="p">[</span><span class="s1">&#39;eject_gas&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation</span><span class="p">]</span><span class="o">+</span><span class="n">mass_profiles</span><span class="p">[</span><span class="s1">&#39;bound_gas&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation</span><span class="p">])</span><span class="o">/</span><span class="n">M_200</span><span class="p">)</span>

            <span class="n">displacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">mass_profiles</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_displacement</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">mass_profiles</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">displacement</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Baryons corrections computed for Halo &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ihalo</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> -------   BCM   --------- </span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span></div>

<div class="viewcode-block" id="Baryons.approximate_baryon_simulation"><a class="viewcode-back" href="../../code.html#bacco.Baryons.approximate_baryon_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">approximate_baryon_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function which compute and apply the displacement of particles in a simulation,</span>
<span class="sd">        binning the halos by mass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mlow</span><span class="p">,</span> <span class="n">mhigh</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">halos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span> <span class="o">&gt;</span> <span class="n">mlow</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span> <span class="o">&lt;=</span> <span class="n">mhigh</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">halos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">M_200</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlow</span> <span class="o">+</span> <span class="n">mhigh</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
            <span class="c1"># r_200 = np.mean(self.Simulation.fof[&#39;halo_r200c&#39;][halos])</span>
            <span class="n">r_200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">mass_to_eulerian_radius</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
            <span class="n">conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_concentration</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
            <span class="n">r_s</span> <span class="o">=</span> <span class="n">r_200</span><span class="o">/</span><span class="n">conc</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="mf">1e6</span>
                <span class="n">log_rho_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">compute_rho0_nfw</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">M_200</span><span class="p">,</span><span class="n">r_s</span><span class="p">))</span>
                <span class="n">M_halo</span> <span class="o">=</span> <span class="n">M_200</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauv</span><span class="o">*</span><span class="n">conc</span>
                <span class="n">log_rho_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">compute_rho0_trunc_nfw</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">M_200</span><span class="p">,</span><span class="n">r_s</span><span class="p">,</span><span class="n">tau</span><span class="p">))</span>
                <span class="n">M_halo</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mass_trunc_nfw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span>
                                            <span class="n">tau</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

            <span class="n">rshell</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_200</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">rshell</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rshell</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>

            <span class="c1">#let&#39;s compute the theoretical profiles and displacements</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
            <span class="n">profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_profiles</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">return_only_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mass_profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">M_200</span> <span class="o">&gt;=</span> <span class="mf">6e13</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">M_200</span> <span class="o">&lt;=</span> <span class="mf">2e14</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span><span class="p">,(</span><span class="n">mass_profiles</span><span class="p">[</span><span class="s1">&#39;galaxy&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation</span><span class="p">]</span><span class="o">+</span><span class="n">mass_profiles</span><span class="p">[</span><span class="s1">&#39;eject_gas&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation</span><span class="p">]</span><span class="o">+</span><span class="n">mass_profiles</span><span class="p">[</span><span class="s1">&#39;bound_gas&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation</span><span class="p">])</span><span class="o">/</span><span class="n">M_200</span><span class="p">)</span>
            <span class="n">displacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">mass_profiles</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="n">halos</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_displacement</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">mass_profiles</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">displacement</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Baryons corrections computed for Halo &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ihalo</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_fraction_200</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> -------   BCM   --------- </span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span></div>


    <span class="k">def</span> <span class="nf">_apply_displacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">mass_profiles</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">displacement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function that apply a given displacement to the particles of a given halo.</span>

<span class="sd">        ihalo: int, id of the halo.</span>
<span class="sd">        rshell: float array, shells where the mass profiles have been computed</span>
<span class="sd">        mass_profiles: dict, dictionary containing the component mass_profiles computed with :meth:`Baryons.compute_profiles`</span>
<span class="sd">        displacement: float array, displacement computed with :meth:`Baryons.displacement`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_use_sdm</span><span class="p">,</span> <span class="n">apply</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">use_dm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sdm</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">apply</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">=</span> <span class="n">_use_sdm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_sdm_pars</span><span class="p">()</span>
            <span class="c1">#now we read the particles and displace them</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;fof&#39;</span><span class="p">:</span> <span class="n">len_halo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">len_halo</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">displ_field</span><span class="p">,</span> <span class="n">spline</span> <span class="o">=</span> <span class="n">interpol</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">displacement</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displace_halo_centers</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">spline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">displ_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">displacement</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">]:</span>
                    <span class="n">displ_field</span> <span class="p">[</span><span class="n">rr</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span><span class="o">*</span><span class="n">r_200</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">rr_prime</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">+</span> <span class="n">displ_field</span>

            <span class="n">displ_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="n">displ_pos</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">],(</span><span class="n">rr_prime</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="n">rr</span><span class="p">[</span><span class="n">mask</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">put_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">displ_pos</span><span class="p">)</span>

            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">component_subsample</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Baryons corrections computed for Halo </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ihalo</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">particles_per_bin</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">count_particles_per_bin</span><span class="p">(</span><span class="n">rel_pos</span><span class="o">=</span><span class="n">displ_pos</span><span class="p">,</span>
                    <span class="n">shells</span><span class="o">=</span><span class="n">rshell</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span>

            <span class="n">rshell_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># if self.component_subsample == True, we have to select randomly in each radial bin</span>
            <span class="c1"># the particles according to their mass profiles</span>
            <span class="n">fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">frac</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
            <span class="n">differential_mass_profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_mass_profiles</span><span class="p">(</span><span class="n">mass_profiles</span><span class="p">)</span>
            <span class="n">diff_mass_profiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">differential_mass_profiles</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">])</span>
            <span class="c1">#now we compute f_cb, the bin mass fraction over the total mass of each component</span>
            <span class="n">f_cb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">differential_mass_profiles</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">M_halo</span><span class="o">*</span><span class="n">frac</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">])</span>
            <span class="c1"># Nsel is the number of particle per radial bin per component. It is weighted by</span>
            <span class="c1"># f_cb, the mass fraction of the component with respect to the total mass of the component itself.</span>
            <span class="n">Nsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">f_cb</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>

            <span class="c1">#############</span>
            <span class="n">Nsel</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">Nsel</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">,</span> <span class="n">Nsel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Nsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">Nsel</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1">#compute the particles not selected per each bin</span>
            <span class="n">sumNsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Nsel</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#number of particle selected per radial bin</span>
            <span class="n">nns</span><span class="o">=</span> <span class="n">counts</span> <span class="o">-</span> <span class="n">sumNsel</span>  <span class="c1">#number of partcles not selected per bin</span>

            <span class="c1">#redistribute the particles in bins for component different from 0</span>
            <span class="n">not_zero</span> <span class="o">=</span> <span class="n">Nsel</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">comp_per_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">not_zero</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># number of components per radial bin</span>
            <span class="n">pcts</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">nns</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">comp_per_bin</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">add_particles</span> <span class="o">=</span> <span class="n">not_zero</span><span class="o">*</span><span class="n">pcts</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="c1">#particles to be added per bin to preserve the halo particles number</span>
            <span class="c1">#check the conservation of particles</span>
            <span class="n">pcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">add_particles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">sumNsel</span>
            <span class="n">dif</span> <span class="o">=</span> <span class="n">counts</span><span class="o">-</span><span class="n">pcs</span>
            <span class="n">add_particles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">dif</span>

            <span class="n">PartSel</span> <span class="o">=</span> <span class="n">Nsel</span> <span class="o">+</span> <span class="n">add_particles</span> <span class="c1">#particles selected per bin per component</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">PartSel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>        <span class="c1">#check for negative corrections</span>
                <span class="n">negative</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">while</span> <span class="n">negative</span><span class="p">:</span>
                    <span class="n">neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PartSel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">PartSel</span><span class="p">[</span><span class="n">neg</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">PartSel</span><span class="p">[</span><span class="n">neg</span><span class="p">]</span>
                    <span class="n">dif</span> <span class="o">=</span> <span class="n">counts</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PartSel</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">PartSel</span><span class="p">[</span><span class="o">-</span><span class="n">c</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">dif</span>
                    <span class="n">c</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">PartSel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">negative</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">####</span>
            <span class="n">mass_frac</span> <span class="o">=</span> <span class="n">diff_mass_profiles</span><span class="o">/</span><span class="n">differential_mass_profiles</span><span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span>
            <span class="n">ParticleMassBin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OG_pmass</span> <span class="o">*</span> <span class="n">counts</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">/</span><span class="n">PartSel</span><span class="o">*</span><span class="n">mass_frac</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ParticleMassBin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">ParticleMassBin</span><span class="p">))</span>
            <span class="n">ParticleMassBin</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="c1">#ParticleMassBin = diff_mass_profiles/PartSel</span>
            <span class="n">particle_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">len_halo</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;|S32&#39;</span><span class="p">)</span>
            <span class="n">particle_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">len_halo</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rshell_0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">type_per_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">PartSel</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">k</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
                <span class="n">mass_per_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">PartSel</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">[</span><span class="n">ParticleMassBin</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
                <span class="n">particle_type</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">type_per_bin</span>
                <span class="n">particle_mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">mass_per_bin</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">put_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particle_type</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;|S32&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span><span class="s1">&#39;pmass&#39;</span><span class="p">,</span> <span class="n">particle_mass</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermodynamical_props</span><span class="p">:</span>
                <span class="n">T_r</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">P_r</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>
                <span class="n">particle_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">len_halo</span><span class="p">)</span>
                <span class="n">particle_press</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">len_halo</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rshell_0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">T_per_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">PartSel</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">[</span><span class="n">kk</span><span class="o">*</span><span class="n">T_r</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">kk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="p">)])</span>
                    <span class="n">P_per_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">PartSel</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">[</span><span class="n">kk</span><span class="o">*</span><span class="n">P_r</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">kk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="p">)])</span>
                    <span class="n">particle_temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">T_per_bin</span>
                    <span class="n">particle_press</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">P_per_bin</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="n">particle_temp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="n">particle_press</span><span class="p">)</span>


<span class="c1">#   ============================</span>
<span class="c1">#   Define lazy attribute</span>
<span class="c1">#   ============================</span>
<div class="viewcode-block" id="Baryons.Power"><a class="viewcode-back" href="../../code.html#bacco.Baryons.Power">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that returns the mass power spectrum on the baryon simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FitPower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FitPower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">Power</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">Power</span></div>

<div class="viewcode-block" id="Baryons.sdmPower"><a class="viewcode-back" href="../../code.html#bacco.Baryons.sdmPower">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that returns the mass power spectrum on the baryon simulation, using</span>
<span class="sd">        a subsampled catalogue of particles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sdmPower</span><span class="p">[</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FitPower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sdmPower</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sdmPower</span><span class="p">[</span><span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FitPower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sdmPower</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sdmPower</span></div>

<div class="viewcode-block" id="Baryons.ComponentsPower"><a class="viewcode-back" href="../../code.html#bacco.Baryons.ComponentsPower">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">ComponentsPower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that returns a dictionary with power spectrum of the different components</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;ComponentsPower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing  P(k)&quot;</span><span class="p">)</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fields</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="n">pk</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>  \
             <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pk</span></div>

<div class="viewcode-block" id="Baryons.Correl"><a class="viewcode-back" href="../../code.html#bacco.Baryons.Correl">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Correl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that returns the mass correlation function on the baryon simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Correl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">Correl</span></div>

<div class="viewcode-block" id="Baryons.sdmCorrel"><a class="viewcode-back" href="../../code.html#bacco.Baryons.sdmCorrel">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">sdmCorrel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that returns the mass correlation function on the baryon simulation, using</span>
<span class="sd">        a subsampled catalogue of particles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;sdmCorrel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">sdmCorrel</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">ComponentsCorrel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;ComponentsCorrel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_twopointcorr</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute correlation function&quot;</span><span class="p">)</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
        <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.20</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="mi">33</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fields</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="n">corr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_twopointcorr</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
             <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fourier&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corr</span>

<div class="viewcode-block" id="Baryons.Mfof_200"><a class="viewcode-back" href="../../code.html#bacco.Baryons.Mfof_200">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Mfof_200</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the Mass of the particles belonging to the FOF halos inside r200</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Mfof_200&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">r200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">]</span>
        <span class="n">mfof200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r200</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ihalo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">halos</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">check_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span><span class="o">-</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">positions</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">inside200</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;=</span> <span class="n">r200</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]</span>
            <span class="n">mfof200</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inside200</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">OG_pmass</span>
        <span class="k">return</span> <span class="n">mfof200</span></div>

<div class="viewcode-block" id="Baryons.Fields"><a class="viewcode-back" href="../../code.html#bacco.Baryons.Fields">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">Fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return a dictionary with the positions and the masses of the different components</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">positions</span><span class="p">,</span> <span class="n">masses</span> <span class="o">=</span> <span class="p">{},{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;Fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitBackground</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;gas&#39;</span><span class="p">,</span><span class="s1">&#39;dark_matter&#39;</span><span class="p">,</span><span class="s1">&#39;background&#39;</span><span class="p">]:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span>
            <span class="n">positions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">masses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">[</span><span class="s1">&#39;pmass&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">masses</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">particles_not_in_halos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;particles_not_in_halos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">nfiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">nh</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_offsets&#39;</span><span class="p">]</span>
            <span class="n">len_halo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_len&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos_in_file&#39;</span><span class="p">]):</span>
                <span class="n">nh</span> <span class="o">+=</span> <span class="n">ii</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nfiles</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">i0</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">nh</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i0</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">nh</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">i1</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span> <span class="o">-</span> <span class="n">len_halo</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#use_dm == True</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;sdm_pos&#39;</span><span class="p">]</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">particles_around_halos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;particles_around_halos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;making a partition of all the particles outside the halos...&quot;</span><span class="p">)</span>
            <span class="n">beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">halos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])</span>
        <span class="n">halos_centers</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">halos</span><span class="p">]</span>

        <span class="n">psh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">check_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">background_particles</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                                                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ihalo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">halos</span><span class="p">)</span> <span class="p">])</span>

        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">background_particles</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">halos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ihalo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">halos</span><span class="p">):</span>
            <span class="n">dist_from_halo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psh</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">distances</span><span class="o">&gt;</span><span class="n">dist_from_halo</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">distances</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_from_halo</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">=</span> <span class="n">psh</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>
            <span class="n">halos</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">=</span> <span class="n">ihalo</span>

        <span class="n">around_halo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">around_halo</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particles</span>
        <span class="n">around_halo</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distances</span>
        <span class="n">around_halo</span><span class="p">[</span><span class="s1">&#39;halos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">halos</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Time to make the partition:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">beg</span><span class="p">,</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">around_halo</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">SMHM_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;SMHM_relation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">M1_0</span> <span class="o">=</span>      <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]</span>  <span class="c1"># Charactheristic halo mass Msolar/h</span>
        <span class="n">epsilon_0</span> <span class="o">=</span> <span class="mf">0.023</span>      <span class="c1"># Characteristic stellar mass to halo mass ratio</span>
        <span class="n">alpha_0</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">1.779</span>        <span class="c1"># Faint-end slope of SMHM relation</span>
        <span class="n">gamma_0</span> <span class="o">=</span>  <span class="mf">0.547</span>        <span class="c1">#Index of subpower law at massive end of SMHM relation</span>
        <span class="n">delta_0</span> <span class="o">=</span>  <span class="mf">4.394</span>        <span class="c1">#Strength of subpower law at massive end of SMHM relation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMHM_z_evolution</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMHM_z_evolution</span> <span class="k">else</span> <span class="mf">1.</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">a</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#Exponential cutoff of evolution of M ‚àó (M h ) with scale factor</span>

            <span class="n">M1_a</span>      <span class="o">=</span> <span class="o">-</span><span class="mf">1.793</span><span class="p">;</span>  <span class="n">M1_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.251</span>
            <span class="n">alpha_a</span>   <span class="o">=</span> <span class="mf">0.731</span><span class="p">;</span>
            <span class="n">gamma_a</span>   <span class="o">=</span> <span class="mf">1.319</span><span class="p">;</span>   <span class="n">gamma_z</span>   <span class="o">=</span> <span class="mf">0.279</span>
            <span class="n">delta_a</span>   <span class="o">=</span> <span class="mf">2.608</span><span class="p">;</span>   <span class="n">delta_z</span>   <span class="o">=</span> <span class="o">-</span><span class="mf">0.043</span>
            <span class="n">epsilon_a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.006</span><span class="p">;</span>  <span class="n">epsilon_a2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.119</span> <span class="p">;</span> <span class="n">epsilon_z</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="n">M1</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M1_0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">M1_a</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">M1_z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">epsilon_0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">epsilon_a</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">epsilon_z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span><span class="o">+</span><span class="n">epsilon_a2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha_a</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">nu</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">delta_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta_a</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">delta_z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gamma_a</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gamma_z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1_0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon_0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baryon_sim</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">FitPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="c1">#Function that returns the fitted function for</span>
        <span class="c1">#the ratio of the baryon corrected over the initial power spectrum</span>
        <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1">#correction for the Future</span>
        <span class="n">C</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">C</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#todo find the correction for negative z</span>

        <span class="n">z_c</span> <span class="o">=</span> <span class="mf">2.3</span> <span class="c1">#critical redshift</span>
        <span class="n">k_s</span> <span class="o">=</span> <span class="mi">55</span> <span class="c1">#h/Mpc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M_c&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1e12</span><span class="p">:</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="mf">0.105</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M_c&#39;</span><span class="p">])</span> <span class="o">-</span><span class="mf">1.27</span> <span class="o">+</span> <span class="n">C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">B0</span><span class="o">=</span><span class="mi">0</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">B0</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="n">z_c</span><span class="p">)</span><span class="o">**</span><span class="mf">2.5</span> <span class="p">)</span>    <span class="c1">#total suppression</span>
        <span class="n">k_g</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">B</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span><span class="o">**-</span><span class="mf">1.6</span> <span class="c1">#h/Mpc</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">B</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="n">k_g</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">B</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="n">k_s</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#stellar component</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">S</span>

        <span class="k">return</span> <span class="n">F</span>

<span class="c1">#   ============================</span>
<span class="c1">#   Density profiles</span>
<span class="c1">#   ============================</span>
    <span class="k">def</span> <span class="nf">_y_hot_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">concentration</span> <span class="o">=</span> <span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span> <span class="p">)</span><span class="o">**</span><span class="n">gamma_eff</span><span class="p">(</span><span class="n">concentration</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_y_bound_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">y1</span><span class="p">):</span>
        <span class="c1"># Computing the density profile of the bound gas.</span>
        <span class="c1"># In the halo outskirts it is assumed collisionless</span>
        <span class="c1"># i.e. following the nfw profile</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">concentration</span> <span class="o">=</span> <span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">inner</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_sqrt5</span> <span class="o">*</span> <span class="n">r_200</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_sqrt5</span> <span class="o">*</span> <span class="n">r_200</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">inner</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_hot_gas</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">inner</span><span class="p">],</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="n">outer</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_nfw</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">outer</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y1</span><span class="p">))</span>
            <span class="n">y</span><span class="p">[</span><span class="n">r</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span><span class="o">*</span><span class="n">r_200</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="n">outer</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_trunc_nfw</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">outer</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y1</span><span class="p">),</span> <span class="n">tau</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">r_eject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="n">r_esc</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Delta_200</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_200</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span>  <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">r_ej</span> <span class="o">=</span> <span class="n">eta</span><span class="o">*</span><span class="n">r_esc</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span>  <span class="s1">&#39;B&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>       \
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> \
                        <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_matter_ratio</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction_eject_gas</span><span class="p">(</span><span class="n">M_halo</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">out</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">eta</span><span class="o">*</span><span class="n">r_esc</span>
            <span class="n">minx</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">broyden1</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
            <span class="n">r_ej</span> <span class="o">=</span> <span class="n">r_esc</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">minx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;model for the ejected radius not valid&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_ej</span>

    <span class="k">def</span> <span class="nf">_y_eject_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">r_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">r_ej</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_eject</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">eject_model</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">M_halo</span><span class="o">/</span><span class="p">(</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r_ej</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span> <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">r_ej</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_y_galaxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">):</span>
        <span class="n">R_h</span> <span class="o">=</span> <span class="mf">0.015</span><span class="o">*</span><span class="n">r_200</span>  <span class="c1"># based on observations by Kravtsov et al. 2013</span>
        <span class="k">return</span> <span class="n">M_halo</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_h</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">R_h</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rho_trunc_nfw_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="n">rho_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_rho_0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">rho_nfw</span> <span class="o">=</span> <span class="n">rho_0</span> <span class="o">/</span> <span class="p">(</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">tau</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">]:</span>
            <span class="n">rho_nfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rho_nfw</span><span class="p">)</span>
            <span class="n">rho_nfw</span><span class="p">[</span><span class="n">r</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span><span class="o">*</span><span class="n">r_200</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">rho_nfw</span>

    <span class="k">def</span> <span class="nf">rho_bound_gas_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_bound_gas</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;bound_gas&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">rho_eject_gas_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span>  <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_eject_gas</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span>  <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">*</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;eject_gas&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rho_galaxy_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_galaxy</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">*</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;galaxy&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rho_relax_dark_matter_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">M_rdm</span><span class="p">):</span>
        <span class="n">dM_rdm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">M_rdm</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dM_rdm</span>
        <span class="k">return</span> <span class="n">y</span>

<div class="viewcode-block" id="Baryons.minimise_rho_r"><a class="viewcode-back" href="../../code.html#bacco.Baryons.minimise_rho_r">[docs]</a>    <span class="k">def</span> <span class="nf">minimise_rho_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">rhob200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">rho_og_r200</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function wich find a rho&#39; and r&#39; such that a nfw profile + costant is normalised</span>
<span class="sd">        at r200</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">find_root</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">r200</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">fdm</span><span class="p">,</span> <span class="n">rhog200</span><span class="p">,</span> <span class="n">rhobg200</span><span class="p">,</span> <span class="n">M200</span><span class="p">):</span>
            <span class="n">rsplusrp</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">rp</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">rhog200</span><span class="o">-</span><span class="n">rhobg200</span><span class="p">)</span><span class="o">*</span><span class="n">rp</span><span class="o">*</span><span class="n">rsplusrp</span><span class="o">*</span><span class="n">rsplusrp</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="o">/</span><span class="n">rs</span><span class="p">)</span><span class="o">-</span><span class="n">rp</span><span class="o">/</span><span class="n">rsplusrp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rhog200</span><span class="o">-</span><span class="n">rhobg200</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">r200</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="n">rp</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">M200</span><span class="o">*</span><span class="n">fdm</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">r1</span><span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">newton</span><span class="p">(</span><span class="n">find_root</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">r_s</span><span class="p">,</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">],</span><span class="n">rho_og_r200</span><span class="p">,</span><span class="n">rhob200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">),</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">rho1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_og_r200</span><span class="o">-</span><span class="n">rhob200</span><span class="p">)</span><span class="o">/</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">r1</span><span class="o">/</span><span class="n">r_s</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">r1</span><span class="o">/</span><span class="n">r_s</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">r1</span><span class="p">,</span> <span class="n">rho1</span></div>

<div class="viewcode-block" id="Baryons.rho_nfw_plus_constant"><a class="viewcode-back" href="../../code.html#bacco.Baryons.rho_nfw_plus_constant">[docs]</a>    <span class="k">def</span> <span class="nf">rho_nfw_plus_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">M_200</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A NFW profile + constant, used to make sure that the density is continous in</span>
<span class="sd">        the truncation mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rhob200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_bound_gas_r</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">rho_og_r200</span> <span class="o">=</span> <span class="n">rho_nfw</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">)</span>
        <span class="n">r1</span><span class="p">,</span> <span class="n">rho1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimise_rho_r</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">rhob200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">rho_og_r200</span><span class="p">)</span>

        <span class="n">rho_dmo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">r1</span>
        <span class="n">rho_dmo</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_nfw</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rho1</span><span class="p">))</span><span class="o">*</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span>
        <span class="n">rho_dmo</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_og_r200</span><span class="o">-</span><span class="n">rhob200</span>
        <span class="n">rho_dmo</span><span class="p">[</span><span class="n">r</span><span class="o">&gt;</span><span class="n">r_200</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">return</span> <span class="n">rho_dmo</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">rho_background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;rho_background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mf">0.</span>
        <span class="n">expfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span>
        <span class="n">rhobg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">omega_matter_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">rhocrit_z</span><span class="p">(</span><span class="n">expfactor</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;outern&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">TotM_halo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">])</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">rhobg</span> <span class="o">-=</span> <span class="n">TotM_halo</span><span class="o">/</span><span class="n">volume</span>
        <span class="k">return</span> <span class="n">rhobg</span>

    <span class="k">def</span> <span class="nf">rho_background_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_background</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rho_only_gravity_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="n">rho_nfw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_trunc_nfw_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho_nfw</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_background_r</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rho_only_baryon_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">):</span>
        <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_bound_gas</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">)</span>
        <span class="n">rho_bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_bound_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">rho_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_galaxy_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">rho_eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_eject_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho_bg</span><span class="o">+</span><span class="n">rho_cg</span><span class="o">+</span><span class="n">rho_eg</span>

    <span class="k">def</span> <span class="nf">rho_baryon_correction_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">):</span>
        <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_bound_gas</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">)</span>
        <span class="n">rho_bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_bound_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">rho_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_galaxy_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">rho_eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_eject_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">rho_rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_relax_dark_matter_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">M_rdm</span><span class="p">)</span>
        <span class="n">rho_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_background_r</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho_bg</span><span class="o">+</span><span class="n">rho_cg</span><span class="o">+</span><span class="n">rho_eg</span><span class="o">+</span><span class="n">rho_rm</span><span class="o">+</span><span class="n">rho_bk</span>

<span class="c1">#   ============================</span>
<span class="c1">#   Mass profiles</span>
<span class="c1">#   ============================</span>

    <span class="k">def</span> <span class="nf">mass_nfw_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Mass_nfw</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">notrunc_radii</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)</span>
            <span class="n">mass_nfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trunc_radii</span><span class="p">]))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mass_nfw</span> <span class="o">=</span> <span class="n">Mass_trunc_nfw</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mass_nfw</span>

    <span class="k">def</span> <span class="nf">mass_bound_gas_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span><span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
            <span class="n">integr</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">mass_bound_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">notrunc_radii</span><span class="p">],</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">integr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">integr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trunc_radii</span><span class="p">]))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># integral = self.integrate_density_profile(np.atleast_1d(r), self._y_bound_gas, r_200, r_s, tau, y1)</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">mass_bound_gas_r</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;bound_gas&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">mass_galaxy_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">):</span>
        <span class="c1"># integr = self.integrate_density_profile(r, self._y_galaxy, r_200, M_halo)</span>
        <span class="n">integr</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">mass_galaxy_r</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;galaxy&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">integr</span>

    <span class="k">def</span> <span class="nf">mass_ejected_gas_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span>  <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="n">ejm</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eject_model</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">integr</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">mass_ejected_gas_r</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">r_200</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span> <span class="n">ejm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_matter_ratio</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Delta_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;eject_gas&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;eject_gas&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">integr</span>

    <span class="k">def</span> <span class="nf">mass_nfw_plus_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">):</span>
        <span class="c1"># rhob200 = self.rho_bound_gas_r(r_200, r_200, r_s, tau, frac, y1, norm)</span>
        <span class="c1"># rho_og_r200 = rho_nfw(r_200, r_s, log_rho_0)</span>
        <span class="c1"># r1, rho1 = self.minimise_rho_r(r_200, r_s, log_rho_0, frac, rhob200, M_200, rho_og_r200)</span>
        <span class="c1"># mass= np.zeros_like(r)</span>
        <span class="c1"># mask = r &lt;= r1</span>
        <span class="c1"># mass[mask] = Mass_nfw(r[mask], r_s, math.log(rho1))*frac[&#39;relax_dark_matter&#39;]</span>
        <span class="c1"># mass[~mask] = mass[mask][-1] + 4/3 * np.pi * (rho_og_r200-rhob200) * (r[~mask]**3-r1**3)</span>
        <span class="c1"># mass[self.trunc_radii] = M_200*frac[&#39;relax_dark_matter&#39;]</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span> <span class="n">mass_nfw_plus_constant_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">r_s</span><span class="p">,</span><span class="n">log_rho_0</span><span class="p">,</span><span class="n">tau</span><span class="p">,</span><span class="n">r_200</span><span class="p">,</span><span class="n">M_200</span><span class="p">,</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;bound_gas&#39;</span><span class="p">],</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">],</span><span class="n">y1</span><span class="p">,</span><span class="n">norm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mass</span>

    <span class="k">def</span> <span class="nf">mass_relax_dark_matter_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">M_nfw</span><span class="p">,</span> <span class="n">M_bar</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span><span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
            <span class="c1"># x = np.atleast_1d(r[self.notrunc_radii])</span>
            <span class="c1"># M = np.atleast_1d(M_bar[self.notrunc_radii].astype(self.float_precision))</span>
            <span class="c1"># integr = cengine.mass_relaxed_dark_matter_r(x,M, frac[&#39;relax_dark_matter&#39;],</span>
            <span class="c1">#                                 r_s, log_rho_0, tau, a, n, self.nthreads)[0]</span>
            <span class="c1"># m_rdm = np.array([integr[i]  if ri &lt;= r_200*self.ParticlesRadius else</span>
            <span class="c1">#                                 integr[-1] for i,ri in enumerate(r)])</span>
            <span class="n">m_rdm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">M_nfw</span><span class="p">)</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">0.7</span><span class="o">*</span><span class="n">r_200</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation</span>
            <span class="n">mrel</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">mass_relaxed_dark_matter_r</span><span class="p">(</span><span class="n">r</span><span class="p">[:</span><span class="n">j</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">M_bar</span><span class="p">[:</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)),</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># m_rdm[:j][mrel &gt; M_nfw[:j]] = mrel[:j][mrel &gt; M_nfw[:j]]</span>
            <span class="n">m_rdm</span><span class="p">[:</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mrel</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">M_nfw</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_rdm</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
            <span class="n">m_rdm</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diff</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m_rdm</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">mass_relaxed_dark_matter_r</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">M_bar</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)),</span>
                <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">],</span><span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># xi = self.xi_relax_dark_matter(r, M_nfw, M_bar, frac, r_200, r_s, log_rho_0, tau, a, n)</span>
            <span class="c1"># m_rdm = self.mass_nfw_r(r/xi, r_200, r_s, log_rho_0, tau)</span>
        <span class="k">return</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_rdm</span>

    <span class="k">def</span> <span class="nf">mass_background_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_background_r</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">3</span>

    <span class="k">def</span> <span class="nf">mass_only_gravity_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="n">mass_nfw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_nfw_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">mass_backg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_background_r</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mass_nfw</span><span class="o">+</span><span class="n">mass_backg</span>

    <span class="k">def</span> <span class="nf">mass_only_baryon_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">):</span>
        <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_bound_gas</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">)</span>
        <span class="n">M_bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_bound_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">M_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_galaxy_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">M_eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_ejected_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span><span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">M_bg</span><span class="o">+</span><span class="n">M_cg</span><span class="o">+</span><span class="n">M_eg</span>

    <span class="k">def</span> <span class="nf">mass_baryon_correction_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">):</span>
        <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_bound_gas</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">)</span>
        <span class="n">M_bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_bound_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">M_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_galaxy_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">M_eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_ejected_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">M_rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_relax_dark_matter_r</span><span class="p">(</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">M_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_background_r</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">M_bg</span><span class="o">+</span><span class="n">M_cg</span><span class="o">+</span><span class="n">M_eg</span><span class="o">+</span><span class="n">M_rm</span><span class="o">+</span><span class="n">M_bk</span>

    <span class="k">def</span> <span class="nf">diff_mass_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_profiles</span><span class="p">):</span>
        <span class="n">dfm</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mass_profiles</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mass_profiles</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mass_profiles</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="n">dfm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mass_profiles</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="k">def</span> <span class="nf">compute_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">return_only_mass</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_bound_gas</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">)</span>
        <span class="c1">#computing mass profiles</span>
        <span class="n">M_eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_ejected_gas_r</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span>  <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">M_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_background_r</span><span class="p">(</span><span class="n">rshell</span><span class="p">)</span>
        <span class="n">M_bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_bound_gas_r</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">M_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_galaxy_r</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">M_bar</span> <span class="o">=</span> <span class="n">M_bg</span> <span class="o">+</span> <span class="n">M_cg</span> <span class="o">+</span> <span class="n">M_eg</span>
        <span class="n">M_nfw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_nfw_r</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
            <span class="n">M_rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_nfw_plus_constant</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">M_rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_relax_dark_matter_r</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">M_nfw</span><span class="o">=</span><span class="n">M_rm</span><span class="o">/</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">],</span> <span class="n">M_bar</span><span class="o">=</span><span class="n">M_bar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M_rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_relax_dark_matter_r</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">M_nfw</span><span class="o">=</span><span class="n">M_nfw</span><span class="p">,</span> <span class="n">M_bar</span><span class="o">=</span><span class="n">M_bar</span><span class="p">)</span>

        <span class="n">M_dmo</span> <span class="o">=</span> <span class="n">M_nfw</span> <span class="o">*</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span>
        <span class="n">M_og</span> <span class="o">=</span> <span class="n">M_nfw</span> <span class="o">+</span> <span class="n">M_bk</span>

        <span class="n">Mass_profiles</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">:</span>    <span class="n">M_rm</span><span class="p">,</span>
                         <span class="s1">&#39;galaxy&#39;</span><span class="p">:</span>               <span class="n">M_cg</span><span class="p">,</span>
                         <span class="s1">&#39;bound_gas&#39;</span><span class="p">:</span>            <span class="n">M_bg</span><span class="p">,</span>
                         <span class="s1">&#39;eject_gas&#39;</span><span class="p">:</span>            <span class="n">M_eg</span><span class="p">,</span>
                         <span class="s1">&#39;background&#39;</span><span class="p">:</span>           <span class="n">M_bk</span><span class="p">,</span>
                         <span class="s1">&#39;baryon_only&#39;</span><span class="p">:</span>          <span class="n">M_bar</span><span class="p">,</span>
                         <span class="s1">&#39;dark_matter_only&#39;</span><span class="p">:</span>     <span class="n">M_dmo</span><span class="p">,</span>
                         <span class="s1">&#39;nfw&#39;</span><span class="p">:</span>                  <span class="n">M_nfw</span><span class="p">,</span>
                         <span class="s1">&#39;initial_gravity_only&#39;</span><span class="p">:</span> <span class="n">M_og</span><span class="p">,</span>
                         <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">!=</span> <span class="s1">&#39;baryon_correct&#39;</span><span class="p">:</span>
            <span class="n">Mass_profiles</span><span class="p">[</span><span class="s1">&#39;final_gravity_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">single_component</span><span class="p">])</span> <span class="o">*</span> <span class="n">M_nfw</span> <span class="o">+</span> <span class="n">M_bk</span>
            <span class="n">Mass_profiles</span><span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mass_profiles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">single_component</span><span class="p">]</span><span class="o">+</span> \
                    <span class="n">Mass_profiles</span><span class="p">[</span><span class="s1">&#39;final_gravity_only&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Mass_profiles</span><span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_bg</span> <span class="o">+</span> <span class="n">M_cg</span> <span class="o">+</span> <span class="n">M_eg</span> <span class="o">+</span> <span class="n">M_rm</span> <span class="o">+</span> <span class="n">M_bk</span>

        <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mass_profiles</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_only_mass</span><span class="p">:</span>
            <span class="c1">#computing density profiles</span>
            <span class="n">rho_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_background_r</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">rho_bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_bound_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">rho_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_galaxy_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
            <span class="n">rho_eg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_eject_gas_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">rho_nfwi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_trunc_nfw_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">rho_rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_relax_dark_matter_r</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">rshell</span><span class="p">,</span><span class="n">M_rm</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
                <span class="n">rho_rm</span><span class="p">[</span><span class="n">r</span><span class="o">&gt;</span><span class="mf">0.7</span><span class="o">*</span><span class="n">r_200</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_nfw_plus_constant</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="o">&gt;</span><span class="mf">0.7</span><span class="o">*</span><span class="n">r_200</span><span class="p">],</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">)</span>

            <span class="n">rho_og</span> <span class="o">=</span> <span class="n">rho_nfwi</span><span class="o">+</span><span class="n">rho_bk</span>
            <span class="n">rho_dmo</span> <span class="o">=</span> <span class="n">rho_nfwi</span> <span class="o">*</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span>
            <span class="n">Density_profiles</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">:</span>      <span class="n">rho_rm</span><span class="p">,</span>
                                <span class="s1">&#39;galaxy&#39;</span><span class="p">:</span>                 <span class="n">rho_cg</span><span class="p">,</span>
                                <span class="s1">&#39;bound_gas&#39;</span><span class="p">:</span>              <span class="n">rho_bg</span><span class="p">,</span>
                                <span class="s1">&#39;eject_gas&#39;</span><span class="p">:</span>              <span class="n">rho_eg</span><span class="p">,</span>
                                <span class="s1">&#39;background&#39;</span><span class="p">:</span>             <span class="n">rho_bk</span><span class="p">,</span>
                                <span class="s1">&#39;initial_gravity_only&#39;</span><span class="p">:</span>   <span class="n">rho_og</span><span class="p">,</span>
                                <span class="s1">&#39;dark_matter_only&#39;</span><span class="p">:</span>       <span class="n">rho_dmo</span><span class="p">,</span>
                                <span class="s1">&#39;nfw&#39;</span><span class="p">:</span>                    <span class="n">rho_nfwi</span>
                                <span class="p">}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">!=</span> <span class="s1">&#39;baryon_correct&#39;</span><span class="p">:</span>
                <span class="n">Density_profiles</span><span class="p">[</span><span class="s1">&#39;final_gravity_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">single_component</span><span class="p">])</span> <span class="o">*</span> <span class="n">rho_nfwi</span> <span class="o">+</span> <span class="n">rho_bk</span>
                <span class="n">Density_profiles</span><span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Density_profiles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">single_component</span><span class="p">]</span><span class="o">+</span> \
                        <span class="n">Density_profiles</span><span class="p">[</span><span class="s1">&#39;final_gravity_only&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Density_profiles</span><span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_bg</span> <span class="o">+</span> <span class="n">rho_cg</span> <span class="o">+</span> <span class="n">rho_eg</span> <span class="o">+</span> <span class="n">rho_rm</span> <span class="o">+</span> <span class="n">rho_bk</span>

            <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Density_profiles</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermodynamical_props</span><span class="p">:</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">gammaf</span> <span class="o">=</span> <span class="n">gamma_f</span><span class="p">(</span><span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span><span class="p">)</span>
            <span class="n">rho_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_rho_0</span><span class="p">)</span><span class="o">*</span><span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">4</span>
            <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_bound_gas</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;bound_gas&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span><span class="p">,</span> <span class="n">rho_s</span><span class="p">,</span> <span class="n">gammaf</span><span class="p">)</span>
            <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_bound_gas</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">rho_s</span><span class="p">,</span> <span class="n">gammaf</span><span class="p">)</span>
            <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;universal_pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universal_pressure_profile</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_200</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">profiles</span>

    <span class="k">def</span> <span class="nf">measure_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">min_pts_in_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">density</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
        <span class="n">r_200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
        <span class="n">rshell</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_200</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_component_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
            <span class="n">particles_per_bin</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">count_particles_per_bin</span><span class="p">(</span><span class="n">rel_pos</span><span class="o">=</span><span class="n">pts</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                            <span class="n">shells</span><span class="o">=</span><span class="n">rshell</span><span class="p">,</span> <span class="n">particle_mass</span><span class="o">=</span><span class="n">pts</span><span class="p">[</span><span class="s1">&#39;pmass&#39;</span><span class="p">],</span>
                                             <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span>
            <span class="n">profiles</span> <span class="o">=</span> <span class="n">measure_averaged_profiles</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span><span class="n">counts</span><span class="p">,</span><span class="n">min_pts_in_bin</span><span class="o">=</span><span class="n">min_pts_in_bin</span><span class="p">)</span>
            <span class="n">mass</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span>
            <span class="n">density</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">mass</span>

<span class="c1">#   ============================</span>
<span class="c1">#   Mass fractions</span>
<span class="c1">#   ============================</span>

    <span class="k">def</span> <span class="nf">fraction_bound_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">f_cg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f_cg</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_galaxy</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_matter_ratio</span><span class="o">-</span><span class="n">f_cg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M_c&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">M_200</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">fraction_galaxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_200</span><span class="p">):</span>
        <span class="n">fact</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span> <span class="n">g</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">g</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">M_200</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span>

    <span class="k">def</span> <span class="nf">fraction_eject_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">f_bg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_cg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f_bg</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_cg</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_bound_gas</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
            <span class="n">f_cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_galaxy</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baryon_matter_ratio</span> <span class="o">-</span> <span class="n">f_bg</span> <span class="o">-</span> <span class="n">f_cg</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">fraction_dark_matter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="s1">&#39;fraction_dark_matter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">baryon_matter_ratio</span>

    <span class="k">def</span> <span class="nf">fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_200</span><span class="p">):</span>
        <span class="n">fcg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_galaxy</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
        <span class="n">fbg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_bound_gas</span><span class="p">(</span><span class="n">M_200</span><span class="p">,</span><span class="n">fcg</span><span class="p">)</span>
        <span class="c1">#assuming that the factor</span>
        <span class="c1">#Mtot,vir/Mtot,tot *Mbound,tot/M_bound,vir is ~ 1, fairly true</span>
        <span class="c1">#since after r_200 bound gas and dark_matter follow the same</span>
        <span class="c1">#profile (NFW); to check (adiabatic contraction and ejected gas effect?)</span>
        <span class="n">feg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_eject_gas</span><span class="p">(</span><span class="n">M_200</span><span class="p">,</span> <span class="n">f_bg</span><span class="o">=</span><span class="n">fbg</span><span class="p">,</span> <span class="n">f_cg</span><span class="o">=</span><span class="n">fcg</span><span class="p">)</span>
        <span class="n">fdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_dark_matter</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;eject_gas&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">feg</span><span class="p">),</span>
                <span class="s1">&#39;galaxy&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fcg</span><span class="p">),</span>
                <span class="s1">&#39;bound_gas&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fbg</span><span class="p">),</span>
                <span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fdm</span><span class="p">),</span>
                <span class="s1">&#39;baryon_correct&#39;</span><span class="p">:</span> <span class="mf">1.</span>
                <span class="p">}</span>

<span class="c1">#   ============================</span>
<span class="c1">#   Hot bound gas properties (see Martizzi, Teyssier and Moore 2013 and</span>
<span class="c1">#   Bryan &amp; Norman 1998 )</span>
<span class="c1">#   ============================</span>

<div class="viewcode-block" id="Baryons.universal_pressure_profile"><a class="viewcode-back" href="../../code.html#bacco.Baryons.universal_pressure_profile">[docs]</a>    <span class="k">def</span> <span class="nf">universal_pressure_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_200</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function which return the universal density profile of a cluster, in erg/cm^3</span>
<span class="sd">        following  Nagai, Kravtsov &amp; Vikhlinin 2007; Arnaud et al 2010.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">4.3</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">P0</span> <span class="o">=</span> <span class="mf">3.3</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mf">1.45e-11</span> <span class="c1">#erg cm^-3    *1.60218e9 [KeV cm^-3]</span>
        <span class="n">c_500</span> <span class="o">=</span> <span class="n">virial_concentration_converter</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="n">M_500</span> <span class="o">=</span> <span class="n">virial_mass_converter</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="n">M_200</span><span class="p">,</span><span class="n">conc</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="n">c_500</span><span class="p">)</span>
        <span class="n">P_200</span> <span class="o">=</span> <span class="n">cost</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_500</span><span class="o">/</span><span class="mf">1e15</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="mf">0.12</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_200</span> <span class="o">*</span> <span class="n">P0</span> <span class="o">/</span> <span class="p">(</span> <span class="n">x</span><span class="o">**</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="o">**</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">beta</span><span class="o">-</span><span class="n">gamma</span><span class="p">)</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Baryons.pressure_bound_gas"><a class="viewcode-back" href="../../code.html#bacco.Baryons.pressure_bound_gas">[docs]</a>    <span class="k">def</span> <span class="nf">pressure_bound_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">rho_s</span><span class="p">,</span> <span class="n">gammaf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function which return a ploytropic density profile, in erg/cm^3</span>
<span class="sd">        following  Martizzi et al. 2013</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#norm is the normalization of the bound_gas density</span>
        <span class="c1"># rho_s is the  dark matter density at r_s</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">6.6743e-8</span> <span class="c1">#cm^3 g^-1 s^-2</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">gammaf</span> <span class="o">=</span> <span class="n">gamma_f</span><span class="p">(</span><span class="n">conc</span><span class="p">)</span> <span class="k">if</span> <span class="n">gammaf</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">gammaf</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">rho_s</span> <span class="o">*</span> <span class="n">r_s</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">gammaf</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">gammaf</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.989</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">3.24078</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-34</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#[erg/cm^3]</span>
        <span class="k">return</span> <span class="mf">1e5</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gammaf</span><span class="o">/</span><span class="p">(</span><span class="n">gammaf</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#WARNING: CHECK 1e5</span></div>

<div class="viewcode-block" id="Baryons.temperature_bound_gas"><a class="viewcode-back" href="../../code.html#bacco.Baryons.temperature_bound_gas">[docs]</a>    <span class="k">def</span> <span class="nf">temperature_bound_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">rho_s</span><span class="p">,</span> <span class="n">gammaf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the bound gas Temperature profiles in K</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># rho_s is the  dark matter density at r_s</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">6.6743e-8</span> <span class="c1">#cm^3 g^-1 s^-2</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span>
        <span class="n">gammaf</span> <span class="o">=</span> <span class="n">gamma_f</span><span class="p">(</span><span class="n">conc</span><span class="p">)</span> <span class="k">if</span> <span class="n">gammaf</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">gammaf</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="mf">1.380649e-16</span>  <span class="c1">#Boltzmann constant, [erg/K]</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="mf">1.672621e-24</span>  <span class="c1">#proton mass, [g]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.59</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">G</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span> <span class="n">r_s</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">gammaf</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">gammaf</span> <span class="o">*</span> <span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">mp</span><span class="o">/</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.989</span><span class="o">/</span><span class="mf">3.24078</span><span class="p">)</span><span class="o">*</span><span class="mf">1e8</span> <span class="c1"># [K]</span>
        <span class="k">return</span> <span class="n">T0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span></div>

<span class="c1">#   ============================</span>
<span class="c1">#   Util functions</span>
<span class="c1">#   ============================</span>

    <span class="k">def</span> <span class="nf">norm_bound_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">):</span>
        <span class="c1">#the bound gas, as all the other components, is normalised to have</span>
        <span class="c1">#at r -&gt; infinity all the mass of the halo</span>
        <span class="n">rchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_sqrt5</span><span class="o">*</span><span class="n">r_200</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_hot_gas</span><span class="p">(</span><span class="n">rchange</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">==</span><span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">rho_nfw</span><span class="p">(</span><span class="n">rchange</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c1">#replaced np.log(1) -&gt; 0</span>
            <span class="n">rnorm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span><span class="o">*</span><span class="n">r_200</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">rho_trunc_nfw</span><span class="p">(</span><span class="n">rchange</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">rnorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1"># m = self.integrate_density_profile(np.infty, self._y_bound_gas, r_200, r_s, tau, y1)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">mass_bound_gas_r</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rnorm</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">),</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">M_halo</span><span class="o">/</span><span class="n">m</span>
        <span class="k">return</span> <span class="n">y1</span><span class="p">,</span> <span class="n">norm</span>

    <span class="k">def</span> <span class="nf">integrate_density_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rho</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">integral</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nbins</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbins</span><span class="p">):</span>
                <span class="n">integral</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">integral</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">integral</span>

    <span class="k">def</span> <span class="nf">xi_relax_dark_matter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">M_nfw</span><span class="p">,</span> <span class="n">M_bar</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span><span class="n">r_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">xi_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">adiabatic_contraction</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
                <span class="c1"># if self.mode == &#39;truncated&#39;:</span>
                <span class="c1">#     Mi = Mass_nfw(rf/xi, r_200, r_s, log_rho_0)</span>
                <span class="c1"># else:</span>
                <span class="n">Mi</span> <span class="o">=</span> <span class="n">Mass_trunc_nfw</span><span class="p">(</span><span class="n">rf</span><span class="o">/</span><span class="n">xi</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)</span>
                <span class="n">Mf</span> <span class="o">=</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">Mi</span> <span class="o">+</span> <span class="n">M_bar</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="n">Mi</span><span class="o">/</span><span class="n">Mf</span><span class="p">)</span><span class="o">**</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">xi</span>

            <span class="n">xi_new</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">broyden1</span><span class="p">(</span><span class="n">adiabatic_contraction</span><span class="p">,</span> <span class="n">xi_old</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lenr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">M</span><span class="p">,</span><span class="n">spl</span> <span class="o">=</span> <span class="n">interpol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">M_nfw</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">lenr</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Mi = self.mass_nfw_r(rf/xi_old, r_200, r_s, log_rho_0, tau)</span>
                <span class="n">Mi</span> <span class="o">=</span> <span class="n">interpol</span><span class="p">(</span><span class="n">x2</span><span class="o">=</span><span class="n">rf</span><span class="o">/</span><span class="n">xi_old</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">spline</span><span class="o">=</span><span class="n">spl</span><span class="p">,</span><span class="n">bound_values</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Mf</span> <span class="o">=</span> <span class="n">frac</span><span class="p">[</span><span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">Mi</span> <span class="o">+</span> <span class="n">M_bar</span>
                <span class="n">xi_new</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="n">Mi</span><span class="o">/</span><span class="n">Mf</span><span class="p">)</span><span class="o">**</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">not_converging</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">while</span> <span class="n">not_converging</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">lenr</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">xi_new</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">xi_old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">-</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">not_converging</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">xi_old</span> <span class="o">=</span> <span class="n">xi_new</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Convergence in Dark Matter back-reaction not reached&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">xi_new</span>

    <span class="k">def</span> <span class="nf">get_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;outern&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">pos</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fof&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">get_halo_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">sDM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">get_halo_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">sDM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span>

        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pos</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">,</span><span class="s1">&#39;outern&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rr</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]]</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;outern&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">get_halo_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">sDM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]],</span> <span class="n">rr</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rr</span>

    <span class="k">def</span> <span class="nf">put_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;outern&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">set_halo_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">sdm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_mask</span><span class="p">[</span><span class="n">ihalo</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_component_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span>
        <span class="n">pmass</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;pmass&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s1">&#39;baryon_correct&#39;</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;type&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">type</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">pmass</span> <span class="o">=</span> <span class="n">pmass</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span> <span class="s1">&#39;pmass&#39;</span><span class="p">:</span> <span class="n">pmass</span> <span class="p">}</span>

    <span class="c1"># obsolete function</span>
    <span class="k">def</span> <span class="nf">displace_halo_centers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">spline</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">check_boundaries</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pos</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">displ_field</span> <span class="o">=</span> <span class="n">interpol</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">spline</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span><span class="n">bound_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rr_prime</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">+</span> <span class="n">displ_field</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">displ_pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">displ_pos</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">rr_prime</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="n">rr</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">rr_prime</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="n">rr</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">rr_prime</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="n">rr</span><span class="p">[</span><span class="n">mask</span><span class="p">]]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">displ_pos</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_boundaries</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span><span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1">#   ============================</span>
<span class="c1">#   Displacement</span>
<span class="c1">#   ============================</span>

    <span class="k">def</span> <span class="nf">displacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">Mass_profiles</span><span class="p">):</span>
        <span class="n">M_bcm</span> <span class="o">=</span> <span class="n">Mass_profiles</span><span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">]</span>
        <span class="n">M_og</span> <span class="o">=</span> <span class="n">Mass_profiles</span><span class="p">[</span><span class="s1">&#39;initial_gravity_only&#39;</span><span class="p">]</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">r_bcm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">M_og</span><span class="p">,</span><span class="n">M_bcm</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">displ</span> <span class="o">=</span> <span class="n">r_bcm</span> <span class="o">-</span><span class="n">r</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">]:</span>
            <span class="n">displ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trunc_radii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">displ</span>

    <span class="k">def</span> <span class="nf">make_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ihalo</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logarithmic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_sdm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="k">if</span> <span class="n">use_sdm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">use_sdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sdm</span>
        <span class="n">fig1</span><span class="p">,</span><span class="n">fig2</span><span class="p">,</span><span class="n">fig3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">M_200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_m200c&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span>   <span class="c1">#Msun/h</span>
        <span class="n">r_200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_r200c&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span>
        <span class="n">radial_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">r_200</span>
        <span class="n">rho_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">fof</span><span class="p">[</span><span class="s1">&#39;halo_density_profile&#39;</span><span class="p">][</span><span class="n">ihalo</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span>
        <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">compute_concentration</span><span class="p">(</span><span class="n">radial_bins</span><span class="p">,</span> <span class="n">rho_profile</span><span class="p">)</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;truncated&#39;</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="mf">1e6</span>
            <span class="n">log_rho_0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">compute_rho0_nfw</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">M_200</span><span class="p">,</span><span class="n">r_s</span><span class="p">))</span>
            <span class="n">M_halo</span> <span class="o">=</span> <span class="n">M_200</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauv</span><span class="o">*</span><span class="n">conc</span>
            <span class="n">M_halo</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mass_trunc_nfw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">],</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span>
                                        <span class="n">tau</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

        <span class="n">rshell</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_200</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">rshell</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rshell</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>
        <span class="c1">#let&#39;s compute the theoretical profiles and displacements</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_profiles</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">r_200</span><span class="p">,</span> <span class="n">M_200</span><span class="p">,</span> <span class="n">r_s</span><span class="p">,</span> <span class="n">M_halo</span><span class="p">,</span> <span class="n">log_rho_0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">mass</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="n">theo_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">mass</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">spline</span> <span class="o">=</span> <span class="n">interpol</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">theo_d</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">subs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">len_halo</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">displacement</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">subs</span><span class="p">],</span><span class="n">displacement</span><span class="p">[</span><span class="n">subs</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">displacement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">theo_d</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;truncated&#39;</span><span class="p">]:</span>
                <span class="n">displacement</span> <span class="p">[</span><span class="n">rr</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParticlesRadius</span><span class="o">*</span><span class="n">r_200</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">!=</span> <span class="s1">&#39;baryon_correct&#39;</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;baryon_correct&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span><span class="p">,</span> <span class="s1">&#39;final_gravity_only&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">density</span><span class="p">,</span><span class="n">mass</span><span class="p">,</span> <span class="n">displacement</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span>  <span class="kc">None</span><span class="p">:</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">figs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
                <span class="n">nx</span> <span class="o">=</span> <span class="n">n</span>
                <span class="n">ny</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">figs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">nx</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">ny</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">fig1</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figs</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="p">{</span>  <span class="s1">&#39;baryon_correct&#39;</span><span class="p">:</span>    <span class="s1">&#39;orange&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;eject_gas&#39;</span><span class="p">:</span>         <span class="s1">&#39;green&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;galaxy&#39;</span><span class="p">:</span>            <span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bound_gas&#39;</span><span class="p">:</span>         <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;relax_dark_matter&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;final_gravity_only&#39;</span><span class="p">:</span><span class="s1">&#39;darkgrey&#39;</span>
                    <span class="p">}</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Halo &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ihalo</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, Mass= &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">M_halo</span><span class="p">)</span><span class="o">+</span> \
                    <span class="s1">&#39;, concentration=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">))</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gravity_only_sim</span><span class="o">.</span><span class="n">get_halo_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">sDM</span><span class="o">=</span><span class="n">use_sdm</span><span class="p">)</span>
            <span class="n">particles_per_bin</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">count_particles_per_bin</span><span class="p">(</span><span class="n">rel_pos</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
                        <span class="n">shells</span><span class="o">=</span><span class="n">rshell</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity_only_sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">])</span>
            <span class="n">measured_og</span> <span class="o">=</span> <span class="n">measure_averaged_profiles</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span><span class="n">counts</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">OG_pmass</span><span class="p">)</span>

            <span class="n">meas_r</span><span class="p">,</span> <span class="n">meas_rho</span><span class="p">,</span> <span class="n">meas_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_profiles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">measured_og</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">measured_og</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;initial_gravity_only&#39;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial_gravity_only&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">density</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_subsample</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;baryon_correct&#39;</span><span class="p">):</span>
                       <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">meas_rho</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e9</span><span class="p">,</span> <span class="mf">1e17</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho$&#39;</span><span class="p">)</span>

                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_s</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1e-2</span><span class="p">,</span><span class="mf">1e-1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span> <span class="p">:</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">measured_og</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">],</span> <span class="n">measured_og</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">mass</span><span class="p">[</span><span class="s1">&#39;initial_gravity_only&#39;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial_gravity_only&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">mass</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">frac</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">*</span><span class="n">M_halo</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_subsample</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;baryon_correct&#39;</span><span class="p">):</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">meas_mass</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">mass</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e10</span><span class="p">,</span><span class="mf">1e15</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rshell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$M$&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_s</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">r_s</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">M_200</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="c1"># ax[n].axhline(M_halo,ls=&#39;-&#39;,c=&#39;black&#39;,alpha=0.3)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M_200</span><span class="o">*</span><span class="mf">1.05</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$M_</span><span class="si">{200}</span><span class="s1">$&#39;</span><span class="p">)</span>
                <span class="c1"># ax[n].text(r[0], M_halo*1.05, r&#39;$M_{halo}$&#39;)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1e-2</span><span class="p">,</span><span class="mf">1e-1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span> <span class="p">:</span> <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">displacement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="n">theo_d</span> <span class="o">&lt;</span> <span class="mf">0.</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">theo_d</span> <span class="o">&gt;</span> <span class="mf">0.</span>
                <span class="n">zero</span> <span class="o">=</span> <span class="n">theo_d</span> <span class="o">==</span> <span class="mf">0.</span>

                <span class="k">if</span> <span class="n">logarithmic</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">displacement</span><span class="p">),</span>
                               <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;effective&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="n">neg</span><span class="p">],</span> <span class="o">-</span><span class="n">theo_d</span><span class="p">[</span><span class="n">neg</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;negative&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">theo_d</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;positive&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rshell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="n">neg</span><span class="p">],</span> <span class="n">theo_d</span><span class="p">[</span><span class="n">neg</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;theoretical&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">theo_d</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="n">zero</span><span class="p">],</span> <span class="n">theo_d</span><span class="p">[</span><span class="n">zero</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">displacement</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;effective&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span> <span class="n">rshell</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;r=r&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">rshell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rshell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Phi(r)$ (Mpc/h)&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_s</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_200</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1e-2</span><span class="p">,</span><span class="mf">1e-1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span> <span class="p">:</span> <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">rmin</span><span class="p">,</span><span class="n">rmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">tick</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;%.e&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tick</span><span class="p">])</span>
            <span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span><span class="mi">0</span><span class="p">,[</span><span class="n">r_s</span><span class="p">,</span><span class="n">r_200</span><span class="p">])</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="mi">0</span><span class="p">,[</span><span class="sa">r</span><span class="s1">&#39;$r_s$&#39;</span><span class="p">,</span><span class="s1">&#39;r200&#39;</span><span class="p">])</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="n">idx</span><span class="p">],(</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r (Mpc/h)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">rmin</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">rmax</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">fig1</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">save_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_file</span><span class="o">+</span><span class="s1">&#39;_profiles.png&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;in order to save the plot, you must provide a valid </span><span class="se">\</span>
<span class="s2">                        directory path&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scatter</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">gaussian_kde</span>

            <span class="n">tpos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">tpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">tpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">zz</span> <span class="o">=</span> <span class="n">tpos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ccc</span> <span class="o">=</span><span class="s1">&#39;black&#39;</span>

            <span class="c1"># xxyy =np.vstack([xx,yy])</span>
            <span class="c1"># zzzz = gaussian_kde(xxyy)(xxyy)</span>
            <span class="c1"># idx = zzz.argsort()</span>
            <span class="c1"># ccc = zzzz[idx]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_subsample</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_component</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fig2</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gravity only&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">ccc</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r [Mpc/h]&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;r [Mpc/h]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig2</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_component_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="o">=</span><span class="n">ihalo</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">key</span><span class="p">)[</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>
                    <span class="n">x_prime</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y_prime</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">z_prime</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">xy</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_prime</span><span class="p">,</span><span class="n">y_prime</span><span class="p">])</span>
                        <span class="n">zzz</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">xy</span><span class="p">)(</span><span class="n">xy</span><span class="p">)</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">zzz</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

                        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gravity only&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_prime</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y_prime</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">zzz</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> component not present in halo </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">ihalo</span><span class="p">))</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r [Mpc/h]&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;r [Mpc/h]&#39;</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Halo &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ihalo</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, Mass= &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">M_halo</span><span class="p">)</span><span class="o">+</span> \
                            <span class="s1">&#39;, concentration=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">save_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_file</span><span class="o">+</span><span class="s1">&#39;_scatter.png&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;in order to save the plot, you must provide a valid </span><span class="se">\</span>
<span class="s2">                        directory path&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermodynamical_props</span><span class="p">:</span>
            <span class="n">theo_pres</span><span class="p">,</span> <span class="n">theo_temp</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">],</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>

            <span class="n">shell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rshell</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">shell</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shell</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">pp</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;pressure&#39;</span><span class="p">)</span>
            <span class="n">tt</span><span class="p">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;temperature&#39;</span><span class="p">)</span>
            <span class="nb">type</span><span class="p">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_particles</span><span class="p">(</span><span class="n">ihalo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>

            <span class="c1">#masking out particles other than hot gas</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;bound_gas&#39;</span>

            <span class="k">def</span> <span class="nf">binning</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
                <span class="n">mes_qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
                <span class="n">numpart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dist</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shell</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">&gt;</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">d</span><span class="o">&lt;=</span><span class="n">shell</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">mes_qty</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">qty</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">numpart</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                <span class="k">return</span> <span class="n">mes_qty</span><span class="o">/</span><span class="n">numpart</span>


            <span class="n">fig3</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Halo &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ihalo</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, Mass= &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">M_halo</span><span class="p">)</span><span class="o">+</span> \
                    <span class="s1">&#39;, concentration=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r_200</span><span class="o">/</span><span class="n">r_s</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">))</span>

            <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span><span class="n">theo_pres</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span><span class="n">theo_temp</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">binning</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">pr</span><span class="p">[</span><span class="n">mask</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">binning</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">tr</span><span class="p">[</span><span class="n">mask</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">up</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;universal_pressure&#39;</span><span class="p">]</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Universal pressure&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P [erg/cm^3]&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;T [K]&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r [Mpc/h]&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

            <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">21</span><span class="p">})</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig1</span><span class="p">,</span> <span class="n">fig2</span><span class="p">,</span> <span class="n">fig3</span></div>


<span class="c1">#we define here some extra util functions</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="o">-</span><span class="mf">1.779</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.547</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="mf">4.394</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
        <span class="n">delta</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">))</span><span class="o">**</span><span class="n">gamma</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span> <span class="p">)</span> <span class="c1">#there is a wrong sign in Schneider &amp; Teyssier 2016</span>

<span class="k">def</span> <span class="nf">gamma_f</span><span class="p">(</span><span class="n">conc</span><span class="p">):</span>
    <span class="n">one_over_sqrt5</span> <span class="o">=</span> <span class="mf">0.4472135954999579</span> <span class="c1">#1/np.sqrt(5.)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">one_over_sqrt5</span> <span class="o">*</span> <span class="n">conc</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span> <span class="p">)</span><span class="o">/</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">gamma_eff</span><span class="p">(</span><span class="n">conc</span><span class="p">):</span>
    <span class="n">one_over_sqrt5</span> <span class="o">=</span> <span class="mf">0.4472135954999579</span> <span class="c1">#1/np.sqrt(5.)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">one_over_sqrt5</span> <span class="o">*</span> <span class="n">conc</span>
    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">interpol</span><span class="p">(</span><span class="n">x2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bound_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
            <span class="n">deriv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bound_values</span> <span class="o">==</span> <span class="s1">&#39;extrapolate&#39;</span> <span class="ow">and</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span> <span class="ow">and</span> <span class="n">spline</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">fx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">deriv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bound_values</span> <span class="o">==</span> <span class="s1">&#39;extrapolate&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;cubic&#39;</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>

        <span class="n">intp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">spline</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">deriv</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">intp</span><span class="p">,</span> <span class="n">spline</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;quadratic&#39;</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;cubic&#39;</span>
        <span class="k">if</span> <span class="n">bound_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;extrapolate&#39;</span> <span class="ow">or</span> <span class="n">bound_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;extrapolate&#39;</span><span class="p">:</span>
            <span class="n">lenx2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
            <span class="n">argx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lenx2</span><span class="p">)</span>
            <span class="n">half1</span> <span class="o">=</span> <span class="n">argx2</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">lenx2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">half2</span> <span class="o">=</span> <span class="n">argx2</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lenx2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">spline1</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span><span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                <span class="n">fill_value</span><span class="o">=</span><span class="n">bound_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="nb">sorted</span><span class="p">)</span>
            <span class="n">spline2</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span><span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                <span class="n">fill_value</span><span class="o">=</span><span class="n">bound_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="nb">sorted</span><span class="p">)</span>
            <span class="n">out1</span> <span class="o">=</span> <span class="n">spline1</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">half1</span><span class="p">])</span>
            <span class="n">out2</span> <span class="o">=</span> <span class="n">spline2</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">half2</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">out1</span><span class="p">,</span><span class="n">out2</span><span class="p">)),</span> <span class="n">spline2</span>

        <span class="k">elif</span> <span class="n">spline</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                <span class="n">fill_value</span><span class="o">=</span><span class="n">bound_values</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="nb">sorted</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="n">spline</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">without_keys</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">dict</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">cleanup_files</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;baryonic_halo_tab&#39;</span><span class="p">,</span><span class="s1">&#39;baryonic_background_tab&#39;</span><span class="p">,</span><span class="s1">&#39;baryonic_background_mesh&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">group_dir</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm &#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;deleted &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_boundaries</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">halfbox</span> <span class="o">=</span> <span class="n">box</span><span class="o">/</span><span class="mf">2.</span>
    <span class="k">if</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">halfbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">halfbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">halfbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">halfbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">halfbox</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">halfbox</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>

    <span class="k">elif</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">box</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">box</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">box</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>

    <span class="k">return</span> <span class="n">dp</span>

<span class="k">def</span> <span class="nf">adiabatic_relaxation</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Mfix_r</span><span class="p">,</span> <span class="n">Mrelax</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">Mfix_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Mrelax</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">relaxing</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
        <span class="n">Mi</span> <span class="o">=</span> <span class="n">Mrelax</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">Mf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac</span><span class="p">)</span> <span class="o">*</span> <span class="n">Mrelax</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="n">Mfix_r</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="n">Mi</span><span class="o">/</span><span class="n">Mf</span><span class="p">)</span><span class="o">**</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">xi</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">broyden1</span><span class="p">(</span><span class="n">relaxing</span><span class="p">,</span> <span class="n">rf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mfix_r</span> <span class="o">+</span> <span class="n">Mrelax</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">xi</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">baryon_pars</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;bahamas&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that return the baryonic parameters which correspond to varyous hydrodynamical simulations</span>
<span class="sd">    model: hydro simulation for which we want the parameterisation. Options are:</span>
<span class="sd">                            &#39;bahamas&#39;,&#39;cosmo_owls&#39;,&#39;owls&#39;,&#39;horizon&#39;,&#39;TNG300&#39;,&#39;illustris&#39;,&#39;eagle&#39;</span>
<span class="sd">    z: redshift of the baryonic feedback</span>
<span class="sd">    stat: return mean, mode or bestfit of the parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#loading the data</span>
    <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
    <span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">this_dir</span><span class="o">+</span><span class="s2">&quot;/../tests/testdata/hydro_simulations_fit.hdf5&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">{}</span><span class="s2"> not found!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
    <span class="n">bcm_pars</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bahamas&#39;</span><span class="p">,</span><span class="s1">&#39;cosmo_owls&#39;</span><span class="p">,</span><span class="s1">&#39;owls&#39;</span><span class="p">,</span><span class="s1">&#39;horizon&#39;</span><span class="p">]:</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span> <span class="k">for</span> <span class="n">zi</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zz</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">bcm_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">zi</span><span class="p">][</span><span class="n">par</span><span class="p">][</span><span class="n">stat</span><span class="p">]</span> <span class="k">for</span> <span class="n">zi</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pars</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1">#interpolating the redshifts</span>
            <span class="n">bcm_pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#if there is no data for the redshift evolution, a BAHAMAS-like evolution is assumed</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span> <span class="k">for</span> <span class="n">zi</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;bahamas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zz</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">bcm_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bahamas_pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;bahamas&#39;</span><span class="p">][</span><span class="n">zi</span><span class="p">][</span><span class="n">par</span><span class="p">][</span><span class="n">stat</span><span class="p">]</span> <span class="k">for</span> <span class="n">zi</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;bahamas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">bahamas_pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bahamas_pars</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">bahamas_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">bahamas_pars</span><span class="p">)</span>
            <span class="n">hp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;0.0&#39;</span><span class="p">][</span><span class="n">par</span><span class="p">][</span><span class="n">stat</span><span class="p">]</span>
            <span class="n">bcm_pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span> <span class="o">*</span> <span class="n">bahamas_z</span><span class="o">/</span><span class="n">bahamas_pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


    <span class="n">bcm_pars</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
    <span class="k">return</span> <span class="n">bcm_pars</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Raul E. Angulo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>