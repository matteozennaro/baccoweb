

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bacco.utils &mdash; bacco 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> bacco
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bacco</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bacco.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bacco.utils</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A collection of miscelaneous functions</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">integrate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">special</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">getsizeof</span><span class="p">,</span> <span class="n">stderr</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">reprlib</span> <span class="k">import</span> <span class="nb">repr</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="k">import</span> <span class="n">Mapping</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Mapping</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;bacco.util&#39;</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;crossmatch&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_displacement&quot;</span><span class="p">,</span> <span class="s2">&quot;cached_property&quot;</span><span class="p">,</span> <span class="s2">&quot;load_powerspec_MS&quot;</span><span class="p">,</span> <span class="s2">&quot;sbesselj0&quot;</span><span class="p">,</span> <span class="s2">&quot;sbesselj1&quot;</span><span class="p">,</span> <span class="s2">&quot;xi2pk&quot;</span><span class="p">,</span> <span class="s2">&quot;pk2xi&quot;</span><span class="p">,</span> <span class="s2">&quot;sigmaR&quot;</span><span class="p">,</span> <span class="s2">&quot;make_pk2d&quot;</span><span class="p">,</span>
           <span class="s2">&quot;ximulti&quot;</span><span class="p">,</span> <span class="s2">&quot;pkmulti&quot;</span><span class="p">,</span> <span class="s2">&quot;xibar&quot;</span><span class="p">,</span> <span class="s2">&quot;create_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;read_parameter_file&quot;</span><span class="p">,</span> <span class="s2">&quot;write_parameter_file&quot;</span><span class="p">,</span> <span class="s2">&quot;remove_IDs_HDF5&quot;</span><span class="p">]</span>

<span class="n">_missing</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">line_profiler</span> <span class="k">import</span> <span class="n">LineProfiler</span>

    <span class="k">def</span> <span class="nf">do_profile</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">profiled_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">profiler</span> <span class="o">=</span> <span class="n">LineProfiler</span><span class="p">()</span>
                    <span class="n">profiler</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">follow</span><span class="p">:</span>
                        <span class="n">profiler</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">profiler</span><span class="o">.</span><span class="n">enable_by_count</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">profiler</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">profiled_func</span>
        <span class="k">return</span> <span class="n">inner</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">do_profile</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="p">[]):</span>
        <span class="s2">&quot;Helpful if you accidentally leave in production!&quot;</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">nothing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nothing</span>
        <span class="k">return</span> <span class="n">inner</span>

<span class="k">def</span> <span class="nf">find_BinA</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.cyengine</span> <span class="k">import</span> <span class="n">cymock</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">len_A</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">len_B</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">arg_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;mergesort&#39;</span><span class="p">)</span>
    <span class="n">arg_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;mergesort&#39;</span><span class="p">)</span>
    <span class="n">_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">arg_A</span><span class="p">]</span>
    <span class="n">_B</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">arg_B</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">len_B</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">cymock</span><span class="o">.</span><span class="n">core_find_BinA</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">_A</span><span class="p">,</span> <span class="n">_B</span><span class="p">,</span> <span class="n">arg_A</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">arg_B</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="c1">#mask = index==-99</span>
    <span class="c1">#index[mask] = np.nan</span>
    <span class="c1">#while (a &lt; len_A) and (b &lt; len_B):</span>
        <span class="c1">#if _A[a] &lt; _B[b]:</span>
            <span class="c1">#a+=1</span>
        <span class="c1">#elif _A[a] == _B[b]:</span>
            <span class="c1">#index[arg_B[b]] = arg_A[a]</span>
            <span class="c1">#b +=1</span>
        <span class="c1">#else:</span>
            <span class="c1">#index[arg_B[b]] = np.nan</span>
            <span class="c1">#logger.warning(&#39;WARNING, element of B not in A&#39;)</span>
            <span class="c1">#b +=1</span>

    <span class="k">return</span> <span class="n">index</span>

<span class="k">class</span> <span class="nc">LazyDict</span><span class="p">(</span><span class="n">Mapping</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span><span class="p">:</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Available properties: </span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> Loaded properties </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_lazy_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_computed_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<div class="viewcode-block" id="cached_property"><a class="viewcode-back" href="../../code.html#bacco.utils.cached_property">[docs]</a><span class="k">class</span> <span class="nc">cached_property</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A decorator that converts a function into a lazy property.  The</span>
<span class="sd">    function wrapped is called the first time to retrieve the result</span>
<span class="sd">    and then that calculated result is used the next time you access</span>
<span class="sd">    the value::</span>

<span class="sd">        class Foo(object):</span>

<span class="sd">            @cached_property</span>
<span class="sd">            def foo(self):</span>
<span class="sd">                # calculate something important here</span>
<span class="sd">                return 42</span>

<span class="sd">    The class has to have a `__dict__` in order for this property to</span>
<span class="sd">    work.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># implementation detail: this property is implemented as non-data</span>
    <span class="c1"># descriptor.  non-data descriptors are only invoked if there is</span>
    <span class="c1"># no entry with the same name in the instance&#39;s __dict__.</span>
    <span class="c1"># this allows us to completely get rid of the access function call</span>
    <span class="c1"># overhead.  If one choses to invoke __get__ by hand the property</span>
    <span class="c1"># will still work as expected because the lookup logic is replicated</span>
    <span class="c1"># in __get__ for manual invocation.</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">_missing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">_missing</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span></div>

<span class="k">def</span> <span class="nf">check_lss_precision</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
    <span class="k">return</span> <span class="n">lss</span><span class="o">.</span><span class="n">check_precision</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">check_power_precision</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>
    <span class="k">return</span> <span class="n">power</span><span class="o">.</span><span class="n">check_precision</span><span class="p">()</span>

<span class="c1"># from GadgetPkOverlapBinner</span>
<span class="k">def</span> <span class="nf">read_gadget_pk</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">minModeCountA</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">minModeCountB</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">targetBinNumberA</span><span class="o">=</span><span class="mi">125</span><span class="p">,</span> <span class="n">targetBinNumberB</span><span class="o">=</span><span class="mi">125</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_PowerBin</span><span class="p">(</span><span class="n">Bins</span><span class="p">,</span> <span class="n">MinDlogK</span><span class="p">,</span> <span class="n">MinModeCount</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">istart</span><span class="p">]</span>
        <span class="n">K_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Delta2_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ModeCount</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">SumPower</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">ConvFac</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">Specshape</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">istart</span> <span class="o">&lt;</span> <span class="n">Bins</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ModeCount</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">deltak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">deltak</span> <span class="o">&gt;=</span> <span class="n">MinDlogK</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MinModeCount</span><span class="p">:</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">SumPower</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">ModeCount</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ind</span><span class="o">*</span><span class="n">ModeCount</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">ModeCount</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">ConvFac</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="n">d2</span><span class="o">*</span><span class="n">Specshape</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                <span class="n">K_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">K_list</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
                <span class="n">Delta2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Delta2_list</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
                <span class="n">count_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_list</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ModeCount</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
                <span class="n">istart</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">istart</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">istart</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_list</span><span class="p">,</span> <span class="n">Delta2_list</span><span class="p">,</span> <span class="n">count_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">fi</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">time1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="n">binsA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="n">dummyL</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

    <span class="n">lines1</span> <span class="o">=</span> <span class="p">[</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binsA</span><span class="p">)]</span>
    <span class="n">da1</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines1</span><span class="p">))]</span>

    <span class="n">time2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="n">binsB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="n">dummyL</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

    <span class="n">lines2</span> <span class="o">=</span> <span class="p">[</span><span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binsB</span><span class="p">)]</span>
    <span class="n">da2</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines2</span><span class="p">))]</span>

    <span class="n">fi</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">da1A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">da1</span><span class="p">)</span>
    <span class="n">da1B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">da2</span><span class="p">)</span>

    <span class="n">columnsA</span> <span class="o">=</span> <span class="p">[</span><span class="n">da1A</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>  <span class="c1"># extract each column of the A array from text file</span>
    <span class="n">K_A</span><span class="p">,</span> <span class="n">Delta2_A</span><span class="p">,</span> <span class="n">Shot_A</span><span class="p">,</span> <span class="n">ModePow_A</span><span class="p">,</span> <span class="n">ModeCount_A</span><span class="p">,</span> <span class="n">Delta2Uncorrected_A</span><span class="p">,</span> <span class="n">ModePowUncorrected_A</span><span class="p">,</span> <span class="n">Specshape_A</span><span class="p">,</span> <span class="n">SumPower_A</span><span class="p">,</span> <span class="n">ConvFac_A</span> <span class="o">=</span> <span class="n">columnsA</span>

    <span class="n">columnsB</span> <span class="o">=</span> <span class="p">[</span><span class="n">da1B</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>  <span class="c1"># extract each column of the B array from text file</span>
    <span class="n">K_B</span><span class="p">,</span> <span class="n">Delta2_B</span><span class="p">,</span> <span class="n">Shot_B</span><span class="p">,</span> <span class="n">ModePow_B</span><span class="p">,</span> <span class="n">ModeCount_B</span><span class="p">,</span> <span class="n">Delta2Uncorrected_B</span><span class="p">,</span> <span class="n">ModePowUncorrected_B</span><span class="p">,</span> <span class="n">Specshape_B</span><span class="p">,</span> <span class="n">SumPower_B</span><span class="p">,</span> <span class="n">ConvFac_B</span> <span class="o">=</span> <span class="n">columnsB</span>

    <span class="n">MinDlogK_A</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">K_A</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">K_A</span><span class="p">)))</span><span class="o">/</span><span class="n">targetBinNumberA</span>
    <span class="n">MinDlogK_B</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">K_B</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">K_B</span><span class="p">)))</span><span class="o">/</span><span class="n">targetBinNumberB</span>

    <span class="n">K_list_A</span><span class="p">,</span> <span class="n">Delta2_list_A</span><span class="p">,</span> <span class="n">count_list_A</span> <span class="o">=</span> <span class="n">_PowerBin</span><span class="p">(</span><span class="n">binsA</span><span class="p">,</span> <span class="n">MinDlogK_A</span><span class="p">,</span> <span class="n">minModeCountA</span><span class="p">,</span> <span class="n">columnsA</span><span class="p">)</span>

    <span class="n">K_list_B</span><span class="p">,</span> <span class="n">Delta2_list_B</span><span class="p">,</span> <span class="n">count_list_B</span> <span class="o">=</span> <span class="n">_PowerBin</span><span class="p">(</span><span class="n">binsB</span><span class="p">,</span> <span class="n">MinDlogK_B</span><span class="p">,</span> <span class="n">minModeCountB</span><span class="p">,</span> <span class="n">columnsB</span><span class="p">)</span>

    <span class="n">shotFunc</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">K_B</span><span class="p">,</span> <span class="n">Shot_B</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

    <span class="n">DA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Delta2_list_A</span><span class="p">)</span>
    <span class="n">KA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">K_list_A</span><span class="p">)</span>
    <span class="n">countA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">count_list_A</span><span class="p">)</span>
    <span class="n">KB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">K_list_B</span><span class="p">)</span>
    <span class="n">DB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Delta2_list_B</span><span class="p">)</span>
    <span class="n">countB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">count_list_B</span><span class="p">)</span>
    <span class="n">PKA</span> <span class="o">=</span> <span class="n">DA</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">KA</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">PKB</span> <span class="o">=</span> <span class="n">DB</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">KB</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">3</span>
    <span class="k">return</span> <span class="n">DA</span><span class="p">,</span> <span class="n">KA</span><span class="p">,</span> <span class="n">PKA</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="n">KB</span><span class="p">,</span> <span class="n">PKB</span><span class="p">,</span> <span class="n">shotFunc</span><span class="p">,</span> <span class="n">countA</span><span class="p">,</span> <span class="n">countB</span><span class="p">,</span> <span class="n">time1</span>


<span class="k">def</span> <span class="nf">nearest_neighbour</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the index and the distance to the nearest neighbour in a N-dimensional space</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dist</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">crossmatch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">neighbour</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># From pyDOE</span>


<span class="k">def</span> <span class="nf">latinhypercube</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spread</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_spread_lh</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">max_niter</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>

        <span class="n">nrejected</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_dist</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="n">dist</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">nearest_neighbour</span><span class="p">(</span><span class="n">values</span><span class="p">[:,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]])</span>
                <span class="n">total_dist</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_niter</span><span class="p">):</span>
            <span class="c1"># We select two random points without replacement</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Let&#39;s swap values and accept it if it creates a more homogeneous distribution</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
                <span class="n">values</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">dim</span><span class="p">]</span>
                <span class="n">new_total_dist</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                        <span class="n">dist</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">nearest_neighbour</span><span class="p">(</span><span class="n">values</span><span class="p">[:,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]])</span>
                        <span class="n">new_total_dist</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">new_total_dist</span> <span class="o">&lt;</span> <span class="n">total_dist</span><span class="p">):</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">dim</span><span class="p">]</span>
                    <span class="n">nrejected</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">nrejected</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nrejected</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">total_dist</span> <span class="o">=</span> <span class="n">new_total_dist</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="c1"># Generate the intervals</span>
    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">samples</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Fill points uniformly in each interval</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">cut</span><span class="p">[:</span><span class="n">samples</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">cut</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">samples</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">rdpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">rdpoints</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span>

    <span class="c1"># Make the random pairings</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rdpoints</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
        <span class="n">H</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdpoints</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">spread</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">_spread_lh</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">*</span><span class="p">(</span><span class="n">limits</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limits</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">limits</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">H</span>


<span class="k">def</span> <span class="nf">count_particles_per_bin</span><span class="p">(</span><span class="n">rel_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centr_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">part_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">particle_mass</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function assign a field of particles to different radial bins, providing a center</span>
<span class="sd">    and the shells position. The first shell is ignored, but its number count can be returned</span>
<span class="sd">    with the option first_bin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.baryons</span> <span class="k">import</span> <span class="n">check_boundaries</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">check_boundaries</span><span class="p">(</span><span class="n">part_pos</span> <span class="o">-</span> <span class="n">centr_pos</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span> <span class="k">if</span> <span class="n">rel_pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rel_pos</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pos</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dist</span>
    <span class="k">if</span> <span class="n">shells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">shells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">shells</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">particles_per_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">shells</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># counts number of the particles per bin</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shells</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">ri</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">shells</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">particles_per_bin</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">particle_mass</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles_per_bin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#number of particles in each radial bin</span>
    <span class="k">return</span> <span class="n">particles_per_bin</span><span class="p">,</span> <span class="n">counts</span>


<span class="k">def</span> <span class="nf">measure_averaged_profiles</span><span class="p">(</span><span class="n">shells</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">particle_mass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_pts_in_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vshells</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">shells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="n">shells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">shells</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">shells</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shells</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">vshells</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="p">(</span><span class="n">shells</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span><span class="n">shells</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">vshells</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vshells</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">particle_mass</span> <span class="o">/</span> <span class="n">vshells</span> <span class="o">*</span> <span class="n">counts</span>
    <span class="n">mass</span> <span class="o">=</span>  <span class="n">particle_mass</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">min_pts_in_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">&gt;=</span> <span class="n">min_pts_in_bin</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;rho&#39;</span><span class="p">:</span><span class="n">rho</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="n">shells</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mass</span><span class="p">}</span>



<span class="k">def</span> <span class="nf">crossmatch</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">neighbour</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">cKDTree</span>

    <span class="sd">&quot;&quot;&quot;Cross-match the values between X1 and X2</span>

<span class="sd">    By default, this uses a KD Tree for speed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X1 : array_like</span>
<span class="sd">        first dataset, shape(N1, D)</span>
<span class="sd">    X2 : array_like</span>
<span class="sd">        second dataset, shape(N2, D)</span>
<span class="sd">    max_distance : float (optional)</span>
<span class="sd">        maximum radius of search.  If no point is within the given radius,</span>
<span class="sd">        then inf will be returned.</span>

<span class="sd">    Returns</span>



<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dist, ind: ndarrays</span>
<span class="sd">        The distance and index of the closest point in X2 to each point in X1</span>
<span class="sd">        Both arrays are length N1.</span>
<span class="sd">        Locations with no match are indicated by</span>
<span class="sd">        dist[i] = inf, ind[i] = N2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">N1</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">X1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">N2</span><span class="p">,</span> <span class="n">D2</span> <span class="o">=</span> <span class="n">X2</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">D</span> <span class="o">!=</span> <span class="n">D2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Arrays must have the same second dimension&#39;</span><span class="p">)</span>

    <span class="n">kdt</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">X2</span><span class="p">)</span>

    <span class="n">dist</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">kdt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">neighbour</span><span class="p">),</span> <span class="n">distance_upper_bound</span><span class="o">=</span><span class="n">max_distance</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">ind</span>


<span class="k">def</span> <span class="nf">load_powerspec_MS</span><span class="p">(</span><span class="n">redshift</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">redshift</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Only data for z=0 and 1 available at the moment&quot;</span><span class="p">)</span>

    <span class="c1"># Load data</span>
    <span class="k">if</span> <span class="n">redshift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">zname</span> <span class="o">=</span> <span class="s2">&quot;z0&quot;</span>
    <span class="k">if</span> <span class="n">redshift</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">zname</span> <span class="o">=</span> <span class="s2">&quot;z1&quot;</span>
    <span class="n">k_mxxl</span><span class="p">,</span> <span class="n">pk_mxxl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;../testdata/powerspectra/pk_MS/&quot;</span> <span class="o">+</span>
                                 <span class="n">zname</span><span class="o">+</span><span class="s2">&quot;_mxxl_pk.txt&quot;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">k_ms</span><span class="p">,</span> <span class="n">pk_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;../testdata/powerspectra/pk_MS/&quot;</span><span class="o">+</span><span class="n">zname</span> <span class="o">+</span>
                             <span class="s2">&quot;_ms_pk.txt&quot;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1">#k_ms2, pk_ms2 = np.loadtxt(&quot;../testdata/powerspectra/pk_MS/&quot;+zname+&quot;_msII_pk.txt&quot;, unpack=True, usecols=(0,1))</span>
    <span class="n">k_lt</span><span class="p">,</span> <span class="n">pk_lt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;../testdata/powerspectra/pk_MS/billennium_powspec&quot;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MXXL&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_mxxl</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pk_mxxl</span><span class="p">},</span>
            <span class="s1">&#39;Lt&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="n">k_lt</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="mf">1.2532593</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">pk_lt</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">k_lt</span><span class="p">)},</span>
            <span class="s1">&#39;MS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_ms</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pk_ms</span><span class="p">}}</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">create_gaussian_field</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="mf">100.</span><span class="p">):</span>

    <span class="n">ngrid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">box</span><span class="o">/</span><span class="n">ngrid</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))))</span>
    <span class="n">kmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">fft_of_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kmod</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">fft_of_rho</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">kmod</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
    <span class="n">fft_of_rho</span> <span class="o">=</span> <span class="n">fft_of_rho</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfftn</span><span class="p">(</span><span class="n">fft_of_rho</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grid</span>


<div class="viewcode-block" id="read_parameter_file"><a class="viewcode-back" href="../../code.html#bacco.utils.read_parameter_file">[docs]</a><span class="k">def</span> <span class="nf">read_parameter_file</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the parameters file of a simulation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">pars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">pars</span></div>

<div class="viewcode-block" id="remove_IDs_HDF5"><a class="viewcode-back" href="../../code.html#bacco.utils.remove_IDs_HDF5">[docs]</a><span class="k">def</span> <span class="nf">remove_IDs_HDF5</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snaplist</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lastsnap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pair</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delect IDs folder from the groups in the HDF5 files.</span>

<span class="sd">    BETA! not elegant (not even close...) needs h5repack installed</span>

<span class="sd">    basedir:   The directory of the simulation, eg. /scratch/user/LCDM_L04096N32768</span>
<span class="sd">    halo_file: The name of the halofile of ANY snapshot (even if it is not in snaplist), eg.</span>
<span class="sd">    groups_001/fof_subhalo_history_tab_orph_wweight_001</span>
<span class="sd">    snaplist:  The list of snapshots to clean, eg. [7,14,21]</span>
<span class="sd">    lastsnap:  The final snapshot to clean, eg. 100. Use snaplist OR lastsnap</span>
<span class="sd">    pair:      If there are Pair simulations</span>
<span class="sd">    verbose:   verbose</span>

<span class="sd">    If snaplist is given, it will fix only a particular set of snapshots.</span>
<span class="sd">    If lastsnap is given, it will fix all snapshot untill that snapshot (included)</span>
<span class="sd">    if a snapshot is missing, the code will *not* stop</span>
<span class="sd">    If neither snaplist or lastsnap is given, the code will run from group_000 until</span>
<span class="sd">    there is no groups</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pair</span><span class="p">:</span>
        <span class="n">remove_IDs_HDF5</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">snaplist</span> <span class="o">=</span> <span class="n">snaplist</span><span class="p">,</span> <span class="n">lastsnap</span> <span class="o">=</span> <span class="n">lastsnap</span><span class="p">,</span> <span class="n">pair</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">remove_IDs_HDF5</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span><span class="s1">&#39;3.14&#39;</span><span class="p">),</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">snaplist</span> <span class="o">=</span> <span class="n">snaplist</span><span class="p">,</span> <span class="n">lastsnap</span> <span class="o">=</span> <span class="n">lastsnap</span><span class="p">,</span> <span class="n">pair</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="kn">import</span> <span class="nn">h5py</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">system</span> <span class="k">as</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="n">s_path</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">halo_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">s_file</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">halo_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s%03d</span><span class="s1">/</span><span class="si">%s%03d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span><span class="n">s_path</span><span class="p">,</span><span class="n">snap</span><span class="p">,</span><span class="n">s_file</span><span class="p">,</span><span class="n">snap</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">snaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lastsnap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;use snaplist or lastsnap, not both&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snaplist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lastsnap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">snaplist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lastsnap</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">snaplist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">snaplist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">snap</span> <span class="ow">in</span> <span class="n">snaplist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In snap </span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">snap</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File: </span><span class="si">%s</span><span class="s2"> does not exist &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">snaplist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lastsnap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stoping remove_IDs_HDF5&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;moving to the next snapshot&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>  <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nfiles</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;IDs&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;IDs&#39;</span><span class="p">][</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;IDs&#39;</span><span class="p">]</span>
        <span class="n">s</span><span class="p">(</span><span class="s1">&#39;h5repack </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/tmp.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">basedir</span><span class="p">))</span>
        <span class="n">s</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">%s</span><span class="s1">/tmp.hdf5 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nfiles</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="n">i</span><span class="p">),</span>  <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">nfiles</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;IDs&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;IDs&#39;</span><span class="p">][</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;IDs&#39;</span><span class="p">]</span>
            <span class="n">s</span><span class="p">(</span><span class="s1">&#39;h5repack </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/tmp.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="n">basedir</span><span class="p">))</span>
            <span class="n">s</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">%s</span><span class="s1">/tmp.hdf5 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span><span class="n">fof_filename</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span><span class="n">i</span><span class="p">)))</span></div>

<span class="k">def</span> <span class="nf">create_hdf5_halofile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
    <span class="kn">import</span> <span class="nn">gc</span>
    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="k">assert</span> <span class="n">fname</span> <span class="o">!=</span> <span class="n">sim</span><span class="o">.</span><span class="n">halo_file</span><span class="p">,</span> <span class="s1">&#39;I don</span><span class="se">\&#39;</span><span class="s1">t think you want to overwrite this file.&#39;</span>
    <span class="k">assert</span> <span class="n">sim</span><span class="o">.</span><span class="n">use_orphans</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Since you are not saving </span><span class="se">\&#39;</span><span class="s1">SnapBecameOrphan</span><span class="se">\&#39;</span><span class="s1">, you must keep only subs that are not orphans&#39;</span>

    <span class="n">not_orphan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;orphan_snap&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vthreshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">not_orphan</span><span class="p">])[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mf">5e-3</span><span class="p">)]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">][</span><span class="n">not_orphan</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vthreshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nfiles&#39;</span><span class="p">]):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">halo_file</span><span class="o">+</span><span class="s1">&#39;.</span><span class="si">%i</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">not_orphan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;SnapBecameOrphan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">not_orphan</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vthreshold</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">==</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.</span><span class="si">%i</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">a1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Config&#39;</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Parameters&#39;</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Header&#39;</span><span class="p">)</span>

        <span class="n">g1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">)</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">)</span>
        <span class="n">g3</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;IDs&#39;</span><span class="p">)</span>
        <span class="n">g4</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;sDM&#39;</span><span class="p">)</span>

        <span class="p">[</span> <span class="n">a1</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="p">[</span> <span class="n">a2</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="p">[</span> <span class="n">a3</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubsampledLen&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;SubsampledLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubsampledOffset&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;SubsampledOffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;GroupPos&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;GroupVel&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;GroupLen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Group_M_Crit200&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">][</span><span class="s1">&#39;Group_M_Crit200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">g2</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">not_orphan</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">g2</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubhaloVel&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">not_orphan</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">g2</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">][</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">not_orphan</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

        <span class="n">g4</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Pos&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="s1">&#39;Pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">g4</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;IDs&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;sDM&#39;</span><span class="p">][</span><span class="s1">&#39;IDs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">hf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_hdf5_subfile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
    <span class="kn">import</span> <span class="nn">gc</span>

    <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_ThisFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Nsubgroups_Total&#39;</span><span class="p">]</span>

    <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Config&#39;</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Parameters&#39;</span><span class="p">)</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Header&#39;</span><span class="p">)</span>

    <span class="n">g1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">)</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Subhalo&#39;</span><span class="p">)</span>
    <span class="n">g3</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;IDs&#39;</span><span class="p">)</span>
    <span class="n">g4</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;sDM&#39;</span><span class="p">)</span>

    <span class="p">[</span> <span class="n">a1</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="p">[</span> <span class="n">a2</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="p">[</span> <span class="n">a3</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">g2</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubhaloPos&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>
    <span class="k">del</span> <span class="n">sub</span><span class="o">.</span><span class="n">_raw_dict</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">g2</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubhaloVel&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span>
    <span class="k">del</span> <span class="n">sub</span><span class="o">.</span><span class="n">_raw_dict</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">g2</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;SubhaloVpeak&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;vpeak&#39;</span><span class="p">])</span>
    <span class="n">hf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">param_dict_from_file</span><span class="p">(</span><span class="n">paramfile</span><span class="p">,</span> <span class="n">skipparam</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Read file without comments</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">paramfile</span><span class="p">):</span>
        <span class="n">li</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">li</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">paramtxt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1"># Use regular expressions to parse file</span>

    <span class="k">def</span> <span class="nf">find_param</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">re</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;^</span><span class="si">%s</span><span class="s2">\s+(\S*)\s*&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find </span><span class="si">%s</span><span class="s2"> -- setting to -1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param</span><span class="p">,))</span>
            <span class="k">return</span> <span class="s2">&quot;-1&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found multiple values for </span><span class="si">%s</span><span class="s2"> -- setting it to -1&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;-1&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="n">params_float</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;BoxSize&quot;</span><span class="p">,</span> <span class="s2">&quot;Omega0&quot;</span><span class="p">,</span> <span class="s2">&quot;OmegaLambda&quot;</span><span class="p">,</span> <span class="s2">&quot;OmegaBaryon&quot;</span><span class="p">,</span> <span class="s2">&quot;HubbleParam&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;CpuTimeBetRestartFile&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;TimeBegin&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeMax&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeBetSnapshot&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeOfFirstSnapshot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;TimeBetStatistics&quot;</span><span class="p">,</span> <span class="s2">&quot;ErrTolIntAccuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;MaxSizeTimestep&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MinSizeTimestep&quot;</span><span class="p">,</span> <span class="s2">&quot;MaxRMSDisplacementFac&quot;</span><span class="p">,</span> <span class="s2">&quot;ErrTolTheta&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ErrTolForceAcc&quot;</span><span class="p">,</span> <span class="s2">&quot;PartAllocFactor&quot;</span><span class="p">,</span> <span class="s2">&quot;BufferSize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;UnitLength_in_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;UnitMass_in_g&quot;</span><span class="p">,</span> <span class="s2">&quot;UnitVelocity_in_cm_per_s&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;GravityConstantInternal&quot;</span><span class="p">,</span> <span class="s2">&quot;ErrTolThetaSubfind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;w0&quot;</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">,</span> <span class="s2">&quot;FixedInitialAmplitude&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">,</span> <span class="s2">&quot;InitPhase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;InputSpectrum_UnitLength_in_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;Sigma8&quot;</span><span class="p">,</span> <span class="s2">&quot;As&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;OmegaBaryonCAMB&quot;</span><span class="p">,</span> <span class="s2">&quot;MNue&quot;</span><span class="p">,</span> <span class="s2">&quot;MNum&quot;</span><span class="p">,</span> <span class="s2">&quot;MNut&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeTransfer&quot;</span><span class="p">)</span>
    <span class="n">params_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;InitCondFile&quot;</span><span class="p">,</span> <span class="s2">&quot;OutputDir&quot;</span><span class="p">,</span> <span class="s2">&quot;SnapshotFileBase&quot;</span><span class="p">,</span> <span class="s2">&quot;EnergyFile&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;InfoFile&quot;</span><span class="p">,</span> <span class="s2">&quot;TimingsFile&quot;</span><span class="p">,</span> <span class="s2">&quot;CpuFile&quot;</span><span class="p">,</span> <span class="s2">&quot;MemFile&quot;</span><span class="p">,</span> <span class="s2">&quot;RestartFile&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;ResubmitCommand&quot;</span><span class="p">,</span> <span class="s2">&quot;OutputListFilename&quot;</span><span class="p">,</span> <span class="s2">&quot;FileWithInputSpectrum&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;FileWithInputGrowthRate&quot;</span><span class="p">,</span> <span class="s2">&quot;KspaceTransferFunction&quot;</span><span class="p">)</span>
    <span class="n">params_int</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;NumFilesWrittenInParallel&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeLimitCPU&quot;</span><span class="p">,</span> <span class="s2">&quot;ResubmitOn&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;UseRadiation&quot;</span><span class="p">,</span> <span class="s2">&quot;UseCola&quot;</span><span class="p">,</span> <span class="s2">&quot;ICFormat&quot;</span><span class="p">,</span> <span class="s2">&quot;SnapFormat&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;MaxMemSize&quot;</span><span class="p">,</span> <span class="s2">&quot;OutputListOn&quot;</span><span class="p">,</span> <span class="s2">&quot;TypeOfOpeningCriterion&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;MaxNumNgbDeviation&quot;</span><span class="p">,</span> <span class="s2">&quot;DesNumNgb&quot;</span><span class="p">,</span> <span class="s2">&quot;DesLinkNgb&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;ICmesh&quot;</span><span class="p">,</span> <span class="s2">&quot;Nsample&quot;</span><span class="p">,</span> <span class="s2">&quot;WhichSpectrum&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;ReNormalizeInputSpectrum&quot;</span><span class="p">,</span> <span class="s2">&quot;SphereMode&quot;</span><span class="p">,</span> <span class="s2">&quot;Seed&quot;</span><span class="p">)</span>
    <span class="n">params_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Softening&quot;</span><span class="p">:</span><span class="s2">&quot;SofteningHalo&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;SofteningMaxPhys&quot;</span><span class="p">:</span><span class="s2">&quot;SofteningHaloMaxPhys&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;PMmesh&quot;</span><span class="p">:</span><span class="s2">&quot;Nmesh&quot;</span><span class="p">}</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipparam</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">find_param</span><span class="p">(</span><span class="n">paramtxt</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipparam</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_param</span><span class="p">(</span><span class="n">paramtxt</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipparam</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">find_param</span><span class="p">(</span><span class="n">paramtxt</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_map</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipparam</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">find_param</span><span class="p">(</span><span class="n">paramtxt</span><span class="p">,</span> <span class="n">params_map</span><span class="p">[</span><span class="n">param</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">params</span>

<span class="k">def</span> <span class="nf">default_params</span><span class="p">():</span>
    <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;This function has not been implemented yet&quot;</span>

    <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Output options</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InitCondFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_conditions_file</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OutputDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputdir</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SnapshotFileBase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;snapshot&quot;</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;EnergyFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;energy.txt&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InfoFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;info.txt&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimingsFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;timings.txt&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CpuFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cpu.txt&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MemFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;memory.txt&quot;</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RestartFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;restart&quot;</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;NumFilesWrittenInParallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeLimitCPU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">430000</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CpuTimeBetRestartFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7200.0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ResubmitOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ResubmitCommand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span>

    <span class="c1"># Code options</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UseRadiation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UseCola&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ICFormat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SnapFormat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxMemSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MaxMemSize</span>

    <span class="c1"># Characteristics of run</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeBegin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TimeBegin</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TimeEnd</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OmegaLambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxsize</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>

    <span class="c1"># Output frequency</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OutputListFilename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlist_file</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OutputListOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">outlist_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeBetSnapshot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeOfFirstSnapshot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.05 0.021 0.1&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeBetStatistics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># Accuracy of time integration</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolIntAccuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ErrTolIntAccuracy</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxSizeTimestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_timestep</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MinSizeTimestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxRMSDisplacementFac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="c1"># Tree algorithm and force accuracy</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolTheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TypeOfOpeningCriterion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolForceAcc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ErrTolForceAcc</span>

    <span class="c1"># Parameters that affect memory usage of the code</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;PartAllocFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PartAllocFactor</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BufferSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;PMmesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">npart</span>

    <span class="c1"># System of units</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.085678e24</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitMass_in_g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.989e43</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitVelocity_in_cm_per_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e5</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GravityConstantInternal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># SUBFIND parameters</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolThetaSubfind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxNumNgbDeviation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DesNumNgb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DesNumNgb</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DesLinkNgb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DesLinkNgb</span>

    <span class="c1"># ICs parameters</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ICmesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npart</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npart</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;FixedInitialAmplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_amplitude</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;FileWithInputSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">powerspectrum_file</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;FileWithInputGrowthRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">growthrate_file</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;WhichSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Means reading it from FileWithInputSpectrum</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InitPhase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_phase</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InputSpectrum_UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.085678e24</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SphereMode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">424</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">seed</span>

    <span class="c1"># Massive neutrinos</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InputSpectrum_UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.085678e24</span>  <span class="c1"># 1.0 Mpc</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;KspaceTransferFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transfer_file</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeTransfer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TimeBegin</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OmegaBaryonCAMB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MNue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>  <span class="c1"># degenerate case</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MNum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>  <span class="c1"># degenerate case</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MNut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>  <span class="c1"># degenerate case</span>

    <span class="k">return</span> <span class="n">pars</span>

<span class="k">def</span> <span class="nf">create_hdf5_dmfile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">pmass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">writeparam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Todo for this function</span>
    <span class="c1"># make sure that it can be called with less requirements and using some default</span>
    <span class="c1"># variables. Also make it more flexible</span>

    <span class="kn">import</span> <span class="nn">h5py</span>
    <span class="kn">import</span> <span class="nn">gc</span>

    <span class="n">myheader</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">myparams</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">pmass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">myheader</span><span class="p">[</span><span class="s2">&quot;MassTable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pmass</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>

    <span class="n">myheader</span><span class="p">[</span><span class="s1">&#39;NumFilesPerSnapshot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">myheader</span><span class="p">[</span><span class="s1">&#39;NumFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">myheader</span><span class="p">[</span><span class="s2">&quot;NumPart_ThisFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dm</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1">#myheader[&quot;NumPart_ThisFile_HighWord&quot;] = [0, dm[&quot;pos&quot;].shape[0] &gt;&gt; 32, 0, 0, 0, 0]</span>
    <span class="n">myheader</span><span class="p">[</span><span class="s2">&quot;NumPart_Total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dm</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">myheader</span><span class="p">[</span><span class="s2">&quot;NumPart_Total_HighWord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dm</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">myparams</span><span class="p">[</span><span class="s2">&quot;ICFormat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">myparams</span><span class="p">[</span><span class="s2">&quot;SnapFormat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">myparams</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FWRITE_SIZELIMIT&#39;</span><span class="p">:</span><span class="mf">500.</span><span class="p">}</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Config&#39;</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Parameters&#39;</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Header&#39;</span><span class="p">)</span>

        <span class="n">g1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;PartType1&#39;</span><span class="p">)</span>

        <span class="p">[</span> <span class="n">a1</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="p">[</span> <span class="n">a2</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">myparams</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">myparams</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="p">[</span> <span class="n">a3</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">myheader</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">myheader</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Coordinates&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Velocities&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ParticleIDs&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">writeparam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">write_parameter_file</span><span class="p">(</span><span class="n">writeparam</span><span class="p">,</span> <span class="n">myparams</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">tree_main_branch</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="n">nids</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">snap</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">vpeak</span><span class="p">,</span> <span class="n">mbid</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">k</span>
    <span class="k">while</span> <span class="n">prog</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">slen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;Len&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">])</span>
        <span class="n">snap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;SnapNum&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">])</span>
        <span class="n">vmax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;Vmax&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">])</span>
        <span class="n">vpeak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;VelDisp&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">])</span>
        <span class="n">mbid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;SubMostBoundID&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">])</span>
        <span class="n">nids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prog</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>  <span class="c1"># means firts iteration</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;Pos&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;Vel&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;Pos&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">,</span> <span class="p">:]]))</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">vel</span><span class="p">,</span> <span class="p">[</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;Vel&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">,</span> <span class="p">:]]))</span>

        <span class="n">prog</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;FirstProgenitor&#39;</span><span class="p">][</span><span class="n">prog</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">nids</span><span class="p">,</span> <span class="n">snap</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">vpeak</span><span class="p">,</span> <span class="n">mbid</span>




<span class="k">def</span> <span class="nf">create_simulation</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">TimeBegin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">npart</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">boxsize</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">TimeEnd</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">tetrad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ReNormalizeInputSpectrum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numsnaps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">outlist_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aa_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subfind_history_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_timestep</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">use_cola</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_radiation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fixed_init_amplitude</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gadget4</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="s1">&#39;DIPC&#39;</span><span class="p">,</span>
                      <span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">softening</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ErrTolIntAccuracy</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">ErrTolForceAcc</span><span class="o">=</span><span class="mf">0.0025</span><span class="p">,</span> <span class="n">DesLinkNgb</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">use_reps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simple_name</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">MaxMemSize</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">PartAllocFactor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">DesNumNgb</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">onlyGroups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initial_conditions_file</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">paired</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">tetrad</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">par1</span> <span class="o">=</span> <span class="n">create_simulation</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">TimeBegin</span><span class="o">=</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="n">npart</span><span class="o">=</span><span class="n">npart</span><span class="p">,</span> <span class="n">boxsize</span><span class="o">=</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">TimeEnd</span><span class="o">=</span><span class="n">TimeEnd</span><span class="p">,</span>
                                 <span class="n">phase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ReNormalizeInputSpectrum</span><span class="o">=</span><span class="n">ReNormalizeInputSpectrum</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">=</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">use_reps</span><span class="o">=</span><span class="n">use_reps</span><span class="p">,</span>
                                 <span class="n">numsnaps</span><span class="o">=</span><span class="n">numsnaps</span><span class="p">,</span> <span class="n">outlist_file</span><span class="o">=</span><span class="n">outlist_file</span><span class="p">,</span> <span class="n">aa_list</span><span class="o">=</span><span class="n">aa_list</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
                                 <span class="n">subfind_history_mode</span><span class="o">=</span><span class="n">subfind_history_mode</span><span class="p">,</span> <span class="n">max_timestep</span><span class="o">=</span><span class="n">max_timestep</span><span class="p">,</span> <span class="n">use_cola</span><span class="o">=</span><span class="n">use_cola</span><span class="p">,</span>
                                 <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">use_radiation</span><span class="o">=</span><span class="n">use_radiation</span><span class="p">,</span> <span class="n">DesLinkNgb</span> <span class="o">=</span> <span class="n">DesLinkNgb</span><span class="p">,</span>
                                 <span class="n">fixed_init_amplitude</span><span class="o">=</span><span class="n">fixed_init_amplitude</span><span class="p">,</span> <span class="n">gadget4</span><span class="o">=</span><span class="n">gadget4</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">simple_name</span> <span class="o">=</span> <span class="n">simple_name</span><span class="p">,</span>
                                 <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span> <span class="n">softening</span><span class="o">=</span><span class="n">softening</span><span class="p">,</span> <span class="n">ErrTolIntAccuracy</span><span class="o">=</span><span class="n">ErrTolIntAccuracy</span><span class="p">,</span> <span class="n">ErrTolForceAcc</span><span class="o">=</span><span class="n">ErrTolForceAcc</span><span class="p">,</span>
                                 <span class="n">MaxMemSize</span><span class="o">=</span><span class="n">MaxMemSize</span><span class="p">,</span> <span class="n">PartAllocFactor</span><span class="o">=</span><span class="n">PartAllocFactor</span><span class="p">,</span> <span class="n">DesNumNgb</span><span class="o">=</span><span class="n">DesNumNgb</span><span class="p">,</span> <span class="n">onlyGroups</span><span class="o">=</span><span class="n">onlyGroups</span><span class="p">)</span>
        <span class="n">par2</span> <span class="o">=</span> <span class="n">create_simulation</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">TimeBegin</span><span class="o">=</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="n">npart</span><span class="o">=</span><span class="n">npart</span><span class="p">,</span> <span class="n">boxsize</span><span class="o">=</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">TimeEnd</span><span class="o">=</span><span class="n">TimeEnd</span><span class="p">,</span>
                                 <span class="n">phase</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ReNormalizeInputSpectrum</span><span class="o">=</span><span class="n">ReNormalizeInputSpectrum</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">=</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">use_reps</span><span class="o">=</span><span class="n">use_reps</span><span class="p">,</span>
                                 <span class="n">numsnaps</span><span class="o">=</span><span class="n">numsnaps</span><span class="p">,</span> <span class="n">outlist_file</span><span class="o">=</span><span class="n">outlist_file</span><span class="p">,</span> <span class="n">aa_list</span><span class="o">=</span><span class="n">aa_list</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
                                 <span class="n">subfind_history_mode</span><span class="o">=</span><span class="n">subfind_history_mode</span><span class="p">,</span> <span class="n">max_timestep</span><span class="o">=</span><span class="n">max_timestep</span><span class="p">,</span> <span class="n">use_cola</span><span class="o">=</span><span class="n">use_cola</span><span class="p">,</span>
                                 <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">use_radiation</span><span class="o">=</span><span class="n">use_radiation</span><span class="p">,</span> <span class="n">DesLinkNgb</span> <span class="o">=</span> <span class="n">DesLinkNgb</span><span class="p">,</span>
                                 <span class="n">fixed_init_amplitude</span><span class="o">=</span><span class="n">fixed_init_amplitude</span><span class="p">,</span> <span class="n">gadget4</span><span class="o">=</span><span class="n">gadget4</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">simple_name</span> <span class="o">=</span> <span class="n">simple_name</span><span class="p">,</span>
                                 <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span> <span class="n">softening</span><span class="o">=</span><span class="n">softening</span><span class="p">,</span> <span class="n">ErrTolIntAccuracy</span><span class="o">=</span><span class="n">ErrTolIntAccuracy</span><span class="p">,</span> <span class="n">ErrTolForceAcc</span><span class="o">=</span><span class="n">ErrTolForceAcc</span><span class="p">,</span>
                                 <span class="n">MaxMemSize</span><span class="o">=</span><span class="n">MaxMemSize</span><span class="p">,</span> <span class="n">PartAllocFactor</span><span class="o">=</span><span class="n">PartAllocFactor</span><span class="p">,</span> <span class="n">DesNumNgb</span><span class="o">=</span><span class="n">DesNumNgb</span><span class="p">,</span> <span class="n">onlyGroups</span><span class="o">=</span><span class="n">onlyGroups</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tetrad</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">par3</span> <span class="o">=</span> <span class="n">create_simulation</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">TimeBegin</span><span class="o">=</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="n">npart</span><span class="o">=</span><span class="n">npart</span><span class="p">,</span> <span class="n">boxsize</span><span class="o">=</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">TimeEnd</span><span class="o">=</span><span class="n">TimeEnd</span><span class="p">,</span>
                                     <span class="n">phase</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ReNormalizeInputSpectrum</span><span class="o">=</span><span class="n">ReNormalizeInputSpectrum</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">=</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">use_reps</span><span class="o">=</span><span class="n">use_reps</span><span class="p">,</span>
                                     <span class="n">numsnaps</span><span class="o">=</span><span class="n">numsnaps</span><span class="p">,</span> <span class="n">outlist_file</span><span class="o">=</span><span class="n">outlist_file</span><span class="p">,</span> <span class="n">aa_list</span><span class="o">=</span><span class="n">aa_list</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
                                     <span class="n">subfind_history_mode</span><span class="o">=</span><span class="n">subfind_history_mode</span><span class="p">,</span> <span class="n">max_timestep</span><span class="o">=</span><span class="n">max_timestep</span><span class="p">,</span> <span class="n">use_cola</span><span class="o">=</span><span class="n">use_cola</span><span class="p">,</span>
                                     <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">use_radiation</span><span class="o">=</span><span class="n">use_radiation</span><span class="p">,</span> <span class="n">DesLinkNgb</span> <span class="o">=</span> <span class="n">DesLinkNgb</span><span class="p">,</span>
                                     <span class="n">fixed_init_amplitude</span><span class="o">=</span><span class="n">fixed_init_amplitude</span><span class="p">,</span> <span class="n">gadget4</span><span class="o">=</span><span class="n">gadget4</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
                                     <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span> <span class="n">softening</span><span class="o">=</span><span class="n">softening</span><span class="p">,</span> <span class="n">ErrTolIntAccuracy</span><span class="o">=</span><span class="n">ErrTolIntAccuracy</span><span class="p">,</span> <span class="n">ErrTolForceAcc</span><span class="o">=</span><span class="n">ErrTolForceAcc</span><span class="p">,</span>
                                     <span class="n">MaxMemSize</span><span class="o">=</span><span class="n">MaxMemSize</span><span class="p">,</span> <span class="n">PartAllocFactor</span><span class="o">=</span><span class="n">PartAllocFactor</span><span class="p">,</span> <span class="n">DesNumNgb</span><span class="o">=</span><span class="n">DesNumNgb</span><span class="p">,</span> <span class="n">onlyGroups</span><span class="o">=</span><span class="n">onlyGroups</span><span class="p">)</span>
            <span class="n">par4</span> <span class="o">=</span> <span class="n">create_simulation</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">TimeBegin</span><span class="o">=</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="n">npart</span><span class="o">=</span><span class="n">npart</span><span class="p">,</span> <span class="n">boxsize</span><span class="o">=</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">TimeEnd</span><span class="o">=</span><span class="n">TimeEnd</span><span class="p">,</span>
                                     <span class="n">phase</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ReNormalizeInputSpectrum</span><span class="o">=</span><span class="n">ReNormalizeInputSpectrum</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">=</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">use_reps</span><span class="o">=</span><span class="n">use_reps</span><span class="p">,</span>
                                     <span class="n">numsnaps</span><span class="o">=</span><span class="n">numsnaps</span><span class="p">,</span> <span class="n">outlist_file</span><span class="o">=</span><span class="n">outlist_file</span><span class="p">,</span> <span class="n">aa_list</span><span class="o">=</span><span class="n">aa_list</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
                                     <span class="n">subfind_history_mode</span><span class="o">=</span><span class="n">subfind_history_mode</span><span class="p">,</span> <span class="n">max_timestep</span><span class="o">=</span><span class="n">max_timestep</span><span class="p">,</span> <span class="n">use_cola</span><span class="o">=</span><span class="n">use_cola</span><span class="p">,</span>
                                     <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span> <span class="n">use_radiation</span><span class="o">=</span><span class="n">use_radiation</span><span class="p">,</span> <span class="n">DesLinkNgb</span> <span class="o">=</span> <span class="n">DesLinkNgb</span><span class="p">,</span>
                                     <span class="n">fixed_init_amplitude</span><span class="o">=</span><span class="n">fixed_init_amplitude</span><span class="p">,</span> <span class="n">gadget4</span><span class="o">=</span><span class="n">gadget4</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
                                     <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span> <span class="n">softening</span><span class="o">=</span><span class="n">softening</span><span class="p">,</span> <span class="n">ErrTolIntAccuracy</span><span class="o">=</span><span class="n">ErrTolIntAccuracy</span><span class="p">,</span> <span class="n">ErrTolForceAcc</span><span class="o">=</span><span class="n">ErrTolForceAcc</span><span class="p">,</span>
                                     <span class="n">MaxMemSize</span><span class="o">=</span><span class="n">MaxMemSize</span><span class="p">,</span> <span class="n">PartAllocFactor</span><span class="o">=</span><span class="n">PartAllocFactor</span><span class="p">,</span> <span class="n">DesNumNgb</span><span class="o">=</span><span class="n">DesNumNgb</span><span class="p">,</span> <span class="n">onlyGroups</span><span class="o">=</span><span class="n">onlyGroups</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">,</span> <span class="n">par3</span><span class="p">,</span> <span class="n">par4</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">)</span>

    <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">simple_name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_N</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">npart</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_N</span><span class="si">{1}</span><span class="s1">_L</span><span class="si">{2:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">npart</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="n">suffix</span>

    <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outputdir</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_output&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">initial_phase</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial_phase</span> <span class="o">=</span> <span class="n">phase</span>
        <span class="n">outputdir</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_output/</span><span class="si">{1:.2f}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">initial_phase</span><span class="p">)</span>

    <span class="n">outputdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">outputdir</span><span class="p">)</span>

    <span class="n">jobscript_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;job.sh&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">parameter_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;G4_param.txt&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parameter_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;LG3_param.txt&quot;</span><span class="p">)</span>
    <span class="n">lgalaxies_parameter_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;lgalaxies_input.txt&quot;</span><span class="p">)</span>
    <span class="n">powerspectrum_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;input_spectrum.dat&quot;</span><span class="p">)</span>
    <span class="n">transfer_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;input_transfer.dat&quot;</span><span class="p">)</span>
    <span class="n">growthrate_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;input_growthrate.dat&quot;</span><span class="p">)</span>

    <span class="n">lgalaxies_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;SAM_gals&quot;</span><span class="p">)</span>
    <span class="n">snapnum</span> <span class="o">=</span> <span class="mi">78</span> <span class="k">if</span> <span class="n">snapnum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">snapnum</span>
    <span class="n">tree_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;treedata&quot;</span><span class="p">),</span> <span class="s2">&quot;trees_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">))</span>
    <span class="n">tree_outdir</span> <span class="o">=</span> <span class="n">outputdir</span>

    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">create_dir</span><span class="p">(</span><span class="n">lgalaxies_outdir</span><span class="p">)</span>
        <span class="n">create_dir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">create_dir</span><span class="p">(</span><span class="n">outputdir</span><span class="p">)</span>

        <span class="c1"># Foundamental and Nyquist wavemodes</span>
        <span class="c1"># The size of the pm grid is assumed to be the same as the number of ptcles</span>
        <span class="n">ktransition_original</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]</span>
        <span class="n">N_pmgrid</span> <span class="o">=</span> <span class="n">npart</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">boxsize</span>
        <span class="n">kn</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">*</span> <span class="n">N_pmgrid</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kn</span>
        <span class="k">if</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span>

        <span class="k">if</span> <span class="n">outlist_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k_scale_indep</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">((</span><span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;reps&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="mf">0.8</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">simple_name</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">TimeEnd</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">)</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="p">(</span><span class="n">numsnaps</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">TimeEnd</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">)</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="p">(</span><span class="n">numsnaps</span><span class="o">-</span><span class="mi">10</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">aa_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">aa_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_growth_z</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">),</span> <span class="n">aa</span><span class="p">)</span>
            <span class="n">outlist_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s2">&quot;outputlist.dat&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">onlyGroups</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">outlist_file</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">aa_list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aa_list</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.20f</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">outlist_file</span><span class="p">,</span> <span class="n">aa_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">softening</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">softening</span> <span class="o">=</span> <span class="n">boxsize</span><span class="o">*</span><span class="mf">0.02</span><span class="o">/</span><span class="n">npart</span>
        <span class="n">fixed_amplitude</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">fixed_init_amplitude</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outputdir</span><span class="p">)</span>

    <span class="n">sim_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;basedir&#39;</span><span class="p">:</span> <span class="n">outputdir</span><span class="p">,</span>
                <span class="s1">&#39;snapnum&#39;</span><span class="p">:</span> <span class="n">snapnum</span><span class="p">,</span>
                <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
                <span class="s1">&#39;dm_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;snapdir_</span><span class="si">{0:03d}</span><span class="s2">/snapshot_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">),</span>
                <span class="s1">&#39;halo_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;groups_</span><span class="si">{0:03d}</span><span class="s2">/fof_subhalo_tab_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">),</span>
                <span class="s1">&#39;desc_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;treedata/desc_</span><span class="si">{0:03d}</span><span class="s2">/desc_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">),</span>
                <span class="s1">&#39;tree_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;treedata/trees_</span><span class="si">{0:03d}</span><span class="s2">/trees_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">),</span>
                <span class="s1">&#39;lgals_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;SAM_gals/SA_output&quot;</span><span class="p">),</span>
                <span class="s1">&#39;pkfile&#39;</span><span class="p">:</span> <span class="n">powerspectrum_file</span><span class="p">,</span>
                <span class="s1">&#39;sim_format&#39;</span><span class="p">:</span> <span class="s1">&#39;gadget_hdf5&#39;</span>
                <span class="p">}</span>

    <span class="k">if</span> <span class="n">subfind_history_mode</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">sim_dict</span><span class="p">[</span><span class="s1">&#39;halo_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;groups_</span><span class="si">{0:03d}</span><span class="s2">/fof_subhalo_history_tab_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span>
        <span class="n">sim_dict</span><span class="p">[</span><span class="s1">&#39;desc_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;treedata/desc_</span><span class="si">{0:03d}</span><span class="s2">/desc_history_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_orphans</span><span class="p">:</span>
        <span class="n">sim_dict</span><span class="p">[</span><span class="s1">&#39;halo_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;groups_</span><span class="si">{0:03d}</span><span class="s2">/fof_subhalo_history_tab_orph_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span>
        <span class="n">sim_dict</span><span class="p">[</span><span class="s1">&#39;desc_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;treedata/desc_</span><span class="si">{0:03d}</span><span class="s2">/desc_history_orph_</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sim_dict</span>

    <span class="c1"># pk = cosmology._compute_camb_spectrum(expfactor=1.0, bardeen=False, species=&quot;cold&quot;)</span>
    <span class="c1"># Normalization = (cosmology.pars[&#39;sigma8&#39;]/cosmology.compute_sigmaR_z0(8, kk=pk[&#39;kk&#39;], pk=pk[&#39;pk_mass&#39;]))[0]**2</span>
    <span class="c1"># pk = cosmology._compute_camb_spectrum(expfactor=TimeBegin, bardeen=False, species=&quot;cold&quot;)</span>
    <span class="c1"># pk[&#39;pk_mass&#39;] = pk[&#39;pk_mass&#39;] * Normalization</span>

    <span class="n">kk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">expfactor</span> <span class="o">=</span> <span class="n">TimeBegin</span>
    <span class="n">ppkk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">cosmology</span><span class="o">.</span><span class="n">reps_boundary_conditions</span><span class="p">(</span><span class="n">TimeBegin</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">reps_growth</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]))</span>

    <span class="c1"># Write initial power spectrum. In case ReNormalizeInputSpectrum is False (0), it</span>
    <span class="c1"># MUST be at the initial redshift of the simulation. Otherwise, it doesn&#39;t matter,</span>
    <span class="c1"># as it will be renormalized by LG3 at runtime.</span>

    <span class="n">baryon_frac</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span>
    <span class="n">cdm_frac</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cold&#39;</span><span class="p">]</span>
    <span class="n">cold_growth_factor</span> <span class="o">=</span> <span class="n">baryon_frac</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dbaryon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cdm_frac</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dcdm&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ReNormalizeInputSpectrum</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_reps</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
            <span class="n">kextend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
            <span class="n">kextend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kextend</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
            <span class="n">Dplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cold_growth_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cold_growth_factor</span><span class="p">)</span>
            <span class="n">Dplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dplus</span><span class="p">,</span> <span class="n">cold_growth_factor</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Dplus_fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">kextend</span><span class="p">,</span> <span class="n">Dplus</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="n">ln_Dplus_fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kextend</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Dplus</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="n">ppkk</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_Dplus_fn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ppkk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">expfactor</span><span class="o">=</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">powerspectrum_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">kk</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ppkk</span><span class="o">*</span><span class="n">kk</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">ppkk</span><span class="p">))</span>

    <span class="c1"># Transfer needed for the neutrino part</span>
    <span class="c1"># columns must be 7: k cdm b 0 0 neutrino matter (all normalized to matter)</span>
    <span class="n">boltz_Tc</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;boltz_Tc&#39;</span><span class="p">])</span>
    <span class="n">boltz_Tb</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;boltz_Tb&#39;</span><span class="p">])</span>
    <span class="n">boltz_Tn</span> <span class="o">=</span> <span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">repsBC</span><span class="p">[</span><span class="s1">&#39;boltz_Tn&#39;</span><span class="p">])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">transfer_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="n">v6</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="n">v6</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span>
                                                              <span class="n">boltz_Tc</span><span class="p">(</span><span class="n">kk</span><span class="p">),</span>
                                                              <span class="n">boltz_Tb</span><span class="p">(</span><span class="n">kk</span><span class="p">),</span>
                                                              <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">)),</span>
                                                              <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">)),</span>
                                                              <span class="n">boltz_Tn</span><span class="p">(</span><span class="n">kk</span><span class="p">),</span>
                                                              <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">))))</span>

    <span class="c1"># NOTE: new definition of the growth rate, here we are printing QdD/da,</span>
    <span class="c1"># instead of dlnD/dlna. This is to comply with the units currently</span>
    <span class="c1"># implemented in 2LPT.c of LG3. Note that Q(a)= a^3 H/H0.</span>

    <span class="n">baryon_prefac</span> <span class="o">=</span> <span class="n">baryon_frac</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dbaryon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cdm_prefac</span> <span class="o">=</span> <span class="n">cdm_frac</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;Dcdm&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cold_growth_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">baryon_prefac</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;fbaryon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">cdm_prefac</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="s1">&#39;fcdm&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">cold_growth_factor</span>

    <span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>
    <span class="n">method</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># corresponds to &#39;int_hubble&#39;</span>
    <span class="n">_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">([</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_aa</span><span class="p">))</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">cengine</span><span class="o">.</span><span class="n">growth</span><span class="p">(</span><span class="n">_aa</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">],</span>
                    <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">],</span> <span class="n">method</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]))</span>
    <span class="n">Dwrong</span> <span class="o">=</span> <span class="n">gg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">gg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dDcold_da</span> <span class="o">=</span> <span class="n">cold_growth_rate</span> <span class="o">*</span> <span class="n">Dwrong</span> <span class="o">/</span> <span class="n">TimeBegin</span>

    <span class="n">QdDcold_da</span> <span class="o">=</span> <span class="n">dDcold_da</span> <span class="o">*</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Ez_function_norad</span><span class="p">(</span><span class="n">TimeBegin</span><span class="p">)</span> <span class="o">*</span> <span class="n">TimeBegin</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">QdDcold_da</span> <span class="o">=</span> <span class="n">log_int_ext</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">QdDcold_da</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_reps</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">growthrate_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">QdDcold_da</span><span class="p">(</span><span class="n">kk</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">growthrate_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>
            <span class="n">method</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># corresponds to &#39;int_hubble&#39;</span>
            <span class="n">_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">([</span><span class="n">TimeBegin</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_aa</span><span class="p">))</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">cengine</span><span class="o">.</span><span class="n">growth</span><span class="p">(</span><span class="n">_aa</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">],</span>
                            <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">],</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">],</span> <span class="n">method</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]))</span>
            <span class="n">Dwrong</span> <span class="o">=</span> <span class="n">gg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">gg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">kk</span><span class="o">/</span><span class="n">kk</span><span class="o">*</span><span class="n">cosmology</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">TimeBegin</span><span class="p">)</span><span class="o">*</span><span class="n">TimeBegin</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">cosmology</span><span class="o">.</span><span class="n">Ez_function_norad</span><span class="p">(</span><span class="n">TimeBegin</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dwrong</span><span class="p">))</span>

    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="s1">&#39;ktransition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ktransition_original</span>

    <span class="c1"># Output options</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InitCondFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_conditions_file</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OutputDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputdir</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SnapshotFileBase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;snapshot&quot;</span>

    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;EnergyFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;energy.txt&quot;</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InfoFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;info.txt&quot;</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimingsFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;timings.txt&quot;</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CpuFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cpu.txt&quot;</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MemFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;memory.txt&quot;</span>

        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RestartFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;restart&quot;</span>

    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxFilesWithConcurrentIO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;NumFilesPerSnapshot&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">4</span>

        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MultipleDomains&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;NumFilesWrittenInParallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeLimitCPU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">430000</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CpuTimeBetRestartFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7200.0</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ResubmitOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ResubmitCommand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span>

    <span class="c1"># Code options</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UseRadiation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">use_radiation</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UseCola&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">use_cola</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ICFormat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SnapFormat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxMemSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MaxMemSize</span>

    <span class="c1"># Characteristics of run</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeBegin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TimeBegin</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TimeEnd</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OmegaLambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OmegaBaryon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxsize</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningComovingClass0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhysClass0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningComovingClass1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhysClass1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningComovingClass2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhysClass2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningComovingClass3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhysClass3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningComovingClass4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhysClass4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningComovingClass5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhysClass5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>

        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningClassOfPartType0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningClassOfPartType1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningClassOfPartType2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningClassOfPartType3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningClassOfPartType4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningClassOfPartType5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Softening&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SofteningMaxPhys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softening</span>

    <span class="c1"># Output frequency</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OutputListFilename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlist_file</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OutputListOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">outlist_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeBetSnapshot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeOfFirstSnapshot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.05 0.021 0.1&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeBetStatistics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># Accuracy of time integration</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolIntAccuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ErrTolIntAccuracy</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxSizeTimestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_timestep</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MinSizeTimestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxRMSDisplacementFac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CourantFac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ComovingIntegrationOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Tree algorithm and force accuracy</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolTheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TypeOfOpeningCriterion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolForceAcc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ErrTolForceAcc</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolThetaMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TopNodeFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ActivePartFracForNewDomainDecomp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ArtBulkViscConst&#39;</span><span class="p">]</span> <span class="o">=</span>       <span class="mf">1.0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MinEgySpec&#39;</span><span class="p">]</span> <span class="o">=</span>             <span class="mi">0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InitGasTemp&#39;</span><span class="p">]</span> <span class="o">=</span>            <span class="mi">0</span>


    <span class="c1"># Parameters that affect memory usage of the code</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;PartAllocFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PartAllocFactor</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BufferSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;PMmesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">npart</span>

    <span class="c1"># System of units</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.085678e24</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitMass_in_g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.989e43</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitVelocity_in_cm_per_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e5</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GravityConstantInternal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># SUBFIND parameters</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ErrTolThetaSubfind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxNumNgbDeviation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DesNumNgb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DesNumNgb</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DesLinkNgb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DesLinkNgb</span>

    <span class="c1"># ICs parameters</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;PrimordialIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#cosmology.pars[&#39;ns&#39;]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;NSample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npart</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GridSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npart</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;PowerSpectrumType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Means reading it from PowerSpectrumFile</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;PowerSpectrumFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">powerspectrum_file</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ShapeGamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.21</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ICmesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npart</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Nsample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npart</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;FixedInitialAmplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_amplitude</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;FileWithInputSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">powerspectrum_file</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;FileWithInputGrowthRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">growthrate_file</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;WhichSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Means reading it from FileWithInputSpectrum</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InitPhase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_phase</span>

    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InputSpectrum_UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.085678e24</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ReNormalizeInputSpectrum</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ReNormalizeInputSpectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="c1">#Sigma8 must be provided if we request a renormalization (ReNormalizeInputSpectrum=True) inside LG3</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;SphereMode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">424</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">seed</span>

    <span class="c1"># Massive neutrinos</span>
    <span class="k">if</span> <span class="n">gadget4</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;InputSpectrum_UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.085678e24</span>  <span class="c1"># 1.0 Mpc</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;KspaceTransferFunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transfer_file</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;TimeTransfer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TimeBegin</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OmegaBaryonCAMB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MNue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>  <span class="c1"># degenerate case</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MNum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>  <span class="c1"># degenerate case</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MNut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;neutrino_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>  <span class="c1"># degenerate case</span>

    <span class="n">write_parameter_file</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>

    <span class="n">lgalaxies_pars</span> <span class="o">=</span> <span class="n">create_lgalaxies_pars</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">cosmology</span><span class="p">,</span> <span class="n">npart</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">lgalaxies_outdir</span><span class="p">,</span> <span class="n">tree_outdir</span><span class="p">)</span>
    <span class="n">write_parameter_file</span><span class="p">(</span><span class="n">lgalaxies_parameter_file</span><span class="p">,</span> <span class="n">lgalaxies_pars</span><span class="p">)</span>

    <span class="c1"># write jobscript</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cluster</span><span class="o">==</span><span class="s1">&#39;DIPC&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">executable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;cluster is DIPC but no executable specified&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;bacco will use the default gadget3 exec that comes with bacco itself&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;are you sure your bacco folder is in /scratch ?&#39;</span><span class="p">)</span>

    <span class="n">local_exec_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
                      <span class="s1">&#39;../tests/testdata/lg3/L-Gadget3&#39;</span><span class="p">)</span>
    <span class="n">exec_file</span> <span class="o">=</span> <span class="n">local_exec_file</span> <span class="k">if</span> <span class="n">executable</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">executable</span>

    <span class="k">if</span> <span class="n">cluster</span> <span class="o">!=</span> <span class="s1">&#39;DIPC&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">npart</span> <span class="o">&lt;=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">tot_n_proc</span> <span class="o">=</span> <span class="mi">40</span>
            <span class="n">n_parallel_proc</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="k">elif</span> <span class="n">npart</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">:</span>
            <span class="n">tot_n_proc</span> <span class="o">=</span> <span class="mi">80</span>
            <span class="n">n_parallel_proc</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tot_n_proc</span> <span class="o">=</span> <span class="mi">280</span>
            <span class="n">n_parallel_proc</span> <span class="o">=</span> <span class="mi">256</span>
        <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">jobscript_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#/bin/bash </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -j y </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -cwd </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -m n </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -pe orte-40 </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tot_n_proc</span><span class="p">))</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -l h_rt=47:00:00 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module unload all </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load GCC/4.9.3-2.25 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load GSL/2.1-foss-2016a </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load gompi/1.5.14-no-OFED </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load FFTW </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mpiexec -np </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_parallel_proc</span><span class="p">,</span> <span class="n">exec_file</span><span class="p">,</span> <span class="n">parameter_file</span><span class="p">))</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">npart</span> <span class="o">&lt;=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">n_processes_per_node</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="n">n_parallel_proc</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="mi">120</span>
            <span class="n">cput</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="k">elif</span> <span class="n">npart</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">:</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">n_processes_per_node</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="n">n_parallel_proc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">24</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">120</span>
            <span class="n">cput</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">n_processes_per_node</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="n">n_parallel_proc</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">24</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">245</span>
            <span class="n">cput</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># NOTE: on ATLAS @ DiPC there are many types of nodes. The ones labelled</span>
        <span class="c1"># as mediumsize are the most abundant ones</span>
        <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">jobscript_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -q parallel</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l nodes=</span><span class="si">{}</span><span class="s2">:ppn=</span><span class="si">{}</span><span class="s2">:mediumsize</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_nodes</span><span class="p">,</span> <span class="n">n_processes_per_node</span><span class="p">))</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l cput=</span><span class="si">{}</span><span class="s2">:00:00</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cput</span><span class="p">))</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l mem=</span><span class="si">{}</span><span class="s2">gb</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mem</span><span class="p">))</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -N </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd $PBS_O_WORKDIR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module purge </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># text_file.write(&quot;module load OpenMPI/2.1.1-GCC-6.4.0-2.28 \n&quot;)</span>
        <span class="c1"># text_file.write(&quot;module load GSL/2.4-GCCcore-6.4.0 \n&quot;)</span>
        <span class="c1"># text_file.write(&quot;module load HDF5/1.10.1-foss-2017b \n&quot;)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module purge </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load intel/2018b </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load iimpi/2018b </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load GSL/2.5-GCC-7.3.0-2.30 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load FFTW/3.3.8-intel-2018b </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load HDF5/1.10.2-intel-2018b </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load DCRAB </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;dcrab start</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mpirun -np </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_parallel_proc</span><span class="p">,</span> <span class="n">exec_file</span><span class="p">,</span> <span class="n">parameter_file</span><span class="p">))</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;dcrab finish</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">sim_dict</span>



<span class="k">def</span> <span class="nf">create_lgalaxies_pars</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">totnpart</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">tree_outdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    %------------------------------------------</span>
<span class="sd">    %----- SA model inputs       --------------</span>
<span class="sd">    %------------------------------------------</span>

<span class="sd">    FileNameGalaxies          SA</span>
<span class="sd">    FirstFile         40</span>
<span class="sd">    LastFile          40</span>

<span class="sd">    FileWithOutputRedshifts   ./input/desired_output_redshifts.txt</span>
<span class="sd">    McFile                    ./input/Mc.txt</span>
<span class="sd">    CoolFunctionsDir          ./CoolFunctions/</span>

<span class="sd">    SpecPhotDir               /net/bootes/export/data1/Workspace/SpecPhotTables/</span>
<span class="sd">    PhotPrefix                PLANCK ; WMAP7 ;WMAP7</span>
<span class="sd">    SpecPhotIMF               Chabrier ; Salpeter ; Kroupa</span>
<span class="sd">    FileWithFilterNames       ./input/Filter_Names.txt</span>


<span class="sd">    %-------------------------------------------------</span>
<span class="sd">    %----- Simulation input/output files  ------------</span>
<span class="sd">    %-------------------------------------------------</span>

<span class="sd">    SimulationDir           /net/bootes/export/data1/Millennium2/BigRun/modified_trees/</span>

<span class="sd">    LastDarkMatterSnapShot  67</span>
<span class="sd">    Hashbits                8    ;needed for Peano hilbert key output with the GALAXYTREE option</span>

<span class="sd">    OutputDir               /net/bootes/scratch-ssd/SAM/test0/MRII/</span>

<span class="sd">    MaxMemSize             5000 ; 70000 ; 100000 galtree</span>

<span class="sd">    %-------------------------------------------------</span>
<span class="sd">    %----- Scaling options  ------------</span>
<span class="sd">    %-------------------------------------------------</span>

<span class="sd">    ScalePos            0.960558</span>
<span class="sd">    ScaleMass           1.11671</span>

<span class="sd">    ------------------------------------------</span>
<span class="sd">    %----- Cosmological paramters ------------</span>
<span class="sd">    %------------------------------------------</span>

<span class="sd">    %NEW COSMOLOGY: PLANCK1</span>
<span class="sd">    BaryonFrac      0.155</span>
<span class="sd">    Sigma8          0.826</span>
<span class="sd">    FileWithZList   ./input/zlists/zlist_planck_MRII.txt</span>
<span class="sd">    PartMass        0.000768884   ;should be changed according to the dark matter simulation being used ;new</span>
<span class="sd">    BoxSize         96.0558</span>
<span class="sd">    Omega           0.315</span>
<span class="sd">    OmegaLambda     0.685</span>
<span class="sd">    Hubble_h        0.673</span>

<span class="sd">    %ORIGINAL COSMOLOGY: WMAP1</span>
<span class="sd">    FileWithZList_OriginalCosm    ./input/zlists/zlist_MRII.txt</span>
<span class="sd">    PartMass_OriginalCosm         0.000688526 ;should be changed according to the dark matter simulation being used</span>
<span class="sd">    BoxSize_OriginalCosm          100.</span>
<span class="sd">    Omega_OriginalCosm            0.25</span>
<span class="sd">    OmegaLambda_OriginalCosm      0.75</span>
<span class="sd">    Hubble_h_OriginalCosm         0.73</span>

<span class="sd">    %----------------------------------------------------</span>
<span class="sd">    %----- Switches for different physical models -------</span>
<span class="sd">    %----------------------------------------------------</span>


<span class="sd">    ReionizationModel                 0  ;%*0 -- Okamoto 2008 (Guo2010)</span>
<span class="sd">                                          % 1 -- Gnedin reionization (Delucia2007)</span>
<span class="sd">                                          % 2 -- no reionization</span>
<span class="sd">                                          %option 0 is different if H2_AND_RINGS is ON or OFF (if on we only follow the mass in each ring (and therefore rd) if ON we follow each component of the spin (x,y &amp; z))</span>
<span class="sd">    DiskRadiusModel                   0  ;%*0 -- use each component (stellar or gas) spin to get disk radius</span>
<span class="sd">                                          % 1 -- use halo spin parameter to get disk scale radius,</span>
<span class="sd">                                          % 2 -- disk_radius = Gal[p].Rvir / 10.0,</span>

<span class="sd">    %Fu 2010 - StarFormationModel 4, H2FractionRecipe 0 &amp; 2</span>
<span class="sd">    %Fu 2010 - StarFormationModel 3 &amp; 4 with SFRtdyn 0 + StarFormationModel 2 &amp; 4 with SFRtdyn 1, H2FractionRecipe 0 &amp; 2</span>
<span class="sd">    StarFormationModel                0  ;%*0 -- Croton2006, Delucia2007, Guo2011, Henriques2015</span>
<span class="sd">                                          % 1 -- Alternative SF law</span>
<span class="sd">                                          % 2 -- if OPT += -DH2_AND_RINGS: Kennicutt law (set SFRtdyn=1 to have the old SF law, eq 3 in Fu2012)</span>
<span class="sd">                                          % 3 -- if OPT += -DH2_AND_RINGS: introduce in Fu2012 - Krumholz et al. 2009 (eq. 6)</span>
<span class="sd">                                          %*4 -- if OPT += -DH2_AND_RINGS: introduce in Fu2010 - BIGIEL only one mode now (eq 33)</span>

<span class="sd">    FeedbackReheatingModel            0  ;%*0 -- Guo 2010 (ejection scheme used in delucia 2007, plus Vmax dependence)</span>
<span class="sd">                                          % 1 -- Alternative reheating model</span>

<span class="sd">    FeedbackReheatingDeansityScaling  0  ;%*0 -- no scaling with local density</span>
<span class="sd">                                          % 1 -- Scaling with local density as eq. 35 in Fu2010</span>

<span class="sd">    FeedbackEjectionModel             0  ;%*0 -- Guo 2010 (ejection scheme used in delucia 2007, plus Vmax dependence)</span>
<span class="sd">                                          % 1 -- Constant velocity model</span>

<span class="sd">    FeedbackEagleScaling              0  ;%*0 -- no rescaling</span>
<span class="sd">                                          % 1 -- Rescaling as in Eagle - local density and metallicity (eq. 7 in Schaye et al. 2015)</span>


<span class="sd">    FateOfSatellitesGas               0   ;choice of ejection of satellite galaxies.</span>
<span class="sd">                                          %*0 -- ejected gas of satellites distribute between type 1 and type 0,</span>
<span class="sd">                                               % according to the fraction of dark matter retained in subhalos (Guo2010).</span>
<span class="sd">                                          % 1 -- ejected gas of satellite galaxies contributes to</span>
<span class="sd">                                               % the ejected component of type 0 (Delucia2007);</span>

<span class="sd">    ReIncorporationModel              0  ;%*0 -- Henriques2012 (Mdot_eject=-gama_ej*M_ejected*M_vir)</span>
<span class="sd">                                          % 1 -- Guo2010 (suppression in small halos)</span>
<span class="sd">                                          % 2 -- Delucia2007,</span>

<span class="sd">    BlackHoleGrowth                   0  ;How black hole growth from quasar mode is handled</span>
<span class="sd">                                           %*0 -- instantaneous; accretion rate reported averaged over step ([...],Guo2011, Henriques2015)</span>
<span class="sd">                                           % 1 -- via accretion disk at some fraction of Eddington rate</span>

<span class="sd">    AGNRadioModeModel                 0 ;if &gt; 0 grow black hole during mergers,</span>
<span class="sd">                                          %*0 -- Phenomenological AGN feedback scaling with Mhot*Mbh</span>
<span class="sd">                                               % as in Henriques2013b + AGN heating from satellites,</span>
<span class="sd">                                          % 1 -- Phenomenological accretion &amp; AGN feedback as in Croton 2006,</span>
<span class="sd">                                          % 2 -- Bondi-Hoyle accretion,</span>
<span class="sd">                                          % 3 -- Cold cloud accretion</span>
<span class="sd">                                          % 4 -- No cooling supression,</span>

<span class="sd">    DiskInstabilityModel              0  ;allow bulges to form when the stellar disks become unstable</span>
<span class="sd">                                          %*0 -- stability criteria of the stellar disk from Mo, Mao &amp; White (1998)</span>
<span class="sd">                                          % 1 -- no disk instabilities</span>

<span class="sd">    BHGrowthInDiskInstabilityModel    0  ;accretion of gas into the BH due to disk instabilities</span>
<span class="sd">                                          %*0 -- no BH growth in disk instabilities</span>
<span class="sd">                                          % 1 -- cold gas moved into the BH in the same fraction as disk stars moved to bulge</span>

<span class="sd">    HotGasStripingModel               0  ;choice of stripping of satellite galaxies</span>
<span class="sd">                                          %*0 -- gradual stripping (cooling in type 1&#39;s) (Guo2010)</span>
<span class="sd">                                               % Ejected gas of satellites distributed between type 1 and type 0,</span>
<span class="sd">                                               % according to the fraction of dark matter retained in subhalos (Guo2010).</span>
<span class="sd">                                               % This also determines where the ejected gas from type 2 ends up in mergers</span>
<span class="sd">                                               % (maybe it should be a different option).</span>
<span class="sd">                                          % 1 -- immediate stripping (Delucia2007)</span>
<span class="sd">                                               % Ejected gas of satellite galaxies contributes to the</span>
<span class="sd">                                               % ejected component of type 0 if within Rvir</span>

<span class="sd">    HotGasOnType2Galaxies             0  ;allowing hot gas to remain even on type two galaxies</span>
<span class="sd">                                          % 0 -- no hot gas on type 2&#39;s - normal tidal striping implmentation</span>
<span class="sd">                                              % removes all the hot gas once the dark matter halo has been striped</span>
<span class="sd">                                          % 1 -- allow hot gas on type 2&#39;s - only makes sense if tidal striping is modified</span>


<span class="sd">    StarBurstModel                    0  ;recipe for starbursts during mergers</span>
<span class="sd">                                          %*0 -- starbursts in major AND minor mergers as in Somerville 2001</span>

<span class="sd">    BulgeFormationInMinorMergersOn    1  ;option for bulges to form in minor mergers as well as major</span>
<span class="sd">                                          % 0 -- bulges only formed in major mergers</span>
<span class="sd">                                          %*1 -- bulge formation in major AND minor mergers</span>

<span class="sd">    MetallicityOption                 1  ;Photometric tables from SPS models</span>
<span class="sd">                                          % 0 -- only solar metallicity,</span>
<span class="sd">                                          %*1 -- range of metallicities;</span>


<span class="sd">    %------------------------------------------</span>
<span class="sd">    %----- Parameters of physical model -------</span>
<span class="sd">    %------------------------------------------</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% Reionization ;NOT USED if ReionizationModel=0</span>
<span class="sd">    %-------------------------------------------</span>

<span class="sd">    Reionization_z0             8.0  ;These parameter choices give the best fit to Genedin (2000)</span>
<span class="sd">    Reionization_zr             7.0  ;using the analytic fit of Kravtsov et al. 2004</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% Star formation</span>
<span class="sd">    %-------------------------------------------</span>

<span class="sd">    SfrEfficiency               0.02    ;(eq. S14 in Doc)</span>

<span class="sd">    SfrColdCrit                 0.14     ;(eq. S15 in Doc) In units of 10^10Msun</span>
<span class="sd">                                           % there is a factor 3 difference between the eq in Hen15 and in Guo10 because</span>
<span class="sd">                                           % one use Rgas and the other Rgas,d</span>


<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% Star formation bursts during mergers</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    SfrBurstEfficiency          0.14     ;(eq. S33 in Doc)</span>
<span class="sd">    SfrBurstSlope               0.78      ;(eq. S33 in Doc)</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    % BH growth and AGN feedback</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    AgnEfficiency               0.0077   ;(eq. S24 in Doc) Quiescent accretion in the radio mode</span>
<span class="sd">    BlackHoleGrowthRate         0.061   ;(eq. S23 in Henriques15) Fraction of cold gas added to the BH during mergers</span>
<span class="sd">    BlackHoleCutoffVelocity     1900.     ;(eq. S23 in Henriques15)</span>
<span class="sd">    BlackHoleSeedMass           1e-7     ;10^10 Msun/h</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% SN feedback</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    % Heating of cold gas to hot</span>
<span class="sd">    FeedbackReheatingEpsilon    0.7     ;(eq. S18 in Henriques15) Mass of cold gas reheated due to SF (see Martin 1999)</span>
<span class="sd">    ReheatPreVelocity           830.     ;(eq. S19 in Henriques15) Normalization of SN feedback</span>
<span class="sd">    ReheatSlope                 1.1     ;(eq. S19 in Henriques15) Slope of the dependence of  SN feedback on Vvir</span>
<span class="sd">    % Ejection of gas from halo</span>
<span class="sd">    FeedbackEjectionEfficiency  9.3      ;(eq. S16 in Henriques15) Fraction SN energy used in reheat and eject</span>
<span class="sd">    EjectPreVelocity            260.     ;(eq. S17 in Henriques15) Normalization of total SN</span>
<span class="sd">    EjectSlope                  2.2     ;(eq. S17 in Henriques15) Slope of total SN</span>
<span class="sd">    ReIncorporationFactor       2.1e+10  ;(eq. S22 in Henriques15) Fraction of ejected mass reincorporated per dynamical time to hot</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% IMF</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    Yield                       0.03    ;(section 1.9 in Henriques15) Fraction of metals instantaneously returned after SF (produced by short lived massive stars)</span>
<span class="sd">    RecycleFraction             0.43     ;(section 1.6 in Henriques15) Fraction of SF mass instantaneously recycled back to cold - IMF dependent</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% Mergers</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    ThreshMajorMerger           0.28      ;(section 1.12.2 in Henriques15) Major merger when mass ratio gt this</span>
<span class="sd">    MergerTimeMultiplier        1.1      ;(eq. S32 in Henriques15) Adjust the dynamical friction merging time</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %%Hot Gas stripping</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    RamPressureStrip_CutOffMass  2.1e+3  ;(section 1.11.1 in Henriques15) In code Units of 10^10 (mass above which there is stripping)</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% Total SN energy available</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    EnergySN            5.0e51           ;(section 1.7 in Doc)</span>
<span class="sd">    EtaSN               8.0e-3</span>

<span class="sd">    UnitLength_in_cm                   3.08568e+24      ;Mpc - WATCH OUT, distances in the code are in Mpc/h</span>
<span class="sd">    UnitMass_in_g                      1.989e+43        ;10^10Msun - WATCH OUT, masses in the code are in 10^10Msun/h</span>
<span class="sd">    UnitVelocity_in_cm_per_s           100000           ;Km/s - WATCH OUT, this are the correct units in the code km/s</span>

<span class="sd">    %---------------------------------------------------------</span>
<span class="sd">    % Additional parameters not used by the default model</span>
<span class="sd">    %---------------------------------------------------------</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    % BH growth</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    BlackHoleAccretionRate      3.      ;fraction of M_BH/t_Edd.  If Eddington limited then = (1-e)/e where e is radiation efficiency.</span>
<span class="sd">    BlackHoleDisruptGrowthRate  0.0</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% Total SN energy available</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %EnergySNII         1.0e51</span>
<span class="sd">    %EnergySNIA         1.0e51</span>
<span class="sd">    %EnergyAGB          1.0e51</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %% Gas Reincorporation</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    ReincZpower                 2.41</span>
<span class="sd">    ReincVelocitypower          3.26</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %%Fraction of Metals returned to Hot component</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    FracZtoHot                  0.0</span>

<span class="sd">    %-------------------------------------------</span>
<span class="sd">    %%Hot Gas stripping</span>
<span class="sd">    %-------------------------------------------</span>
<span class="sd">    RamPressureRadiusThreshold      0.0  ;efficiency of ram pressure stripping</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">UnitTime_in_s</span> <span class="o">=</span>  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitVelocity_in_cm_per_s&#39;</span><span class="p">]</span>
    <span class="n">Hubble</span> <span class="o">=</span> <span class="mf">3.2407789e-18</span> <span class="o">*</span> <span class="n">UnitTime_in_s</span>
    <span class="n">G</span> <span class="o">=</span> <span class="mf">6.672e-8</span> <span class="o">/</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitMass_in_g&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">UnitTime_in_s</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">part_mass</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">Hubble</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">G</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">totnpart</span>

    <span class="n">lg_pars</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FileNameGalaxies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SA&quot;</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FirstFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;LastFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">40</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FileWithOutputRedshifts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./input/desired_output_redshifts.txt&quot;</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;McFile&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;./input/Mc.txt&quot;</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;CoolFunctionsDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./CoolFunctions/&quot;</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;SpecPhotDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./SpecPhotTables/&quot;</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;PhotPrefix&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;PLANCK&quot;</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;SpecPhotIMF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Chabrier&quot;</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FileWithFilterNames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./input/Filter_Names.txt&quot;</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;SimulationDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree_outdir</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;LastDarkMatterSnapShot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapnum</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Hashbits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;OutputDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;MaxMemSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;MaxMemSize&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ScalePos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ScaleMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BaryonFrac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Sigma8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Sigma8&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FileWithZList&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OutputListFilename&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;PartMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part_mass</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Omega&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Omega0&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;OmegaLambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;OmegaLambda&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Hubble_h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FileWithZList_OriginalCosm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FileWithZList&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;PartMass_OriginalCosm&#39;</span><span class="p">]</span> <span class="o">=</span>      <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;PartMass&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BoxSize_OriginalCosm&#39;</span><span class="p">]</span> <span class="o">=</span>       <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Omega_OriginalCosm&#39;</span><span class="p">]</span> <span class="o">=</span>         <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Omega&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;OmegaLambda_OriginalCosm&#39;</span><span class="p">]</span> <span class="o">=</span>   <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;OmegaLambda&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Hubble_h_OriginalCosm&#39;</span><span class="p">]</span> <span class="o">=</span>      <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Hubble_h&#39;</span><span class="p">]</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ReionizationModel&#39;</span><span class="p">]</span> <span class="o">=</span>                 <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;DiskRadiusModel&#39;</span><span class="p">]</span> <span class="o">=</span>                   <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;StarFormationModel&#39;</span><span class="p">]</span> <span class="o">=</span>                <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FeedbackReheatingModel&#39;</span><span class="p">]</span> <span class="o">=</span>            <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FeedbackReheatingDeansityScaling&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FeedbackEjectionModel&#39;</span><span class="p">]</span> <span class="o">=</span>             <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FeedbackEagleScaling&#39;</span><span class="p">]</span> <span class="o">=</span>              <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FateOfSatellitesGas&#39;</span><span class="p">]</span> <span class="o">=</span>               <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ReIncorporationModel&#39;</span><span class="p">]</span> <span class="o">=</span>              <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BlackHoleGrowth&#39;</span><span class="p">]</span> <span class="o">=</span>                   <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;AGNRadioModeModel&#39;</span><span class="p">]</span> <span class="o">=</span>                 <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;DiskInstabilityModel&#39;</span><span class="p">]</span> <span class="o">=</span>              <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BHGrowthInDiskInstabilityModel&#39;</span><span class="p">]</span> <span class="o">=</span>    <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;HotGasStripingModel&#39;</span><span class="p">]</span> <span class="o">=</span>               <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;HotGasOnType2Galaxies&#39;</span><span class="p">]</span> <span class="o">=</span>             <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;StarBurstModel&#39;</span><span class="p">]</span> <span class="o">=</span>                    <span class="mi">0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BulgeFormationInMinorMergersOn&#39;</span><span class="p">]</span> <span class="o">=</span>    <span class="mi">1</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;MetallicityOption&#39;</span><span class="p">]</span> <span class="o">=</span>                 <span class="mi">1</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Reionization_z0&#39;</span><span class="p">]</span> <span class="o">=</span>             <span class="mf">8.0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Reionization_zr&#39;</span><span class="p">]</span> <span class="o">=</span>             <span class="mf">7.0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;SfrEfficiency&#39;</span><span class="p">]</span> <span class="o">=</span>               <span class="mf">0.02</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;SfrColdCrit&#39;</span><span class="p">]</span> <span class="o">=</span>                 <span class="mf">0.14</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;SfrBurstEfficiency&#39;</span><span class="p">]</span> <span class="o">=</span>          <span class="mf">0.14</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;SfrBurstSlope&#39;</span><span class="p">]</span> <span class="o">=</span>               <span class="mf">0.78</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;AgnEfficiency&#39;</span><span class="p">]</span> <span class="o">=</span>               <span class="mf">0.0077</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BlackHoleGrowthRate&#39;</span><span class="p">]</span> <span class="o">=</span>         <span class="mf">0.061</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BlackHoleCutoffVelocity&#39;</span><span class="p">]</span> <span class="o">=</span>     <span class="mf">1900.</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BlackHoleSeedMass&#39;</span><span class="p">]</span> <span class="o">=</span>           <span class="mf">1e-7</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FeedbackReheatingEpsilon&#39;</span><span class="p">]</span> <span class="o">=</span>    <span class="mf">0.7</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ReheatPreVelocity&#39;</span><span class="p">]</span> <span class="o">=</span>           <span class="mf">830.</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ReheatSlope&#39;</span><span class="p">]</span> <span class="o">=</span>                 <span class="mf">1.1</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FeedbackEjectionEfficiency&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">9.3</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;EjectPreVelocity&#39;</span><span class="p">]</span> <span class="o">=</span>            <span class="mf">260.</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;EjectSlope&#39;</span><span class="p">]</span> <span class="o">=</span>                  <span class="mf">2.2</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ReIncorporationFactor&#39;</span><span class="p">]</span> <span class="o">=</span>       <span class="mf">2.1e+10</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;Yield&#39;</span><span class="p">]</span> <span class="o">=</span>                       <span class="mf">0.03</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;RecycleFraction&#39;</span><span class="p">]</span> <span class="o">=</span>             <span class="mf">0.43</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ThreshMajorMerger&#39;</span><span class="p">]</span> <span class="o">=</span>           <span class="mf">0.28</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;MergerTimeMultiplier&#39;</span><span class="p">]</span> <span class="o">=</span>        <span class="mf">1.1</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;RamPressureStrip_CutOffMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.1e+3</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;EnergySN&#39;</span><span class="p">]</span> <span class="o">=</span>                    <span class="mf">5.0e51</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;EtaSN&#39;</span><span class="p">]</span> <span class="o">=</span>                       <span class="mf">8.0e-3</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BlackHoleAccretionRate&#39;</span><span class="p">]</span> <span class="o">=</span>      <span class="mf">3.</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;BlackHoleDisruptGrowthRate&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">0.0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ReincZpower&#39;</span><span class="p">]</span> <span class="o">=</span>                 <span class="mf">2.41</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;ReincVelocitypower&#39;</span><span class="p">]</span> <span class="o">=</span>          <span class="mf">3.26</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;FracZtoHot&#39;</span><span class="p">]</span> <span class="o">=</span>                  <span class="mf">0.0</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;RamPressureRadiusThreshold&#39;</span><span class="p">]</span> <span class="o">=</span>      <span class="mf">0.0</span>

    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;UnitMass_in_g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitMass_in_g&#39;</span><span class="p">]</span>
    <span class="n">lg_pars</span><span class="p">[</span><span class="s1">&#39;UnitVelocity_in_cm_per_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;UnitVelocity_in_cm_per_s&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">lg_pars</span>



<div class="viewcode-block" id="write_parameter_file"><a class="viewcode-back" href="../../code.html#bacco.utils.write_parameter_file">[docs]</a><span class="k">def</span> <span class="nf">write_parameter_file</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the parameters file of a simulation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pars</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>


<div class="viewcode-block" id="create_dir"><a class="viewcode-back" href="../../code.html#bacco.utils.create_dir">[docs]</a><span class="k">def</span> <span class="nf">create_dir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We try to create a directory. If it exists, we ignore the error. We catch any other error</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="k">raise</span></div>


<span class="k">def</span> <span class="nf">sbesselj0</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">sinc</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">6.0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">120.0</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mf">6.0</span><span class="o">/</span><span class="mf">5040.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span>
    <span class="k">return</span> <span class="n">sinc</span>


<span class="k">def</span> <span class="nf">sbesselj1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">sphbesj1</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="mf">3.0</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">30.0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mf">5.0</span><span class="o">/</span><span class="mf">840.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sphbesj1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">x</span><span class="o">**</span><span class="mf">2.0</span>
    <span class="k">return</span> <span class="n">sphbesj1</span>


<span class="k">def</span> <span class="nf">xi2pk</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">lbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">FFTLog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smooth_cutoff</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span>

    <span class="n">nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
    <span class="n">pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>

    <span class="n">lmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>

    <span class="c1"># FFTLOG</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">pyfftlog</span>

    <span class="c1"># Range of periodic interval</span>

    <span class="n">logkmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.</span>
    <span class="n">logkmax</span> <span class="o">=</span> <span class="mf">4.</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">4096</span>  <span class="c1"># Number of points (Max 4096)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Order mu of Bessel function</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># Bias exponent: q = 0 is unbiased</span>
    <span class="n">kr</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Sensible approximate choice of k_c r_c</span>

    <span class="n">spform</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="n">rr</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">xi</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Tell fhti to change kr to low-ringing value</span>
    <span class="c1"># WARNING: kropt = 3 will fail, as interaction is not supported</span>
    <span class="n">kropt</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Log-spacing of points</span>
    <span class="n">dlogk</span> <span class="o">=</span> <span class="p">(</span><span class="n">logkmax</span> <span class="o">-</span> <span class="n">logkmin</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">dlnk</span> <span class="o">=</span> <span class="n">dlogk</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="c1"># Forward transform (changed from dir to tdir, as dir is a python fct)</span>
    <span class="n">tdir</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">kr</span><span class="p">,</span> <span class="n">xsave</span> <span class="o">=</span> <span class="n">pyfftlog</span><span class="o">.</span><span class="n">fhti</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">dlnk</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">kr</span><span class="p">,</span> <span class="n">kropt</span><span class="p">)</span>
    <span class="c1">#print(&#39;pyfftlog.fhti: new kr = &#39;, kr)</span>

    <span class="n">logkc</span> <span class="o">=</span> <span class="p">(</span><span class="n">logkmin</span> <span class="o">+</span> <span class="n">logkmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">logkc</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">dlogk</span><span class="p">)</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">spform</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">smooth_cutoff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span><span class="o">/</span><span class="n">lbox</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">aa</span> <span class="o">*</span> <span class="n">rr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">bb</span> <span class="o">*</span> <span class="n">rr</span> <span class="o">+</span> <span class="n">cc</span>

<span class="c1">#        ff = 1 - (k - lbox/2) * (1./(np.sqrt(3)*lbox/2-lbox/2))</span>
            <span class="n">ff</span><span class="p">[</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">lbox</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span> <span class="o">*</span> <span class="n">ff</span>
            <span class="n">ar</span><span class="p">[</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">lbox</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ar</span><span class="p">[</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">lbox</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Transform</span>
    <span class="n">logrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">kr</span><span class="p">)</span> <span class="o">-</span> <span class="n">logkc</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Central point in k-space at log10(k_c) = &#39;</span><span class="p">,</span> <span class="n">logkc</span><span class="p">)</span>

    <span class="n">rk</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">logkc</span> <span class="o">-</span> <span class="n">logrc</span><span class="p">)</span>
    <span class="c1">#ak = pyfftlog.fftl(ar.copy(), xsave, rk, tdir)</span>
    <span class="n">ak</span> <span class="o">=</span> <span class="n">pyfftlog</span><span class="o">.</span><span class="n">fht</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">xsave</span><span class="p">,</span> <span class="n">tdir</span><span class="p">)</span>

    <span class="n">kk</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">logrc</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">dlogk</span><span class="p">)</span>

    <span class="n">pk</span> <span class="o">=</span> <span class="n">kk</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ak</span>

    <span class="k">if</span> <span class="n">FFTLog</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">spform</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">rr</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">xi</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nk</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">pk_integrand</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">xir2</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">spform</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">kk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">xir2</span>  <span class="c1"># * np.exp(-(kk[i]*r)**2/.**2)</span>
                <span class="k">return</span> <span class="n">aa</span>

        <span class="n">ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">base</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lbox</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)))</span>
        <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pk_integrand</span><span class="p">(</span><span class="n">ir</span><span class="p">),</span> <span class="n">ir</span><span class="p">)</span>

    <span class="n">pk</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">pk</span>
    <span class="k">return</span> <span class="n">pk</span><span class="p">,</span> <span class="n">kk</span>

<span class="c1"># define kmax 21</span>
<span class="c1"># define nfit 8</span>


<span class="k">def</span> <span class="nf">sirko_integrate</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">closed_a</span><span class="p">,</span> <span class="n">closed_b</span><span class="p">):</span>

    <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">1.e-7</span>
    <span class="n">tolerance2</span> <span class="o">=</span> <span class="mf">1.e-4</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">totsum</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">closed_a</span><span class="p">):</span>
        <span class="n">fxna</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">closed_b</span><span class="p">):</span>
        <span class="n">fxnb</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">krange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
    <span class="n">hh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">krange</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">25</span> <span class="o">*</span> <span class="n">hh</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">halfdx</span> <span class="o">=</span> <span class="n">dx</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">fxn0</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">halfdx</span><span class="p">)</span>
        <span class="n">fxn1</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">halfdx</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tsum</span> <span class="o">=</span> <span class="n">fxn0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tsum</span> <span class="o">=</span> <span class="n">fxn0</span> <span class="o">+</span> <span class="n">fxn1</span>

        <span class="n">irange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">halfdx</span>
        <span class="n">tsum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">function</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">irange</span><span class="p">])</span>

        <span class="n">totsum</span> <span class="o">+=</span> <span class="n">tsum</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">closed_a</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">fxna</span> <span class="o">=</span> <span class="n">fxn0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">closed_b</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">fxnb</span> <span class="o">=</span> <span class="n">fxn1</span>

        <span class="n">answer</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">totsum</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">fxna</span><span class="o">+</span><span class="n">fxnb</span><span class="p">))</span>
        <span class="n">tentative</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span>

    <span class="k">return</span> <span class="n">tentative</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if (k &gt;= nfit-1) { // This is the Neville part (NR 3.1)</span>
<span class="sd">      answer_discrep = fabs(answer[k]-answer[k-1]);</span>
<span class="sd">      if (answer_discrep &lt;= tolerance2*fabs(tentative)) {// passes my new test</span>
<span class="sd">      for (i=0;i&lt;nfit;i++) {</span>
<span class="sd">    c[i] = answer[k-nfit+1 + i];</span>
<span class="sd">    d[i] = answer[k-nfit+1 + i];</span>
<span class="sd">      }</span>
<span class="sd">      for (i=1;i&lt;nfit;i++) {</span>
<span class="sd">    for (j=0;j&lt;nfit-i;j++) {</span>
<span class="sd">      cdterm = (c[j+1]-d[j]) / (h[j]-h[j+i]);</span>
<span class="sd">      d[j] = h[j+i]*cdterm;</span>
<span class="sd">      c[j] = h[j]  *cdterm;</span>
<span class="sd">    }</span>
<span class="sd">    tentative += d[j-1];</span>
<span class="sd">    if (fabs(d[j]) &lt; tolerance*fabs(tentative)) return tentative;</span>
<span class="sd">      } }</span>
<span class="sd">    }</span>
<span class="sd">    n = 2*n;</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="pk2xi"><a class="viewcode-back" href="../../code.html#bacco.utils.pk2xi">[docs]</a><span class="k">def</span> <span class="nf">pk2xi</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">jn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">FFTLog</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the correlation function from a tabulated power spectrum data</span>
<span class="sd">    TODO: Rewrite variables to utilize the same Bessel function</span>

<span class="sd">    :param kk: Wavevectors</span>
<span class="sd">    :param pk: Power spectrum</span>
<span class="sd">    :param rr: Values at which to compute the correlation function</span>
<span class="sd">    :param Log: Decide whether the interpolation is done in linear or logarithmic scales</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="k">as</span> <span class="nn">sciint</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">special</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>

    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>

    <span class="n">logk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
    <span class="n">logpk</span> <span class="o">=</span> <span class="n">pk</span>
    <span class="k">if</span> <span class="n">Log</span><span class="p">:</span>
        <span class="n">logpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

    <span class="n">kstart</span><span class="p">,</span> <span class="n">kstop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lbox</span><span class="p">)</span>
<span class="c1">#  kR = np.logspace(kstart, kstop, num=500, endpoint=True, base=np.exp(1))</span>
<span class="c1">#  J0 = np.asarray([special.sph_jn(jn,x)[0][jn] for x in kR])</span>
<span class="c1">#  J0 = np.asarray([sbesselj0(x) for x in kR])</span>

    <span class="c1"># FFTLOG</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">pyfftlog</span>

    <span class="c1"># Range of periodic interval</span>

    <span class="n">logkmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.</span>
    <span class="n">logkmax</span> <span class="o">=</span> <span class="mf">4.</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">4096</span>  <span class="c1"># Number of points (Max 4096)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">jn</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># Order mu of Bessel function</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Bias exponent: q = 0 is unbiased</span>
    <span class="n">kr</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Sensible approximate choice of k_c r_c</span>

    <span class="n">spform</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5</span><span class="o">-</span><span class="n">q</span><span class="p">))</span> <span class="o">+</span> <span class="n">logpk</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Tell fhti to change kr to low-ringing value</span>
    <span class="c1"># WARNING: kropt = 3 will fail, as interaction is not supported</span>
    <span class="n">kropt</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Log-spacing of points</span>
    <span class="n">dlogk</span> <span class="o">=</span> <span class="p">(</span><span class="n">logkmax</span> <span class="o">-</span> <span class="n">logkmin</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">dlnk</span> <span class="o">=</span> <span class="n">dlogk</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="c1"># Forward transform (changed from dir to tdir, as dir is a python fct)</span>
    <span class="n">tdir</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">kr</span><span class="p">,</span> <span class="n">xsave</span> <span class="o">=</span> <span class="n">pyfftlog</span><span class="o">.</span><span class="n">fhti</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">dlnk</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">kr</span><span class="p">,</span> <span class="n">kropt</span><span class="p">)</span>
    <span class="c1">#print(&#39;pyfftlog.fhti: new kr = &#39;, kr)</span>

    <span class="n">logkc</span> <span class="o">=</span> <span class="p">(</span><span class="n">logkmin</span> <span class="o">+</span> <span class="n">logkmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">logkc</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">dlogk</span><span class="p">)</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">spform</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">lbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ar</span><span class="p">[</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lbox</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Transform</span>
    <span class="n">logrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">kr</span><span class="p">)</span> <span class="o">-</span> <span class="n">logkc</span>
    <span class="c1">#print(&#39;Central point in k-space at log10(k_c) = &#39;, logkc)</span>

    <span class="n">rk</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">logkc</span> <span class="o">-</span> <span class="n">logrc</span><span class="p">)</span>
    <span class="c1">#ak = pyfftlog.fftl(ar.copy(), xsave, rk, tdir)</span>
    <span class="n">ak</span> <span class="o">=</span> <span class="n">pyfftlog</span><span class="o">.</span><span class="n">fht</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">xsave</span><span class="p">,</span> <span class="n">tdir</span><span class="p">)</span>

    <span class="n">rr</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">logrc</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">dlogk</span><span class="p">)</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">rr</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ak</span>

    <span class="k">if</span> <span class="n">FFTLog</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">spform</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logpk</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">xi_integrand</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">spform</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="c1"># aa = np.sinc(k*rr[i]/math.pi) * k**2 * pp  # * np.exp(-(k*rr[i])**2/32.**2)</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pp</span>  <span class="c1"># * np.exp(-(k*rr[i])**2/32.**2)</span>
                <span class="k">return</span> <span class="n">aa</span>

            <span class="k">def</span> <span class="nf">xi_integrand_log</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">((</span><span class="n">k</span><span class="p">),</span> <span class="n">spform</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">kk</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">pp</span>  <span class="c1"># * np.exp(-(kk*rr[i])**2/32.**2)</span>
                <span class="k">return</span> <span class="n">aa</span>

            <span class="n">ik</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">kstart</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">256.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span>
                                            <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">num</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ik</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kstart</span><span class="p">),</span> <span class="mf">256.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">xi_integrand</span><span class="p">(</span><span class="n">ik</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">ik</span><span class="p">)</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">pk2xi</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">rr</span></div>


<span class="n">pk2xi</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">sigma_displacement</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">lbox</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">logk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
    <span class="n">ak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lbox</span><span class="p">)</span>
        <span class="n">ak</span><span class="p">[</span><span class="n">logk</span> <span class="o">&lt;</span> <span class="n">kstart</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">ak</span> <span class="o">*</span> <span class="n">kk</span><span class="p">,</span> <span class="n">logk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sigmaR</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">omegaM</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">lbox</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">logk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
    <span class="n">logpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
    <span class="n">ak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lbox</span><span class="p">)</span>
        <span class="n">ak</span><span class="p">[</span><span class="n">logk</span> <span class="o">&lt;</span> <span class="n">kstart</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;kstar = &#39;</span><span class="p">,</span> <span class="n">kstart</span><span class="p">)</span>
<span class="c1">#    print &#39;kstar2 = &#39;, kstart</span>

    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
    <span class="n">rhoc</span> <span class="o">=</span> <span class="mf">2.775e11</span>  <span class="c1"># in [h^2 Msun Mpc^-3]</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">omegaM</span> <span class="o">*</span> <span class="n">rhoc</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">):</span>
        <span class="n">kR</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">*</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#J1 = np.asarray([sbesselj1(x) for x in kR]) * 3.0 / kR</span>
        <span class="n">J1</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">/</span><span class="p">(</span><span class="n">kR</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">kR</span><span class="p">)</span> <span class="o">-</span> <span class="n">kR</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">kR</span><span class="p">))</span>
        <span class="n">sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">ak</span> <span class="o">*</span> <span class="n">J1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kk</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">logk</span><span class="p">)</span>
        <span class="c1">#sigma[i] = integrate.simps(ak * J1**2 * kk**3, logk)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_pk2d</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">RSD</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">):</span>

    <span class="k">assert</span> <span class="n">FOG</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;lorentzian&#39;</span><span class="p">]</span>

    <span class="n">nkk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
    <span class="n">nmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">pk2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmu</span><span class="p">,</span> <span class="n">nkk</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fog_none</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">sigma_s</span><span class="p">,</span> <span class="n">mu</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    <span class="k">def</span> <span class="nf">fog_gaussian</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">sigma_s</span><span class="p">,</span> <span class="n">mu</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">sigma_s</span> <span class="o">*</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fog_lorentzian</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">sigma_s</span><span class="p">,</span> <span class="n">mu</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">sigma_s</span> <span class="o">*</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">FOG</span><span class="o">==</span><span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">fog_damping</span> <span class="o">=</span> <span class="n">fog_none</span>
    <span class="k">elif</span> <span class="n">FOG</span><span class="o">==</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">fog_damping</span> <span class="o">=</span> <span class="n">fog_gaussian</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fog_damping</span> <span class="o">=</span> <span class="n">fog_lorentzian</span>

    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nkk</span><span class="p">):</span>
        <span class="n">FoG</span> <span class="o">=</span> <span class="n">fog_damping</span><span class="p">(</span><span class="n">kk</span><span class="p">[</span><span class="n">ik</span><span class="p">],</span> <span class="n">sigma_s</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
        <span class="n">Kaiser</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">pk2d</span><span class="p">[:,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">*</span> <span class="n">Kaiser</span> <span class="o">*</span> <span class="n">FoG</span>
<span class="c1">#    pdb.set_trace()</span>
       <span class="c1"># if (RSD == False):</span>
       <span class="c1">#   pk2d[:,ik] = pk[ik] * Kaiser/Kaiser</span>

    <span class="k">return</span> <span class="n">pk2d</span>


<span class="k">def</span> <span class="nf">pkmulti</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">pk2d</span><span class="p">):</span>

    <span class="n">nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
    <span class="n">P_ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nk</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">ell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">Leg</span> <span class="o">=</span> <span class="n">special</span><span class="o">.</span><span class="n">legendre</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ell</span><span class="p">)(</span><span class="n">mu</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nk</span><span class="p">):</span>
            <span class="n">P_ell</span><span class="p">[</span><span class="n">ell</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pk2d</span><span class="p">[:,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">*</span> <span class="n">Leg</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
        <span class="n">P_ell</span><span class="p">[</span><span class="n">ell</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ell</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P_ell</span>


<span class="k">def</span> <span class="nf">ximulti</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">p_ell</span><span class="p">):</span>

    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">xi_ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">ell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">xi_ell</span><span class="p">[</span><span class="n">ell</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">ell</span> <span class="o">*</span> <span class="n">pk2xi</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">p_ell</span><span class="p">[</span><span class="n">ell</span><span class="p">,</span> <span class="p">:],</span> <span class="n">rr</span><span class="p">,</span> <span class="n">jn</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">ell</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xi_ell</span>


<span class="k">def</span> <span class="nf">xibar</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">xi</span><span class="p">):</span>

    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">xib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">):</span>
            <span class="n">xib</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ir</span><span class="p">]</span> <span class="o">*</span> <span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ir</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ir</span><span class="p">])</span>
        <span class="n">xib</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">rr</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mf">3.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xib</span>

<span class="c1">#def Load_ArrSim(Arr_Snap, targ_snap, basedir,Nsnap, dm_file = &#39;snapshot&#39;, halo_file = &#39;fof_subhalo_history_tab_orph_wweight&#39;, use_orphans=False, verbose = True):</span>
<span class="c1">#    &#39;&#39;&#39;</span>
<span class="c1">#    Load the fof of a simulation to an array, so it can be re-read it</span>
<span class="c1">#</span>
<span class="c1">#    Arr_Snap - &gt; [0] is the index of the array of snapshot to use.</span>
<span class="c1">#                 [1] is the array with the simulations.</span>
<span class="c1">#                 [2] is the snapshots of the simulations.</span>
<span class="c1">#    eg. Arr_Snap = np.zeros(3,dtype=object)</span>
<span class="c1">#        Arr_Snap[0] = 0</span>
<span class="c1">#        Arr_Snap[1] = np.zeros(Nsnap,dtype=object)</span>
<span class="c1">#        Arr_Snap[2] = np.zeros(Nsnap,dtype=int)</span>
<span class="c1">#    &#39;&#39;&#39;</span>
<span class="c1">#    if Arr_Snap[2][0] == 0:</span>
<span class="c1">#        targ_Sim =  Simulation(verbose=False,basedir=basedir,dm_file=&#39;snapdir_%03d/%s_%03d&#39;%(targ_snap,dm_file,targ_snap),halo_file=&#39;groups_%03d/%s_%03d&#39;%(targ_snap,halo_file,targ_snap), use_orphans=use_orphans)</span>
<span class="c1">#        targ_Sim.fof</span>
<span class="c1">#        targ_Sim.halo_sdm()</span>
<span class="c1">#        for i in range(Nsnap):</span>
<span class="c1">#            Arr_Snap[1][i] = copy.copy(targ_Sim)</span>
<span class="c1">#            Arr_Snap[2][i] = targ_snap</span>
<span class="c1">#    else:</span>
<span class="c1">#        sim_found = False</span>
<span class="c1">#        for i in range(Nsnap):</span>
<span class="c1">#            j = (Arr_Snap[0]+i+1)%Nsnap</span>
<span class="c1">#            if (Arr_Snap[2][j] == targ_snap):</span>
<span class="c1">#                sim_found = True</span>
<span class="c1">#                targ_Sim = copy.copy(Arr_Snap[1][j])</span>
<span class="c1">#                if verbose: logger.info(&quot;Simulation at snapshot %d already in memory&quot;%(targ_snap))</span>
<span class="c1">#                break</span>
<span class="c1">#        if sim_found == False:</span>
<span class="c1">#            targ_Sim = Simulation(verbose=False,basedir=basedir,dm_file=&#39;snapdir_%03d/%s_%03d&#39;%(targ_snap,dm_file,targ_snap),halo_file=&#39;groups_%03d/%s_%03d&#39;%(targ_snap,halo_file,targ_snap), use_orphans=use_orphans)</span>
<span class="c1">#            targ_Sim.fof</span>
<span class="c1">#            targ_Sim.halo_sdm()</span>
<span class="c1">#            Arr_Snap[1][Arr_Snap[0]%Nsnap] = copy.copy(targ_Sim)</span>
<span class="c1">#            Arr_Snap[2][Arr_Snap[0]%Nsnap] = targ_snap</span>
<span class="c1">#            if verbose:</span>
<span class="c1">#                logger.info(&quot;Simulation at snapshot %d not in memory. Using index %d. Loading...&quot;%(targ_snap,Arr_Snap[0]))</span>
<span class="c1">#                logger.info(&quot;Array of loaded snapshots: &quot;,Arr_Snap)</span>
<span class="c1">#            Arr_Snap[0] += 1</span>
<span class="c1">#    return targ_Sim</span>

<span class="k">def</span> <span class="nf">cosmo_derivatives</span><span class="p">(</span><span class="n">cosmo_params</span><span class="p">,</span> <span class="n">par1</span><span class="o">=</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">,</span> <span class="n">par2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">h_par1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_par2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;powerspec&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">accuracy_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">multipole_l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma_v</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="n">ngen_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the derivatives of a cosmological quantity</span>
<span class="sd">    Inputs:</span>
<span class="sd">        cosmology: a cosmology class (at some given redshift)</span>
<span class="sd">        par1: name of parameter to derive (among cosmo.pars.keys())</span>
<span class="sd">        par2: name of parameter to derive (among cosmo.pars.keys()), if None the 1D derivative for par1 is performed</span>
<span class="sd">        h_par1: increment for par1, if None it is computed internally</span>
<span class="sd">        h_par2: increment for par2, if None it is computed internally</span>
<span class="sd">        qty: cosmo property to derive (implemented qtys listed below)</span>
<span class="sd">        x: the x axis used tom compute qty (defaults are used if not provided)</span>
<span class="sd">        accuracy_order: accuracy of the derivative: 2 or 4 for 1D derivs, 2 for 2D derivs (default 2)</span>
<span class="sd">        bias: float or array with len = accuracy_order + 1 (default 1.0)</span>
<span class="sd">        multipole_l: only used if qty is zpowerspec, accepts 0, 2, 4 (default 0)</span>
<span class="sd">        sigma_v: only used if qty is pkmulti, velocity dispersion for FoG (default 1)</span>
<span class="sd">        ngen_dir: directory where NGenHalofit is installed</span>
<span class="sd">    Implemented qty options:</span>
<span class="sd">        powerspec, nlpowerspec, zpowerspec, nlzpowerspec, halomassfunction,</span>
<span class="sd">        correlationfunction, nlcorrelationfunction, zcorrelationfunction,</span>
<span class="sd">        pkmulti, NGen_halofit</span>

<span class="sd">    Retruns:</span>
<span class="sd">        dictionary with the same structure of qty with derivatives</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="k">assert</span> <span class="n">accuracy_order</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;Implemented accuracy order only are 2 or 4&#39;</span>

    <span class="k">if</span> <span class="n">par2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">accuracy_order</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">coeffs</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">accuracy_order</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">coeffs</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">accuracy_order</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span> <span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="n">coeffs</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;4th order accuracy for 2-dimensional differentiation not implemented&#39;</span><span class="p">)</span>

    <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stencil</span><span class="p">))</span> <span class="o">+</span> <span class="n">bias</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">bias</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span> <span class="o">==</span> <span class="n">accuracy_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;bias not correctly specified&#39;</span>

    <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">qty_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">h_par1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h_par1</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cosmo_pars</span><span class="p">[</span><span class="n">par1</span><span class="p">])</span> <span class="k">if</span> <span class="n">cosmo_pars</span><span class="p">[</span><span class="n">par1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">else</span> <span class="mf">0.01</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">h_par2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">par2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">h_par2</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par2</span><span class="p">])</span> <span class="k">if</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par2</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">else</span> <span class="mf">0.01</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Cosmology</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stencil</span><span class="p">):</span>
        <span class="n">cosmo_pars</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cosmo_params</span><span class="p">)</span>
        <span class="n">_tcosmo</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="p">(</span><span class="o">**</span><span class="n">cosmo_pars</span><span class="p">)</span>
        <span class="n">_tcosmo</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">par1</span> <span class="ow">in</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">_tcosmo</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="n">par1</span><span class="p">,</span> <span class="n">cosmo_pars</span><span class="p">[</span><span class="n">par1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Parameter </span><span class="si">{}</span><span class="s1"> cannot be assigned to Cosmology class&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">par2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par2</span> <span class="ow">in</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">_tcosmo</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="n">par2</span><span class="p">,</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Parameter </span><span class="si">{}</span><span class="s1"> cannot be assigned to Cosmology class&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;powerspec&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;nlpowerspec&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_nlpowerspec</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;zpowerspec&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_zpowerspec</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">l</span><span class="o">=</span><span class="n">multipole_l</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;nlzpowerspec&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_nlzpowerspec</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">l</span><span class="o">=</span><span class="n">multipole_l</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;halomassfunction&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_halomassfunction</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;correlationfunction&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_correlationfunction</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;nlcorrelationfunction&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_nlcorrelationfunction</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;zcorrelationfunction&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_zcorrelationfunction</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">l</span><span class="o">=</span><span class="n">multipole_l</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;pkmulti&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">th_pk</span> <span class="o">=</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">k_scale_indep</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">)</span> <span class="o">/</span> <span class="n">bias</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">RSD</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">FOG</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span> <span class="k">if</span> <span class="n">sigma_v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;gaussian&#39;</span>
            <span class="c1"># compute the P_\ell(k) predictions using the linear matter ps</span>
            <span class="n">th_pk_2d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_pk2d</span><span class="p">(</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">th_pk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="n">sigma_v</span><span class="p">,</span> <span class="n">RSD</span><span class="o">=</span><span class="n">RSD</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="n">FOG</span><span class="p">)</span>
            <span class="n">th_pk_multi</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pkmulti</span><span class="p">(</span><span class="n">x_at_stencil_point</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">th_pk_2d</span><span class="p">)</span>
            <span class="n">th_pk_l0_l2_l4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">th_pk_multi</span><span class="p">)</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th_pk_l0_l2_l4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">qty</span><span class="o">==</span><span class="s1">&#39;NGen_halofit&#39;</span><span class="p">:</span>
            <span class="n">x_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">,</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="s1">&#39;A_s&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma8&#39;</span><span class="p">,</span> <span class="s1">&#39;w0&#39;</span><span class="p">,</span> <span class="s1">&#39;wa&#39;</span><span class="p">,</span><span class="s1">&#39;hubble&#39;</span><span class="p">,</span><span class="s1">&#39;omega_de&#39;</span><span class="p">]</span>
            <span class="n">cosm</span> <span class="o">=</span> <span class="p">{</span><span class="n">par</span><span class="p">:</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">}</span>
            <span class="n">cosm</span><span class="p">[</span><span class="s1">&#39;expfactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">expfactor</span><span class="p">;</span> <span class="n">cosm</span><span class="p">[</span><span class="s1">&#39;de_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">de_model</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">NGenHalofit</span><span class="p">(</span><span class="n">cosm</span><span class="p">,</span> <span class="n">ngen_dir</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">x_at_stencil_point</span><span class="p">)</span>
            <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;pk_ngen&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">cosm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;could not recognize qty </span><span class="si">{}</span><span class="s1">, it is either misspelled or not yet implemented&#39;</span><span class="p">)</span>

        <span class="n">_tcosmo</span><span class="o">.</span><span class="n">cleanup</span><span class="p">();</span> <span class="k">del</span> <span class="n">cosmo_pars</span>

    <span class="n">qty_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qty_at_stencil_point</span><span class="p">)</span>
    <span class="n">div_incr</span> <span class="o">=</span> <span class="n">h_par1</span> <span class="k">if</span> <span class="n">par2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">h_par1</span> <span class="o">*</span> <span class="n">h_par2</span>
    <span class="n">derivative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">qty_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">accuracy_order</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="n">result</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_at_stencil_point</span><span class="p">,</span>
               <span class="s1">&#39;deriv&#39;</span><span class="p">:</span> <span class="n">derivative</span><span class="p">,</span>
               <span class="s1">&#39;lnderiv&#39;</span> <span class="p">:</span> <span class="n">derivative</span> <span class="o">/</span> <span class="n">qty_at_stencil_point</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
               <span class="s1">&#39;qty_at_stencil_point&#39;</span> <span class="p">:</span> <span class="n">qty_at_stencil_point</span>
              <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">sim_derivatives</span><span class="p">(</span><span class="n">cosmo_params</span><span class="p">,</span> <span class="n">sim_basedir</span><span class="p">,</span> <span class="n">sim_dm_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sim_halo_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interpolate_snaps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">par1</span><span class="o">=</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">,</span> <span class="n">par2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">x0_par1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x0_par2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_par1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_par2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logpar1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">logpar2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;sdmPower&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">derive_pmulti</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">accuracy_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">conc_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lss_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">use_orphans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">baryons</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">scaler_kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the derivatives, starting from a simulation that gets rescaled to</span>
<span class="sd">    the necessary cosmologies</span>

<span class="sd">    Inputs:</span>
<span class="sd">        cosmo_params: dictionary with cosmology parameters (included redshift), around which the derivatives will be computed</span>
<span class="sd">        sim_basedir: basedir where the sim is located</span>
<span class="sd">        sim_dm_file: dm_file, to be passed if mass ptcls are required (at any time, the snap number will be overwritten)</span>
<span class="sd">        sim_halo_file: halo_file, to be passed if sdm, halo or subs are required (at any time, the snap number will be overwritten)</span>
<span class="sd">        paired: whether it is a paired simulation</span>
<span class="sd">        interpolate_snaps: whether to interpolate between the two clostest snapshots or not in the scaling</span>
<span class="sd">        par1: name of parameter to derive (among cosmo.pars.keys())</span>
<span class="sd">        par2: name of parameter to derive (among cosmo.pars.keys()), if None the 1D derivative for par1 is performed</span>
<span class="sd">        x0_par1: value around which evaluate the derivative for par1 (if None, the one of the simulation is used)</span>
<span class="sd">        x0_par2: value around which evaluate the derivative for par2 (if None, the one of the simulation is used)</span>
<span class="sd">        h_par1: increment for par1, if None it is computed internally</span>
<span class="sd">        h_par2: increment for par2, if None it is computed internally</span>
<span class="sd">        logpar1: whether or not par1 is in log10</span>
<span class="sd">        logpar2: whether or not par2 is in log10</span>
<span class="sd">        qty: sim property to derive (implemented Power, sdmPower, haloPower, subPower)</span>
<span class="sd">        accuracy_order: accuracy of the derivative: 2 or 4 for 1D derivs, 2 for 2D derivs (default 2)</span>
<span class="sd">        conc_correction: whether to apply the concentration correction in the rescaling (default True)</span>
<span class="sd">        lss_correction: whether to apply the lss correction in the rescaling (default True)</span>
<span class="sd">        use_orphans: whether the sim has orphans (default True)</span>
<span class="sd">        A_s: A_s to be passed to the simulation class (default None)</span>
<span class="sd">        baryons: dictionary with parameters to compute the baryons corrections if required</span>
<span class="sd">        **scaler_kwargs: arguments to be passed to scale_simulation, other than conc_correction and lss_correction</span>
<span class="sd">    Retruns:</span>
<span class="sd">        three dictionaries, with the same structure of qty, with derivatives, logderivatives and the vectors containing</span>
<span class="sd">        qty evaluated at the different stencil points used for computing the derivative</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="kn">from</span> <span class="nn">.simulation</span> <span class="k">import</span> <span class="n">ScaledSimulation</span><span class="p">,</span> <span class="n">Simulation</span>
    <span class="kn">from</span> <span class="nn">.scaler</span> <span class="k">import</span> <span class="n">Scaler</span><span class="p">,</span> <span class="n">runmin_cleanup</span>
    <span class="k">if</span> <span class="n">baryons</span><span class="p">:</span> <span class="kn">from</span> <span class="nn">.baryons</span> <span class="k">import</span> <span class="n">Baryons</span>

    <span class="k">assert</span> <span class="n">accuracy_order</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;Implemented accuracy order only are 2 or 4&#39;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">sim_dm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sim_halo_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;Missing one of either dm_file or halo_file&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;WARNING: Corrections for k-shifts not implemented in multipoles and correlation function!&#39;</span><span class="p">)</span>
        <span class="n">compute_kcorr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compute_kcorr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;WARNING: Shotnoise in multipoles is not substracted!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">par2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">accuracy_order</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">coeffs</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">accuracy_order</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">coeffs</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">accuracy_order</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span> <span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="n">coeffs</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;4th order accuracy for 2-dimensional differentiation not implemented&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_original_cosmo</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">bdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;0.00&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">paired</span> <span class="k">else</span> <span class="n">basedir</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">basedir</span><span class="o">=</span><span class="n">bdir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">halo_file</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">)</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">sc</span>

    <span class="n">k_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pk_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pk_l2_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pk_l4_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xi_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pk_theory_lin_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pk_theory_nl_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pmulti0_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pmulti2_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pmulti4_at_stencil_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># theta_at_stencil_point = []</span>
    <span class="c1"># bisp_at_stencil_point = []</span>
    <span class="n">stencil_point_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">cosmology</span>
    <span class="k">for</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stencil</span><span class="p">):</span>
        <span class="n">_ocosmo</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">get_original_cosmo</span><span class="p">(</span><span class="n">sim_basedir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">sim_dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">sim_halo_file</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="n">paired</span><span class="p">,</span> <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">))</span>
        <span class="n">cosmo_pars</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cosmo_params</span><span class="p">)</span>
        <span class="n">baryon_pars</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">baryons</span><span class="p">)</span>

        <span class="n">_tcosmo</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">(</span><span class="o">**</span><span class="n">cosmo_pars</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">par1</span> <span class="ow">in</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">x0_par1</span> <span class="o">=</span> <span class="n">cosmo_pars</span><span class="p">[</span><span class="n">par1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x0_par1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x0_par1</span>
            <span class="k">if</span> <span class="n">h_par1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">h_par1</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0_par1</span><span class="p">)</span> <span class="k">if</span> <span class="n">x0_par1</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">else</span> <span class="mf">0.01</span>
            <span class="k">if</span> <span class="n">logpar1</span><span class="p">:</span>
                <span class="n">_tcosmo</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="n">par1</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">x0_par1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_tcosmo</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="n">par1</span><span class="p">,</span> <span class="n">x0_par1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">par1</span> <span class="ow">in</span> <span class="n">baryon_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">x0_par1</span> <span class="o">=</span> <span class="n">baryon_pars</span><span class="p">[</span><span class="n">par1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x0_par1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x0_par1</span>
            <span class="k">if</span> <span class="n">h_par1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">h_par1</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0_par1</span><span class="p">)</span> <span class="k">if</span> <span class="n">x0_par1</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">else</span> <span class="mf">0.01</span>
            <span class="k">if</span> <span class="n">logpar1</span><span class="p">:</span>
                <span class="n">baryon_pars</span><span class="p">[</span><span class="n">par1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">x0_par1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">baryon_pars</span><span class="p">[</span><span class="n">par1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0_par1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Parameter </span><span class="si">{}</span><span class="s1"> cannot be assigned neither to Cosmology nor to Baryons class&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">par2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par2</span> <span class="ow">in</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">x0_par2</span> <span class="o">=</span> <span class="n">cosmo_pars</span><span class="p">[</span><span class="n">par2</span><span class="p">]</span> <span class="k">if</span> <span class="n">x0_par2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x0_par2</span>
                <span class="k">if</span> <span class="n">h_par2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">h_par2</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0_par2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x0_par2</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">else</span> <span class="mf">0.01</span>
                <span class="k">if</span> <span class="n">logpar2</span><span class="p">:</span>
                    <span class="n">_tcosmo</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="n">par2</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">x0_par2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par2</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_tcosmo</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="n">par2</span><span class="p">,</span> <span class="n">x0_par2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par2</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">par_2</span> <span class="ow">in</span>  <span class="n">baryon_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">x0_par2</span> <span class="o">=</span> <span class="n">baryon_pars</span><span class="p">[</span><span class="n">par2</span><span class="p">]</span> <span class="k">if</span> <span class="n">x0_par2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x0_par2</span>
                <span class="k">if</span> <span class="n">h_par2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">h_par2</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0_par2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x0_par2</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">else</span> <span class="mf">0.01</span>
                <span class="k">if</span> <span class="n">logpar2</span><span class="p">:</span>
                    <span class="n">baryon_pars</span><span class="p">[</span><span class="n">par2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">x0_par2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">baryon_pars</span><span class="p">[</span><span class="n">par2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0_par2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">point</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_par2</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Parameter </span><span class="si">{}</span><span class="s1"> cannot be assigned neither to Cosmology nor to Baryons class&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par2</span><span class="p">))</span>

        <span class="n">fof_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sub_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dm_qtys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Power&#39;</span><span class="p">,</span> <span class="s1">&#39;zPower&#39;</span><span class="p">]</span>
        <span class="n">sdm_qtys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sdmPower&#39;</span><span class="p">,</span> <span class="s1">&#39;sdmzPower&#39;</span><span class="p">]</span>
        <span class="n">halo_qtys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;haloPower&#39;</span><span class="p">,</span> <span class="s1">&#39;zhaloPower&#39;</span><span class="p">,</span> <span class="s1">&#39;haloPower_100particles&#39;</span><span class="p">,</span> <span class="s1">&#39;zhaloPower_100particles&#39;</span><span class="p">]</span>
        <span class="n">sub_qtys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subhalo_power_vpeak&#39;</span><span class="p">,</span> <span class="s1">&#39;subhalo_power_vmax&#39;</span><span class="p">,</span> <span class="s1">&#39;subhalo_power_vmax_real&#39;</span><span class="p">,</span> <span class="s1">&#39;subhalo_power_vpeak_real&#39;</span><span class="p">,</span> <span class="s1">&#39;subhalo_pmulti_vpeak&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">dm_qtys</span><span class="p">:</span>
            <span class="n">scl_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">scl_sdm</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">scl_halos</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">conc_correction</span> <span class="k">else</span> <span class="kc">False</span><span class="p">;</span> <span class="n">scl_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span>
            <span class="k">if</span> <span class="n">conc_correction</span><span class="p">:</span> <span class="n">fof_props</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">,</span> <span class="s1">&#39;halo_m200c&#39;</span><span class="p">,</span><span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">baryon_pars</span><span class="p">:</span> <span class="n">baryon_pars</span><span class="p">[</span><span class="s1">&#39;use_dm&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">elif</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">sdm_qtys</span><span class="p">:</span>
            <span class="n">scl_dm</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">scl_sdm</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">scl_halos</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">scl_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span>
            <span class="n">fof_props</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;halo_sdm&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">conc_correction</span><span class="p">:</span> <span class="n">fof_props</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;halo_radial_bins&#39;</span><span class="p">,</span> <span class="s1">&#39;halo_m200c&#39;</span><span class="p">,</span> <span class="s1">&#39;halo_mfof&#39;</span><span class="p">,</span><span class="s1">&#39;nhalos&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">baryon_pars</span><span class="p">:</span> <span class="n">baryon_pars</span><span class="p">[</span><span class="s1">&#39;use_sdm&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">elif</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">halo_qtys</span><span class="p">:</span>
            <span class="n">scl_dm</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">scl_sdm</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">scl_halos</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">scl_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">baryon_pars</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fof_props</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;halo_vel&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">conc_correction</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;conc_correction does not apply to halos, setting it to False&#39;</span><span class="p">)</span>
                <span class="n">conc_correction</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">elif</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">sub_qtys</span><span class="p">:</span>
            <span class="n">scl_dm</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">scl_sdm</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">scl_halos</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">scl_sub</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">baryon_pars</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">sub_props</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">conc_correction</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;conc_correction does not apply to subhalos, setting it to False&#39;</span><span class="p">)</span>
                <span class="n">conc_correction</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Defaulting scaling options!&#39;</span><span class="p">)</span>
            <span class="n">scl_dm</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">scl_sdm</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">scl_halos</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">conc_correction</span> <span class="k">else</span> <span class="kc">False</span><span class="p">;</span> <span class="n">scl_sub</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">par1</span> <span class="ow">in</span> <span class="n">_ocosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Changing cosmo par </span><span class="si">{}</span><span class="s1"> from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par1</span><span class="p">,</span> <span class="n">_ocosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par1</span><span class="p">],</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">par1</span><span class="p">]))</span>

        <span class="n">scaled_sim</span> <span class="o">=</span>  <span class="n">ScaledSimulation</span><span class="p">(</span><span class="n">_tcosmo</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="n">sim_basedir</span><span class="p">,</span> <span class="n">dm_file</span><span class="o">=</span><span class="n">sim_dm_file</span><span class="p">,</span> <span class="n">halo_file</span><span class="o">=</span><span class="n">sim_halo_file</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="n">paired</span><span class="p">,</span>
                                                      <span class="n">interpolate_snaps</span><span class="o">=</span><span class="n">interpolate_snaps</span><span class="p">,</span> <span class="n">conc_correction</span><span class="o">=</span><span class="n">conc_correction</span><span class="p">,</span>
                                                      <span class="n">lss_correction</span><span class="o">=</span><span class="n">lss_correction</span><span class="p">,</span> <span class="n">use_orphans</span><span class="o">=</span><span class="n">use_orphans</span><span class="p">,</span>
                                                      <span class="n">A_s</span><span class="o">=</span><span class="n">A_s</span><span class="p">,</span> <span class="n">baryons</span><span class="o">=</span><span class="n">baryon_pars</span><span class="p">,</span> <span class="n">fof_props</span><span class="o">=</span><span class="n">fof_props</span><span class="p">,</span> <span class="n">sub_props</span><span class="o">=</span><span class="n">sub_props</span><span class="p">,</span>
                                                      <span class="n">scl_sdm</span><span class="o">=</span><span class="n">scl_sdm</span><span class="p">,</span> <span class="n">scl_halos</span><span class="o">=</span><span class="n">scl_halos</span><span class="p">,</span> <span class="n">scl_sub</span><span class="o">=</span><span class="n">scl_sub</span><span class="p">,</span> <span class="o">**</span><span class="n">scaler_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Target at a = </span><span class="si">{}</span><span class="s1"> corresponds to original at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">a_in_original</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">interpolate_snaps</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Closests outputs wrt </span><span class="si">{}</span><span class="s1"> are </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, i.e. snaps </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scaled_sim</span><span class="o">.</span><span class="n">a_in_original</span><span class="p">,</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snap_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snap_times</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Closests outputs wrt </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1">, i.e. snap </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scaled_sim</span><span class="o">.</span><span class="n">a_in_original</span><span class="p">,</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snap_times</span><span class="p">,</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snaps</span><span class="p">))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mask</span>

        <span class="n">k_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">r_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span>
        <span class="c1"># theta_at_stencil_point = scaled_sim.Power[&#39;theta&#39;]</span>
        <span class="n">stencil_point_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;cosmo&#39;</span><span class="p">:</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="s1">&#39;cosmo_expfactor&#39;</span><span class="p">:</span><span class="n">_tcosmo</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span>
            <span class="s1">&#39;baryons&#39;</span><span class="p">:</span> <span class="n">baryon_pars</span><span class="p">,</span><span class="s1">&#39;a_in_original&#39;</span><span class="p">:</span><span class="n">scaled_sim</span><span class="o">.</span><span class="n">a_in_original</span><span class="p">,</span> <span class="s1">&#39;snaps&#39;</span><span class="p">:</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snaps</span><span class="p">,</span>
                    <span class="s1">&#39;snap_times&#39;</span><span class="p">:</span> <span class="n">scaled_sim</span><span class="o">.</span><span class="n">snap_times</span><span class="p">})</span>

        <span class="n">pk_l2_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pk_l2&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="n">qty</span> <span class="o">!=</span> <span class="s1">&#39;subhalo_pmulti_vpeak&#39;</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">pk_l4_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pk_l4&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="n">qty</span> <span class="o">!=</span> <span class="s1">&#39;subhalo_pmulti_vpeak&#39;</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

        <span class="n">xi_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;xi&#39;</span><span class="p">])</span>
        <span class="c1"># bisp_at_stencil_point.append(scaled_sim.Power[&#39;bispec&#39;])</span>
        <span class="n">pk_theory_lin_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">pk_theory_nl_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

        <span class="n">pk_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pk&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;shotnoise&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>  <span class="k">if</span> <span class="n">qty</span> <span class="o">!=</span> <span class="s1">&#39;subhalo_pmulti_vpeak&#39;</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">compute_kcorr</span><span class="p">:</span>
            <span class="n">pk_corr</span> <span class="o">=</span> <span class="n">_tcosmo</span><span class="o">.</span><span class="n">get_nlpowerspec</span><span class="p">(</span><span class="n">k_at_stencil_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pk_at_stencil_point</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">pk_corr</span><span class="o">/</span><span class="n">pk_theory_nl_at_stencil_point</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span>
            <span class="n">pk_theory_lin_at_stencil_point</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">pk_corr</span><span class="o">/</span><span class="n">pk_theory_nl_at_stencil_point</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span>
            <span class="n">pk_theory_nl_at_stencil_point</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pk_corr</span>

        <span class="k">if</span> <span class="n">derive_pmulti</span><span class="p">:</span>
            <span class="n">pmulti0_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
            <span class="n">pmulti2_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
            <span class="n">pmulti4_at_stencil_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scaled_sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;pmulti&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

        <span class="k">del</span> <span class="n">_tcosmo</span>
        <span class="k">del</span> <span class="n">_ocosmo</span>
        <span class="k">del</span> <span class="n">scaled_sim</span>
        <span class="k">del</span> <span class="n">cosmo_pars</span>
        <span class="k">del</span> <span class="n">baryon_pars</span>

    <span class="n">div_incr</span> <span class="o">=</span> <span class="n">h_par1</span> <span class="k">if</span> <span class="n">par2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">h_par1</span> <span class="o">*</span> <span class="n">h_par2</span>

    <span class="n">k_at_stencil_point</span> <span class="o">=</span> <span class="n">k_at_stencil_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>



    <span class="n">pk_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pk_at_stencil_point</span><span class="p">)</span>
    <span class="n">pk_l2_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pk_l2_at_stencil_point</span><span class="p">)</span>
    <span class="n">pk_l4_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pk_l4_at_stencil_point</span><span class="p">)</span>
    <span class="n">xi_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xi_at_stencil_point</span><span class="p">)</span>
    <span class="n">pk_theory_lin_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pk_theory_lin_at_stencil_point</span><span class="p">)</span>
    <span class="n">pk_theory_nl_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pk_theory_nl_at_stencil_point</span><span class="p">)</span>
    <span class="n">pmulti0_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pmulti0_at_stencil_point</span><span class="p">)</span>
    <span class="n">pmulti2_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pmulti2_at_stencil_point</span><span class="p">)</span>
    <span class="n">pmulti4_at_stencil_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pmulti4_at_stencil_point</span><span class="p">)</span>

    <span class="n">derivative_pk</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pk_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span>
    <span class="n">derivative_pk_l2</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pk_l2_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span>
    <span class="n">derivative_pk_l4</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pk_l4_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span>
    <span class="n">derivative_xi</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">xi_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span>
    <span class="n">derivative_pk_theory_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pk_theory_lin_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span>
    <span class="n">derivative_pk_theory_nl</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pk_theory_nl_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span>
    <span class="c1">#derivative_bisp  = np.sum((np.array(coeffs) * np.array(bisp_at_stencil_point).T).T, axis=0) / div_incr</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">accuracy_order</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">derive_pmulti</span><span class="p">:</span>
        <span class="n">derivative_pmulti</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pmulti0_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span><span class="p">,</span>
                                             <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pmulti2_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span><span class="p">,</span>
                                             <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pmulti4_at_stencil_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_incr</span><span class="p">])</span>
        <span class="n">lnderivative_pmulti</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">derivative_pmulti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pmulti0_at_stencil_point</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                             <span class="n">derivative_pmulti</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pmulti2_at_stencil_point</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                             <span class="n">derivative_pmulti</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pmulti4_at_stencil_point</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)])</span>

    <span class="n">deriv</span>   <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_at_stencil_point</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">derivative_pk</span><span class="p">,</span> <span class="s1">&#39;pk_l2&#39;</span> <span class="p">:</span> <span class="n">derivative_pk_l2</span><span class="p">,</span>
              <span class="s1">&#39;pk_l4&#39;</span> <span class="p">:</span> <span class="n">derivative_pk_l4</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r_at_stencil_point</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span> <span class="p">:</span> <span class="n">derivative_xi</span><span class="p">,</span>
              <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span> <span class="n">derivative_pk_theory_lin</span><span class="p">,</span> <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span> <span class="n">derivative_pk_theory_nl</span><span class="p">,</span>
              <span class="c1"># &#39;theta&#39; : theta_at_stencil_point, &#39;bispec&#39;: derivative_bisp</span>
              <span class="s1">&#39;pmulti&#39;</span> <span class="p">:</span> <span class="n">derivative_pmulti</span> <span class="k">if</span> <span class="n">derive_pmulti</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">0.0</span>
              <span class="p">}</span>
    <span class="n">lnderiv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_at_stencil_point</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">derivative_pk</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pk_at_stencil_point</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
              <span class="s1">&#39;pk_l2&#39;</span> <span class="p">:</span> <span class="n">derivative_pk_l2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pk_l2_at_stencil_point</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
              <span class="s1">&#39;pk_l4&#39;</span> <span class="p">:</span> <span class="n">derivative_pk_l4</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pk_l4_at_stencil_point</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
              <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r_at_stencil_point</span><span class="p">,</span>
              <span class="s1">&#39;xi&#39;</span> <span class="p">:</span> <span class="n">derivative_xi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xi_at_stencil_point</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
              <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span> <span class="n">derivative_pk_theory_lin</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pk_theory_lin_at_stencil_point</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
              <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span> <span class="n">derivative_pk_theory_nl</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pk_theory_nl_at_stencil_point</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
              <span class="c1"># &#39;theta&#39; : theta_at_stencil_point, &#39;bispec&#39;: derivative_bisp</span>
              <span class="s1">&#39;pmulti&#39;</span> <span class="p">:</span> <span class="n">lnderivative_pmulti</span> <span class="k">if</span> <span class="n">derive_pmulti</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">0.0</span>
              <span class="p">}</span>
    <span class="n">qty_at_stencil_point</span> <span class="o">=</span> <span class="p">{</span>
             <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_at_stencil_point</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r_at_stencil_point</span><span class="p">,</span>
             <span class="s1">&#39;pk&#39;</span> <span class="p">:</span> <span class="n">pk_at_stencil_point</span><span class="p">,</span> <span class="s1">&#39;pk_l2&#39;</span> <span class="p">:</span> <span class="n">pk_l2_at_stencil_point</span><span class="p">,</span>
             <span class="s1">&#39;pk_l4&#39;</span> <span class="p">:</span> <span class="n">pk_l4_at_stencil_point</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span> <span class="p">:</span> <span class="n">xi_at_stencil_point</span><span class="p">,</span>
             <span class="s1">&#39;pk_theory_lin&#39;</span> <span class="p">:</span> <span class="n">pk_theory_lin_at_stencil_point</span><span class="p">,</span>
             <span class="s1">&#39;pk_theory_nl&#39;</span> <span class="p">:</span> <span class="n">pk_theory_nl_at_stencil_point</span><span class="p">,</span>
             <span class="s1">&#39;stencil_info&#39;</span><span class="p">:</span><span class="n">stencil_point_info</span>
             <span class="p">}</span>
    <span class="k">return</span> <span class="n">deriv</span><span class="p">,</span> <span class="n">lnderiv</span><span class="p">,</span> <span class="n">qty_at_stencil_point</span>

<span class="k">def</span> <span class="nf">scaled_sim_snapshots</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">snaplist_filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">,</span> <span class="n">from_snap_forward</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">snaplist</span><span class="p">,</span> <span class="n">atimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">snaplist_filename</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">:</span>
        <span class="n">original</span><span class="o">.</span><span class="n">set_initial_growth_expfac</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">set_initial_growth_expfac</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;forward&#39;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">from_snap_forward</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">o_expfactor</span> <span class="o">=</span> <span class="n">atimes</span><span class="p">[</span><span class="n">from_snap_forward</span><span class="p">]</span>
        <span class="n">original</span><span class="o">.</span><span class="n">set_expfactor</span><span class="p">(</span><span class="n">o_expfactor</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">.scaler</span> <span class="k">import</span> <span class="n">Scaler</span><span class="p">,</span> <span class="n">runmin_cleanup</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">runmin</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">expfactor</span> <span class="o">=</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;a_in_original&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span> <span class="k">else</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;a_in_target&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">atimes</span> <span class="o">-</span> <span class="n">expfactor</span><span class="p">))</span>
        <span class="n">snaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span><span class="p">,</span> <span class="n">id1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">atimes</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span> <span class="o">-</span> <span class="n">expfactor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">id1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atimes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">id1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">id1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;a in original : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;closest snapshots in original cosmology: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">snaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;corresponding to times: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atimes</span><span class="p">[</span><span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">atimes</span><span class="p">[</span><span class="n">snaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the original cosmology at a = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_expfactor</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;corresponds to the target cosmology at a = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expfactor</span><span class="p">))</span>

    <span class="n">runmin_cleanup</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">log_int_ext</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Log interpolation &amp; extrapolation of a set of data. The kind and order of</span>
<span class="sd">    the interpolation can be chosen through the keywork kind. The</span>
<span class="sd">    extrapolation only implements a power law (linear extrapolation in log-log).</span>

<span class="sd">    All data passed to and received from this function are in linear scale, the</span>
<span class="sd">    log conversion is done internally.</span>

<span class="sd">    Input ----------------------------------------------------------------------</span>
<span class="sd">      x    :   independent variable (linear scale)</span>
<span class="sd">      y    :   dependent variable (linear scale)</span>
<span class="sd">      kind :   (optional) kind of interpolation between linear, nearest,</span>
<span class="sd">               zero, slinear, quadratic, cubic, previous, next.</span>
<span class="sd">               Deafult is quadratic.</span>
<span class="sd">    Output ---------------------------------------------------------------------</span>
<span class="sd">      f    :   interpolator/extrapolator (callable), such that y0 = f(x0)</span>
<span class="sd">    ----------------------------------------------------------------------------</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;quadratic&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
        <span class="n">lnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">lny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_lnx</span> <span class="o">=</span> <span class="n">lnx</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_lnx</span> <span class="o">=</span> <span class="n">lnx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lnx</span><span class="p">,</span> <span class="n">lny</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">lny</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lny</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lnx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lnx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">=</span> <span class="p">(</span><span class="n">lny</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lny</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lnx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lnx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qleft</span> <span class="o">=</span> <span class="n">lny</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">*</span> <span class="n">lnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qright</span> <span class="o">=</span> <span class="n">lny</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">*</span> <span class="n">lnx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_lny_at_lnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lnx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lnx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_lnx</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">*</span> <span class="n">lnx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qleft</span>
        <span class="k">elif</span> <span class="n">lnx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_lnx</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">*</span> <span class="n">lnx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qright</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lnx</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">lnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_lny_at_lnx</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span> <span class="k">for</span> <span class="n">lx</span> <span class="ow">in</span> <span class="n">lnx</span><span class="p">]))</span>

<span class="k">class</span> <span class="nc">lin_int_ext</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Lin interpolation &amp; extrapolation of a set of data. The kind and order of</span>
<span class="sd">    the interpolation can be chosen through the keywork kind. The</span>
<span class="sd">    extrapolation only implements a linear extrapolation.</span>

<span class="sd">    All data passed to and received from this function are in linear scale.</span>

<span class="sd">    Input ----------------------------------------------------------------------</span>
<span class="sd">      x    :   independent variable (linear scale)</span>
<span class="sd">      y    :   dependent variable (linear scale)</span>
<span class="sd">      kind :   (optional) kind of interpolation between linear, nearest,</span>
<span class="sd">               zero, slinear, quadratic, cubic, previous, next.</span>
<span class="sd">               Deafult is quadratic.</span>
<span class="sd">    Output ---------------------------------------------------------------------</span>
<span class="sd">      f    :   interpolator/extrapolator (callable), such that y0 = f(x0)</span>
<span class="sd">    ----------------------------------------------------------------------------</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;quadratic&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qleft</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qright</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_y_at_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_x</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qleft</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qright</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_at_x</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]))</span>

<span class="k">class</span> <span class="nc">semilogx_int_ext</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Log-x interpolation &amp; extrapolation of a set of data. The kind and order of</span>
<span class="sd">    the interpolation can be chosen through the keyword kind. The</span>
<span class="sd">    extrapolation only implements a power law (linear extrapolation in log-lin).</span>

<span class="sd">    All data passed to and received from this function are in linear scale, the</span>
<span class="sd">    log conversion is done internally.</span>

<span class="sd">    Input ----------------------------------------------------------------------</span>
<span class="sd">      x    :   independent variable (linear scale)</span>
<span class="sd">      y    :   dependent variable (linear scale)</span>
<span class="sd">      kind :   (optional) kind of interpolation between linear, nearest,</span>
<span class="sd">               zero, slinear, quadratic, cubic, previous, next.</span>
<span class="sd">               Deafult is quadratic.</span>
<span class="sd">    Output ---------------------------------------------------------------------</span>
<span class="sd">      f    :   interpolator/extrapolator (callable), such that y0 = f(x0)</span>
<span class="sd">    ----------------------------------------------------------------------------</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;quadratic&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
        <span class="n">lnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_lnx</span> <span class="o">=</span> <span class="n">lnx</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_lnx</span> <span class="o">=</span> <span class="n">lnx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lnx</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lnx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lnx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lnx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lnx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qleft</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">*</span> <span class="n">lnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qright</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">*</span> <span class="n">lnx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_y_at_lnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lnx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lnx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_lnx</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mleft</span> <span class="o">*</span> <span class="n">lnx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qleft</span>
        <span class="k">elif</span> <span class="n">lnx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_lnx</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mright</span> <span class="o">*</span> <span class="n">lnx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qright</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lnx</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">lnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_at_lnx</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span> <span class="k">for</span> <span class="n">lx</span> <span class="ow">in</span> <span class="n">lnx</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">get_quasirandom_number</span><span class="p">(</span><span class="n">nelements</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
    <span class="k">return</span> <span class="n">lss</span><span class="o">.</span><span class="n">get_quasirandom</span><span class="p">(</span><span class="n">nelements</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">compute_displacement</span><span class="p">(</span><span class="n">Cosmology</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">424</span><span class="p">,</span> <span class="n">fixedPk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">InitialPhase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">damping_scale</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
    <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ngrid</span>

    <span class="n">Di</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">Di2</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">Di3a</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">Di3b</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">return_density</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">order_by_order</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">disp_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
                                 <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                                 <span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fixedPk</span><span class="p">,</span>
                                 <span class="n">InitialPhase</span><span class="p">,</span> <span class="n">return_density</span><span class="p">,</span>
                                 <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">disp_field</span>

<span class="k">def</span> <span class="nf">auto_power_lpt_orders</span><span class="p">(</span><span class="n">Cosmology</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">424</span><span class="p">,</span> <span class="n">InitialPhase</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixedPk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_grids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lpt_order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
    <span class="kn">from</span> <span class="nn">bacco.statistics</span> <span class="k">import</span> <span class="n">compute_powerspectrum</span><span class="p">,</span> <span class="n">compute_crossspectrum_twogrids</span>

    <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ngrid</span>

    <span class="n">Di</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">Di2</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">Di3a</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">Di3b</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">damping_scale</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">get_nonlinear_scale</span><span class="p">()</span>
    <span class="c1">#We avoid damping the power spectrum at all</span>
    <span class="n">damping_scale</span> <span class="o">*=</span> <span class="mi">100</span>

    <span class="n">order_by_order</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">return_density</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">redshift_space</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">gr</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
    <span class="n">lpt_order</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;LPT_order&#39;</span><span class="p">]</span>

    <span class="n">stat_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dens_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
                                 <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">gr</span><span class="p">,</span> <span class="n">lpt_order</span><span class="p">,</span> <span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                                 <span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fixedPk</span><span class="p">,</span>
                                 <span class="n">InitialPhase</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_density</span><span class="p">,</span> <span class="n">redshift_space</span><span class="p">,</span>
                                 <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1">#auto power spectra</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ngrid</span> <span class="o">=</span> <span class="n">dens_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]):</span>
        <span class="n">lpk</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="n">dens_field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dens_field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_lpt_field&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpk</span><span class="p">[</span><span class="s1">&#39;nmodes&#39;</span><span class="p">])</span>

    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_lpt_field&#39;</span><span class="p">])</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_lpt_field&#39;</span><span class="p">])</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_lpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_lpt_field&#39;</span><span class="p">])</span>

    <span class="c1">#cross power spectra</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_xlpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_xlpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_xlpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">lpk</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="n">dens_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dens_field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">ngrid</span><span class="o">=</span><span class="n">dens_field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_xlpt_field&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpk</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_xlpt_field&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpk</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_xlpt_field&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpk</span><span class="p">[</span><span class="s1">&#39;nmodes&#39;</span><span class="p">])</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_xlpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_xlpt_field&#39;</span><span class="p">])</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_xlpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_xlpt_field&#39;</span><span class="p">])</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_xlpt_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_xlpt_field&#39;</span><span class="p">])</span>

    <span class="n">full_field</span> <span class="o">=</span> <span class="n">dens_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lpt_order</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">full_field</span> <span class="o">+=</span> <span class="n">dens_field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lpt_order</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">full_field</span> <span class="o">+=</span> <span class="n">dens_field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">full_dict</span> <span class="o">=</span> <span class="n">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="n">full_field</span><span class="p">,</span> <span class="n">full_field</span><span class="p">,</span><span class="n">interlacing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">ngrid</span><span class="o">=</span><span class="n">dens_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">Cosmology</span><span class="p">)</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_full_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dict</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_full_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;nmodes_full_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dict</span><span class="p">[</span><span class="s1">&#39;nmodes&#39;</span><span class="p">]</span>

    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_theory_lin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;k_theory_nl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dict</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dict</span><span class="p">[</span><span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">]</span>
    <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dict</span><span class="p">[</span><span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">return_grids</span><span class="p">:</span>
        <span class="n">stat_dict</span><span class="p">[</span><span class="s1">&#39;field_LPT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_field</span><span class="o">*</span><span class="n">ngrid</span><span class="o">**</span><span class="mi">3</span>
    <span class="k">return</span> <span class="n">stat_dict</span>

<span class="k">def</span> <span class="nf">symmetrize_grid_2d</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngrid</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngrid</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">ngrid</span> <span class="o">-</span> <span class="n">i</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>
    <span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="mf">0.0</span><span class="n">j</span>
    <span class="k">return</span> <span class="n">grid</span>

<span class="k">def</span> <span class="nf">create_density_field_2d</span><span class="p">(</span><span class="n">k_in</span><span class="p">,</span> <span class="n">pk_in</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">fixedpk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># fac = (2.0* np.pi / box)</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">pk_at_k</span> <span class="o">=</span> <span class="n">log_int_ext</span><span class="p">(</span><span class="n">k_in</span><span class="p">,</span> <span class="n">pk_in</span><span class="p">)</span>

    <span class="n">kf</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span><span class="p">)</span>

    <span class="n">delta_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngrid</span><span class="p">):</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">ngrid</span> <span class="o">-</span> <span class="n">i</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">i</span>
        <span class="n">kx</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">*</span> <span class="n">ii</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="n">ngrid</span> <span class="o">-</span> <span class="n">j</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">j</span>
            <span class="n">ky</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">*</span> <span class="n">jj</span>

            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ky</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="n">dmodulus</span> <span class="o">=</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pk_at_k</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">fixedpk</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">dmodulus</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()))</span>

            <span class="n">dphase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

            <span class="n">delta_c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmodulus</span> <span class="o">*</span> <span class="n">dphase</span>

    <span class="n">delta_c</span> <span class="o">=</span> <span class="n">symmetrize_grid_2d</span><span class="p">(</span><span class="n">delta_c</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">delta_c_2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Warning: 2LPT in 2D not implemented yet&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta_c_2</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">delta_c_3</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Warning: 3LPT in 2D not implemented yet&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta_c_3</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">delta_c</span> <span class="o">+=</span> <span class="n">delta_c_2</span> <span class="o">+</span> <span class="n">delta_c_3</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">delta_c</span><span class="p">),</span> <span class="n">delta_c</span>

<span class="k">def</span> <span class="nf">power_compute_2d</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">delta_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dims_k</span> <span class="o">=</span> <span class="n">delta_k</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ngrid</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">k_meas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
    <span class="n">p_meas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
    <span class="n">n_meas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
    <span class="n">kf</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span>
    <span class="n">kmin</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">kf</span>
    <span class="n">kmax</span> <span class="o">=</span> <span class="n">kmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kf</span>
    <span class="n">binfac</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">-</span> <span class="n">kmin</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngrid</span><span class="p">):</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">ngrid</span> <span class="o">-</span> <span class="n">i</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">i</span>
        <span class="n">kx</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">*</span> <span class="n">ii</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="n">ngrid</span> <span class="o">-</span> <span class="n">j</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">j</span>
            <span class="n">ky</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">*</span> <span class="n">jj</span>

            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ky</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="n">kmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">kmax</span><span class="p">):</span>

                <span class="nb">bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">((</span><span class="n">k</span> <span class="o">-</span> <span class="n">kf</span><span class="p">)</span> <span class="o">*</span> <span class="n">binfac</span><span class="p">))</span>
                <span class="n">n_meas</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">k_meas</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">k</span>
                <span class="n">p_meas</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">delta_k</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">delta_k</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ngrid</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">n_meas</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">k_meas</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">k</span>
                    <span class="n">p_meas</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">delta_k</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">delta_k</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">k_meas</span> <span class="o">/</span> <span class="n">n_meas</span><span class="p">,</span> <span class="n">p_meas</span> <span class="o">/</span> <span class="n">n_meas</span><span class="p">,</span> <span class="n">n_meas</span>

<span class="c1">#Total (recursive) size of an object: http://code.activestate.com/recipes/577504/</span>
<span class="k">def</span> <span class="nf">total_size</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the approximate memory footprint an object and all of its contents.</span>

<span class="sd">    Automatically finds the contents of the following builtin containers and</span>
<span class="sd">    their subclasses:  tuple, list, deque, dict, set and frozenset.</span>
<span class="sd">    To search other containers, add handlers to iterate over their contents:</span>

<span class="sd">        handlers = {SomeContainerClass: iter,</span>
<span class="sd">                    OtherContainerClass: OtherContainerClass.get_elements}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dict_handler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">all_handlers</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
                    <span class="nb">list</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
                    <span class="n">deque</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">:</span> <span class="n">dict_handler</span><span class="p">,</span>
                    <span class="nb">set</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
                    <span class="nb">frozenset</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
                   <span class="p">}</span>
    <span class="n">all_handlers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>     <span class="c1"># user handlers take precedence</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>                      <span class="c1"># track which object id&#39;s have already been seen</span>
    <span class="n">default_size</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># estimate sizeof object without __sizeof__</span>

    <span class="k">def</span> <span class="nf">sizeof</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>       <span class="c1"># do not double count the same object</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">default_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">all_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">sizeof</span><span class="p">,</span> <span class="n">handler</span><span class="p">(</span><span class="n">o</span><span class="p">)))</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">return</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">classifier_ScaleSim</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Cosmology</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">CleanUp_Cosmology</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ANN</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/../tests/testdata/ANN/ANN.h5&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s2">&quot;No network at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/../tests/testdata/ANN/ANN.h5</span><span class="se">\n</span><span class="s1"> Try also: pip install sklearn&#39;</span><span class="p">,))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ANN not found&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Cosmology</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s2">&quot;At least params or Cosmology must be not None&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ANN not found&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Cosmology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Cosmology and params not None, using params&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">sigma8</span><span class="p">,</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">],</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">],</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">CleanUp_Cosmology</span><span class="p">:</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="n">clf</span> <span class="o">=</span> <span class="n">ANN</span><span class="p">[</span><span class="s1">&#39;ANN&#39;</span><span class="p">]</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">ANN</span><span class="p">[</span><span class="s1">&#39;scaler&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_params</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">params</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">_params</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">_params</span><span class="p">)</span>
    <span class="n">best_Cosmology</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Cosmology 0:</span><span class="se">\n</span><span class="s1"> Sigma_8=</span><span class="si">%0.3f</span><span class="s1">, Omega_M=</span><span class="si">%0.3f</span><span class="s1">, Omega_b=</span><span class="si">%0.3f</span><span class="s1">, ns=</span><span class="si">%0.2f</span><span class="s1">, h=</span><span class="si">%0.2f</span><span class="se">\n</span><span class="s1">Cosmology 1:</span><span class="se">\n</span><span class="s1"> Sigma_8=</span><span class="si">%0.3f</span><span class="s1">, Omega_M=</span><span class="si">%0.3f</span><span class="s1">, Omega_b=</span><span class="si">%0.3f</span><span class="s1">, ns=</span><span class="si">%0.2f</span><span class="s1">, h=</span><span class="si">%0.2f</span><span class="se">\n</span><span class="s1">Cosmology 2:</span><span class="se">\n</span><span class="s1"> Sigma_8=</span><span class="si">%0.3f</span><span class="s1">, Omega_M=</span><span class="si">%0.3f</span><span class="s1">, Omega_b=</span><span class="si">%0.3f</span><span class="s1">, ns=</span><span class="si">%0.2f</span><span class="s1">, h=</span><span class="si">%0.2f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.27</span><span class="p">,</span><span class="mf">0.06</span><span class="p">,</span><span class="mf">0.92</span><span class="p">,</span><span class="mf">0.65</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.315</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">1.01</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.36</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">1.01</span><span class="p">,</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;best_Cosmology&#39;</span><span class="p">:</span> <span class="n">best_Cosmology</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span><span class="n">pred</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">Standard_Simulation_Names</span><span class="p">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s1">&#39;test_lcdm&#39;</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">768</span><span class="p">):</span>
    <span class="c1">## Main 3 Cosmology (for now)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Vilya&#39;</span> <span class="ow">or</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;vilya&#39;</span> <span class="ow">or</span>  <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Main_Sergio_00&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;LCDM_sig8_0.900_OmM_0.270_Omb_0.060_ns_0.920_h_0.65_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Nenya&#39;</span> <span class="ow">or</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;nenya&#39;</span> <span class="ow">or</span>  <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Main_Sergio_01&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;LCDM_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Narya&#39;</span> <span class="ow">or</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;narya&#39;</span> <span class="ow">or</span>  <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Main_Sergio_02&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;LCDM_sig8_0.900_OmM_0.360_Omb_0.050_ns_1.010_h_0.70_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="c1">## Target Nenya Cosmology</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_00&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.860_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_01&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.815_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_02&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.770_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_03&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.730_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_04&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.400_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_05&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.360_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_06&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.270_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_07&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.230_Omb_0.050_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_08&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.060_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_09&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.055_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_10&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.045_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_11&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.040_ns_1.010_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_12&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_0.990_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_13&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_0.965_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_14&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_0.940_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_15&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_0.920_h_0.60_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_16&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.80_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_17&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.75_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_18&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.70_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_19&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.65_mnu_0.00_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_20&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.10_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_21&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.20_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_22&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.30_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Name</span> <span class="o">==</span> <span class="s1">&#39;Target_Sergio_23&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Target_sig8_0.900_OmM_0.315_Omb_0.050_ns_1.010_h_0.60_mnu_0.40_N</span><span class="si">%d</span><span class="s1">_output&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">wrapbox</span><span class="p">):</span>
    <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span>  <span class="n">wrapbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">wrapbox</span>
    <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="mi">0</span>      <span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wrapbox</span>
    <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span>  <span class="n">wrapbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">wrapbox</span>
    <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="mi">0</span>      <span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wrapbox</span>
    <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span>  <span class="n">wrapbox</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">wrapbox</span>
    <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="mi">0</span>      <span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wrapbox</span>
    <span class="k">return</span> <span class="n">dp</span>

<span class="k">def</span> <span class="nf">clean_lazy</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">lazy</span><span class="p">)</span> <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">attrs</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">lazy</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">lazy</span><span class="p">[</span><span class="n">at</span><span class="p">]</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">at</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">rejection_sampling</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">npoints</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">block_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to perform rejection sampling in many dimensions.</span>

<span class="sd">    Inputs:</span>

<span class="sd">    func: a function instance corresponding to the required distribution</span>
<span class="sd">          function (normalization is not important)</span>
<span class="sd">    npoints: the desired number of points distributed according to func</span>
<span class="sd">    bounds: ranges for each dimension, with shape (ndims, 2)</span>
<span class="sd">    func_args: additional arguents to be passed to func (must be tuple)</span>
<span class="sd">    threshold: multiplicative factor used to set the threshold of the rejection</span>
<span class="sd">    block_len: number of points tried all together</span>
<span class="sd">    max_iter: number of repetions (final number of tried points will be</span>
<span class="sd">              block_len * max_iter)</span>

<span class="sd">    Retruns:</span>

<span class="sd">    xx: ndarray containing npoints positions in the allowed parameter space</span>
<span class="sd">        distributed according to func</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">naccepted</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">curr_block</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out_points</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">ndims</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ndims</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">low</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">ndims</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">ndims</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">naccepted</span> <span class="o">&lt;</span> <span class="n">npoints</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">curr_block</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">):</span>
        <span class="n">try_vector_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">block_len</span><span class="p">,</span> <span class="n">ndims</span><span class="p">))</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">try_vector_points</span><span class="p">,</span> <span class="o">*</span><span class="n">func_args</span><span class="p">)</span> <span class="k">if</span> <span class="n">func_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">func</span><span class="p">(</span><span class="n">try_vector_points</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block_len</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">block_len</span><span class="p">)</span> <span class="c1"># uniform distribution</span>

        <span class="k">if</span> <span class="n">curr_block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ndims</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">out_points</span><span class="p">,</span> <span class="n">try_vector_points</span><span class="p">[</span><span class="n">mask</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">try_vector_points</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">u</span> <span class="o">&lt;</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">g</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">try_vector_points</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">npoints</span><span class="p">:</span>
            <span class="n">out_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_points</span><span class="p">)</span>
            <span class="n">out_points</span> <span class="o">=</span> <span class="n">out_points</span><span class="p">[:</span><span class="n">npoints</span><span class="p">]</span>
            <span class="n">naccepted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_points</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">naccepted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_points</span><span class="p">)</span>
        <span class="n">curr_block</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">naccepted</span> <span class="o">&lt;</span> <span class="n">npoints</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Not enough points to continue (</span><span class="si">{0}</span><span class="s1"> out of </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">naccepted</span><span class="p">,</span> <span class="n">npoints</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out_points</span>

<span class="k">def</span> <span class="nf">trilin_interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xf</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>

    <span class="n">ngrid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">periodic</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
    <span class="n">flip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>

    <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span>
        <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">z</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">else</span> <span class="n">y</span>

    <span class="n">ngridp</span> <span class="o">=</span> <span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">ngrid</span>
    <span class="n">iy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="n">ngrid</span>
    <span class="n">iz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">%</span> <span class="n">ngrid</span>
    <span class="n">ix1</span> <span class="o">=</span> <span class="p">((</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="n">iy1</span> <span class="o">=</span> <span class="p">((</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="n">iz1</span> <span class="o">=</span> <span class="p">((</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>

    <span class="n">x0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">ix</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">ix</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">iy</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">iy</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">iy</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">iz</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">iz</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">iz</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">ix1</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">ix1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">ix1</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">iy1</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">iy1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">iy1</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">iz1</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">iz1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">iz1</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x0</span> <span class="o">&gt;</span> <span class="n">x1</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ix</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">ix1</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">if</span> <span class="n">y0</span> <span class="o">&gt;</span> <span class="n">y1</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">y1</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">iy</span>
        <span class="n">iy</span> <span class="o">=</span> <span class="n">iy1</span>
        <span class="n">iy1</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">if</span> <span class="n">z0</span> <span class="o">&gt;</span> <span class="n">z1</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">z0</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">z1</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">iz</span>
        <span class="n">iz</span> <span class="o">=</span> <span class="n">iz1</span>
        <span class="n">iz1</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="n">xnow</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>
    <span class="n">ynow</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>
    <span class="n">znow</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">z</span><span class="o">-</span><span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">xf</span><span class="p">)</span>

    <span class="n">y000</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix</span> <span class="p">,</span> <span class="n">iy</span> <span class="p">,</span> <span class="n">iz</span> <span class="p">]</span>
    <span class="n">y100</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span> <span class="n">iy</span> <span class="p">,</span> <span class="n">iz</span> <span class="p">]</span>
    <span class="n">y110</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span> <span class="n">iy1</span><span class="p">,</span> <span class="n">iz</span> <span class="p">]</span>
    <span class="n">y010</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix</span> <span class="p">,</span> <span class="n">iy1</span><span class="p">,</span> <span class="n">iz</span> <span class="p">]</span>
    <span class="n">y001</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix</span> <span class="p">,</span> <span class="n">iy</span> <span class="p">,</span> <span class="n">iz1</span><span class="p">]</span>
    <span class="n">y101</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span> <span class="n">iy</span> <span class="p">,</span> <span class="n">iz1</span><span class="p">]</span>
    <span class="n">y111</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span> <span class="n">iy1</span><span class="p">,</span> <span class="n">iz1</span><span class="p">]</span>
    <span class="n">y011</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">ix</span> <span class="p">,</span> <span class="n">iy1</span><span class="p">,</span> <span class="n">iz1</span><span class="p">]</span>

    <span class="n">a0</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \

    <span class="n">a1</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \

    <span class="n">a2</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \

    <span class="n">a3</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \

    <span class="n">a4</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">*</span> <span class="n">z0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \

    <span class="n">a5</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \

    <span class="n">a6</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \

    <span class="n">a7</span> <span class="o">=</span> <span class="n">y000</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y001</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y010</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y011</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y100</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y101</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y110</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span> \
       <span class="o">+</span> <span class="n">y111</span> <span class="o">/</span> <span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z0</span><span class="p">))</span> \


    <span class="n">result</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">xnow</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">ynow</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">znow</span>                 \
           <span class="o">+</span> <span class="n">a4</span> <span class="o">*</span> <span class="n">xnow</span> <span class="o">*</span> <span class="n">ynow</span> <span class="o">+</span> <span class="n">a5</span> <span class="o">*</span> <span class="n">xnow</span> <span class="o">*</span> <span class="n">znow</span> <span class="o">+</span> <span class="n">a6</span> <span class="o">*</span> <span class="n">ynow</span> <span class="o">*</span> <span class="n">znow</span> \
           <span class="o">+</span> <span class="n">a7</span> <span class="o">*</span> <span class="n">xnow</span> <span class="o">*</span> <span class="n">ynow</span> <span class="o">*</span> <span class="n">znow</span>


    <span class="c1"># print(ix, ix1, iy, iy1, iz, iz1)</span>
    <span class="c1"># print(x0,x1,y0,y1,z0,z1)</span>
    <span class="c1"># print(xnow,ynow,znow)</span>
    <span class="c1"># print(grid[ix,iy,iz] / nmodes * box**3, grid[ix1, iy, iz] / nmodes * box**3, grid[ix1, iy1, iz] / nmodes * box**3, grid[ix, iy1, iz] / nmodes * box**3)</span>
    <span class="c1"># print(grid[ix,iy,iz1] / nmodes * box**3, grid[ix1, iy, iz1] / nmodes * box**3, grid[ix1, iy1, iz1] / nmodes * box**3, grid[ix, iy1, iz1] / nmodes * box**3)</span>
    <span class="c1"># print(result)</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">cic_interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="n">periodic</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
    <span class="n">flip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
    <span class="n">ngrid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># grid = copy.deepcopy(_grid)</span>
    <span class="c1"># grid = grid.flatten()</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="p">):</span>
        <span class="n">x</span><span class="o">=-</span><span class="n">x</span>
        <span class="n">y</span><span class="o">=-</span><span class="n">y</span>
        <span class="n">z</span><span class="o">=-</span><span class="n">z</span>
        <span class="n">flip</span><span class="o">=</span><span class="kc">True</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">ngrid</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">else</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">ngridp</span> <span class="o">=</span> <span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">%</span><span class="n">ngrid</span><span class="p">);</span> <span class="n">iy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">%</span><span class="n">ngrid</span><span class="p">;</span> <span class="n">iz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">%</span><span class="n">ngrid</span><span class="p">;</span>
    <span class="n">ix1</span> <span class="o">=</span> <span class="p">((</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">ngrid</span><span class="p">);</span> <span class="n">iy1</span> <span class="o">=</span> <span class="p">((</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">ngrid</span><span class="p">);</span> <span class="n">iz1</span> <span class="o">=</span> <span class="p">((</span><span class="n">iz</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">ngrid</span><span class="p">);</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span> <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">iy</span><span class="p">));</span> <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">iz</span><span class="p">));</span>

    <span class="n">re</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">ww</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix*ngrid+iy)*ngridp+iz));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">]</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix*ngrid+iy)*ngridp+iz1));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz1</span><span class="p">]</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix*ngrid+iy1)*ngridp+iz));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy1</span><span class="p">,</span><span class="n">iz</span><span class="p">]</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix*ngrid+iy1)*ngridp+iz1));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy1</span><span class="p">,</span><span class="n">iz1</span><span class="p">]</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix1*ngrid+iy)*ngridp+iz));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">]</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix1*ngrid+iy)*ngridp+iz1));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz1</span><span class="p">]</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix1*ngrid+iy1)*ngridp+iz));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span><span class="n">iy1</span><span class="p">,</span><span class="n">iz</span><span class="p">]</span>

    <span class="n">w</span>   <span class="o">=</span> <span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dz</span><span class="p">);</span>
    <span class="n">ww</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="c1"># idx = int(np.rint((ix1*ngrid+iy1)*ngridp+iz1));</span>
    <span class="n">re</span> <span class="o">+=</span> <span class="n">w</span><span class="o">*</span><span class="n">grid</span><span class="p">[</span><span class="n">ix1</span><span class="p">,</span><span class="n">iy1</span><span class="p">,</span><span class="n">iz1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">re</span>

<span class="k">def</span> <span class="nf">NGenHalofit</span><span class="p">(</span><span class="n">cosmo_pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ngen_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Function that return non linear power spectra compured with NGenHalofit (Smith 2018)</span>
<span class="sd">    Make sure to install NGenHalofit before calling this function</span>
<span class="sd">    https://bitbucket.org/ngenhalofitteam/ngenhalofitpublic/src/master/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ngen_dir</span><span class="o">+</span> <span class="s1">&#39;bacco_pk/&#39;</span> <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output_dir</span>
    <span class="n">parf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ngen_dir</span><span class="o">+</span><span class="s1">&#39;parameterfiles/input.bacco.dat&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">cosmology</span>
    <span class="n">cosmo</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">(</span><span class="o">**</span><span class="n">cosmo_pars</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">k</span>
    <span class="n">kmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">);</span> <span class="n">kmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">k</span><span class="p">);</span> <span class="n">nbins</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">logbins</span><span class="o">=</span><span class="mi">1</span>
    <span class="c1">#cosmological parameter</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;aexp </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># normalised expansion factor for generating some auxiliary data. The default value of this should be 1.0.</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;w0 </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="c1"># dark energy equation of state: w=w0+(1-a)wa</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;w1	</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">])</span> <span class="p">)</span>	<span class="c1"># dark energy equation of state: w=w0+(1-a)wa</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;om_ch20 </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="c1">#physical density of CDM (= omega_CDM x h^2)</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;om_bh20	</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_baryon&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>	<span class="c1"># physical density of baryonic matter (= omega_b x h^2)</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;om_DE0  </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;omega_de&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="c1"># total dark energy density (we assume flatness: om_m0=1-om_DE0)</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;As  </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">As</span><span class="o">/</span><span class="mf">2.144850e-9</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># amplitude of primordial power spectrum (1.0 = 2.144850E-09)</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pindex  </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span> <span class="p">)</span>	<span class="p">)</span>	<span class="c1"># power spectral index</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;running </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">)</span>	<span class="c1">#running of the primordial power spectrum</span>

     <span class="c1">#some input parameters</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;nPkOut </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span> <span class="p">)</span> <span class="c1">#number of bins in which the power spectrum is computed up to a max specified by NPKOUT see allvars.h</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rkOutMIN </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kmin</span><span class="p">)</span> <span class="p">)</span>	<span class="c1">#  min wavenumber for the output data file</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rkOutMAX </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span> <span class="p">)</span> 	<span class="c1"># max wavenumber for the output data file</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;iLogOrLin </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logbins</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># logarithmically spaced wavenumbers (1 = logarithmically spaced wavenumbers)</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;iGenEffSpecTarget </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        Generate the halofit spectral parameters for the target model</span>
<span class="sd">     					  == 1 calculate the effective spectral parameters for halofit</span>
<span class="sd">     					  == 0 use pre-computed effective spectral parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;iGenEffSpecVar </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        % Generate the halofit spectral parameters for daemmerung runs</span>
<span class="sd">            == 1 calculate the effective spectral parameters for halofit</span>
<span class="sd">            == 0 use pre-computed effective spectral parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#file handlers</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;PkNGenHalofit_Test&#39;</span>
    <span class="n">pk_dir</span> <span class="o">=</span> <span class="n">ngen_dir</span><span class="o">+</span><span class="s1">&#39;baccolinCLASS/&#39;</span>
    <span class="n">pk_file</span> <span class="o">=</span> <span class="s1">&#39;Pk_class_linear.dat&#39;</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;OutputDir </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># location for output data files</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;OutputFileBase </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="p">)</span> <span class="c1">#base name of the nonlinear power spectra data</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;OutputMPTFileBase </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;PkMPT_PowSpec_Fiducial&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># base name of the MPT spectra data</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PowDirTarget </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pk_dir</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># location of the target linear power spectrum data</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PowFileTarget </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pk_file</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># name of power spectrum target file</span>

    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PowDirVar </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ngen_dir</span><span class="o">+</span><span class="s1">&#39;DATAPlinCAMB/&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># location of the variational linear power spectrum data</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PowFileBaseVar </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Planck2013.Step_ByHand.HighAcc_matterpower&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="c1">#root name of power spectrum files	of the variational runs</span>
    <span class="n">parf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#expansion parameter file</span>
    <span class="n">expf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ngen_dir</span><span class="o">+</span><span class="s1">&#39;parameterfiles/expansion.bacco.dat&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">expf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">expfactor</span><span class="p">))</span>
    <span class="n">expf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#input linear power spectrum file</span>
    <span class="n">create_dir</span><span class="p">(</span><span class="n">pk_dir</span><span class="p">)</span>
    <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">691</span><span class="p">)</span>
    <span class="n">pklin</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">get_powerspec_z0</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kk</span><span class="p">,</span><span class="n">pklin</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">pk_dir</span><span class="o">+</span><span class="n">pk_file</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">cosmo</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cd </span><span class="si">{}</span><span class="s1"> &amp;&amp; ./NGenHalofit.exe </span><span class="si">{}</span><span class="s1">parameterfiles/input.bacco.dat </span><span class="si">{}</span><span class="s1">parameterfiles/expansion.bacco.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ngen_dir</span><span class="p">,</span><span class="n">ngen_dir</span><span class="p">,</span><span class="n">ngen_dir</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">output_dir</span><span class="o">+</span><span class="n">file_name</span><span class="o">+</span><span class="s1">&#39;.0.dat&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;pk_lin&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;pk_halofit&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;pk_ngen&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_tabPowerSpectrum_z0&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;transfer&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;transfer&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Raul E. Angulo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>