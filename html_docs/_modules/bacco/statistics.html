

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bacco.statistics &mdash; bacco 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> bacco
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bacco</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bacco.statistics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bacco.statistics</h1><div class="highlight"><pre>
<span></span>
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A collection of miscelaneous functions</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span>  <span class="n">do_profile</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;bacco.statistics&#39;</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;compute_powerspectrum&quot;</span><span class="p">,</span> <span class="s2">&quot;compute_twopointcorr&quot;</span><span class="p">,</span> <span class="s2">&quot;compute_crossspectrum&quot;</span><span class="p">,</span>
           <span class="s2">&quot;compute_halo_mass_function&quot;</span><span class="p">,</span> <span class="s2">&quot;compute_concentration&quot;</span><span class="p">,</span> <span class="s2">&quot;compute_multipoles&quot;</span><span class="p">,</span>
           <span class="s2">&quot;compute_twopointcorr_jackknife&quot;</span><span class="p">,</span><span class="s2">&quot;compute_wp_jackknife&quot;</span><span class="p">,</span><span class="s2">&quot;compute_multipoles_jackknife&quot;</span><span class="p">,</span>
           <span class="s2">&quot;compute_theory_error_cov&quot;</span><span class="p">,</span><span class="s2">&quot;compute_gaussian_error_multipoles_power&quot;</span><span class="p">]</span>

<span class="c1">#-----------------------------------------</span>
<span class="c1"># Clustering</span>
<span class="c1">#-----------------------------------------</span>


<span class="k">def</span> <span class="nf">compute_mesh</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;ngrid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interlacing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;interlacing&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">deposit_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deposit_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;depmethod&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">deposit_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;cic&#39;</span><span class="p">,</span> <span class="s1">&#39;tsc&#39;</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the mesh with ngrid=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;interlacing </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">interlacing</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if computing power spectrum&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Velocity must be provided if computing power spectrum in redshift space&quot;</span><span class="p">)</span>
    <span class="n">vel_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">))</span> <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Boxsize must be provided&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;ngp&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;tsc&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># CiC</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="n">vel_factor</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span><span class="p">),</span> <span class="n">box</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span>
                      <span class="mi">0</span> <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">dep_method</span><span class="p">,</span>
                      <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mesh</span>


<span class="k">def</span> <span class="nf">compute_velocity_mesh</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>

    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;ngrid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">deposit_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deposit_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;depmethod&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">deposit_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;cic&#39;</span><span class="p">,</span> <span class="s1">&#39;tsc&#39;</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the velocity 3d mesh with ngrid=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if computing power spectrum&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Velocity must be provided&quot;</span><span class="p">)</span>
    <span class="n">vel_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">))</span> <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Boxsize must be provided&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;ngp&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;tsc&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># CiC</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">velocity_mesh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                               <span class="n">vel_factor</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngrid</span><span class="p">),</span> <span class="n">box</span><span class="p">,</span>
                               <span class="n">dep_method</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mesh</span>


<span class="k">def</span> <span class="nf">compute_masked_powerspectrum</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">log_binning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>
    <span class="n">type_calculation</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># masked-P(k)</span>

    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;ngrid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interlacing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;interlacing&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">deposit_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deposit_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;depmethod&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pk_logbinning</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">deposit_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;cic&#39;</span><span class="p">,</span> <span class="s1">&#39;tsc&#39;</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the power spectrum with ngrid=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;interlacing </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">interlacing</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if computing power spectrum&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Boxsize must be provided&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Cosmology must be provided&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Velocity must be provided if computing power spectrum in redshift space&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">lt_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">ngrid</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">lt_pk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;ngp&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;tsc&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;cic&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>

    <span class="n">grid1</span> <span class="o">=</span> <span class="n">compute_mesh</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">vel</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span>
                         <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>

    <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pk1</span><span class="p">,</span> <span class="n">pk2</span><span class="p">,</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="n">pk_l4</span><span class="p">,</span> <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="n">pk_theory_nl</span><span class="p">,</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="n">bispec_im</span><span class="p">,</span> <span class="n">bispec_err</span><span class="p">)</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">grid1</span><span class="p">,</span>
                                                                                       <span class="n">mask</span><span class="p">,</span>
                                                                                       <span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span>
                                                                                       <span class="mi">0</span> <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                                       <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                                                                       <span class="n">dep_method</span><span class="p">,</span>
                                                                                       <span class="mi">0</span> <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                                       <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">]</span><span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">],</span>
                                                                                       <span class="n">lt_k</span><span class="p">,</span> <span class="n">lt_pk</span><span class="p">,</span> <span class="n">type_calculation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                                                       <span class="mi">0</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span> <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span> <span class="n">pk_theory_nl</span><span class="p">,</span>
            <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span> <span class="n">nmodes</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span> <span class="s1">&#39;xi1&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span> <span class="s1">&#39;xi2&#39;</span><span class="p">:</span> <span class="n">xi2</span><span class="p">,</span>
            <span class="s1">&#39;dd&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;bispec&#39;</span><span class="p">:</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="s1">&#39;bispec_im&#39;</span><span class="p">:</span> <span class="n">bispec_im</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_crossspectrum</span><span class="p">(</span><span class="n">pos1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vel1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vel2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">log_binning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning_kmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>

    <span class="n">type_calculation</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># cross-P(k)</span>

    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;ngrid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interlacing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;interlacing&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">deposit_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deposit_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;depmethod&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_kmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_kmax</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_kmax&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_nbins</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_nbins&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">bs_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_bs_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">bs_k1</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span>
        <span class="k">if</span> <span class="n">bs_method</span> <span class="o">==</span> <span class="s1">&#39;sampled&#39;</span><span class="p">:</span>
            <span class="n">_bs_method</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">bs_method</span> <span class="o">==</span> <span class="s1">&#39;brute-force&#39;</span><span class="p">:</span>
            <span class="n">_bs_method</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;BiSpectrum method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bs_method</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;BiSpectrum method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bs_method</span><span class="p">))</span>
    <span class="n">bs_k2</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">bs_k1</span> <span class="k">if</span> <span class="n">bs_k2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bs_k2</span>
    <span class="n">bs_deltak</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">box</span> <span class="k">if</span> <span class="n">bs_deltak</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bs_deltak</span>

    <span class="k">assert</span> <span class="n">deposit_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;cic&#39;</span><span class="p">,</span> <span class="s1">&#39;tsc&#39;</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the power spectrum with ngrid=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;interlacing </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">interlacing</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pos1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pos2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if computing power spectrum&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Boxsize must be provided&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Cosmology must be provided&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vel1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">vel2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Velocity must be provided if computing power spectrum in redshift space&quot;</span><span class="p">)</span>

    <span class="n">lt_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">ngrid</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">lt_pk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">)</span>
    <span class="n">lt_pk_nlin</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_nlpowerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mass1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mass2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;ngp&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;tsc&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;cic&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>

    <span class="n">grid1</span> <span class="o">=</span> <span class="n">compute_mesh</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos1</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">vel1</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass1</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span>
                         <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">grid2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_grid2</span> <span class="o">=</span> <span class="n">compute_mesh</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos2</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">vel2</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass2</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span>
                             <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>
        <span class="n">linear_grid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="n">grid2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_grid2</span> <span class="o">=</span> <span class="n">grid2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>
        <span class="n">linear_grid</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pk1</span><span class="p">,</span> <span class="n">pk2</span><span class="p">,</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="n">pk_l4</span><span class="p">,</span>
     <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="n">pk_theory_nl</span><span class="p">,</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span>
     <span class="n">r</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span>
     <span class="n">theta</span><span class="p">,</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="n">bispec_im</span><span class="p">,</span> <span class="n">red_bispec_re</span><span class="p">,</span> <span class="n">bispec_err</span><span class="p">,</span> <span class="n">ntri</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">p2d</span><span class="p">)</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">grid1</span><span class="p">,</span> <span class="n">_grid2</span><span class="p">,</span>
                                                                                         <span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span>
                                                                                         <span class="mi">0</span> <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                                         <span class="n">dep_method</span><span class="p">,</span>
                                                                                         <span class="n">_bs_method</span><span class="p">,</span>
                                                                                         <span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="p">,</span>
                                                                                         <span class="mi">0</span> <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                                         <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">]</span><span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">],</span>
                                                                                         <span class="n">log_binning_kmax</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="p">,</span>
                                                                                         <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;correct_grid&#39;</span><span class="p">],</span>
                                                                                         <span class="n">lt_k</span><span class="p">,</span> <span class="n">lt_pk</span><span class="p">,</span> <span class="n">lt_pk_nlin</span><span class="p">,</span>
                                                                                         <span class="n">type_calculation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">linear_grid</span><span class="p">,</span>
                                                                                         <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">grid2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#This means we created _grid2 internally</span>
        <span class="k">del</span> <span class="n">_grid2</span>
    <span class="k">del</span> <span class="n">grid1</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;pk1&#39;</span><span class="p">:</span><span class="n">pk1</span><span class="p">,</span> <span class="s1">&#39;pk2&#39;</span><span class="p">:</span><span class="n">pk2</span><span class="p">,</span> <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span> <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span> <span class="n">pk_theory_nl</span><span class="p">,</span>
            <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span> <span class="n">nmodes</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span> <span class="s1">&#39;xi1&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span> <span class="s1">&#39;xi2&#39;</span><span class="p">:</span> <span class="n">xi2</span><span class="p">,</span>
            <span class="s1">&#39;dd&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;bispec&#39;</span><span class="p">:</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="s1">&#39;bispec_im&#39;</span><span class="p">:</span> <span class="n">bispec_im</span><span class="p">,</span>
            <span class="s1">&#39;red_bispec&#39;</span> <span class="p">:</span> <span class="n">red_bispec_re</span><span class="p">,</span> <span class="s1">&#39;ntri&#39;</span> <span class="p">:</span> <span class="n">ntri</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_crossspectrum_twogrids</span><span class="p">(</span><span class="n">grid1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linear_grid1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">log_binning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning_kmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">check_power_precision</span>

    <span class="n">type_calculation</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># cross-P(k)</span>

    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">grid1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interlacing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;interlacing&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">deposit_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deposit_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;depmethod&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_kmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_kmax</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_kmax&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_nbins</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_nbins&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">deposit_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;cic&#39;</span><span class="p">,</span> <span class="s1">&#39;tsc&#39;</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the power spectrum with ngrid=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;interlacing </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">interlacing</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">grid1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if computing power spectrum&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grid2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if computing power spectrum&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Boxsize must be provided&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Cosmology must be provided&quot;</span><span class="p">)</span>

    <span class="n">lt_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">ngrid</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">lt_pk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">)</span>
    <span class="n">lt_pk_nlin</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_nlpowerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mass1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mass2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;ngp&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;tsc&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;cic&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="n">grid2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="n">grid1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">_grid2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid2</span><span class="p">)</span>
    <span class="n">_grid1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="n">grid1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">_grid2</span> <span class="o">=</span> <span class="n">_grid2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="n">grid2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">_grid2</span> <span class="o">=</span> <span class="n">_grid2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">check_power_precision</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_grid1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_grid1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_grid2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_power_precision</span><span class="p">()</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">_grid1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_grid1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_grid2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="n">linear_grid1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">linear_grid1</span><span class="p">)</span>
    <span class="n">linear_grid2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">linear_grid2</span><span class="p">)</span>

    <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pk1</span><span class="p">,</span> <span class="n">pk2</span><span class="p">,</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="n">pk_l4</span><span class="p">,</span> <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="n">pk_theory_nl</span><span class="p">,</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="n">bispec_im</span><span class="p">,</span> <span class="n">red_bispec</span><span class="p">,</span> <span class="n">bispec_err</span><span class="p">,</span> <span class="n">ntri</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">power2d</span><span class="p">)</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">_grid1</span><span class="p">,</span>
                                                                                          <span class="n">_grid2</span><span class="p">,</span>
                                                                                         <span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span>
                                                                                         <span class="mi">0</span> <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                                         <span class="n">dep_method</span><span class="p">,</span>
                                                                                         <span class="mi">0</span><span class="p">,</span>
                                                                                         <span class="mi">1000</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                                                                         <span class="mi">0</span> <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                                         <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">box</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">],</span>
                                                                                         <span class="n">log_binning_kmax</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="p">,</span>
                                                                                         <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;correct_grid&#39;</span><span class="p">],</span>
                                                                                         <span class="n">lt_k</span><span class="p">,</span> <span class="n">lt_pk</span><span class="p">,</span> <span class="n">lt_pk_nlin</span><span class="p">,</span> <span class="n">type_calculation</span><span class="p">,</span>
                                                                                         <span class="n">linear_grid1</span><span class="p">,</span> <span class="n">linear_grid2</span><span class="p">,</span>
                                                                                         <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="k">del</span> <span class="n">_grid1</span><span class="p">,</span> <span class="n">_grid2</span>
    <span class="c1"># error for x corr is needed</span>
    <span class="n">pk_gaussian_error</span> <span class="o">=</span> <span class="n">pk</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">nmodes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;pk1&#39;</span><span class="p">:</span><span class="n">pk1</span><span class="p">,</span> <span class="s1">&#39;pk2&#39;</span><span class="p">:</span><span class="n">pk2</span><span class="p">,</span> <span class="s1">&#39;pk_l2&#39;</span> <span class="p">:</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="s1">&#39;pk_l4&#39;</span> <span class="p">:</span> <span class="n">pk_l4</span><span class="p">,</span> <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span> <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span> <span class="n">pk_theory_nl</span><span class="p">,</span>
            <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span> <span class="n">nmodes</span><span class="p">,</span> <span class="s1">&#39;pk_gaussian_error&#39;</span><span class="p">:</span><span class="n">pk_gaussian_error</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span> <span class="s1">&#39;xi1&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span> <span class="s1">&#39;xi2&#39;</span><span class="p">:</span> <span class="n">xi2</span><span class="p">,</span>
            <span class="s1">&#39;dd&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;bispec&#39;</span><span class="p">:</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="s1">&#39;bispec_im&#39;</span><span class="p">:</span> <span class="n">bispec_im</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">fourier_landyszalay</span><span class="p">(</span><span class="n">pos1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ran</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">dd</span> <span class="o">=</span> <span class="n">compute_crossspectrum</span><span class="p">(</span><span class="n">pos1</span><span class="o">=</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="o">=</span><span class="n">ran</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span>
                               <span class="n">log_binning</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="n">compute_powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">ran</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span>
                               <span class="n">log_binning</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">)</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;xi2&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="s1">&#39;xi1&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">-</span><span class="mf">1.</span>
    <span class="n">xi_ls</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;xi2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;xi1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rr</span><span class="p">[</span><span class="s1">&#39;xi1&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="s1">&#39;xi1&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi_ls</span><span class="p">,</span> <span class="s1">&#39;xi_natural&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">}</span>

<span class="c1">#@do_profile()</span>
<span class="k">def</span> <span class="nf">compute_powerspectrum</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit_in_Mpc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">deposit_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_num_triangles</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">bs_k1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">bs_k2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">log_binning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning_kmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pmulti_interp</span><span class="o">=</span><span class="s1">&#39;polyfit&#39;</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">grid1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dilution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>

    <span class="n">type_calculation</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Auto-P(k)</span>
    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;ngrid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interlacing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;interlacing&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">deposit_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deposit_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;depmethod&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_kmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_kmax</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_kmax&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_nbins</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_nbins&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Boxsize must be provided&quot;</span><span class="p">)</span>

    <span class="n">_box</span> <span class="o">=</span> <span class="n">box</span><span class="o">*</span><span class="n">unit_in_Mpc</span>
    <span class="k">if</span> <span class="n">bs_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_bs_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">bs_k1</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">_box</span>
        <span class="k">if</span> <span class="n">bs_method</span> <span class="o">==</span> <span class="s1">&#39;sampled&#39;</span><span class="p">:</span>
            <span class="n">_bs_method</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">bs_method</span> <span class="o">==</span> <span class="s1">&#39;brute-force&#39;</span><span class="p">:</span>
            <span class="n">_bs_method</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;BiSpectrum method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bs_method</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;BiSpectrum method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bs_method</span><span class="p">))</span>
    <span class="n">bs_k2</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">bs_k1</span> <span class="k">if</span> <span class="n">bs_k2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bs_k2</span>
    <span class="n">bs_deltak</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span><span class="n">_box</span> <span class="k">if</span> <span class="n">bs_deltak</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bs_deltak</span>

    <span class="k">assert</span> <span class="n">deposit_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;cic&#39;</span><span class="p">,</span> <span class="s1">&#39;tsc&#39;</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the power spectrum with ngrid=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;interlacing </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">interlacing</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Either positions or grid must be provided if computing power spectrum&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmology</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Cosmology must be provided&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Velocity must be provided if computing power spectrum in redshift space&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">vel_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">))</span> <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="n">lt_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">_box</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">_box</span><span class="o">*</span><span class="n">ngrid</span> <span class="o">*</span> <span class="n">folds</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">lt_pk_lin</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_zpowerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lt_pk_nlin</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_nlpowerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_nlzpowerspec</span><span class="p">(</span><span class="n">lt_k</span><span class="p">,</span> <span class="n">cold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">knl</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_nonlinear_scale</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;ngp&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;tsc&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">deposit_method</span> <span class="o">==</span> <span class="s1">&#39;cic&#39;</span><span class="p">:</span>
        <span class="n">dep_method</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deposit method </span><span class="si">{0}</span><span class="s2"> not recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deposit_method</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">grid1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dilution</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">old_npart</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_npart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">old_npart</span> <span class="o">*</span> <span class="n">dilution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;diluting catalogue: from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> particles (</span><span class="si">{}</span><span class="s1">%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_npart</span><span class="p">,</span> <span class="n">new_npart</span><span class="p">,</span> <span class="n">dilution</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span>
            <span class="n">indexes_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">old_npart</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">new_npart</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">indexes_to_keep</span><span class="p">,:]</span>
            <span class="k">if</span> <span class="n">vel</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span><span class="p">[</span><span class="n">indexes_to_keep</span><span class="p">,:]</span>

        <span class="n">_grid1</span> <span class="o">=</span> <span class="n">compute_mesh</span><span class="p">(</span><span class="n">ngrid</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">_box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="o">*</span><span class="n">unit_in_Mpc</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">vel</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">interlacing</span><span class="o">=</span><span class="n">interlacing</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="n">folds</span><span class="p">,</span>
                              <span class="n">deposit_method</span><span class="o">=</span><span class="n">deposit_method</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="n">zspace</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>
        <span class="n">linear_grid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">folds</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="n">grid1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_grid1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ngrid</span> <span class="o">==</span> <span class="n">grid1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">_grid1</span> <span class="o">=</span> <span class="n">_grid1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>
        <span class="n">linear_grid</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1">#_grid1 = grid1.reshape(1,ngrid, ngrid, ngrid)</span>

    <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pk1</span><span class="p">,</span> <span class="n">pk2</span><span class="p">,</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="n">pk_l4</span><span class="p">,</span>
     <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="n">pk_theory_nl</span><span class="p">,</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span>
     <span class="n">r</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span>
     <span class="n">theta</span><span class="p">,</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="n">bispec_im</span><span class="p">,</span> <span class="n">red_bispec_re</span><span class="p">,</span> <span class="n">bispec_err</span><span class="p">,</span> <span class="n">ntri</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">p2d</span><span class="p">)</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">_grid1</span><span class="p">,</span> <span class="n">_grid1</span><span class="p">,</span>
                                                                       <span class="n">ngrid</span><span class="p">,</span> <span class="n">_box</span> <span class="o">/</span> <span class="n">folds</span><span class="p">,</span>
                                                                       <span class="mi">0</span> <span class="k">if</span> <span class="n">interlacing</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                       <span class="n">dep_method</span><span class="p">,</span>
                                                                       <span class="n">_bs_method</span><span class="p">,</span>
                                                                       <span class="n">bs_num_triangles</span><span class="p">,</span> <span class="n">bs_k1</span><span class="p">,</span> <span class="n">bs_k2</span><span class="p">,</span> <span class="n">bs_deltak</span><span class="p">,</span>
                                                                       <span class="mi">0</span> <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                                                       <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">_box</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">]</span><span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">],</span>
                                                                       <span class="n">log_binning_kmax</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="p">,</span>
                                                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;correct_grid&#39;</span><span class="p">],</span>
                                                                       <span class="n">lt_k</span><span class="p">,</span> <span class="n">lt_pk_lin</span><span class="p">,</span> <span class="n">lt_pk_nlin</span><span class="p">,</span>
                                                                       <span class="n">type_calculation</span><span class="p">,</span> <span class="n">linear_grid</span><span class="p">,</span> <span class="n">linear_grid</span><span class="p">,</span>
                                                                       <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

    <span class="k">del</span> <span class="n">_grid1</span>
    <span class="n">pk</span> <span class="o">*=</span> <span class="n">folds</span><span class="o">**</span><span class="mi">3</span>
    <span class="c1"># Covariance matrix of the power spectrum:</span>
    <span class="c1"># C_ij = (2 * delta_ij / Nk) * P(k_i) + T(k_i, k_j)</span>
    <span class="c1"># Considering the gaussian approximation, T=0, i=j</span>
    <span class="c1"># Note that Nk is not the number of independent modes,</span>
    <span class="c1"># but the total -&gt; hence the 2.</span>
    <span class="n">pk_gaussian_error</span> <span class="o">=</span> <span class="n">pk</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">nmodes</span><span class="p">)</span>

    <span class="n">moments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
    <span class="n">p2ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">No</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">p16_roots</span> <span class="o">=</span> <span class="p">[</span>
         <span class="mf">0.09501251</span><span class="p">,</span>  <span class="mf">0.28160355</span><span class="p">,</span>  <span class="mf">0.45801678</span><span class="p">,</span>  <span class="mf">0.61787624</span><span class="p">,</span>
         <span class="mf">0.75540441</span><span class="p">,</span>  <span class="mf">0.8656312</span><span class="p">,</span>   <span class="mf">0.94457502</span><span class="p">,</span>  <span class="mf">0.98940093</span><span class="p">]</span>

    <span class="n">p16_w</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mf">0.189450610455069</span><span class="p">,</span> <span class="mf">0.182603415044924</span><span class="p">,</span> <span class="mf">0.169156519395003</span><span class="p">,</span> <span class="mf">0.149595988816577</span><span class="p">,</span>
        <span class="mf">0.124628971255534</span><span class="p">,</span> <span class="mf">0.095158511682493</span><span class="p">,</span> <span class="mf">0.062253523938648</span><span class="p">,</span> <span class="mf">0.027152459411754</span><span class="p">]</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">lin_int_ext</span>
    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">nmodes</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">p2d</span><span class="p">[:,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">p2d</span><span class="p">[:,</span><span class="n">ik</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                <span class="n">pmu_lin_interp</span> <span class="o">=</span> <span class="n">lin_int_ext</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">p2d</span><span class="p">[:,</span><span class="n">ik</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                <span class="n">know</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>

                <span class="k">def</span> <span class="nf">_p_at_mu</span><span class="p">(</span><span class="n">mui</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pmulti_interp</span><span class="o">==</span><span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">pmu_lin_interp</span><span class="p">(</span><span class="n">mui</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">pmulti_interp</span><span class="o">==</span><span class="s1">&#39;polyfit&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mui</span><span class="o">**</span><span class="p">(</span><span class="n">deg</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">pmulti_interp</span><span class="o">==</span><span class="s1">&#39;mix&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">know</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">knl</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mui</span><span class="o">**</span><span class="p">(</span><span class="n">deg</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">pmu_lin_interp</span><span class="p">(</span><span class="n">mui</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal choice for pmulti_interp: choose between linear, polyfit and mix&#39;</span><span class="p">)</span>


                <span class="k">for</span> <span class="n">ell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">io</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">No</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">+=</span> <span class="n">p16_w</span><span class="p">[</span><span class="n">io</span><span class="p">]</span> <span class="o">*</span> <span class="n">p16_roots</span><span class="p">[</span><span class="n">io</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ell</span><span class="p">)</span> <span class="o">*</span> <span class="n">_p_at_mu</span><span class="p">(</span><span class="n">p16_roots</span><span class="p">[</span><span class="n">io</span><span class="p">])</span>
                    <span class="n">moments</span><span class="p">[</span><span class="n">ell</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">p2ds</span><span class="p">[:,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">_p_at_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pk multipoles at k </span><span class="si">{}</span><span class="s1"> set to zero: it seems you have a lot of bins for this grid size&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">know</span><span class="p">))</span>

    <span class="n">multi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">9.0</span> <span class="o">/</span> <span class="mf">8.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">35</span> <span class="o">*</span> <span class="n">moments</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-</span> <span class="mf">30.0</span> <span class="o">*</span> <span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;pk_theory_lin&#39;</span><span class="p">:</span> <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="s1">&#39;pk_theory_nl&#39;</span><span class="p">:</span> <span class="n">pk_theory_nl</span><span class="p">,</span>
            <span class="s1">&#39;pk_l2&#39;</span> <span class="p">:</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="s1">&#39;pk_l4&#39;</span> <span class="p">:</span> <span class="n">pk_l4</span><span class="p">,</span> <span class="s1">&#39;shotnoise&#39;</span><span class="p">:</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span> <span class="n">nmodes</span><span class="p">,</span>
            <span class="s1">&#39;pk_gaussian_error&#39;</span> <span class="p">:</span> <span class="n">pk_gaussian_error</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span> <span class="s1">&#39;xi1&#39;</span><span class="p">:</span> <span class="n">xi1</span><span class="p">,</span>
            <span class="s1">&#39;xi2&#39;</span><span class="p">:</span> <span class="n">xi2</span><span class="p">,</span> <span class="s1">&#39;dd&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;bispec&#39;</span><span class="p">:</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="s1">&#39;bispec_im&#39;</span><span class="p">:</span> <span class="n">bispec_im</span><span class="p">,</span>
            <span class="s1">&#39;red_bispec&#39;</span> <span class="p">:</span> <span class="n">red_bispec_re</span><span class="p">,</span> <span class="s1">&#39;ntri&#39;</span> <span class="p">:</span> <span class="n">ntri</span><span class="p">,</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="n">mu</span><span class="p">,</span> <span class="s1">&#39;p2d&#39;</span><span class="p">:</span> <span class="n">p2d</span><span class="p">,</span> <span class="s1">&#39;p2ds&#39;</span><span class="p">:</span> <span class="n">p2ds</span><span class="p">,</span> <span class="s1">&#39;pmulti&#39;</span><span class="p">:</span> <span class="n">multi</span><span class="p">,</span> <span class="s1">&#39;pmoments&#39;</span> <span class="p">:</span> <span class="n">moments</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_density_from_displacements</span><span class="p">(</span><span class="n">disp_field</span><span class="p">,</span> <span class="n">gaussian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eulerian</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>

    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A boxsize is needed&#39;</span><span class="p">)</span>

    <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nthreads</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">verbose</span>

    <span class="n">divergence_of_psi</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_divergence</span><span class="p">(</span><span class="n">disp_field</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="n">J</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">divergence_of_psi</span>

    <span class="k">if</span> <span class="n">gaussian</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># cross derivatives</span>
        <span class="n">psi_11</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_derivative</span><span class="p">(</span><span class="n">disp_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">psi_22</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_derivative</span><span class="p">(</span><span class="n">disp_field</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">psi_33</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_derivative</span><span class="p">(</span><span class="n">disp_field</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">psi_21</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_derivative</span><span class="p">(</span><span class="n">disp_field</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">psi_31</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_derivative</span><span class="p">(</span><span class="n">disp_field</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">psi_32</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">field_derivative</span><span class="p">(</span><span class="n">disp_field</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="n">cross_derivs</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_22</span> <span class="o">*</span> <span class="n">psi_11</span> <span class="o">-</span> <span class="n">psi_21</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  <span class="c1"># i=2, j=1</span>
                        <span class="n">psi_33</span> <span class="o">*</span> <span class="n">psi_11</span> <span class="o">-</span> <span class="n">psi_31</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  <span class="c1"># i=3, j=1</span>
                        <span class="n">psi_33</span> <span class="o">*</span> <span class="n">psi_22</span> <span class="o">-</span> <span class="n">psi_32</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># i=3, j=2</span>
        <span class="n">J</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cross_derivs</span>

    <span class="c1"># delta_from_psi = -divergence_of_psi</span>
    <span class="n">delta_from_psi</span> <span class="o">=</span> <span class="o">-</span><span class="n">divergence_of_psi</span> <span class="c1">#- 0.5*cross_derivs;</span>
    <span class="c1">#delta_from_psi = 1.0 / J - 1.0</span>
    <span class="c1">#delta_from_psi -= np.mean(delta_from_psi)</span>

<span class="c1">#    import matplotlib.pyplot as plt</span>
<span class="c1">#    import ipdb; ipdb.set_trace()</span>
<span class="c1">#    plt.plot(delta_from_psi.flatten(), delta_from_psi2-flatten(),&#39;.&#39;)</span>
<span class="c1">#    plt.show()</span>

    <span class="n">density</span> <span class="o">=</span> <span class="n">delta_from_psi</span> <span class="o">/</span> <span class="n">delta_from_psi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>

    <span class="k">if</span> <span class="n">eulerian</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">box</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">disp_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span><span class="n">_x</span><span class="p">,</span><span class="n">_x</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">_qpos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">find_lagrangian_coordinates</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">disp_field</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
        <span class="n">new_density</span> <span class="o">=</span> <span class="n">lss</span><span class="o">.</span><span class="n">interpolate_field</span><span class="p">(</span><span class="n">_qpos</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

<span class="c1">#        import matplotlib.pyplot as plt</span>
<span class="c1">#        plt.imshow(new_density[:,:,0])</span>
<span class="c1">#        import ipdb; ipdb.set_trace()</span>

        <span class="k">del</span> <span class="n">_qpos</span>

    <span class="k">return</span> <span class="n">density</span>

<span class="k">def</span> <span class="nf">compute_linear_overdensity</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">FixedInitialAmplitude</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">InitialPhase</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span>
                               <span class="n">redshift_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">smoothed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">order_by_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.lss_scaler</span> <span class="k">import</span> <span class="n">lss</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">deepcopy</span>

    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A boxsize is needed&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A seed is needed&#39;</span><span class="p">)</span>

    <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nthreads</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">verbose</span>

    <span class="n">_cosmology</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cosmology</span><span class="p">)</span>
    <span class="c1"># _cosmology = copy.deepcopy(cosmology)</span>

    <span class="c1"># Linearly extrapolate the z=0 result to the desired redshift</span>
    <span class="n">wavemode</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">Di</span>       <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">wavemode</span><span class="p">)</span>
    <span class="n">Di2</span>      <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span><span class="o">/</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">Di3a</span>     <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD3a</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
    <span class="n">Di3b</span>     <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactorD3b</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
    <span class="n">power</span>    <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">_tabPowerSpectrum_z0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span><span class="p">:</span>
        <span class="n">power</span> <span class="o">*=</span> <span class="n">Di</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Di</span> <span class="o">=</span>   <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Di</span> <span class="o">/=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">wavemode</span><span class="o">=</span><span class="n">wavemode</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating linear field: Di=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Di</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">InitialPhase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">FixedInitialAmplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">return_density</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">order_by_order</span> <span class="o">=</span> <span class="n">order_by_order</span>
    <span class="n">growthrate</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span>
    <span class="n">damping_scale</span> <span class="o">=</span> <span class="n">_cosmology</span><span class="o">.</span><span class="n">get_nonlinear_scale</span><span class="p">()</span> <span class="k">if</span> <span class="n">smoothed</span> <span class="k">else</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">box</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">]</span>
    <span class="n">grid</span><span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">.</span><span class="n">lpt_field</span><span class="p">(</span><span class="n">wavemode</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span>
                         <span class="n">Di</span><span class="p">,</span> <span class="n">Di2</span><span class="p">,</span> <span class="n">Di3a</span><span class="p">,</span> <span class="n">Di3b</span><span class="p">,</span> <span class="n">growthrate</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;LPT_order&#39;</span><span class="p">],</span> <span class="n">damping_scale</span><span class="p">,</span> <span class="n">order_by_order</span><span class="p">,</span>
                         <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">][</span><span class="s1">&#39;disp_ngrid&#39;</span><span class="p">],</span> <span class="n">box</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span>
                         <span class="mf">1.</span><span class="o">/</span><span class="n">_cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FixedInitialAmplitude</span><span class="p">,</span>
                         <span class="n">InitialPhase</span><span class="p">,</span> <span class="n">return_density</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">redshift_space</span><span class="p">),</span>
                         <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">))</span> <span class="c1">#[::-1,::-1,::-1]</span>
    <span class="k">return</span> <span class="n">grid</span>

<span class="k">def</span> <span class="nf">compute_twopointcorr</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ran</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;brute_force&quot;</span><span class="p">,</span> <span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="s2">&quot;halotools&quot;</span><span class="p">,</span> <span class="s2">&quot;Corrfunc&quot;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Correlation function method=</span><span class="si">{0}</span><span class="s2"> not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Positions must be provided if computing twopointcorr&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">vel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Velocity must be provided if computing the correlation function in redshift space&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; Box must be provided to compute_twopointcorr()&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">box</span><span class="o">*</span><span class="mf">0.20</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="mi">33</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;halotools&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Arbitrary rbins not yet implemented&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;brute_force&quot;</span><span class="p">:</span>
        <span class="n">method_nr</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span><span class="p">:</span>
        <span class="n">method_nr</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;halotools&quot;</span><span class="p">:</span>
        <span class="n">method_nr</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fourier&quot;</span><span class="p">:</span>
        <span class="n">method_nr</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Corrfunc&quot;</span><span class="p">:</span>
        <span class="n">method_nr</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the correlation function&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">random</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="n">vel_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">Ez_function</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">))</span> <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; Redshift space enabled (vel factor=</span><span class="si">%f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">vel_factor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;halotools&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;zspace not implemented for halotools -- FIXME!&quot;</span><span class="p">)</span>
            <span class="c1">#_pos[:,2] += cosmology.expfactor * np.sqrt(cosmology.expfactor) * vel[:,2]/vel_factor</span>
        <span class="kn">import</span> <span class="nn">halotools.mock_observables</span> <span class="k">as</span> <span class="nn">htools</span>
        <span class="c1">#rbins = np.logspace(-1, 1, 100)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">htools</span><span class="o">.</span><span class="n">tpcf</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="n">rbins</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">,</span>
                         <span class="n">randoms</span><span class="o">=</span><span class="n">ran</span><span class="p">,</span> <span class="n">estimator</span><span class="o">=</span><span class="s1">&#39;Landy-Szalay&#39;</span><span class="p">)</span>
        <span class="n">rbins_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">rbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">xierr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">rbins_mid</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;brute_force&quot;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.correlationfx</span> <span class="k">import</span> <span class="n">correl</span>
        <span class="n">rbins_mid</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xierr</span><span class="p">,</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">correl</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                                  <span class="n">box</span><span class="p">,</span> <span class="n">method_nr</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">rbins_mid</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fourier&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>
        <span class="n">interlacing</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">deposit_method</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">log_binning</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Default values of the following parameters have been assumed:</span><span class="se">\n</span><span class="s1">interlacing = True</span><span class="se">\n</span><span class="s1">deposit_method = TSC</span><span class="se">\n</span><span class="s1">log_binning = True</span><span class="se">\n</span><span class="s1">There pars are (for now) hard coded&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pk1</span><span class="p">,</span> <span class="n">pk2</span><span class="p">,</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="n">pk_l4</span><span class="p">,</span> <span class="n">pk_theory_lin</span><span class="p">,</span> <span class="n">pk_theory_nl</span><span class="p">,</span> <span class="n">shotnoise</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">bispec_re</span><span class="p">,</span> <span class="n">bispec_im</span><span class="p">,</span> <span class="n">bispec_err</span><span class="p">)</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">vel_factor</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">interlacing</span><span class="p">,</span> <span class="n">deposit_method</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">log_binning</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
        <span class="n">xierr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; ...done in </span><span class="si">{0:.3}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">rbins_mid</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="s1">&#39;xierr&#39;</span><span class="p">:</span> <span class="n">xierr</span><span class="p">,</span> <span class="s1">&#39;pairs&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Corrfunc&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">Corrfunc.theory.xi</span> <span class="k">import</span> <span class="n">xi</span>
        <span class="n">rbins_mid</span> <span class="o">=</span> <span class="n">rbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>  <span class="c1"># Fix middle point</span>
        <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span>
            <span class="n">Z1</span> <span class="o">+=</span> <span class="n">vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="c1"># Check This!</span>
            <span class="n">Z1</span><span class="p">[</span><span class="n">Z1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>
            <span class="n">Z1</span><span class="p">[</span><span class="n">Z1</span><span class="o">&gt;=</span><span class="n">box</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">xi_corrfunc</span> <span class="o">=</span> <span class="n">xi</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">rbins</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Z1</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">rbins_mid</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">:</span> <span class="n">xi_corrfunc</span><span class="p">[</span><span class="s1">&#39;xi&#39;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">compute_binned_powerspectrum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">log_binning_kmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">correct_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.powerspectrum</span> <span class="k">import</span> <span class="n">power</span>
    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ngrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;ngrid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_kmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_kmax</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_kmax&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_binning_nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_binning_nbins</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning_nbins&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">correct_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">correct_grid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;correct_grid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">min_k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">boxsize</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">]</span><span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;min_k&#39;</span><span class="p">]</span>

    <span class="n">binnedk</span><span class="p">,</span> <span class="n">binnedpk</span><span class="p">,</span> <span class="n">nmodes</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">theorygrid</span><span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="n">log_binning</span><span class="p">,</span> <span class="n">min_k</span><span class="p">,</span>
                                                 <span class="n">log_binning_kmax</span><span class="p">,</span> <span class="n">log_binning_nbins</span><span class="p">,</span>
                                                 <span class="n">correct_grid</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">binnedk</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">binnedpk</span><span class="p">,</span> <span class="s1">&#39;nmodes&#39;</span><span class="p">:</span> <span class="n">nmodes</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">fake_pk_multipoles_measurement</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">sigma_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Takes a power spectrum (k, pk) in input, computes the gaussian errors,</span>
<span class="sd">    displaces each point gaussianly around the true value</span>

<span class="sd">    cosmology: a cosmology class</span>
<span class="sd">    ndensity:  the number density of objects in (h/Mpc)^3</span>
<span class="sd">    volume:    the volume of teh survey</span>
<span class="sd">    bias:      the average bias of the sample</span>
<span class="sd">    sigma_v:   the galaxy velocity dispersion inside virialized halos (if None, no FoG is applied)</span>
<span class="sd">    k:         wavemodes in h/Mpc (default from 1e-3 to ~2)</span>
<span class="sd">    expfactor: a = 1 / (1 + z) required (default is the one from cosmo)</span>
<span class="sd">    seed: the seed used to randomly sample a gaussian around each P(k) measurement</span>
<span class="sd">    gamma:     a factor to reduce cosmic variance noise (if 1, not considered)</span>

<span class="sd">    Note:</span>

<span class="sd">    Euclid:</span>
<span class="sd">        ndensity ~ 5e-4 (h/Mpc)^3</span>
<span class="sd">        volume ~ 5e10 (Mpc/h)^3</span>
<span class="sd">        bias ~ 0.9 + 0.4 * z</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_gaussian_error_multipoles_power</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>
    <span class="kn">import</span> <span class="nn">time</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">k</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">expfactor</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">expfactor</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">seed</span>

    <span class="n">th_pk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">thnl_pk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec_z</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">k_scale_indep</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reps&#39;</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_scale_indep</span><span class="p">)</span> <span class="o">/</span> <span class="n">bias</span>

    <span class="n">RSD</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">FOG</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span> <span class="k">if</span> <span class="n">sigma_v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;gaussian&#39;</span>

    <span class="c1"># compute the P_\ell(k) predictions using the linear matter ps</span>
    <span class="n">th_pk_2d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_pk2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">th_pk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="n">sigma_v</span><span class="p">,</span> <span class="n">RSD</span><span class="o">=</span><span class="n">RSD</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="n">FOG</span><span class="p">)</span>
    <span class="n">th_pk_multi</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pkmulti</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">th_pk_2d</span><span class="p">)</span>
    <span class="n">th_pk_l0</span>   <span class="o">=</span> <span class="n">th_pk_multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">th_pk_l2</span>   <span class="o">=</span> <span class="n">th_pk_multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">th_pk_l4</span>   <span class="o">=</span> <span class="n">th_pk_multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># compute the P_\ell(k) predictions using the linear matter ps without FoGs (used for errors)</span>
    <span class="n">th_pk_2d_nofog</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_pk2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">th_pk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">RSD</span><span class="o">=</span><span class="n">RSD</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">th_pk_multi_nofog</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pkmulti</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">th_pk_2d_nofog</span><span class="p">)</span>
    <span class="n">th_pk_l0_nofog</span>   <span class="o">=</span> <span class="n">th_pk_multi_nofog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">th_pk_l2_nofog</span>   <span class="o">=</span> <span class="n">th_pk_multi_nofog</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">th_pk_l4_nofog</span>   <span class="o">=</span> <span class="n">th_pk_multi_nofog</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># compute the P_\ell(k) predictions using the non-linear matter ps</span>
    <span class="n">thnl_pk_2d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_pk2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">thnl_pk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="n">sigma_v</span><span class="p">,</span> <span class="n">RSD</span><span class="o">=</span><span class="n">RSD</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="n">FOG</span><span class="p">)</span>
    <span class="n">thnl_pk_multi</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pkmulti</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">thnl_pk_2d</span><span class="p">)</span>
    <span class="n">thnl_pk_l0</span> <span class="o">=</span> <span class="n">thnl_pk_multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">thnl_pk_l2</span> <span class="o">=</span> <span class="n">thnl_pk_multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">thnl_pk_l4</span> <span class="o">=</span> <span class="n">thnl_pk_multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># compute gaussian covariance matrix (using linear theory predictions)</span>
    <span class="n">kf</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">volume</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">/</span> <span class="n">kf</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">th_pk_l00_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">th_pk_l0_nofog</span><span class="p">,</span> <span class="n">th_pk_l2_nofog</span><span class="p">,</span> <span class="n">th_pk_l4_nofog</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">nk</span>
    <span class="n">th_pk_l02_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">th_pk_l0_nofog</span><span class="p">,</span> <span class="n">th_pk_l2_nofog</span><span class="p">,</span> <span class="n">th_pk_l4_nofog</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">nk</span>
    <span class="n">th_pk_l04_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">th_pk_l0_nofog</span><span class="p">,</span> <span class="n">th_pk_l2_nofog</span><span class="p">,</span> <span class="n">th_pk_l4_nofog</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">nk</span>
    <span class="n">th_pk_l22_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">th_pk_l0_nofog</span><span class="p">,</span> <span class="n">th_pk_l2_nofog</span><span class="p">,</span> <span class="n">th_pk_l4_nofog</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">nk</span>
    <span class="n">th_pk_l24_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">th_pk_l0_nofog</span><span class="p">,</span> <span class="n">th_pk_l2_nofog</span><span class="p">,</span> <span class="n">th_pk_l4_nofog</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">nk</span>
    <span class="n">th_pk_l44_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">th_pk_l0_nofog</span><span class="p">,</span> <span class="n">th_pk_l2_nofog</span><span class="p">,</span> <span class="n">th_pk_l4_nofog</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">nk</span>

    <span class="n">th_pk_l00_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l00_var</span><span class="p">)</span>
    <span class="n">th_pk_l02_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l02_var</span><span class="p">)</span>
    <span class="n">th_pk_l04_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l04_var</span><span class="p">)</span>
    <span class="n">th_pk_l22_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l22_var</span><span class="p">)</span>
    <span class="n">th_pk_l24_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l24_var</span><span class="p">)</span>
    <span class="n">th_pk_l44_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l44_var</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gamma</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="c1">#logger.info(&#39;Reducing cosmic variance by gamma = {}&#39;.format(gamma))</span>
        <span class="n">th_pk_l00_std</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l00_var</span><span class="p">)</span>
        <span class="n">th_pk_l02_std</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l02_var</span><span class="p">)</span>
        <span class="n">th_pk_l04_std</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l04_var</span><span class="p">)</span>
        <span class="n">th_pk_l22_std</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l22_var</span><span class="p">)</span>
        <span class="n">th_pk_l24_std</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l24_var</span><span class="p">)</span>
        <span class="n">th_pk_l44_std</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th_pk_l44_var</span><span class="p">)</span>

    <span class="c1"># np.random.seed(seed)</span>
    <span class="n">pk_l0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">th_pk_l0</span><span class="p">,</span> <span class="n">th_pk_l00_std</span><span class="p">)</span>
    <span class="n">pk_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">th_pk_l2</span><span class="p">,</span> <span class="n">th_pk_l22_std</span><span class="p">)</span>
    <span class="n">pk_l4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">th_pk_l4</span><span class="p">,</span> <span class="n">th_pk_l44_std</span><span class="p">)</span>

    <span class="n">nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">nk</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nk</span><span class="p">))</span>
    <span class="n">diag_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>
    <span class="n">cov</span><span class="p">[</span><span class="n">diag_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">th_pk_l00_var</span>

    <span class="n">cov</span><span class="p">[</span><span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l02_var</span>
    <span class="n">cov</span><span class="p">[</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l02_var</span>

    <span class="n">cov</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l04_var</span>
    <span class="n">cov</span><span class="p">[</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l04_var</span>

    <span class="n">cov</span><span class="p">[</span><span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nk</span> <span class="o">+</span> <span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l22_var</span>

    <span class="n">cov</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span> <span class="o">+</span> <span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l24_var</span>
    <span class="n">cov</span><span class="p">[</span><span class="n">nk</span> <span class="o">+</span> <span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l24_var</span>

    <span class="n">cov</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nk</span><span class="o">+</span><span class="n">diag_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">nk</span> <span class="o">+</span> <span class="n">diag_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">th_pk_l44_var</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;pk_l0&#39;</span><span class="p">:</span> <span class="n">pk_l0</span><span class="p">,</span> <span class="s1">&#39;pk_l2&#39;</span><span class="p">:</span> <span class="n">pk_l2</span><span class="p">,</span> <span class="s1">&#39;pk_l4&#39;</span><span class="p">:</span> <span class="n">pk_l4</span><span class="p">,</span>
            <span class="s1">&#39;pk_l0_true&#39;</span><span class="p">:</span> <span class="n">th_pk_l0</span><span class="p">,</span> <span class="s1">&#39;pk_l2_true&#39;</span><span class="p">:</span> <span class="n">th_pk_l2</span><span class="p">,</span> <span class="s1">&#39;pk_l4_true&#39;</span><span class="p">:</span> <span class="n">th_pk_l4</span><span class="p">,</span>
            <span class="s1">&#39;pknl_l0_true&#39;</span><span class="p">:</span> <span class="n">thnl_pk_l0</span><span class="p">,</span> <span class="s1">&#39;pknl_l2_true&#39;</span><span class="p">:</span> <span class="n">th_pk_l2</span><span class="p">,</span> <span class="s1">&#39;pknl_l4_true&#39;</span><span class="p">:</span> <span class="n">thnl_pk_l4</span><span class="p">,</span>
            <span class="s1">&#39;std_pk_l0&#39;</span><span class="p">:</span> <span class="n">th_pk_l00_std</span><span class="p">,</span> <span class="s1">&#39;std_pk_l2&#39;</span><span class="p">:</span> <span class="n">th_pk_l22_std</span><span class="p">,</span> <span class="s1">&#39;std_pk_l4&#39;</span><span class="p">:</span> <span class="n">th_pk_l44_std</span><span class="p">,</span>
            <span class="s1">&#39;cov_block_diagonals_00_02_04_22_24_44&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">th_pk_l00_var</span><span class="p">,</span> <span class="n">th_pk_l02_var</span><span class="p">,</span> <span class="n">th_pk_l04_var</span><span class="p">,</span> <span class="n">th_pk_l22_var</span><span class="p">,</span> <span class="n">th_pk_l24_var</span><span class="p">,</span> <span class="n">th_pk_l44_var</span><span class="p">],</span>
            <span class="s1">&#39;cov&#39;</span> <span class="p">:</span> <span class="n">cov</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">approx_number_k_modes</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Approximates the number of wavemodes falling in a spherical</span>
<span class="sd">    bin centered in k</span>

<span class="sd">    Inputs:</span>
<span class="sd">    k:      wavemode</span>
<span class="sd">    box:    box size in Mpc/h</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pknbody&#39;</span><span class="p">][</span><span class="s1">&#39;log_binning&#39;</span><span class="p">]:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">box</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">prepend</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">box</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">/</span> <span class="n">kf</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">N</span>

<span class="k">def</span> <span class="nf">approx_pk_gaussian_error</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Approximates the gaussian error on the power spectrum</span>

<span class="sd">    Inputs:</span>
<span class="sd">    k:      wavemode</span>
<span class="sd">    pk:     power spectrum (either measured, or theory + shot noise)</span>
<span class="sd">    box:    box size in Mpc/h</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="n">approx_number_k_modes</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">nk</span><span class="p">)</span> <span class="o">*</span> <span class="n">pk</span>

<span class="k">def</span> <span class="nf">fake_2pcf_multipoles_measurement</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">expfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Takes a power spectrum (k, pk) in input, computes the gaussian errors,</span>
<span class="sd">    displaces each point gaussianly around the true value</span>

<span class="sd">    cosmology: a cosmology class</span>
<span class="sd">    ndensity:  the number density of objects in (h/Mpc)^3</span>
<span class="sd">    volume:    the volume of teh survey</span>
<span class="sd">    bias:      the average bias of the sample</span>
<span class="sd">    r:         radii in Mpc/h (default from 1 to 200)</span>
<span class="sd">    expfactor: a = 1 / (1 + z) required (default is the one from cosmo)</span>
<span class="sd">    seed: the seed used to randomly sample a gaussian around each P(k) measurement</span>

<span class="sd">    Note:</span>

<span class="sd">    Euclid:</span>
<span class="sd">        ndensity ~ 5e-4 (h/Mpc)^3</span>
<span class="sd">        volume ~ 5e10 (Mpc/h)^3</span>
<span class="sd">        bias ~ 0.9 + 0.4 * z</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">.statistics</span> <span class="k">import</span> <span class="n">compute_gaussian_error_multipoles_power</span>
    <span class="kn">from</span> <span class="nn">.cengine</span> <span class="k">import</span> <span class="n">cengine</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>
    <span class="kn">import</span> <span class="nn">time</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">expfactor</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="k">if</span> <span class="n">expfactor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">expfactor</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">seed</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="c1"># set up theory</span>
    <span class="n">pk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_powerspec</span><span class="p">(</span><span class="n">wavemode</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">growthrate</span><span class="p">(</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span><span class="p">)</span> <span class="o">/</span> <span class="n">bias</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># error prediction -- gaussian errors that do not account for nonlinearities not FoGs</span>
    <span class="n">pk2d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_pk2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">RSD</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">pkmulti</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pkmulti</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">pk2d</span><span class="p">)</span>
    <span class="n">pk_l0_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span>
    <span class="n">pk_l2_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span>
    <span class="n">pk_l4_var</span> <span class="o">=</span> <span class="n">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">volume</span><span class="p">,</span> <span class="n">ndensity</span><span class="p">)</span>

    <span class="n">th_xi_l0</span>   <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_zcorrelationfunction</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">th_xi_l2</span>   <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_zcorrelationfunction</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">th_xi_l4</span>   <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_zcorrelationfunction</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>

    <span class="c1"># now, the prediction including FoGs</span>
    <span class="n">pk2d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_pk2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="n">sigma_s</span><span class="p">,</span> <span class="n">RSD</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">FOG</span><span class="o">=</span><span class="n">FOG</span><span class="p">)</span>
    <span class="n">pkmulti</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pkmulti</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">pk2d</span><span class="p">)</span>
    <span class="n">_xi_0</span><span class="p">,</span> <span class="n">_r</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pk2xi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">jn</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">_xi_0</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">_r</span><span class="p">,</span> <span class="n">_r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_xi_0</span><span class="p">)</span>
    <span class="n">_xi_2</span><span class="p">,</span> <span class="n">_r</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pk2xi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">jn</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">_xi_2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">_r</span><span class="p">,</span> <span class="n">_r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_xi_2</span><span class="p">)</span>
    <span class="n">_xi_4</span><span class="p">,</span> <span class="n">_r</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pk2xi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pkmulti</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">jn</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">_xi_4</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">semilogx_int_ext</span><span class="p">(</span><span class="n">_r</span><span class="p">,</span> <span class="n">_r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_xi_4</span><span class="p">)</span>
    <span class="n">th_xi_l0</span> <span class="o">=</span> <span class="n">_xi_0</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">th_xi_l2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">_xi_2</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">th_xi_l4</span> <span class="o">=</span> <span class="n">_xi_4</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">xi_l0_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
    <span class="n">xi_l2_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
    <span class="n">xi_l4_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;computing covariance matrix...&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
            <span class="n">dri</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">drj</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xi_l0_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">double_hankel_r1r2</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk_l0_var</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dri</span><span class="p">,</span> <span class="n">drj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">xi_l2_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">double_hankel_r1r2</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk_l2_var</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dri</span><span class="p">,</span> <span class="n">drj</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">xi_l4_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cengine</span><span class="o">.</span><span class="n">double_hankel_r1r2</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pk_l4_var</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dri</span><span class="p">,</span> <span class="n">drj</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;done in </span><span class="si">{}</span><span class="s1"> seconds!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>
    <span class="n">xi_l0_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">xi_l0_var</span><span class="p">))</span>
    <span class="n">xi_l2_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">xi_l2_var</span><span class="p">))</span>
    <span class="n">xi_l4_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">xi_l4_var</span><span class="p">))</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">xi_l0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">th_xi_l0</span><span class="p">,</span> <span class="n">xi_l0_std</span><span class="p">)</span>
    <span class="n">xi_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">th_xi_l2</span><span class="p">,</span> <span class="n">xi_l2_std</span><span class="p">)</span>
    <span class="n">xi_l4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">th_xi_l4</span><span class="p">,</span> <span class="n">xi_l4_std</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;xi_l0&#39;</span><span class="p">:</span> <span class="n">xi_l0</span><span class="p">,</span> <span class="s1">&#39;xi_l2&#39;</span><span class="p">:</span> <span class="n">xi_l2</span><span class="p">,</span> <span class="s1">&#39;xi_l4&#39;</span><span class="p">:</span> <span class="n">xi_l4</span><span class="p">,</span>
            <span class="s1">&#39;xi_l0_true&#39;</span><span class="p">:</span> <span class="n">th_xi_l0</span><span class="p">,</span> <span class="s1">&#39;xi_l2_true&#39;</span><span class="p">:</span> <span class="n">th_xi_l2</span><span class="p">,</span> <span class="s1">&#39;xi_l4_true&#39;</span><span class="p">:</span> <span class="n">th_xi_l4</span><span class="p">,</span>
            <span class="s1">&#39;std_xi_l0&#39;</span><span class="p">:</span> <span class="n">xi_l0_std</span><span class="p">,</span> <span class="s1">&#39;std_xi_l2&#39;</span><span class="p">:</span> <span class="n">xi_l2_std</span><span class="p">,</span> <span class="s1">&#39;std_xi_l4&#39;</span><span class="p">:</span> <span class="n">xi_l4_std</span><span class="p">,</span>
            <span class="s1">&#39;cov_xi_l0&#39;</span><span class="p">:</span> <span class="n">xi_l0_var</span><span class="p">,</span> <span class="s1">&#39;cov_xi_l2&#39;</span><span class="p">:</span> <span class="n">xi_l2_var</span><span class="p">,</span> <span class="s1">&#39;cov_xi_l4&#39;</span><span class="p">:</span> <span class="n">xi_l4_var</span><span class="p">}</span>

<span class="c1"># def get_noisy_theory_2pcf_multipoles()</span>

<span class="k">def</span> <span class="nf">powerspectrum</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">ngrid</span>
    <span class="n">grid</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span>
                                 <span class="n">bins</span><span class="o">=</span><span class="n">ngrid</span><span class="p">,</span>
                                 <span class="nb">range</span><span class="o">=</span><span class="p">[(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)],</span>
                                 <span class="n">normed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">weights</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">])</span>

    <span class="n">grid</span> <span class="o">/=</span> <span class="n">dx</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftn</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">ngrid</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ngrid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">kmod</span> <span class="o">=</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>


<span class="c1">#-----------------------------------------</span>
<span class="c1">#  Halo-statistics</span>
<span class="c1">#-----------------------------------------</span>

<div class="viewcode-block" id="compute_halo_mass_function"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_halo_mass_function">[docs]</a><span class="k">def</span> <span class="nf">compute_halo_mass_function</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Njk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">convert_kpc_to_Mpc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;dn_dlnM&#39;</span><span class="p">,</span> <span class="n">mdef</span><span class="o">=</span><span class="s1">&#39;mfof&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    halo_mass_function(sim, convert_kpc_to_Mpc=True)</span>

<span class="sd">    Compute and the halo mass function and its covariance matrix.</span>
<span class="sd">    The units of the HMF are h^{4} Mpc^{-3} M_\odot^{-1}. The covariance</span>
<span class="sd">    matrix is computed with a jackknife, dividing each dimension into Njk</span>
<span class="sd">    cells (default is 4). Note that an improved jackkinfe is implemented</span>
<span class="sd">    here, following arXiv:1503.00313.</span>

<span class="sd">    If convert_kpc_2o_Mpc=True halo positions are assumed to be in kpc/h</span>
<span class="sd">    and are converted to Mpc/h. Otherwise, they are assumed to already be</span>
<span class="sd">    in Mpc/h and no correction is applied.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">qty</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dn_dlnM&#39;</span><span class="p">,</span> <span class="s1">&#39;dn_dM&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">mdef</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mfof&#39;</span><span class="p">,</span> <span class="s1">&#39;m200c&#39;</span><span class="p">,</span> <span class="s1">&#39;m200m&#39;</span><span class="p">,</span> <span class="s1">&#39;mvir&#39;</span><span class="p">]</span>

    <span class="n">kpc2Mpc</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="k">if</span> <span class="n">convert_kpc_to_Mpc</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">1.0</span>

    <span class="c1"># volume of box, of jackkinfe cell, and effective volume of a resampling</span>
    <span class="n">Vtot</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kpc2Mpc</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">VJKcell</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kpc2Mpc</span> <span class="o">/</span> <span class="n">Njk</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">Vjkeff</span> <span class="o">=</span> <span class="n">Vtot</span> <span class="o">-</span> <span class="n">VJKcell</span>

    <span class="c1"># jackknife implementation</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">jkstep</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BoxSize&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">Njk</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Njk</span><span class="p">):</span>
        <span class="n">excl_x_min</span><span class="p">,</span> <span class="n">excl_x_max</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">jkstep</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">jkstep</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Njk</span><span class="p">):</span>
            <span class="n">excl_y_min</span><span class="p">,</span> <span class="n">excl_y_max</span> <span class="o">=</span> <span class="n">j</span><span class="o">*</span><span class="n">jkstep</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">jkstep</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Njk</span><span class="p">):</span>
                <span class="n">excl_z_min</span><span class="p">,</span> <span class="n">excl_z_max</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">jkstep</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">jkstep</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">excl_x_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">excl_x_max</span><span class="p">))</span> <span class="o">&amp;</span>
                                <span class="p">((</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">excl_y_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">excl_y_min</span><span class="p">))</span> <span class="o">&amp;</span>
                                <span class="p">((</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">excl_z_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_pos&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">excl_z_max</span><span class="p">))</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_&#39;</span><span class="o">+</span><span class="n">mdef</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Njk</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">Njk</span><span class="p">)],</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Njk</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">Njk</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_&#39;</span><span class="o">+</span><span class="n">mdef</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mf">1e10</span><span class="p">,</span> <span class="mf">1e16</span><span class="p">]))</span>
                <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Njk</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">Njk</span><span class="p">)]</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Njk</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">Njk</span><span class="p">)]</span> <span class="o">/</span> <span class="n">Vjkeff</span>

    <span class="c1"># Bin centers are the same for all histograms</span>
    <span class="c1">#hmean, bmean = np.histogram(np.log(sim.fof.halo_table[&#39;halo_mvir&#39;][sim.fof.halo_table[&#39;halo_mvir&#39;]&gt;0]*1e10), bins=30)</span>

    <span class="n">bmean</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bmean</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">centmean</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bmean</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bmean</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">bmean</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">bmean</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">log_bin_width</span> <span class="o">=</span> <span class="n">bmean</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bmean</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># average mass function</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Njk</span><span class="o">**</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">hmean</span> <span class="o">+=</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">hmean</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Njk</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">hmean</span><span class="p">,</span> <span class="n">bmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_&#39;</span><span class="o">+</span><span class="n">mdef</span><span class="p">][</span><span class="n">sim</span><span class="o">.</span><span class="n">fof</span><span class="o">.</span><span class="n">halo_table</span><span class="p">[</span><span class="s1">&#39;halo_&#39;</span><span class="o">+</span><span class="n">mdef</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="mf">1e10</span><span class="p">,</span> <span class="mf">1e16</span><span class="p">]))</span>
    <span class="n">hmean</span> <span class="o">=</span> <span class="n">hmean</span><span class="o">/</span><span class="n">Vtot</span>

    <span class="c1"># The computation of the covariance matrix follows arXiv:1503.00313</span>
    <span class="c1"># This method corrects for the effective volume used in the jackknife</span>
    <span class="c1"># method, leading to more accurate estimations of the errors</span>
    <span class="n">R_Vtot</span> <span class="o">=</span> <span class="p">((</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">Vtot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">R_Vjkcell</span> <span class="o">=</span> <span class="p">((</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">VJKcell</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">sigma_Vtot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span><span class="n">R_Vtot</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">sigma_Vjkcell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">Cosmology</span><span class="o">.</span><span class="n">get_logvariance_z</span><span class="p">(</span>
        <span class="n">R_Vjkcell</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">rsigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma_Vtot</span> <span class="o">/</span> <span class="n">sigma_Vjkcell</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)):</span>
            <span class="n">Delta_i_Delta_j</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">jk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Njk</span><span class="o">**</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">Delta_i_Delta_j</span> <span class="o">+=</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">jk</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">hmean</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">jk</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">hmean</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">Delta_i_Delta_j</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Njk</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsigma</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">Njk</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Delta_i_Delta_j</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">):</span>
                <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rsigma</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">Njk</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">jk</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="n">jk</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">Vtot</span><span class="p">)</span>

    <span class="c1"># A normalization is needed now!</span>
    <span class="c1"># With this choice, the HMF comes out with units of</span>
    <span class="c1"># h^4 Mpc^{-3} M_\odot^{-1}</span>
    <span class="k">if</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;dn_dlnM&#39;</span><span class="p">:</span>
        <span class="n">hmean</span> <span class="o">=</span> <span class="n">hmean</span> <span class="o">/</span> <span class="n">log_bin_width</span>
    <span class="k">if</span> <span class="n">qty</span> <span class="o">==</span> <span class="s1">&#39;dn_dM&#39;</span><span class="p">:</span>
        <span class="n">hmean</span> <span class="o">=</span> <span class="n">hmean</span> <span class="o">/</span> <span class="n">bin_width</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)):</span>
            <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">bin_width</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">bin_width</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="c1"># Errors on ln(x) are given by sigma_x/x</span>
    <span class="n">herrlog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">hmean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">show_plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Njk</span><span class="o">**</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">hn</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">bin_width</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">centmean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hn</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">centmean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hmean</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">herrlog</span><span class="p">,</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$[M/(h^{-1}M_\odot)]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">[(\mathrm</span><span class="si">{d}</span><span class="s1">n/\mathrm</span><span class="si">{d}</span><span class="s1">M)/(h^</span><span class="si">{4}</span><span class="s1"> \mathrm</span><span class="si">{Mpc}</span><span class="s1">^3 M_\odot^{-1})]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$z = </span><span class="si">%.5f</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">sim</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Redshift&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># ax.set_ylim([1e-24,1e-16])</span>
        <span class="c1"># plt.savefig(&#39;mf.pdf&#39;, bbox_inches=&#39;tight&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">Cnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centmean</span><span class="p">)):</span>
                <span class="n">Cnorm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">centmean</span><span class="p">,</span> <span class="n">centmean</span><span class="p">,</span> <span class="n">Cnorm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues_r&#39;</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">[M/(h^{-1}M_\odot)]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">[M/(h^{-1}M_\odot)]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$C_</span><span class="si">{ij}</span><span class="s1">/(\sigma_i \sigma_j)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># plt.savefig(&#39;cov.pdf&#39;, bbox_inches=&#39;tight&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">centmean</span><span class="p">),</span> <span class="n">bin_width</span><span class="p">,</span> <span class="n">hmean</span><span class="p">,</span> <span class="n">C</span></div>


<div class="viewcode-block" id="compute_concentration"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_concentration">[docs]</a><span class="k">def</span> <span class="nf">compute_concentration</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits an NFW profile to the input density profile.</span>
<span class="sd">    Inputs: radii/r_200 and density in [h^2 Msun/Mpc^3]</span>
<span class="sd">    Returns the scale radius (rs), the typical density (rhoc), and the best-fit profile evalutated at</span>
<span class="sd">        the input radii</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">iminuit</span>
    <span class="n">_radius</span> <span class="o">=</span> <span class="n">radius</span><span class="p">[</span><span class="n">density</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_density</span> <span class="o">=</span> <span class="n">density</span><span class="p">[</span><span class="n">density</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

    <span class="kn">from</span> <span class="nn">.halo</span> <span class="k">import</span> <span class="n">rho_nfw</span>

    <span class="k">def</span> <span class="nf">cost_function</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rhoc</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">rho_nfw</span><span class="p">(</span><span class="n">_radius</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rhoc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_density</span><span class="o">/</span><span class="n">model</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">mintry</span> <span class="o">=</span> <span class="n">iminuit</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="n">cost_function</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">rhoc</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">limit_rs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
                            <span class="n">limit_rhoc</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e20</span><span class="p">)),</span> <span class="n">error_rs</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">error_rhoc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">print_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">errordef</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">mintry</span><span class="o">.</span><span class="n">migrad</span><span class="p">(</span><span class="n">ncall</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mintry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;rs&#39;</span><span class="p">],</span> <span class="n">mintry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;rhoc&#39;</span><span class="p">],</span> <span class="n">rho_nfw</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mintry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;rs&#39;</span><span class="p">],</span> <span class="n">mintry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;rhoc&#39;</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">approximate_concentration</span><span class="p">(</span><span class="n">r_200</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">M_200</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    approximate halo concentration following Prada et al. 2011 (https://arxiv.org/pdf/1104.5130.pdf)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">add</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.216</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">c</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">c</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">add</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">add</span>  <span class="o">-</span> <span class="n">vm</span><span class="o">/</span><span class="n">v</span>

    <span class="n">G</span> <span class="o">=</span> <span class="mf">43.0071</span><span class="c1"># Mpc/(1e10 M_solar) km^2 / s^2</span>
    <span class="n">r_200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r_200</span><span class="p">)</span>
    <span class="n">M_200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">M_200</span><span class="p">)</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">concs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r_200</span><span class="p">)</span>
    <span class="n">v_200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">G</span><span class="o">*</span><span class="n">M_200</span><span class="o">/</span><span class="n">r_200</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v200</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v_200</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">vmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="p">((</span><span class="n">v200</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">v200</span><span class="o">&lt;</span><span class="mi">30000</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">concs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">newton</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">vmax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">v200</span><span class="p">),</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full_output</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">converged</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">concs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">concs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">concs</span>

<span class="k">def</span> <span class="nf">compute_shear_power</span><span class="p">(</span><span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Pk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">z_m</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fucntion that integrate the matter power spectrum to get shear power spectrum.</span>
<span class="sd">    Input:</span>
<span class="sd">        cosmology: a cosmology object to set the geometry of the universe.</span>
<span class="sd">        k: wavemodes</span>
<span class="sd">        Pk: matter power spectrum measured at k</span>
<span class="sd">        z_m: median redshift of the distribution of galaxies. Default 0.9 (Eucclid-like)</span>
<span class="sd">    Output:</span>
<span class="sd">        a dictionary with multipoles l and angular power spectrum Cl.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.cls</span> <span class="k">import</span> <span class="n">Cl</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">k</span>
    <span class="n">Pk</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">get_nlpowerspec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">Pk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Pk</span>
    <span class="n">cl</span> <span class="o">=</span> <span class="n">Cl</span><span class="p">(</span><span class="n">cosmo</span><span class="o">=</span><span class="n">cosmology</span><span class="p">,</span> <span class="n">probes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">],</span> <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">nside</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                        <span class="n">nl</span><span class="o">=</span><span class="n">nl</span><span class="p">,</span> <span class="n">do_tomography</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">Pk</span><span class="p">,</span> <span class="n">z_m</span> <span class="o">=</span> <span class="n">z_m</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="n">cl</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;cl&#39;</span><span class="p">:</span> <span class="n">cl</span><span class="o">.</span><span class="n">Cls</span><span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">compute_wp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">pi_max</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">log_rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;halotools&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute wp with halotools or Corrfunc.</span>
<span class="sd">        more info: http://halotools.readthedocs.io/en/latest/api/halotools.mock_observables.wp.html#halotools.mock_observables.wp</span>
<span class="sd">        Input: </span>
<span class="sd">            pos: position of the objects</span>
<span class="sd">            box: boxsize of the simulation</span>
<span class="sd">            pi_max: maximum value of pi. For Corrfunc it has to be &lt; box/3</span>
<span class="sd">            rmin: minimum value of &#39;r&#39; were wp is measured, not valid if rbins is given</span>
<span class="sd">            rmax: maximum value of &#39;r&#39; were wp is measured, not valid if rbins is given. It has to be &lt; box/3</span>
<span class="sd">            nbins: number of bins of &#39;r&#39; array</span>
<span class="sd">            method: Method to compute wp (eg. halotools, Corrfunc)</span>
<span class="sd">            random: number of a random subsample, used to speedup the calculations</span>
<span class="sd">            seed: Value of the random seed</span>
<span class="sd">            nthreads: number of threads</span>
<span class="sd">            rbins: Array of float of leanght nbins+1. Edges of the &#39;r&#39; bins.</span>
<span class="sd">            verbose: verbose</span>
<span class="sd">        Output:</span>
<span class="sd">            rbins_mid: middle points of the &#39;r&#39; bins</span>
<span class="sd">            wp: value of wp</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">random</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">random</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="n">rmax</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span><span class="n">box</span><span class="o">/</span><span class="mf">3.001</span><span class="p">)</span>
    <span class="n">pi_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pi_max</span><span class="p">,</span><span class="n">box</span><span class="o">/</span><span class="mf">3.001</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmax</span><span class="p">),</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">nbin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">rbins_mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;halotools&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">halotools.mock_observables</span> <span class="k">as</span> <span class="nn">htools</span>
        <span class="n">Xi</span> <span class="o">=</span> <span class="n">htools</span><span class="o">.</span><span class="n">wp</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">rbins</span><span class="p">,</span> <span class="n">pi_max</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">rbins_mid</span><span class="p">,</span> <span class="s1">&#39;wp&#39;</span><span class="p">:</span> <span class="n">Xi</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Corrfunc&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">Corrfunc.theory.wp</span> <span class="k">import</span> <span class="n">wp</span>        
        <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">wp_corrfunc</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pi_max</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">rbins</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Z1</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">rbins_mid</span><span class="p">,</span> <span class="s1">&#39;wp&#39;</span><span class="p">:</span> <span class="n">wp_corrfunc</span><span class="p">[</span><span class="s1">&#39;wp&#39;</span><span class="p">]}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wp function method=</span><span class="si">{0}</span><span class="s2"> not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>


<div class="viewcode-block" id="compute_multipoles"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_multipoles">[docs]</a><span class="k">def</span> <span class="nf">compute_multipoles</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">log_rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_mubin</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">axis_zsd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                       <span class="n">method</span><span class="o">=</span><span class="s2">&quot;halotools&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">zspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cosmology</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the multipoles of xi with halotools.</span>
<span class="sd">        more info:</span>
<span class="sd">        -http://halotools.readthedocs.io/en/latest/api/halotools.mock_observables.s_mu_tpcf.html#halotools.mock_observables.s_mu_tpcf</span>
<span class="sd">        -http://halotools.readthedocs.io/en/latest/api/halotools.mock_observables.tpcf_multipole.html#halotools.mock_observables.tpcf_multipole</span>
<span class="sd">        If zspace is False, it assume the redshift space distortion effect</span>
<span class="sd">        is already include in the position</span>
<span class="sd">        TODO: Add a simulation implementation, improve this description</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">random</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">random</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="k">if</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">elif</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">log_rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rmin</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_rmin</span>
    <span class="k">if</span> <span class="n">log_rmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rmax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_rmax</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span><span class="n">box</span><span class="o">/</span><span class="mf">3.001</span><span class="p">)</span>
    <span class="n">mu_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_mubin</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">logspace</span><span class="p">:</span>
        <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmin</span><span class="p">)</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nbin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">rbins_mid</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">nbin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">rbins_mid</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">rbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">xi_pole</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">xi_pole</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbins_mid</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;halotools&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">halotools.mock_observables</span> <span class="k">as</span> <span class="nn">htools</span>
        <span class="n">xi_s_mu</span> <span class="o">=</span> <span class="n">htools</span><span class="o">.</span><span class="n">s_mu_tpcf</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="n">rbins</span><span class="p">,</span> <span class="n">mu_bins</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Corrfunc&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">Corrfunc.theory.DDsmu</span> <span class="k">import</span> <span class="n">DDsmu</span>
        <span class="kn">import</span> <span class="nn">halotools.mock_observables</span> <span class="k">as</span> <span class="nn">htools</span>

        <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zspace</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">expfactor</span>
            <span class="n">Z1</span> <span class="o">+=</span> <span class="n">vel</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">cosmology</span><span class="o">.</span><span class="n">hubble_z</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="c1"># Check This!</span>
            <span class="n">Z1</span><span class="p">[</span><span class="n">Z1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box</span>
            <span class="n">Z1</span><span class="p">[</span><span class="n">Z1</span><span class="o">&gt;=</span><span class="n">box</span><span class="p">]</span> <span class="o">-=</span> <span class="n">box</span>
        <span class="n">ngal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X1</span><span class="p">))</span>
        <span class="n">DD_s_mu</span> <span class="o">=</span> <span class="n">DDsmu</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">rbins</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Z1</span><span class="p">,</span> <span class="n">boxsize</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>
        <span class="n">xi_s_mu</span> <span class="o">=</span> <span class="n">DD_s_mu</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="n">DD_s_mu</span><span class="p">[</span><span class="s1">&#39;smax&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">DD_s_mu</span><span class="p">[</span><span class="s1">&#39;smin&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">ngal</span><span class="o">/</span><span class="n">box</span><span class="o">**</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">ngal</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mu_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xi_s_mu</span> <span class="o">=</span> <span class="n">xi_s_mu</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rbins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wp function method=</span><span class="si">{0}</span><span class="s2"> not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="n">xi_pole</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">htools</span><span class="o">.</span><span class="n">tpcf_multipole</span><span class="p">(</span><span class="n">xi_s_mu</span><span class="p">,</span> <span class="n">mu_bins</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">xi_pole</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">_r2&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">xi_pole</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">*</span> <span class="n">xi_pole</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">xi_pole</span></div>


<span class="k">def</span> <span class="nf">_RR</span><span class="p">(</span><span class="n">binning</span><span class="p">,</span> <span class="n">LBox</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">Nsec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Nsec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">Nsec</span> <span class="o">=</span> <span class="n">N</span>
    <span class="k">return</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="n">binning</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">*</span><span class="n">Nsec</span><span class="o">/</span><span class="n">LBox</span><span class="o">**</span><span class="mi">3</span>
<span class="k">def</span> <span class="nf">_DDrppi2wp</span><span class="p">(</span><span class="n">binning</span><span class="p">,</span><span class="n">DDrppi</span><span class="p">,</span> <span class="n">Lbox</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span><span class="n">Nsec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Nsec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">Nsec</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">NBins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">binning</span><span class="p">)</span>
    <span class="n">N_pi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">delta_pi</span> <span class="o">=</span> <span class="n">DDrppi</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">DDrppi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">last_rp</span> <span class="o">=</span> <span class="n">DDrppi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DDrppi</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">DDrppi</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_rp</span><span class="p">:</span> <span class="n">N_pi</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
    <span class="n">NBins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DDrppi</span><span class="p">)</span><span class="o">/</span><span class="n">N_pi</span><span class="p">)</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBins</span><span class="p">)</span>
    <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBins</span><span class="p">)</span>
    <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;wp&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBins</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBins</span><span class="p">):</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DDrppi</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N_pi</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DDrppi</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N_pi</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">RR</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">delta_pi</span><span class="o">*</span><span class="p">(</span><span class="n">DDrppi</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N_pi</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">DDrppi</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N_pi</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">N</span><span class="o">*</span><span class="n">Nsec</span><span class="o">/</span><span class="n">Lbox</span><span class="o">**</span><span class="mi">3</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_pi</span><span class="p">):</span>
            <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">DDrppi</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N_pi</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;wp&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">DDrppi</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N_pi</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">RR</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;wp&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">wp</span>

<div class="viewcode-block" id="compute_twopointcorr_jackknife"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_twopointcorr_jackknife">[docs]</a><span class="k">def</span> <span class="nf">compute_twopointcorr_jackknife</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">axis_zsd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">random</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Corrfunc&quot;</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute 2PCF and their jackknife errorsself.</span>
<span class="sd">        The Jackknife samples are done removing cubic subsamples</span>
<span class="sd">        from the primary (not secondary) galaxy sampleself.</span>
<span class="sd">        The number of jackknife samples are equaly to n_jn3^3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">random</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">random</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="k">if</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">elif</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">jn_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">n_jn3</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">n_jn3</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Corrfunc&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">Corrfunc.theory.DD</span> <span class="k">import</span> <span class="n">DD</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span><span class="n">box</span><span class="o">/</span><span class="mf">3.001</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmax</span><span class="p">),</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binning</span> <span class="o">=</span> <span class="n">rbins</span>
            <span class="n">nbin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">bin_mean</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">xi</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_mean</span>
        <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">Auto</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
        <span class="n">Mask</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">njackknife</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jn3</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">N_JN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">njackknife</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">Mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jn_index</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">N_JN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">Mask</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">DD_Sub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">DD_Sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DD</span><span class="p">(</span><span class="n">Auto</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">binning</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">Y</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">Z</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">X2</span><span class="o">=</span><span class="n">X</span> <span class="p">,</span><span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span><span class="p">,</span><span class="n">Z2</span> <span class="o">=</span> <span class="n">Z</span><span class="p">,</span> <span class="n">boxsize</span> <span class="o">=</span> <span class="n">box</span><span class="p">,</span> <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">DD_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DD_Sub</span><span class="p">)[:][</span><span class="s1">&#39;npairs&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">xi_full</span> <span class="o">=</span> <span class="n">DD_full</span><span class="o">/</span><span class="n">_RR</span><span class="p">(</span><span class="n">binning</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">xi</span><span class="p">[</span><span class="s1">&#39;xi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_full</span>

        <span class="n">DD_jn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">njackknife</span><span class="p">,</span><span class="n">nbin</span><span class="p">))</span>
        <span class="n">xi_jn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">njackknife</span><span class="p">,</span><span class="n">nbin</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">DD_jn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DD_full</span> <span class="o">-</span> <span class="n">DD_Sub</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span>
            <span class="n">xi_jn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DD_jn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">_RR</span><span class="p">(</span><span class="n">binning</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">N_JN</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xi_jn_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xi_jn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">jn_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">njackknife</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">njackknife</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xi_jn_mean</span><span class="o">-</span><span class="n">xi_jn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">Cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbin</span><span class="p">,</span><span class="n">nbin</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
                <span class="n">Cv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xi_jn</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi_jn_mean</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">xi_jn</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi_jn_mean</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="n">Cv</span> <span class="o">*=</span> <span class="p">(</span><span class="n">njackknife</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">njackknife</span>

        <span class="n">xi</span><span class="p">[</span><span class="s1">&#39;xi_jn_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_jn_mean</span>
        <span class="n">xi</span><span class="p">[</span><span class="s1">&#39;err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jn_err</span>
        <span class="n">xi</span><span class="p">[</span><span class="s1">&#39;xi_jn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_jn</span>
        <span class="n">xi</span><span class="p">[</span><span class="s1">&#39;Cv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cv</span>
        <span class="k">return</span> <span class="n">xi</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wp function method=</span><span class="si">{0}</span><span class="s2"> not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span></div>

<div class="viewcode-block" id="compute_wp_jackknife"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_wp_jackknife">[docs]</a><span class="k">def</span> <span class="nf">compute_wp_jackknife</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">pi_max</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">log_rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">axis_zsd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Corrfunc&quot;</span><span class="p">,</span> <span class="n">n_jn3</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">Nsub</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">NtimesRandom</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute wp jackknife.</span>
<span class="sd">        For halotools check:</span>
<span class="sd">        http://halotools.readthedocs.io/en/latest/api/halotools.mock_observables.wp_jackknife.html#halotools.mock_observables.wp_jackknife</span>
<span class="sd">        For Corrfunc:</span>
<span class="sd">        The Jackknife samples are done removing cubic subsamples</span>
<span class="sd">        from the primary (not secondary) galaxy sampleself.</span>
<span class="sd">        The number of jackknife samples are equaly to n_jn3^3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#if pos in None: logger.error(&quot; Positions must be provided if computing Wp&quot;)</span>
    <span class="c1">#if box in None: logger.error(&quot; Box length must be provided if computing Wp&quot;)</span>

    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">log_rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rmin</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_rmin</span>
    <span class="k">if</span> <span class="n">log_rmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rmax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_rmax</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">random</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">random</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="k">if</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">elif</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">jn_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">n_jn3</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">n_jn3</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">rmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span><span class="n">box</span><span class="o">/</span><span class="mf">3.001</span><span class="p">)</span>
    <span class="n">pi_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pi_max</span><span class="p">,</span><span class="n">box</span><span class="o">/</span><span class="mf">3.001</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;halotools&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">halotools.mock_observables</span> <span class="k">as</span> <span class="nn">htools</span>
        <span class="n">log_rmin</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmin</span><span class="p">)</span>
        <span class="n">log_rmax</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmax</span><span class="p">)</span>
        <span class="n">Nran</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">NtimesRandom</span>
        <span class="n">xran</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">Nran</span><span class="p">)</span>
        <span class="n">yran</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">Nran</span><span class="p">)</span>
        <span class="n">zran</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">Nran</span><span class="p">)</span>
        <span class="n">randoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xran</span><span class="p">,</span> <span class="n">yran</span><span class="p">,</span> <span class="n">zran</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">rbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmax</span><span class="p">),</span> <span class="n">nbin</span><span class="p">)</span>
        <span class="n">rbins_mid</span> <span class="o">=</span> <span class="n">rbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">Xi</span><span class="p">,</span> <span class="n">Cv</span> <span class="o">=</span> <span class="n">htools</span><span class="o">.</span><span class="n">wp_jackknife</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="n">randoms</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">rbins</span><span class="p">,</span> <span class="n">pi_max</span><span class="p">,</span>
                                     <span class="n">period</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">,</span> <span class="n">Nsub</span><span class="o">=</span><span class="n">Nsub</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="n">rbins_mid</span><span class="p">,</span> <span class="s1">&#39;wp&#39;</span><span class="p">:</span> <span class="n">Xi</span><span class="p">,</span> <span class="s1">&#39;Cv&#39;</span><span class="p">:</span> <span class="n">Cv</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Corrfunc&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">Corrfunc.theory.DDrppi</span> <span class="k">import</span> <span class="n">DDrppi</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">binning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmax</span><span class="p">),</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bin_mean</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_mean</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">Auto</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
        <span class="n">Mask</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">njackknife</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jn3</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">N_JN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">njackknife</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">Mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jn_index</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">N_JN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">Mask</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">DDrppi_Sub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">DDrppi_Sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DDrppi</span><span class="p">(</span><span class="n">Auto</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">pi_max</span><span class="p">,</span> <span class="n">binning</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">Y</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">Z</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">X2</span><span class="o">=</span><span class="n">X</span> <span class="p">,</span><span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span><span class="p">,</span><span class="n">Z2</span> <span class="o">=</span> <span class="n">Z</span><span class="p">,</span> <span class="n">boxsize</span> <span class="o">=</span> <span class="n">box</span><span class="p">,</span> <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">DDrppi_full</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DDrppi_Sub</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">DDrppi_full</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DDrppi_Sub</span><span class="p">)[:][</span><span class="s1">&#39;npairs&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">wp_full</span> <span class="o">=</span> <span class="n">_DDrppi2wp</span><span class="p">(</span><span class="n">binning</span><span class="p">,</span><span class="n">DDrppi_full</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span><span class="n">Nsec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;wp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp_full</span><span class="p">[</span><span class="s1">&#39;wp&#39;</span><span class="p">]</span>

        <span class="n">DDrppi_jn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wp_jn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">njackknife</span><span class="p">,</span><span class="n">nbin</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">DDrppi_jn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DDrppi_Sub</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">DDrppi_jn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DDrppi_full</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">DDrppi_Sub</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span>
            <span class="n">wp_jn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DDrppi2wp</span><span class="p">(</span><span class="n">binning</span><span class="p">,</span><span class="n">DDrppi_jn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">box</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span><span class="n">Nsec</span> <span class="o">=</span> <span class="n">N_JN</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="s1">&#39;wp&#39;</span><span class="p">]</span>
        <span class="n">wp_jn_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wp_jn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">jn_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">njackknife</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">njackknife</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">wp_jn_mean</span><span class="o">-</span><span class="n">wp_jn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;wp_jn_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp_jn_mean</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jn_err</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;wp_jn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp_jn</span>
        <span class="n">wp</span><span class="p">[</span><span class="s1">&#39;N_jn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_JN</span>
        <span class="k">return</span> <span class="n">wp</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wp function method=</span><span class="si">{0}</span><span class="s2"> not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span></div>

<div class="viewcode-block" id="compute_multipoles_jackknife"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_multipoles_jackknife">[docs]</a><span class="k">def</span> <span class="nf">compute_multipoles_jackknife</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">log_rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_mubin</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">axis_zsd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">random</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Corrfunc&quot;</span><span class="p">,</span> <span class="n">n_jn3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">logspace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">binning</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute xi_l and their jackknife errorsself.</span>
<span class="sd">        The Jackknife samples are done removing cubic subsamples</span>
<span class="sd">        from the primary (not secondary) galaxy sampleself.</span>
<span class="sd">        The number of jackknife samples are equaly to n_jn3^3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nthreads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nthreads</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">log_rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rmin</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_rmin</span>
    <span class="k">if</span> <span class="n">log_rmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rmax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_rmax</span>

    <span class="k">if</span> <span class="n">random</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">random</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="k">if</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">elif</span> <span class="n">axis_zsd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">jn_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">n_jn3</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">box</span><span class="o">*</span><span class="n">n_jn3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">n_jn3</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">njackknife</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jn3</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Corrfunc&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">Corrfunc.theory.DDsmu</span>  <span class="k">import</span> <span class="n">DDsmu</span>
        <span class="kn">import</span> <span class="nn">halotools.mock_observables</span> <span class="k">as</span> <span class="nn">htools</span>
        <span class="n">xil</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span><span class="n">box</span><span class="o">/</span><span class="mf">3.001</span><span class="p">)</span>
        <span class="n">mu_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_mubin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logspace</span><span class="p">:</span>
                <span class="n">binning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmax</span><span class="p">),</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">bin_mean</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">binning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">bin_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">binning</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbin</span> <span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">binning</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">logspace</span><span class="p">:</span>
                <span class="n">bin_mean</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">binning</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bin_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">binning</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_mean</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">Auto</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>

        <span class="n">Mask</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">njackknife</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jn3</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">N_JN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">njackknife</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">Mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jn_index</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">N_JN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">Mask</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">DD_smu_Sub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">DD_smu_Sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DDsmu</span><span class="p">(</span><span class="n">Auto</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span> <span class="n">binning</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">Y</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">Z</span><span class="p">[</span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">X2</span><span class="o">=</span><span class="n">X</span> <span class="p">,</span><span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span><span class="p">,</span><span class="n">Z2</span> <span class="o">=</span> <span class="n">Z</span><span class="p">,</span> <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">boxsize</span><span class="o">=</span><span class="n">box</span><span class="p">))</span>
        <span class="n">DD_smu_full</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DD_smu_Sub</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">DD_smu_full</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DD_smu_Sub</span><span class="p">)[:][</span><span class="s1">&#39;npairs&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">xi_smu</span> <span class="o">=</span> <span class="n">DD_smu_full</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="n">DD_smu_full</span><span class="p">[</span><span class="s1">&#39;smax&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">DD_smu_full</span><span class="p">[</span><span class="s1">&#39;smin&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">box</span><span class="o">**</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mu_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xi_smu</span> <span class="o">=</span> <span class="n">xi_smu</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binning</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_smu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_smu</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)):</span>
            <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">htools</span><span class="o">.</span><span class="n">tpcf_multipole</span><span class="p">(</span><span class="n">xi_smu</span><span class="p">,</span> <span class="n">mu_bins</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">_r2&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">bin_mean</span><span class="o">*</span><span class="n">bin_mean</span><span class="o">*</span><span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="n">DD_smu_jn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xi_smu_jn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xil_jn</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">),</span><span class="n">njackknife</span><span class="p">,</span><span class="n">nbin</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njackknife</span><span class="p">):</span>
            <span class="n">DD_smu_jn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DD_smu_Sub</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">DD_smu_jn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DD_smu_full</span><span class="p">[</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">DD_smu_Sub</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span>
            <span class="n">xi_smu_jn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DD_smu_jn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npairs&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="n">DD_smu_jn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;smax&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">DD_smu_jn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;smin&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">box</span><span class="o">**</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">N_JN</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mu_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">xi_smu_jn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_smu_jn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binning</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)):</span>
                <span class="n">xil_jn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htools</span><span class="o">.</span><span class="n">tpcf_multipole</span><span class="p">(</span><span class="n">xi_smu_jn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu_bins</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_smu_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xi_smu_jn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)):</span>
            <span class="n">xi_l_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xil_jn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">_mean&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">xi_l_mean</span>
            <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">_err&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">njackknife</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">njackknife</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xi_l_mean</span><span class="o">-</span><span class="n">xil_jn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l</span><span class="si">%d</span><span class="s1">_jn&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">xil_jn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;N_jn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_JN</span>

        <span class="n">Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l0_jn&#39;</span><span class="p">],</span><span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l2_jn&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l4_jn&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Arr_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbin</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="n">nbin</span><span class="o">*</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="o">*</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="o">*</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">Cv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Arr</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Arr_mean</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">Arr</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">Arr_mean</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="n">Cv</span> <span class="o">*=</span> <span class="p">(</span><span class="n">njackknife</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">njackknife</span>
        <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;xi_l_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Arr_mean</span>
        <span class="n">xil</span><span class="p">[</span><span class="s1">&#39;Cv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cv</span>
        <span class="k">return</span> <span class="n">xil</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wp function method=</span><span class="si">{0}</span><span class="s2"> not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">compute_hod</span><span class="p">(</span><span class="n">Mh_g</span><span class="p">,</span> <span class="n">Mh_h</span><span class="p">,</span> <span class="n">centrals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">LogMmin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">LogMmax</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">NBin</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the HOD for centrals and galaxies for a galaxy sample of a simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">centrals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">centrals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Mh_g</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">IndexlogMhalo_fof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Mh_h</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span> <span class="o">-</span> <span class="n">LogMmin</span><span class="p">)</span> <span class="o">/</span>
                                 <span class="nb">float</span><span class="p">(</span><span class="n">LogMmax</span><span class="o">-</span><span class="n">LogMmin</span><span class="p">)</span><span class="o">*</span><span class="n">NBin</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">IndexlogMhalo_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Mh_g</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span> <span class="o">-</span> <span class="n">LogMmin</span><span class="p">)</span> <span class="o">/</span>
                                 <span class="nb">float</span><span class="p">(</span><span class="n">LogMmax</span><span class="o">-</span><span class="n">LogMmin</span><span class="p">)</span><span class="o">*</span><span class="n">NBin</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">HOD_Nhaloes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBin</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">HOD_Cen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBin</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">HOD_Sat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBin</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IndexlogMhalo_fof</span><span class="p">)):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">IndexlogMhalo_fof</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">NBin</span><span class="p">:</span>
            <span class="n">HOD_Nhaloes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IndexlogMhalo_gal</span><span class="p">)):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">IndexlogMhalo_gal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">NBin</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">centrals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">HOD_Cen</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">HOD_Sat</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1">#HOD_Nhaloes +=1e-10</span>
    <span class="n">x_axis</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">NBin</span><span class="p">))</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">LogMmax</span><span class="o">-</span><span class="n">LogMmin</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">NBin</span><span class="p">)</span><span class="o">+</span><span class="n">LogMmin</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Mh&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="n">x_axis</span><span class="p">,</span> <span class="s1">&#39;Nc&#39;</span><span class="p">:</span> <span class="n">HOD_Cen</span><span class="o">/</span><span class="n">HOD_Nhaloes</span><span class="p">,</span> <span class="s1">&#39;Ns&#39;</span><span class="p">:</span> <span class="n">HOD_Sat</span><span class="o">/</span><span class="n">HOD_Nhaloes</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">HOD_Cen</span><span class="o">+</span><span class="n">HOD_Sat</span><span class="p">)</span><span class="o">/</span><span class="n">HOD_Nhaloes</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_simple_MassFunction</span><span class="p">(</span><span class="n">LogM</span><span class="p">,</span> <span class="n">logM_min</span><span class="p">,</span> <span class="n">logM_max</span><span class="p">,</span> <span class="n">NBin</span><span class="p">,</span> <span class="n">LBox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the mass or luminocity function. Mass need to be in log scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBin</span><span class="p">)</span>
    <span class="n">Index</span> <span class="o">=</span> <span class="p">(</span><span class="n">NBin</span><span class="o">*</span><span class="p">(</span><span class="n">LogM</span> <span class="o">-</span> <span class="n">logM_min</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">logM_max</span><span class="o">-</span><span class="n">logM_min</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Index</span> <span class="o">=</span> <span class="n">Index</span><span class="p">[(</span><span class="n">LogM</span> <span class="o">&gt;=</span> <span class="n">logM_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LogM</span> <span class="o">&lt;</span> <span class="n">logM_max</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Index</span><span class="p">:</span>
        <span class="n">Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">Arr</span> <span class="o">/=</span> <span class="p">(</span><span class="n">LBox</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">logM_max</span><span class="o">-</span><span class="n">logM_min</span><span class="p">)</span><span class="o">/</span><span class="n">NBin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logM_min</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">NBin</span><span class="p">))</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">logM_max</span> <span class="o">-</span> <span class="n">logM_min</span><span class="p">)</span><span class="o">/</span><span class="n">NBin</span><span class="p">,</span> <span class="n">Arr</span>


<div class="viewcode-block" id="compute_theory_error_cov"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_theory_error_cov">[docs]</a><span class="k">def</span> <span class="nf">compute_theory_error_cov</span><span class="p">(</span><span class="n">corr_scale</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">comp_envelope</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">Env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">physical_quantity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">Env_amp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xx_amp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;lin_interpol&quot;</span><span class="p">,</span><span class="n">etype</span><span class="o">=</span><span class="s1">&#39;gpy&#39;</span><span class="p">,</span>
                             <span class="n">emul_points</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">variance_emul</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">corr_scale_emul</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_restarts</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">gaussian_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fix_hyperparams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">noise_stdev_emul</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the covariance matrix for the theory errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.sampler</span> <span class="k">import</span> <span class="n">construct_emulator</span>
    <span class="kn">from</span> <span class="nn">.sampler</span> <span class="k">import</span> <span class="n">evaluate_emulator</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">comp_envelope</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;lin_interpol&quot;</span><span class="p">):</span>
            <span class="n">Env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">xx_amp</span><span class="p">,</span><span class="n">Env_amp</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;GP&quot;</span><span class="p">):</span>
            <span class="n">emulator</span> <span class="o">=</span> <span class="n">construct_emulator</span><span class="p">(</span><span class="n">xx_amp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xx_amp</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">Env_amp</span><span class="p">,</span><span class="n">etype</span><span class="o">=</span><span class="n">etype</span><span class="p">,</span><span class="n">variance</span><span class="o">=</span><span class="n">variance_emul</span><span class="p">,</span>
                                          <span class="n">lengthscale</span><span class="o">=</span><span class="n">corr_scale_emul</span><span class="p">,</span> <span class="n">num_restarts</span><span class="o">=</span><span class="n">num_restarts</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                                          <span class="n">fix_hyperparams</span><span class="o">=</span><span class="n">fix_hyperparams</span><span class="p">,</span>
                                          <span class="n">noise_stdev</span><span class="o">=</span><span class="n">noise_stdev_emul</span><span class="p">)</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#np.linspace(min(xx),max(xx),emul_points)</span>
            <span class="n">Env</span><span class="p">,</span> <span class="n">emul_var</span> <span class="o">=</span> <span class="n">evaluate_emulator</span><span class="p">(</span><span class="n">emulator</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">etype</span><span class="o">=</span><span class="n">etype</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gaussian_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">Env</span><span class="o">=</span><span class="n">gaussian_error</span><span class="o">+</span><span class="n">Env</span><span class="c1">#np.maximum(gaussian_error,Env)</span>

    <span class="n">Cov_theory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Env</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">Env</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Env</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Env</span><span class="p">)):</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xx</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">corr_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">Cov_theory</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Env</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">kernel</span><span class="o">*</span><span class="n">Env</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Cov_theory</span></div>

<div class="viewcode-block" id="compute_gaussian_error_multipoles_power"><a class="viewcode-back" href="../../code.html#bacco.statistics.compute_gaussian_error_multipoles_power">[docs]</a><span class="k">def</span> <span class="nf">compute_gaussian_error_multipoles_power</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">mono</span><span class="p">,</span><span class="n">quad</span><span class="p">,</span><span class="n">hexa</span><span class="p">,</span><span class="n">Vol</span><span class="p">,</span><span class="n">nmean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the gaussian error of the multipoles of the power spectrum</span>
<span class="sd">    divided by the volume. The actual P(k) error is this times the volume,</span>
<span class="sd">    divided by the number of modes in each wavemode bin.</span>
<span class="sd">    Attention: Vol corresponds to the volume in real space</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">py3nj</span>
    <span class="n">Pl</span> <span class="o">=</span> <span class="p">[</span><span class="n">mono</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mono</span><span class="p">)),</span><span class="n">quad</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mono</span><span class="p">)),</span><span class="n">hexa</span><span class="p">]</span>
    <span class="n">sigma_sq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mono</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">l3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l4</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l3</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">shot_noise1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">nmean</span> <span class="k">if</span> <span class="n">l4</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">shot_noise2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">nmean</span> <span class="k">if</span> <span class="n">l4</span><span class="o">==</span><span class="n">l3</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">wigner1</span><span class="o">=</span><span class="mf">1.</span>
            <span class="n">wigner2</span><span class="o">=</span><span class="mf">1.</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">l1</span><span class="o">-</span><span class="n">l2</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l4</span><span class="o">-</span><span class="n">l3</span><span class="p">)]),</span> <span class="nb">min</span><span class="p">([</span><span class="n">l1</span><span class="o">+</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">wigner1</span> <span class="o">=</span> <span class="n">py3nj</span><span class="o">.</span><span class="n">wigner3j</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">l2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">wigner2</span> <span class="o">=</span> <span class="n">py3nj</span><span class="o">.</span><span class="n">wigner3j</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l4</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">l3</span><span class="o">-</span><span class="n">l4</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">sigma_sq</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">Vol</span><span class="o">*</span><span class="p">(</span><span class="n">Pl</span><span class="p">[</span><span class="n">l4</span><span class="p">]</span><span class="o">+</span><span class="n">shot_noise1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Pl</span><span class="p">[</span><span class="n">l3</span><span class="o">-</span><span class="n">l4</span><span class="p">]</span><span class="o">+</span><span class="n">shot_noise2</span><span class="p">)</span><span class="o">*</span><span class="n">wigner1</span><span class="o">**</span><span class="mf">2.</span><span class="o">*</span><span class="n">wigner2</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1">#if (sigma_sq&lt;0).any() :</span>
    <span class="c1">#    import ipdb; ipdb.set_trace()</span>

    <span class="k">return</span> <span class="n">sigma_sq</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Raul E. Angulo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>